!function(e,t){if("object"==typeof exports&&"object"==typeof module)module.exports=t();else if("function"==typeof define&&define.amd)define([],t);else{var r=t();for(var s in r)("object"==typeof exports?exports:e)[s]=r[s]}}("undefined"!=typeof self?self:this,function(){return function(e){function t(s){if(r[s])return r[s].exports;var n=r[s]={i:s,l:!1,exports:{}};return e[s].call(n.exports,n,n.exports,t),n.l=!0,n.exports}var r={};return t.m=e,t.c=r,t.d=function(e,r,s){t.o(e,r)||Object.defineProperty(e,r,{configurable:!1,enumerable:!0,get:s})},t.n=function(e){var r=e&&e.__esModule?function(){return e.default}:function(){return e};return t.d(r,"a",r),r},t.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},t.p="",t(t.s=4)}([function(e,t){function r(e){throw new Error("Cannot find module '"+e+"'.")}r.keys=function(){return[]},r.resolve=r,e.exports=r,r.id=0},function(e,t,r){!function(t,r){e.exports=r()}("undefined"!=typeof self&&self,function(){return function(e){function t(s){if(r[s])return r[s].exports;var n=r[s]={i:s,l:!1,exports:{}};return e[s].call(n.exports,n,n.exports,t),n.l=!0,n.exports}var r={};return t.m=e,t.c=r,t.d=function(e,r,s){t.o(e,r)||Object.defineProperty(e,r,{configurable:!1,enumerable:!0,get:s})},t.n=function(e){var r=e&&e.__esModule?function(){return e.default}:function(){return e};return t.d(r,"a",r),r},t.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},t.p="",t(t.s=0)}([function(e,t,r){"undefined"!=typeof self&&self,e.exports=function(e){function t(s){if(r[s])return r[s].exports;var n=r[s]={i:s,l:!1,exports:{}};return e[s].call(n.exports,n,n.exports,t),n.l=!0,n.exports}var r={};return t.m=e,t.c=r,t.d=function(e,r,s){t.o(e,r)||Object.defineProperty(e,r,{configurable:!1,enumerable:!0,get:s})},t.n=function(e){var r=e&&e.__esModule?function(){return e.default}:function(){return e};return t.d(r,"a",r),r},t.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},t.p="",t(t.s=26)}([function(e,t,r){"use strict";(function(t){function s(e,t,r){t.forEach(t=>{if("function"!=typeof r[t])throw new Error(`${e} must implement ${t}()`)})}var n={IS_NODE:void 0!==t&&!!t.versions&&!!t.versions.node&&!t.versions.electron,REQUEST_ATTEMPT_LIMIT:5,SERVER_URL:"https://api.cmetamap.com/1",LIVEQUERY_SERVER_URL:null,VERSION:"js"+r(28).version,APPLICATION_ID:null,JAVASCRIPT_KEY:null,MASTER_KEY:null,USE_MASTER_KEY:!1,PERFORM_USER_REWRITE:!0,FORCE_REVOCABLE_SESSION:!1,ALLOW_ANONYMOUS_KEY:null,USE_ALLOW_ANONYMOUS_KEY:!1};e.exports={get:function(e){if(n.hasOwnProperty(e))return n[e];throw new Error("Configuration key not found: "+e)},set:function(e,t){n[e]=t},setAnalyticsController(e){s("AnalyticsController",["track"],e),n.AnalyticsController=e},getAnalyticsController:()=>n.AnalyticsController,setCloudController(e){s("CloudController",["run"],e),n.CloudController=e},getCloudController:()=>n.CloudController,setConfigController(e){s("ConfigController",["current","get"],e),n.ConfigController=e},getConfigController:()=>n.ConfigController,setFileController(e){s("FileController",["saveFile","saveBase64"],e),n.FileController=e},getFileController:()=>n.FileController,setInstallationController(e){s("InstallationController",["currentInstallationId"],e),n.InstallationController=e},getInstallationController:()=>n.InstallationController,setObjectController(e){s("ObjectController",["save","fetch","destroy"],e),n.ObjectController=e},getObjectController:()=>n.ObjectController,setObjectStateController(e){s("ObjectStateController",["getState","initializeState","removeState","getServerData","setServerData","getPendingOps","setPendingOp","pushPendingState","popPendingState","mergeFirstPendingState","getObjectCache","estimateAttribute","estimateAttributes","commitServerChanges","enqueueTask","clearAllState"],e),n.ObjectStateController=e},getObjectStateController:()=>n.ObjectStateController,setPushController(e){s("PushController",["send"],e),n.PushController=e},getPushController:()=>n.PushController,setQueryController(e){s("QueryController",["find","aggregate"],e),n.QueryController=e},getQueryController:()=>n.QueryController,setRESTController(e){s("RESTController",["request","ajax"],e),n.RESTController=e},getRESTController:()=>n.RESTController,setSchemaController(e){s("SchemaController",["get","create","update","delete","send"],e),n.SchemaController=e},getSchemaController:()=>n.SchemaController,setSessionController(e){s("SessionController",["getSession"],e),n.SessionController=e},getSessionController:()=>n.SessionController,setStorageController(e){e.async?s("An async StorageController",["getItemAsync","setItemAsync","removeItemAsync"],e):s("A synchronous StorageController",["getItem","setItem","removeItem"],e),n.StorageController=e},getStorageController:()=>n.StorageController,setAsyncStorage(e){n.AsyncStorage=e},getAsyncStorage:()=>n.AsyncStorage,setUserController(e){s("UserController",["setCurrentUser","currentUser","currentUserAsync","signUp","logIn","become","logOut","requestPasswordReset","upgradeToRevocableSession","linkWith"],e),n.UserController=e},getUserController:()=>n.UserController,setLiveQueryController(e){s("LiveQueryController",["subscribe","unsubscribe","open","close"],e),n.LiveQueryController=e},getLiveQueryController:()=>n.LiveQueryController,setHooksController(e){s("HooksController",["create","get","update","remove"],e),n.HooksController=e},getHooksController:()=>n.HooksController}}).call(t,r(14))},function(e,t,r){"use strict";(function(e){Object.defineProperty(t,"__esModule",{value:!0});var r=!0;class s{constructor(e){this._resolved=!1,this._rejected=!1,this._resolvedCallbacks=[],this._rejectedCallbacks=[],"function"==typeof e&&e(this.resolve.bind(this),this.reject.bind(this))}resolve(...e){if(this._resolved||this._rejected)throw new Error("A promise was resolved even though it had already been "+(this._resolved?"resolved":"rejected")+".");this._resolved=!0,this._result=e;for(var t=0;t<this._resolvedCallbacks.length;t++)this._resolvedCallbacks[t].apply(this,e);this._resolvedCallbacks=[],this._rejectedCallbacks=[]}reject(e){if(this._resolved||this._rejected)throw new Error("A promise was rejected even though it had already been "+(this._resolved?"resolved":"rejected")+".");this._rejected=!0,this._error=e;for(var t=0;t<this._rejectedCallbacks.length;t++)this._rejectedCallbacks[t](e);this._resolvedCallbacks=[],this._rejectedCallbacks=[]}then(t,n){var o=new s,a=function(...e){if("function"==typeof t)if(r)try{e=[t.apply(this,e)]}catch(t){e=[s.error(t)]}else e=[t.apply(this,e)];1===e.length&&s.is(e[0])?e[0].then(function(){o.resolve.apply(o,arguments)},function(e){o.reject(e)}):o.resolve.apply(o,e)},i=function(e){var t=[];if("function"==typeof n){if(r)try{t=[n(e)]}catch(e){t=[s.error(e)]}else t=[n(e)];1===t.length&&s.is(t[0])?t[0].then(function(){o.resolve.apply(o,arguments)},function(e){o.reject(e)}):r?o.resolve.apply(o,t):o.reject(t[0])}else o.reject(e)},l=function(e){e.call()};return r&&(void 0!==e&&"function"==typeof e.nextTick?l=function(t){e.nextTick(t)}:"function"==typeof setTimeout&&(l=function(e){setTimeout(e,0)})),this._resolved?l(()=>{a.apply(this,this._result)}):this._rejected?l(()=>{i(this._error)}):(this._resolvedCallbacks.push(a),this._rejectedCallbacks.push(i)),o}always(e){return this.then(e,e)}done(e){return this.then(e)}fail(e){return this.then(null,e)}catch(e){return this.then(null,e)}_thenRunCallbacks(e,t){var r={};return"function"==typeof e?(r.success=function(t){e(t,null)},r.error=function(t){e(null,t)}):"object"==typeof e&&("function"==typeof e.success&&(r.success=e.success),"function"==typeof e.error&&(r.error=e.error)),this.then(function(...e){return r.success&&r.success.apply(this,e),s.as.apply(s,arguments)},function(e){return r.error&&(void 0!==t?r.error(t,e):r.error(e)),s.error(e)})}_continueWith(e){return this.then(function(...t){return e(t,null)},function(t){return e(null,t)})}static is(e){return null!=e&&"function"==typeof e.then}static as(...e){var t=new s;return t.resolve.apply(t,e),t}static resolve(e){return new s((t,r)=>{s.is(e)?e.then(t,r):t(e)})}static error(...e){var t=new s;return t.reject.apply(t,e),t}static reject(...e){return s.error.apply(null,e)}static when(e){var t,r=Array.isArray(e),n=(t=r?e:arguments).length,o=!1,a=[],i=r?[a]:a,l=[];if(a.length=t.length,l.length=t.length,0===n)return s.as.apply(this,i);for(var u=new s,c=function(){--n<=0&&(o?u.reject(l):u.resolve.apply(u,i))},d=function(e,t){s.is(e)?e.then(function(e){a[t]=e,c()},function(e){l[t]=e,o=!0,c()}):(a[h]=e,c())},h=0;h<t.length;h++)d(t[h],h);return u}static all(e){let t=0,r=[];for(let s of e)r[t++]=s;if(0===t)return s.as([]);let n=!1,o=new s,a=0,i=[];return r.forEach((e,r)=>{s.is(e)?e.then(e=>{if(n)return!1;i[r]=e,++a>=t&&o.resolve(i)},e=>{o.reject(e),n=!0}):(i[r]=e,a++,!n&&a>=t&&o.resolve(i))}),o}static race(e){let t=!1,r=new s;for(let n of e)s.is(n)?n.then(e=>{t||(t=!0,r.resolve(e))},e=>{t||(t=!0,r.reject(e))}):t||(t=!0,r.resolve(n));return r}static _continueWhile(e,t){return e()?t().then(function(){return s._continueWhile(e,t)}):s.as()}static isPromisesAPlusCompliant(){return r}static enableAPlusCompliant(){r=!0}static disableAPlusCompliant(){r=!1}}t.default=s}).call(t,r(14))},function(e,t,r){"use strict";function s(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var r in e)Object.prototype.hasOwnProperty.call(e,r)&&(t[r]=e[r]);return t.default=e,t}function n(e){return e&&e.__esModule?e:{default:e}}function o(){var e=a.default.get("SERVER_URL");"/"!==e[e.length-1]&&(e+="/");var t=e.replace(/https?:\/\//,"");return t.substr(t.indexOf("/"))}Object.defineProperty(t,"__esModule",{value:!0});var a=n(r(0)),i=n(r(29)),l=n(r(7)),u=n(r(6)),c=(n(r(30)),n(r(20))),d=n(r(8)),h=n(r(31)),f=n(r(3)),p=n(r(4)),m=r(9),_=n(r(1)),y=n(r(13)),b=n(r(5)),g=s(r(32)),v=n(r(19)),E=s(r(33)),S=n(r(34)),w={},O=0,I=0,A=!a.default.get("IS_NODE");A?a.default.setObjectStateController(g):a.default.setObjectStateController(E);class N{constructor(e,t,r){"function"==typeof this.initialize&&this.initialize.apply(this,arguments);var s=null;if(this._objCount=I++,"string"==typeof e)this.className=e,t&&"object"==typeof t&&(s=t);else if(e&&"object"==typeof e){this.className=e.className,s={};for(var n in e)"className"!==n&&(s[n]=e[n]);t&&"object"==typeof t&&(r=t)}if(s&&!this.set(s,r))throw new Error("Can't create an invalid Mmbs Object")}get attributes(){let e=a.default.getObjectStateController();return Object.freeze(e.estimateAttributes(this._getStateIdentifier()))}get createdAt(){return this._getServerData().createdAt}get updatedAt(){return this._getServerData().updatedAt}_getId(){if("string"==typeof this.id)return this.id;if("string"==typeof this._localId)return this._localId;var e="local"+String(O++);return this._localId=e,e}_getStateIdentifier(){if(A){let e=this.id;return e||(e=this._getId()),{id:e,className:this.className}}return this}_getServerData(){return a.default.getObjectStateController().getServerData(this._getStateIdentifier())}_clearServerData(){var e=this._getServerData(),t={};for(var r in e)t[r]=void 0;a.default.getObjectStateController().setServerData(this._getStateIdentifier(),t)}_getPendingOps(){return a.default.getObjectStateController().getPendingOps(this._getStateIdentifier())}_clearPendingOps(){var e=this._getPendingOps(),t=e[e.length-1];Object.keys(t).forEach(e=>{delete t[e]})}_getDirtyObjectAttributes(){var e=this.attributes,t=a.default.getObjectStateController().getObjectCache(this._getStateIdentifier()),r={};for(var s in e){var n=e[s];if(n&&"object"==typeof n&&!(n instanceof N)&&!(n instanceof p.default)&&!(n instanceof b.default))try{var o=(0,u.default)(n,!1,!0),i=JSON.stringify(o);t[s]!==i&&(r[s]=n)}catch(e){r[s]=n}}return r}_toFullJSON(e){var t=this.toJSON(e);return t.__type="Object",t.className=this.className,t}_getSaveJSON(){var e,t=this._getPendingOps(),r=this._getDirtyObjectAttributes(),s={};for(e in r)s[e]=new m.SetOp(r[e]).toJSON();for(e in t[0])s[e]=t[0][e].toJSON();return s}_getSaveParams(){var e=this.id?"PUT":"POST",t=this._getSaveJSON(),r="classes/"+this.className;return this.id?r+="/"+this.id:"_User"===this.className&&(r="users"),{method:e,body:t,path:r}}_finishFetch(e){!this.id&&e.objectId&&(this.id=e.objectId);let t=a.default.getObjectStateController();t.initializeState(this._getStateIdentifier());var r={};for(var s in e)"ACL"===s?r[s]=new d.default(e[s]):"objectId"!==s&&(r[s]=(0,l.default)(e[s]),r[s]instanceof b.default&&r[s]._ensureParentAndKey(this,s));r.createdAt&&"string"==typeof r.createdAt&&(r.createdAt=(0,h.default)(r.createdAt)),r.updatedAt&&"string"==typeof r.updatedAt&&(r.updatedAt=(0,h.default)(r.updatedAt)),!r.updatedAt&&r.createdAt&&(r.updatedAt=r.createdAt),t.commitServerChanges(this._getStateIdentifier(),r)}_setExisted(e){let t=a.default.getObjectStateController().getState(this._getStateIdentifier());t&&(t.existed=e)}_migrateId(e){if(this._localId&&e)if(A){let t=a.default.getObjectStateController(),r=t.removeState(this._getStateIdentifier());this.id=e,delete this._localId,r&&t.initializeState(this._getStateIdentifier(),r)}else this.id=e,delete this._localId}_handleSaveResponse(e,t){var r,s={},n=a.default.getObjectStateController(),o=n.popPendingState(this._getStateIdentifier());for(r in o)o[r]instanceof m.RelationOp?s[r]=o[r].applyTo(void 0,this,r):r in e||(s[r]=o[r].applyTo(void 0));for(r in e)"createdAt"!==r&&"updatedAt"!==r||"string"!=typeof e[r]?"ACL"===r?s[r]=new d.default(e[r]):"objectId"!==r&&(s[r]=(0,l.default)(e[r]),s[r]instanceof m.UnsetOp&&(s[r]=void 0)):s[r]=(0,h.default)(e[r]);s.createdAt&&!s.updatedAt&&(s.updatedAt=s.createdAt),this._migrateId(e.objectId),201!==t&&this._setExisted(!0),n.commitServerChanges(this._getStateIdentifier(),s)}_handleSaveError(){this._getPendingOps(),a.default.getObjectStateController().mergeFirstPendingState(this._getStateIdentifier())}initialize(){}toJSON(e){var t=this.id?this.className+":"+this.id:this,r=(e=e||[t],{}),s=this.attributes;for(var n in s)"createdAt"!==n&&"updatedAt"!==n||!s[n].toJSON?r[n]=(0,u.default)(s[n],!1,!1,e):r[n]=s[n].toJSON();var o=this._getPendingOps();for(var n in o[0])r[n]=o[0][n].toJSON();return this.id&&(r.objectId=this.id),r}equals(e){return this===e||e instanceof N&&this.className===e.className&&this.id===e.id&&void 0!==this.id}dirty(e){if(!this.id)return!0;var t=this._getPendingOps(),r=this._getDirtyObjectAttributes();if(e){if(r.hasOwnProperty(e))return!0;for(var s=0;s<t.length;s++)if(t[s].hasOwnProperty(e))return!0;return!1}return 0!==Object.keys(t[0]).length||0!==Object.keys(r).length}dirtyKeys(){for(var e=this._getPendingOps(),t={},r=0;r<e.length;r++)for(var s in e[r])t[s]=!0;var n=this._getDirtyObjectAttributes();for(var s in n)t[s]=!0;return Object.keys(t)}toPointer(){if(!this.id)throw new Error("Cannot create a pointer to an unsaved MmbsObject");return{__type:"Pointer",className:this.className,objectId:this.id}}get(e){return this.attributes[e]}relation(e){var t=this.get(e);if(t){if(!(t instanceof b.default))throw new Error("Called relation() on non-relation field "+e);return t._ensureParentAndKey(this,e),t}return new b.default(this,e)}escape(e){var t=this.attributes[e];if(null==t)return"";if("string"!=typeof t){if("function"!=typeof t.toString)return"";t=t.toString()}return(0,c.default)(t)}has(e){var t=this.attributes;return!!t.hasOwnProperty(e)&&null!=t[e]}set(e,t,r){var s={},n={};if(e&&"object"==typeof e)s=e,r=t;else{if("string"!=typeof e)return this;s[e]=t}r=r||{};var o=[];"function"==typeof this.constructor.readOnlyAttributes&&(o=o.concat(this.constructor.readOnlyAttributes()));for(var i in s)if("createdAt"!==i&&"updatedAt"!==i){if(o.indexOf(i)>-1)throw new Error("Cannot modify readonly attribute: "+i);r.unset?n[i]=new m.UnsetOp:s[i]instanceof m.Op?n[i]=s[i]:s[i]&&"object"==typeof s[i]&&"string"==typeof s[i].__op?n[i]=(0,m.opFromJSON)(s[i]):"objectId"===i||"id"===i?"string"==typeof s[i]&&(this.id=s[i]):"ACL"!==i||"object"!=typeof s[i]||s[i]instanceof d.default?n[i]=new m.SetOp(s[i]):n[i]=new m.SetOp(new d.default(s[i]))}var l=this.attributes,u={};for(var c in n)n[c]instanceof m.RelationOp?u[c]=n[c].applyTo(l[c],this,c):n[c]instanceof m.UnsetOp||(u[c]=n[c].applyTo(l[c]));if(!r.ignoreValidation){var h=this.validate(u);if(h)return"function"==typeof r.error&&r.error(this,h),!1}var f=this._getPendingOps(),p=f.length-1,_=a.default.getObjectStateController();for(var c in n){var y=n[c].mergeWith(f[p][c]);_.setPendingOp(this._getStateIdentifier(),c,y)}return this}unset(e,t){return t=t||{},t.unset=!0,this.set(e,null,t)}increment(e,t){if(void 0===t&&(t=1),"number"!=typeof t)throw new Error("Cannot increment by a non-numeric amount.");return this.set(e,new m.IncrementOp(t))}add(e,t){return this.set(e,new m.AddOp([t]))}addAll(e,t){return this.set(e,new m.AddOp(t))}addUnique(e,t){return this.set(e,new m.AddUniqueOp([t]))}addAllUnique(e,t){return this.set(e,new m.AddUniqueOp(t))}remove(e,t){return this.set(e,new m.RemoveOp([t]))}removeAll(e,t){return this.set(e,new m.RemoveOp(t))}op(e){for(var t=this._getPendingOps(),r=t.length;r--;)if(t[r][e])return t[r][e]}clone(){let e=new this.constructor;e.className||(e.className=this.className);let t=this.attributes;if("function"==typeof this.constructor.readOnlyAttributes){let e=this.constructor.readOnlyAttributes()||[],r={};for(let s in t)e.indexOf(s)<0&&(r[s]=t[s]);t=r}return e.set&&e.set(t),e}newInstance(){let e=new this.constructor;if(e.className||(e.className=this.className),e.id=this.id,A)return e;let t=a.default.getObjectStateController();return t&&t.duplicateState(this._getStateIdentifier(),e._getStateIdentifier()),e}isNew(){return!this.id}existed(){if(!this.id)return!1;let e=a.default.getObjectStateController().getState(this._getStateIdentifier());return!!e&&e.existed}isValid(){return!this.validate(this.attributes)}validate(e){if(e.hasOwnProperty("ACL")&&!(e.ACL instanceof d.default))return new f.default(f.default.OTHER_CAUSE,"ACL must be a Mmbs ACL.");for(var t in e)if(!/^[A-Za-z][0-9A-Za-z_]*$/.test(t))return new f.default(f.default.INVALID_KEY_NAME);return!1}getACL(){var e=this.get("ACL");return e instanceof d.default?e:null}setACL(e,t){return this.set("ACL",e,t)}revert(){this._clearPendingOps()}clear(){var e=this.attributes,t={},r=["createdAt","updatedAt"];"function"==typeof this.constructor.readOnlyAttributes&&(r=r.concat(this.constructor.readOnlyAttributes()));for(var s in e)r.indexOf(s)<0&&(t[s]=!0);return this.set(t,{unset:!0})}fetch(e){var t={};return(e=e||{}).hasOwnProperty("useMasterKey")&&(t.useMasterKey=e.useMasterKey),e.hasOwnProperty("sessionToken")&&(t.sessionToken=e.sessionToken),a.default.getObjectController().fetch(this,!0,t)._thenRunCallbacks(e)}save(e,t,r){var s,n;if("object"==typeof e||void 0===e?(s=e,"object"==typeof t&&(n=t)):((s={})[e]=t,n=r),!n&&s&&(n={},"function"==typeof s.success&&(n.success=s.success,delete s.success),"function"==typeof s.error&&(n.error=s.error,delete s.error)),s){var o=this.validate(s);if(o)return n&&"function"==typeof n.error&&n.error(this,o),_.default.error(o);this.set(s,n)}var i={};(n=n||{}).hasOwnProperty("useMasterKey")&&(i.useMasterKey=!!n.useMasterKey),n.hasOwnProperty("sessionToken")&&"string"==typeof n.sessionToken&&(i.sessionToken=n.sessionToken);var l=a.default.getObjectController(),u=(0,S.default)(this);return l.save(u,i).then(()=>l.save(this,i))._thenRunCallbacks(n,this)}destroy(e){var t={};return(e=e||{}).hasOwnProperty("useMasterKey")&&(t.useMasterKey=e.useMasterKey),e.hasOwnProperty("sessionToken")&&(t.sessionToken=e.sessionToken),this.id?a.default.getObjectController().destroy(this,t)._thenRunCallbacks(e):_.default.as()._thenRunCallbacks(e)}static _clearAllState(){a.default.getObjectStateController().clearAllState()}static fetchAll(e,t){var r={};return(t=t||{}).hasOwnProperty("useMasterKey")&&(r.useMasterKey=t.useMasterKey),t.hasOwnProperty("sessionToken")&&(r.sessionToken=t.sessionToken),a.default.getObjectController().fetch(e,!0,r)._thenRunCallbacks(t)}static fetchAllIfNeeded(e,t){var r={};return(t=t||{}).hasOwnProperty("useMasterKey")&&(r.useMasterKey=t.useMasterKey),t.hasOwnProperty("sessionToken")&&(r.sessionToken=t.sessionToken),a.default.getObjectController().fetch(e,!1,r)._thenRunCallbacks(t)}static destroyAll(e,t){var r={};return(t=t||{}).hasOwnProperty("useMasterKey")&&(r.useMasterKey=t.useMasterKey),t.hasOwnProperty("sessionToken")&&(r.sessionToken=t.sessionToken),a.default.getObjectController().destroy(e,r)._thenRunCallbacks(t)}static saveAll(e,t){var r={};return(t=t||{}).hasOwnProperty("useMasterKey")&&(r.useMasterKey=t.useMasterKey),t.hasOwnProperty("sessionToken")&&(r.sessionToken=t.sessionToken),a.default.getObjectController().save(e,r)._thenRunCallbacks(t)}static createWithoutData(e){var t=new this;return t.id=e,t}static createPointerData(e){if(!e)return null;if(!e.split)return null;var t=e.split("$");return 2!=t.length?null:N.extend(t[0]).createWithoutData(t[1])}static fromJSON(e,t){if(!e.className)throw new Error("Cannot create an object without a className");var r=w[e.className],s=r?new r:new N(e.className),n={};for(var o in e)"className"!==o&&"__type"!==o&&(n[o]=e[o]);if(t){n.objectId&&(s.id=n.objectId);let e=null;"function"==typeof s._preserveFieldsOnFetch&&(e=s._preserveFieldsOnFetch()),s._clearServerData(),e&&s._finishFetch(e)}return s._finishFetch(n),e.objectId&&s._setExisted(!0),s}static registerSubclass(e,t){if("string"!=typeof e)throw new TypeError("The first argument must be a valid class name.");if(void 0===t)throw new TypeError("You must supply a subclass constructor.");if("function"!=typeof t)throw new TypeError("You must register the subclass constructor. Did you attempt to register an instance of the subclass?");w[e]=t,t.className||(t.className=e)}static extend(e,t,r){if("string"!=typeof e){if(e&&"string"==typeof e.className)return N.extend(e.className,e,t);throw new Error("Mmbs.Object.extend's first argument should be the className.")}var s=e;"User"===s&&a.default.get("PERFORM_USER_REWRITE")&&(s="_User");var n=N.prototype;this.hasOwnProperty("__super__")&&this.__super__?n=this.prototype:w[s]&&(n=w[s].prototype);var o=function(e,t){if(this.className=s,this._objCount=I++,"function"==typeof this.initialize&&this.initialize.apply(this,arguments),e&&"object"==typeof e&&!this.set(e||{},t))throw new Error("Can't create an invalid Mmbs Object")};if(o.className=s,o.__super__=n,o.prototype=Object.create(n,{constructor:{value:o,enumerable:!1,writable:!0,configurable:!0}}),t)for(var i in t)"className"!==i&&Object.defineProperty(o.prototype,i,{value:t[i],enumerable:!1,writable:!0,configurable:!0});if(r)for(var i in r)"className"!==i&&Object.defineProperty(o,i,{value:r[i],enumerable:!1,writable:!0,configurable:!0});return o.extend=function(e,t,r){return"string"==typeof e?N.extend.call(o,e,t,r):N.extend.call(o,s,e,t)},o.createWithoutData=N.createWithoutData,w[s]=o,o}static enableSingleInstance(){A=!0,a.default.setObjectStateController(g)}static disableSingleInstance(){A=!1,a.default.setObjectStateController(E)}}var C={fetch(e,t,r){if(Array.isArray(e)){if(e.length<1)return _.default.as([]);var s=[],n=[],o=null,i=[],l=null;if(e.forEach((e,r)=>{l||(o||(o=e.className),o!==e.className&&(l=new f.default(f.default.INVALID_CLASS_NAME,"All objects should be of the same class")),e.id||(l=new f.default(f.default.MISSING_OBJECT_ID,"All objects must have an ID")),(t||0===Object.keys(e._getServerData()).length)&&(n.push(e.id),s.push(e)),i.push(e))}),l)return _.default.error(l);var u=new y.default(o);return u.containedIn("objectId",n),u._limit=n.length,u.find(r).then(e=>{var r={};e.forEach(e=>{r[e.id]=e});for(var n=0;n<s.length;n++)if((!(o=s[n])||!o.id||!r[o.id])&&t)return _.default.error(new f.default(f.default.OBJECT_NOT_FOUND,"All objects must exist on the server."));if(!A)for(n=0;n<i.length;n++){var o;if((o=i[n])&&o.id&&r[o.id]){var a=o.id;o._finishFetch(r[a].toJSON()),i[n]=r[a]}}return _.default.as(i)})}return a.default.getRESTController().request("GET","classes/"+e.className+"/"+e._getId(),{},r).then((t,r,s)=>(e instanceof N&&(e._clearPendingOps(),e._clearServerData(),e._finishFetch(t)),e))},destroy(e,t){var r=a.default.getRESTController();if(Array.isArray(e)){if(e.length<1)return _.default.as([]);var s=[[]];e.forEach(e=>{e.id&&(s[s.length-1].push(e),s[s.length-1].length>=20&&s.push([]))}),0===s[s.length-1].length&&s.pop();var n=_.default.as(),i=[];return s.forEach(e=>{n=n.then(()=>r.request("POST","batch",{requests:e.map(e=>({method:"DELETE",path:o()+"classes/"+e.className+"/"+e._getId(),body:{}}))},t).then(t=>{for(var r=0;r<t.length;r++)if(t[r]&&t[r].hasOwnProperty("error")){var s=new f.default(t[r].error.code,t[r].error.error);s.object=e[r],i.push(s)}}))}),n.then(()=>{if(i.length){var t=new f.default(f.default.AGGREGATE_ERROR);return t.errors=i,_.default.error(t)}return _.default.as(e)})}return e instanceof N?r.request("DELETE","classes/"+e.className+"/"+e._getId(),{},t).then(()=>_.default.as(e)):_.default.as(e)},save(e,t){var r=a.default.getRESTController(),s=a.default.getObjectStateController();if(Array.isArray(e)){if(e.length<1)return _.default.as([]);for(var n=e.concat(),l=0;l<e.length;l++)e[l]instanceof N&&(n=n.concat((0,S.default)(e[l],!0)));n=(0,v.default)(n);var u=_.default.as(),c=[];return n.forEach(e=>{e instanceof p.default?u=u.then(()=>e.save()):e instanceof N&&c.push(e)}),u.then(()=>{var n=null;return _.default._continueWhile(()=>c.length>0,()=>{var e=[],a=[];if(c.forEach(t=>{e.length<20&&(0,i.default)(t)?e.push(t):a.push(t)}),c=a,e.length<1)return _.default.error(new f.default(f.default.OTHER_CAUSE,"Tried to save a batch with a cycle."));var l=new _.default,u=[],d=[];return e.forEach((e,t)=>{var r=new _.default;u.push(r),s.pushPendingState(e._getStateIdentifier()),d.push(s.enqueueTask(e._getStateIdentifier(),function(){return r.resolve(),l.then((r,s)=>{if(r[t].hasOwnProperty("success"))e._handleSaveResponse(r[t].success,s);else{if(!n&&r[t].hasOwnProperty("error")){var o=r[t].error;n=new f.default(o.code,o.error),c=[]}e._handleSaveError()}})}))}),_.default.when(u).then(()=>r.request("POST","batch",{requests:e.map(e=>{var t=e._getSaveParams();return t.path=o()+t.path,t})},t)).then((e,t,r)=>{l.resolve(e,t)}),_.default.when(d)}).then(()=>n?_.default.error(n):_.default.as(e))})}if(e instanceof N){var d=e,h=function(){var e=d._getSaveParams();return r.request(e.method,e.path,e.body,t).then((e,t)=>{d._handleSaveResponse(e,t)},e=>(d._handleSaveError(),_.default.error(e)))};return s.pushPendingState(e._getStateIdentifier()),s.enqueueTask(e._getStateIdentifier(),h).then(()=>e,e=>_.default.error(e))}return _.default.as()}};a.default.setObjectController(C),t.default=N},function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0});class s{constructor(e,t){this.code=e,this.message=t}toString(){return"MmbsError: "+this.code+" "+this.message}}s.OTHER_CAUSE=-1,s.INTERNAL_SERVER_ERROR=1,s.CONNECTION_FAILED=100,s.OBJECT_NOT_FOUND=101,s.INVALID_QUERY=102,s.INVALID_CLASS_NAME=103,s.MISSING_OBJECT_ID=104,s.INVALID_KEY_NAME=105,s.INVALID_POINTER=106,s.INVALID_JSON=107,s.COMMAND_UNAVAILABLE=108,s.NOT_INITIALIZED=109,s.INCORRECT_TYPE=111,s.INVALID_CHANNEL_NAME=112,s.PUSH_MISCONFIGURED=115,s.OBJECT_TOO_LARGE=116,s.OPERATION_FORBIDDEN=119,s.CACHE_MISS=120,s.INVALID_NESTED_KEY=121,s.INVALID_FILE_NAME=122,s.INVALID_ACL=123,s.TIMEOUT=124,s.INVALID_EMAIL_ADDRESS=125,s.MISSING_CONTENT_TYPE=126,s.MISSING_CONTENT_LENGTH=127,s.INVALID_CONTENT_LENGTH=128,s.FILE_TOO_LARGE=129,s.FILE_SAVE_ERROR=130,s.DUPLICATE_VALUE=137,s.INVALID_ROLE_NAME=139,s.EXCEEDED_QUOTA=140,s.SCRIPT_FAILED=141,s.VALIDATION_ERROR=142,s.INVALID_IMAGE_DATA=143,s.UNSAVED_FILE_ERROR=151,s.INVALID_PUSH_TIME_ERROR=152,s.FILE_DELETE_ERROR=153,s.REQUEST_LIMIT_EXCEEDED=155,s.INVALID_EVENT_NAME=160,s.USERNAME_MISSING=200,s.PASSWORD_MISSING=201,s.USERNAME_TAKEN=202,s.EMAIL_TAKEN=203,s.EMAIL_MISSING=204,s.EMAIL_NOT_FOUND=205,s.SESSION_MISSING=206,s.MUST_CREATE_USER_THROUGH_SIGNUP=207,s.ACCOUNT_ALREADY_LINKED=208,s.INVALID_SESSION_TOKEN=209,s.LINKED_ID_MISSING=250,s.INVALID_LINKED_SESSION=251,s.UNSUPPORTED_SERVICE=252,s.AGGREGATE_ERROR=600,s.FILE_READ_ERROR=601,s.X_DOMAIN_REQUEST=602,t.default=s},function(e,t,r){"use strict";function s(e){return e&&e.__esModule?e:{default:e}}function n(e){if(e<26)return String.fromCharCode(65+e);if(e<52)return String.fromCharCode(e-26+97);if(e<62)return String.fromCharCode(e-52+48);if(62===e)return"+";if(63===e)return"/";throw new TypeError("Tried to encode large digit "+e+" in base64.")}Object.defineProperty(t,"__esModule",{value:!0});var o=s(r(0)),a=(s(r(1)),/^data:([a-zA-Z]*\/[a-zA-Z+.-]*);(charset=[a-zA-Z0-9\-\/\s]*,)?base64,/);class i{constructor(e,t,r){var s=r||"";if(this._name=e,void 0!==t)if(Array.isArray(t))this._source={format:"base64",base64:i.encodeBase64(t),type:s};else if("undefined"!=typeof File&&t instanceof File)this._source={format:"file",file:t,type:s};else{if(!t||"string"!=typeof t.base64)throw new TypeError("Cannot create a Mmbs.File with that data.");{const e=t.base64;var n=e.indexOf(",");if(-1!==n){var o=a.exec(e.slice(0,n+1));this._source={format:"base64",base64:e.slice(n+1),type:o[1]}}else this._source={format:"base64",base64:e,type:s}}}}name(){return this._name}url(e){if(e=e||{},this._url)return e.forceSecure?this._url.replace(/^http:\/\//i,"https://"):this._url}save(e){e=e||{};var t=o.default.getFileController();if(this._previousSave||("file"===this._source.format?this._previousSave=t.saveFile(this._name,this._source,e).then(e=>(this._name=e.name,this._url=e.url,this)):this._previousSave=t.saveBase64(this._name,this._source,e).then(e=>(this._name=e.name,this._url=e.url,this))),this._previousSave)return this._previousSave._thenRunCallbacks(e)}toJSON(){return{__type:"File",name:this._name,url:this._url}}equals(e){return this===e||e instanceof i&&this.name()===e.name()&&this.url()===e.url()&&void 0!==this.url()}static fromJSON(e){if("File"!==e.__type)throw new TypeError("JSON object does not represent a MmbsFile");var t=new i(e.name);return t._url=e.url,t}static encodeBase64(e){var t=[];t.length=Math.ceil(e.length/3);for(var r=0;r<t.length;r++){var s=e[3*r],o=e[3*r+1]||0,a=e[3*r+2]||0,i=3*r+1<e.length,l=3*r+2<e.length;t[r]=[n(s>>2&63),n(s<<4&48|o>>4&15),i?n(o<<2&60|a>>6&3):"=",l?n(63&a):"="].join("")}return t.join("")}}var l={saveFile:function(e,t){if("file"!==t.format)throw new Error("saveFile can only be used with File-type sources.");var r={"X-Mmbs-Application-ID":o.default.get("APPLICATION_ID"),"X-Mmbs-JavaScript-Key":o.default.get("JAVASCRIPT_KEY"),"Content-Type":t.type||(t.file?t.file.type:null)},s=o.default.get("SERVER_URL");return"/"!==s[s.length-1]&&(s+="/"),s+="files/"+e,o.default.getRESTController().ajax("POST",s,t.file,r)},saveBase64:function(e,t,r){if("base64"!==t.format)throw new Error("saveBase64 can only be used with Base64-type sources.");var s={base64:t.base64};t.type&&(s._ContentType=t.type);var n="files/"+e;return o.default.getRESTController().request("POST",n,s,r)}};o.default.setFileController(l),t.default=i},function(e,t,r){"use strict";function s(e){return e&&e.__esModule?e:{default:e}}Object.defineProperty(t,"__esModule",{value:!0});var n=r(9),o=(s(r(2)),s(r(13)));t.default=class{constructor(e,t){this.parent=e,this.key=t,this.targetClassName=null}_ensureParentAndKey(e,t){if(this.key=this.key||t,this.key!==t)throw new Error("Internal Error. Relation retrieved from two different keys.");if(this.parent){if(this.parent.className!==e.className)throw new Error("Internal Error. Relation retrieved from two different Objects.");if(this.parent.id){if(this.parent.id!==e.id)throw new Error("Internal Error. Relation retrieved from two different Objects.")}else e.id&&(this.parent=e)}else this.parent=e}add(e){Array.isArray(e)||(e=[e]);var t=new n.RelationOp(e,[]),r=this.parent;if(!r)throw new Error("Cannot add to a Relation without a parent");return r.set(this.key,t),this.targetClassName=t._targetClassName,r}remove(e){Array.isArray(e)||(e=[e]);var t=new n.RelationOp([],e);if(!this.parent)throw new Error("Cannot remove from a Relation without a parent");this.parent.set(this.key,t),this.targetClassName=t._targetClassName}toJSON(){return{__type:"Relation",className:this.targetClassName}}query(){var e,t=this.parent;if(!t)throw new Error("Cannot construct a query for a Relation without a parent");return this.targetClassName?e=new o.default(this.targetClassName):(e=new o.default(t.className))._extraOptions.redirectClassNameForKey=this.key,e._addCondition("$relatedTo","object",{__type:"Pointer",className:t.className,objectId:t.id}),e._addCondition("$relatedTo","key",this.key),e}}},function(e,t,r){"use strict";function s(e){return e&&e.__esModule?e:{default:e}}function n(e,t,r,s){if(e instanceof u.default){if(t)throw new Error("Mmbs Objects not allowed here");var f=e.id?e.className+":"+e.id:e;return r||!s||s.indexOf(f)>-1||e.dirty()||Object.keys(e._getServerData()).length<1?e.toPointer():(s=s.concat(f),e._toFullJSON(s))}if(e instanceof c.Op||e instanceof o.default||e instanceof i.default||e instanceof l.default||e instanceof d.default)return e.toJSON();if(e instanceof a.default){if(!e.url())throw new Error("Tried to encode an unsaved file.");return e.toJSON()}if("[object Date]"===h.call(e)){if(isNaN(e))throw new Error("Tried to encode an invalid date.");return{__type:"Date",iso:e.toJSON()}}if("[object RegExp]"===h.call(e)&&"string"==typeof e.source)return e.source;if(Array.isArray(e))return e.map(e=>n(e,t,r,s));if(e&&"object"==typeof e){var p={};for(var m in e)p[m]=n(e[m],t,r,s);return p}return e}Object.defineProperty(t,"__esModule",{value:!0}),t.default=function(e,t,r,s){return n(e,!!t,!!r,s||[])};var o=s(r(8)),a=s(r(4)),i=s(r(10)),l=s(r(12)),u=s(r(2)),c=r(9),d=s(r(5)),h=Object.prototype.toString},function(e,t,r){"use strict";function s(e){return e&&e.__esModule?e:{default:e}}function n(e){if(null===e||"object"!=typeof e)return e;if(Array.isArray(e)){var t=[];return e.forEach((e,r)=>{t[r]=n(e)}),t}if("string"==typeof e.__op)return(0,u.opFromJSON)(e);if("Pointer"===e.__type&&e.className)return l.default.fromJSON(e);if("Object"===e.__type&&e.className)return l.default.fromJSON(e);if("Relation"===e.__type){var r=new c.default(null,null);return r.targetClassName=e.className,r}if("Date"===e.__type)return new Date(e.iso);if("File"===e.__type)return o.default.fromJSON(e);if("GeoPoint"===e.__type)return new a.default({latitude:e.latitude,longitude:e.longitude});if("Polygon"===e.__type)return new i.default(e.coordinates);var s={};for(var d in e)s[d]=n(e[d]);return s}Object.defineProperty(t,"__esModule",{value:!0}),t.default=n,s(r(8));var o=s(r(4)),a=s(r(10)),i=s(r(12)),l=s(r(2)),u=r(9),c=s(r(5))},function(e,t,r){"use strict";function s(e){return e&&e.__esModule?e:{default:e}}Object.defineProperty(t,"__esModule",{value:!0});var n=s(r(17)),o=s(r(15)),a="*";class i{constructor(e){if(this.permissionsById={},e&&"object"==typeof e)if(e instanceof o.default)this.setReadAccess(e,!0),this.setWriteAccess(e,!0);else for(var t in e){var r=e[t];if("string"!=typeof t)throw new TypeError("Tried to create an ACL with an invalid user id.");this.permissionsById[t]={};for(var s in r){var n=r[s];if("read"!==s&&"write"!==s)throw new TypeError("Tried to create an ACL with an invalid permission type.");if("boolean"!=typeof n)throw new TypeError("Tried to create an ACL with an invalid permission value.");this.permissionsById[t][s]=n}}else if("function"==typeof e)throw new TypeError("MmbsACL constructed with a function. Did you forget ()?")}toJSON(){var e={};for(var t in this.permissionsById)e[t]=this.permissionsById[t];return e}equals(e){if(!(e instanceof i))return!1;var t=Object.keys(this.permissionsById),r=Object.keys(e.permissionsById);if(t.length!==r.length)return!1;for(var s in this.permissionsById){if(!e.permissionsById[s])return!1;if(this.permissionsById[s].read!==e.permissionsById[s].read)return!1;if(this.permissionsById[s].write!==e.permissionsById[s].write)return!1}return!0}_setAccess(e,t,r){if(t instanceof o.default)t=t.id;else if(t instanceof n.default){const e=t.getName();if(!e)throw new TypeError("Role must have a name");t="role:"+e}if("string"!=typeof t)throw new TypeError("userId must be a string.");if("boolean"!=typeof r)throw new TypeError("allowed must be either true or false.");var s=this.permissionsById[t];if(!s){if(!r)return;s={},this.permissionsById[t]=s}r?this.permissionsById[t][e]=!0:(delete s[e],0===Object.keys(s).length&&delete this.permissionsById[t])}_getAccess(e,t){if(t instanceof o.default){if(!(t=t.id))throw new Error("Cannot get access for a MmbsUser without an ID")}else if(t instanceof n.default){const e=t.getName();if(!e)throw new TypeError("Role must have a name");t="role:"+e}var r=this.permissionsById[t];return!!r&&!!r[e]}setReadAccess(e,t){this._setAccess("read",e,t)}getReadAccess(e){return this._getAccess("read",e)}setWriteAccess(e,t){this._setAccess("write",e,t)}getWriteAccess(e){return this._getAccess("write",e)}setPublicReadAccess(e){this.setReadAccess(a,e)}getPublicReadAccess(){return this.getReadAccess(a)}setPublicWriteAccess(e){this.setWriteAccess(a,e)}getPublicWriteAccess(){return this.getWriteAccess(a)}getRoleReadAccess(e){if(e instanceof n.default&&(e=e.getName()),"string"!=typeof e)throw new TypeError("role must be a MmbsRole or a String");return this.getReadAccess("role:"+e)}getRoleWriteAccess(e){if(e instanceof n.default&&(e=e.getName()),"string"!=typeof e)throw new TypeError("role must be a MmbsRole or a String");return this.getWriteAccess("role:"+e)}setRoleReadAccess(e,t){if(e instanceof n.default&&(e=e.getName()),"string"!=typeof e)throw new TypeError("role must be a MmbsRole or a String");this.setReadAccess("role:"+e,t)}setRoleWriteAccess(e,t){if(e instanceof n.default&&(e=e.getName()),"string"!=typeof e)throw new TypeError("role must be a MmbsRole or a String");this.setWriteAccess("role:"+e,t)}}t.default=i},function(e,t,r){"use strict";function s(e){return e&&e.__esModule?e:{default:e}}Object.defineProperty(t,"__esModule",{value:!0}),t.RelationOp=t.RemoveOp=t.AddUniqueOp=t.AddOp=t.IncrementOp=t.UnsetOp=t.SetOp=t.Op=void 0,t.opFromJSON=function(e){if(!e||!e.__op)return null;switch(e.__op){case"Delete":return new h;case"Increment":return new f(e.amount);case"Add":return new p((0,o.default)(e.objects));case"AddUnique":return new m((0,o.default)(e.objects));case"Remove":return new _((0,o.default)(e.objects));case"AddRelation":var t=(0,o.default)(e.objects);return Array.isArray(t)?new y(t,[]):new y([],[]);case"RemoveRelation":var r=(0,o.default)(e.objects);return Array.isArray(r)?new y([],r):new y([],[]);case"Batch":t=[],r=[];for(var s=0;s<e.ops.length;s++)"AddRelation"===e.ops[s].__op?t=t.concat((0,o.default)(e.ops[s].objects)):"RemoveRelation"===e.ops[s].__op&&(r=r.concat((0,o.default)(e.ops[s].objects)));return new y(t,r)}return null};var n=s(r(18)),o=s(r(7)),a=s(r(6)),i=s(r(2)),l=s(r(5)),u=s(r(19));class c{applyTo(e){}mergeWith(e){}toJSON(){}}t.Op=c;class d extends c{constructor(e){super(),this._value=e}applyTo(e){return this._value}mergeWith(e){return new d(this._value)}toJSON(){return(0,a.default)(this._value,!1,!0)}}t.SetOp=d;class h extends c{applyTo(e){}mergeWith(e){return new h}toJSON(){return{__op:"Delete"}}}t.UnsetOp=h;class f extends c{constructor(e){if(super(),"number"!=typeof e)throw new TypeError("Increment Op must be initialized with a numeric amount.");this._amount=e}applyTo(e){if(void 0===e)return this._amount;if("number"!=typeof e)throw new TypeError("Cannot increment a non-numeric value.");return this._amount+e}mergeWith(e){if(!e)return this;if(e instanceof d)return new d(this.applyTo(e._value));if(e instanceof h)return new d(this._amount);if(e instanceof f)return new f(this.applyTo(e._amount));throw new Error("Cannot merge Increment Op with the previous Op")}toJSON(){return{__op:"Increment",amount:this._amount}}}t.IncrementOp=f;class p extends c{constructor(e){super(),this._value=Array.isArray(e)?e:[e]}applyTo(e){if(null==e)return this._value;if(Array.isArray(e))return e.concat(this._value);throw new Error("Cannot add elements to a non-array value")}mergeWith(e){if(!e)return this;if(e instanceof d)return new d(this.applyTo(e._value));if(e instanceof h)return new d(this._value);if(e instanceof p)return new p(this.applyTo(e._value));throw new Error("Cannot merge Add Op with the previous Op")}toJSON(){return{__op:"Add",objects:(0,a.default)(this._value,!1,!0)}}}t.AddOp=p;class m extends c{constructor(e){super(),this._value=(0,u.default)(Array.isArray(e)?e:[e])}applyTo(e){if(null==e)return this._value||[];if(Array.isArray(e)){var t=e,r=[];return this._value.forEach(e=>{e instanceof i.default?(0,n.default)(t,e)||r.push(e):t.indexOf(e)<0&&r.push(e)}),e.concat(r)}throw new Error("Cannot add elements to a non-array value")}mergeWith(e){if(!e)return this;if(e instanceof d)return new d(this.applyTo(e._value));if(e instanceof h)return new d(this._value);if(e instanceof m)return new m(this.applyTo(e._value));throw new Error("Cannot merge AddUnique Op with the previous Op")}toJSON(){return{__op:"AddUnique",objects:(0,a.default)(this._value,!1,!0)}}}t.AddUniqueOp=m;class _ extends c{constructor(e){super(),this._value=(0,u.default)(Array.isArray(e)?e:[e])}applyTo(e){if(null==e)return[];if(Array.isArray(e)){var t=e.indexOf(this._value),r=e.concat([]);for(t=0;t<this._value.length;t++){for(var s=r.indexOf(this._value[t]);s>-1;)r.splice(s,1),s=r.indexOf(this._value[t]);if(this._value[t]instanceof i.default&&this._value[t].id)for(var n=0;n<r.length;n++)r[n]instanceof i.default&&this._value[t].id===r[n].id&&(r.splice(n,1),n--)}return r}throw new Error("Cannot remove elements from a non-array value")}mergeWith(e){if(!e)return this;if(e instanceof d)return new d(this.applyTo(e._value));if(e instanceof h)return new h;if(e instanceof _){for(var t=e._value.concat([]),r=0;r<this._value.length;r++)this._value[r]instanceof i.default?(0,n.default)(t,this._value[r])||t.push(this._value[r]):t.indexOf(this._value[r])<0&&t.push(this._value[r]);return new _(t)}throw new Error("Cannot merge Remove Op with the previous Op")}toJSON(){return{__op:"Remove",objects:(0,a.default)(this._value,!1,!0)}}}t.RemoveOp=_;class y extends c{constructor(e,t){super(),this._targetClassName=null,Array.isArray(e)&&(this.relationsToAdd=(0,u.default)(e.map(this._extractId,this))),Array.isArray(t)&&(this.relationsToRemove=(0,u.default)(t.map(this._extractId,this)))}_extractId(e){if("string"==typeof e)return e;if(!e.id)throw new Error("You cannot add or remove an unsaved Mmbs Object from a relation");if(this._targetClassName||(this._targetClassName=e.className),this._targetClassName!==e.className)throw new Error("Tried to create a Relation with 2 different object types: "+this._targetClassName+" and "+e.className+".");return e.id}applyTo(e,t,r){if(!e){if(!t||!r)throw new Error("Cannot apply a RelationOp without either a previous value, or an object and a key");var s=new i.default(t.className);t.id&&0===t.id.indexOf("local")?s._localId=t.id:t.id&&(s.id=t.id);var n=new l.default(s,r);return n.targetClassName=this._targetClassName,n}if(e instanceof l.default){if(this._targetClassName)if(e.targetClassName){if(this._targetClassName!==e.targetClassName)throw new Error("Related object must be a "+e.targetClassName+", but a "+this._targetClassName+" was passed in.")}else e.targetClassName=this._targetClassName;return e}throw new Error("Relation cannot be applied to a non-relation field")}mergeWith(e){if(!e)return this;if(e instanceof h)throw new Error("You cannot modify a relation after deleting it.");if(e instanceof y){if(e._targetClassName&&e._targetClassName!==this._targetClassName)throw new Error("Related object must be of class "+e._targetClassName+", but "+(this._targetClassName||"null")+" was passed in.");var t=e.relationsToAdd.concat([]);this.relationsToRemove.forEach(e=>{var r=t.indexOf(e);r>-1&&t.splice(r,1)}),this.relationsToAdd.forEach(e=>{t.indexOf(e)<0&&t.push(e)});var r=e.relationsToRemove.concat([]);this.relationsToAdd.forEach(e=>{var t=r.indexOf(e);t>-1&&r.splice(t,1)}),this.relationsToRemove.forEach(e=>{r.indexOf(e)<0&&r.push(e)});var s=new y(t,r);return s._targetClassName=this._targetClassName,s}throw new Error("Cannot merge Relation Op with the previous Op")}toJSON(){var e=e=>({__type:"Pointer",className:this._targetClassName,objectId:e}),t=null,r=null;return this.relationsToAdd.length>0&&(t={__op:"AddRelation",objects:this.relationsToAdd.map(e)}),this.relationsToRemove.length>0&&(r={__op:"RemoveRelation",objects:this.relationsToRemove.map(e)}),t&&r?{__op:"Batch",ops:[t,r]}:t||r||{}}}t.RelationOp=y},function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var s=function(e){return e&&e.__esModule?e:{default:e}}(r(1));class n{constructor(e,t){Array.isArray(e)?(n._validate(e[0],e[1]),this._latitude=e[0],this._longitude=e[1]):"object"==typeof e?(n._validate(e.latitude,e.longitude),this._latitude=e.latitude,this._longitude=e.longitude):"number"==typeof e&&"number"==typeof t?(n._validate(e,t),this._latitude=e,this._longitude=t):(this._latitude=0,this._longitude=0)}get latitude(){return this._latitude}set latitude(e){n._validate(e,this.longitude),this._latitude=e}get longitude(){return this._longitude}set longitude(e){n._validate(this.latitude,e),this._longitude=e}toJSON(){return n._validate(this._latitude,this._longitude),{__type:"GeoPoint",latitude:this._latitude,longitude:this._longitude}}equals(e){return e instanceof n&&this.latitude===e.latitude&&this.longitude===e.longitude}radiansTo(e){var t=Math.PI/180,r=this.latitude*t,s=this.longitude*t,n=e.latitude*t,o=r-n,a=s-e.longitude*t,i=Math.sin(o/2),l=Math.sin(a/2),u=i*i+Math.cos(r)*Math.cos(n)*l*l;return u=Math.min(1,u),2*Math.asin(Math.sqrt(u))}kilometersTo(e){return 6371*this.radiansTo(e)}milesTo(e){return 3958.8*this.radiansTo(e)}static _validate(e,t){if(e!=e||t!=t)throw new TypeError("GeoPoint latitude and longitude must be valid numbers");if(e<-90)throw new TypeError("GeoPoint latitude out of bounds: "+e+" < -90.0.");if(e>90)throw new TypeError("GeoPoint latitude out of bounds: "+e+" > 90.0.");if(t<-180)throw new TypeError("GeoPoint longitude out of bounds: "+t+" < -180.0.");if(t>180)throw new TypeError("GeoPoint longitude out of bounds: "+t+" > 180.0.")}static current(e){var t=new s.default;return navigator.geolocation.getCurrentPosition(function(e){t.resolve(new n(e.coords.latitude,e.coords.longitude))},function(e){t.reject(e)}),t._thenRunCallbacks(e)}}t.default=n},function(e,t,r){"use strict";function s(e){return e&&e.__esModule?e:{default:e}}var n=s(r(0)),o=s(r(1)),a={async:()=>!!n.default.getStorageController().async,getItem(e){var t=n.default.getStorageController();if(1===t.async)throw new Error("Synchronous storage is not supported by the current storage controller");return t.getItem(e)},getItemAsync(e){var t=n.default.getStorageController();return 1===t.async?t.getItemAsync(e):o.default.as(t.getItem(e))},setItem(e,t){var r=n.default.getStorageController();if(1===r.async)throw new Error("Synchronous storage is not supported by the current storage controller");return r.setItem(e,t)},setItemAsync(e,t){var r=n.default.getStorageController();return 1===r.async?r.setItemAsync(e,t):o.default.as(r.setItem(e,t))},removeItem(e){var t=n.default.getStorageController();if(1===t.async)throw new Error("Synchronous storage is not supported by the current storage controller");return t.removeItem(e)},removeItemAsync(e){var t=n.default.getStorageController();return 1===t.async?t.removeItemAsync(e):o.default.as(t.removeItem(e))},generatePath(e){if(!n.default.get("APPLICATION_ID"))throw new Error("You need to call Mmbs.initialize before using Mmbs.");if("string"!=typeof e)throw new Error("Tried to get a Storage path that was not a String.");return"/"===e[0]&&(e=e.substr(1)),"Mmbs/"+n.default.get("APPLICATION_ID")+"/"+e},_clear(){var e=n.default.getStorageController();e.hasOwnProperty("clear")&&e.clear()}};e.exports=a,n.default.setStorageController(r(35))},function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var s=function(e){return e&&e.__esModule?e:{default:e}}(r(10));class n{constructor(e){this._coordinates=n._validate(e)}get coordinates(){return this._coordinates}set coordinates(e){this._coordinates=n._validate(e)}toJSON(){return n._validate(this._coordinates),{__type:"Polygon",coordinates:this._coordinates}}equals(e){if(!(e instanceof n)||this.coordinates.length!==e.coordinates.length)return!1;let t=!0;for(let r=1;r<this._coordinates.length;r+=1)if(this._coordinates[r][0]!=e.coordinates[r][0]||this._coordinates[r][1]!=e.coordinates[r][1]){t=!1;break}return t}containsPoint(e){let t=this._coordinates[0][0],r=this._coordinates[0][0],s=this._coordinates[0][1],n=this._coordinates[0][1];for(let e=1;e<this._coordinates.length;e+=1){const o=this._coordinates[e];t=Math.min(o[0],t),r=Math.max(o[0],r),s=Math.min(o[1],s),n=Math.max(o[1],n)}if(e.latitude<t||e.latitude>r||e.longitude<s||e.longitude>n)return!1;let o=!1;for(let t=0,r=this._coordinates.length-1;t<this._coordinates.length;r=t++){let s=this._coordinates[t][0],n=this._coordinates[t][1],a=this._coordinates[r][0],i=this._coordinates[r][1];n>e.longitude!=i>e.longitude&&e.latitude<(a-s)*(e.longitude-n)/(i-n)+s&&(o=!o)}return o}static _validate(e){if(!Array.isArray(e))throw new TypeError("Coordinates must be an Array");if(e.length<3)throw new TypeError("Polygon must have at least 3 GeoPoints or Points");const t=[];for(let r=0;r<e.length;r+=1){const n=e[r];let o;if(n instanceof s.default)o=n;else{if(!Array.isArray(n)||2!==n.length)throw new TypeError("Coordinates must be an Array of GeoPoints or Points");o=new s.default(n[0],n[1])}t.push([o.latitude,o.longitude])}return t}}t.default=n},function(e,t,r){"use strict";function s(e){return e&&e.__esModule?e:{default:e}}function n(e){return"\\Q"+e.replace("\\E","\\E\\\\E\\Q")+"\\E"}function o(e,t){var r={};if(t.forEach(t=>{let s=-1!==t.indexOf(".");if(s||e.hasOwnProperty(t)){if(s){let s=t.split(".");var n=e,o=r;s.forEach((e,t,r)=>{n&&!n.hasOwnProperty(e)&&(n[e]=void 0),void 0!==n&&(n=n[e]),t<r.length-1&&(o[e]||(o[e]={}),o=o[e])})}}else e[t]=void 0}),Object.keys(r).length>0){function s(e,t,r,n){if(n)for(var o in e)e.hasOwnProperty(o)&&!t.hasOwnProperty(o)&&(t[o]=e[o]);for(var o in r)void 0!==t[o]&&null!==t[o]&&void 0!==e&&null!==e&&s(e[o],t[o],r[o],!0)}s(a.default.getObjectStateController().getServerData({id:e.objectId,className:e.className}),e,r,!1)}}Object.defineProperty(t,"__esModule",{value:!0});var a=s(r(0)),i=s(r(6)),l=s(r(3)),u=s(r(10)),c=(s(r(12)),s(r(2))),d=s(r(1));class h{constructor(e){if("string"==typeof e)"User"===e&&a.default.get("PERFORM_USER_REWRITE")?this.className="_User":this.className=e;else if(e instanceof c.default)this.className=e.className;else{if("function"!=typeof e)throw new TypeError("A MmbsQuery must be constructed with a MmbsObject or class name.");if("string"==typeof e.className)this.className=e.className;else{var t=new e;this.className=t.className}}this._where={},this._include=[],this._limit=-1,this._skip=0,this._extraOptions={}}_orQuery(e){var t=e.map(e=>e.toJSON().where);return this._where.$or=t,this}_addCondition(e,t,r){return this._where[e]&&"string"!=typeof this._where[e]||(this._where[e]={}),this._where[e][t]=(0,i.default)(r,!1,!0),this}toJSON(){var e={where:this._where};this._include.length&&(e.include=this._include.join(",")),this._select&&(e.keys=this._select.join(",")),this._limit>=0&&(e.limit=this._limit),this._skip>0&&(e.skip=this._skip),this._order&&(e.order=this._order.join(","));for(var t in this._extraOptions)e[t]=this._extraOptions[t];return e}withJSON(e){e.where&&(this._where=e.where),e.include&&(this._include=e.include.split(",")),e.keys&&(this._select=e.keys.split(",")),e.limit&&(this._limit=e.limit),e.skip&&(this._skip=e.skip),e.order&&(this._order=e.order.split(","));for(let t in e)e.hasOwnProperty(t)&&-1===["where","include","keys","limit","skip","order"].indexOf(t)&&(this._extraOptions[t]=e[t]);return this}static fromJSON(e,t){return new h(e).withJSON(t)}get(e,t){this.equalTo("objectId",e);var r={};return t&&t.hasOwnProperty("useMasterKey")&&(r.useMasterKey=t.useMasterKey),t&&t.hasOwnProperty("sessionToken")&&(r.sessionToken=t.sessionToken),this.first(r).then(e=>{if(e)return e;var t=new l.default(l.default.OBJECT_NOT_FOUND,"Object not found.");return d.default.error(t)})._thenRunCallbacks(t,null)}find(e){let t={};(e=e||{}).hasOwnProperty("useMasterKey")&&(t.useMasterKey=e.useMasterKey),e.hasOwnProperty("sessionToken")&&(t.sessionToken=e.sessionToken);let r=a.default.getQueryController(),s=this._select;return r.find(this.className,this.toJSON(),t).then(e=>e.results.map(t=>{let r=e.className||this.className;return t.className||(t.className=r),s&&o(t,s),c.default.fromJSON(t,!s)}))._thenRunCallbacks(e)}count(e){var t={};(e=e||{}).hasOwnProperty("useMasterKey")&&(t.useMasterKey=e.useMasterKey),e.hasOwnProperty("sessionToken")&&(t.sessionToken=e.sessionToken);var r=a.default.getQueryController(),s=this.toJSON();return s.limit=0,s.count=1,r.find(this.className,s,t).then(e=>e.count)._thenRunCallbacks(e)}distinct(e,t){const r={};(t=t||{}).hasOwnProperty("sessionToken")&&(r.sessionToken=t.sessionToken);const s=a.default.getQueryController(),n={distinct:e,where:this._where};return s.aggregate(this.className,n,r).then(e=>e.results)._thenRunCallbacks(t)}aggregate(e,t){const r={};(t=t||{}).hasOwnProperty("sessionToken")&&(r.sessionToken=t.sessionToken);const s=a.default.getQueryController();let n={};if(Array.isArray(e))e.forEach(e=>{for(let t in e)n[t]=e[t]});else{if(!e||"object"!=typeof e)throw new Error("Invalid pipeline must be Array or Object");n=e}return s.aggregate(this.className,n,r).then(e=>e.results)._thenRunCallbacks(t)}first(e){var t={};(e=e||{}).hasOwnProperty("useMasterKey")&&(t.useMasterKey=e.useMasterKey),e.hasOwnProperty("sessionToken")&&(t.sessionToken=e.sessionToken);var r=a.default.getQueryController(),s=this.toJSON();s.limit=1;var n=this._select;return r.find(this.className,s,t).then(e=>{var t=e.results;if(t[0])return t[0].className||(t[0].className=this.className),n&&o(t[0],n),c.default.fromJSON(t[0],!n)})._thenRunCallbacks(e)}each(e,t){if(t=t||{},this._order||this._skip||this._limit>=0)return d.default.error("Cannot iterate on a query with sort, skip, or limit.")._thenRunCallbacks(t);new d.default;var r=new h(this.className);r._limit=t.batchSize||100,r._include=this._include.map(e=>e),this._select&&(r._select=this._select.map(e=>e)),r._where={};for(var s in this._where){var n=this._where[s];if(Array.isArray(n))r._where[s]=n.map(e=>e);else if(n&&"object"==typeof n){var o={};r._where[s]=o;for(var a in n)o[a]=n[a]}else r._where[s]=n}r.ascending("objectId");var i={};t.hasOwnProperty("useMasterKey")&&(i.useMasterKey=t.useMasterKey),t.hasOwnProperty("sessionToken")&&(i.sessionToken=t.sessionToken);var l=!1;return d.default._continueWhile(()=>!l,()=>r.find(i).then(t=>{var s=d.default.as();return t.forEach(t=>{s=s.then(()=>e(t))}),s.then(()=>{t.length>=r._limit?r.greaterThan("objectId",t[t.length-1].id):l=!0})}))._thenRunCallbacks(t)}equalTo(e,t){return void 0===t?this.doesNotExist(e):(this._where[e]=(0,i.default)(t,!1,!0),this)}notEqualTo(e,t){return this._addCondition(e,"$ne",t)}lessThan(e,t){return this._addCondition(e,"$lt",t)}greaterThan(e,t){return this._addCondition(e,"$gt",t)}lessThanOrEqualTo(e,t){return this._addCondition(e,"$lte",t)}greaterThanOrEqualTo(e,t){return this._addCondition(e,"$gte",t)}containedIn(e,t){return this._addCondition(e,"$in",t)}notContainedIn(e,t){return this._addCondition(e,"$nin",t)}containsAll(e,t){return this._addCondition(e,"$all",t)}exists(e){return this._addCondition(e,"$exists",!0)}doesNotExist(e){return this._addCondition(e,"$exists",!1)}matches(e,t,r){return this._addCondition(e,"$regex",t),r||(r=""),t.ignoreCase&&(r+="i"),t.multiline&&(r+="m"),r.length&&this._addCondition(e,"$options",r),this}matchesQuery(e,t){var r=t.toJSON();return r.className=t.className,this._addCondition(e,"$inQuery",r)}doesNotMatchQuery(e,t){var r=t.toJSON();return r.className=t.className,this._addCondition(e,"$notInQuery",r)}matchesKeyInQuery(e,t,r){var s=r.toJSON();return s.className=r.className,this._addCondition(e,"$select",{key:t,query:s})}doesNotMatchKeyInQuery(e,t,r){var s=r.toJSON();return s.className=r.className,this._addCondition(e,"$dontSelect",{key:t,query:s})}contains(e,t){if("string"!=typeof t)throw new Error("The value being searched for must be a string.");return this._addCondition(e,"$regex",n(t))}startsWith(e,t){if("string"!=typeof t)throw new Error("The value being searched for must be a string.");return this._addCondition(e,"$regex","^"+n(t))}endsWith(e,t){if("string"!=typeof t)throw new Error("The value being searched for must be a string.");return this._addCondition(e,"$regex",n(t)+"$")}near(e,t){return t instanceof u.default||(t=new u.default(t)),this._addCondition(e,"$nearSphere",t)}withinRadians(e,t,r){return this.near(e,t),this._addCondition(e,"$maxDistance",r)}withinMiles(e,t,r){return this.withinRadians(e,t,r/3958.8)}withinKilometers(e,t,r){return this.withinRadians(e,t,r/6371)}withinGeoBox(e,t,r){return t instanceof u.default||(t=new u.default(t)),r instanceof u.default||(r=new u.default(r)),this._addCondition(e,"$within",{$box:[t,r]}),this}withinPolygon(e,t){return this._addCondition(e,"$geoWithin",{$polygon:t})}polygonContains(e,t){return this._addCondition(e,"$geoIntersects",{$point:t})}ascending(...e){return this._order=[],this.addAscending.apply(this,e)}addAscending(...e){return this._order||(this._order=[]),e.forEach(e=>{Array.isArray(e)&&(e=e.join()),this._order=this._order.concat(e.replace(/\s/g,"").split(","))}),this}descending(...e){return this._order=[],this.addDescending.apply(this,e)}addDescending(...e){return this._order||(this._order=[]),e.forEach(e=>{Array.isArray(e)&&(e=e.join()),this._order=this._order.concat(e.replace(/\s/g,"").split(",").map(e=>"-"+e))}),this}skip(e){if("number"!=typeof e||e<0)throw new Error("You can only skip by a positive number");return this._skip=e,this}limit(e){if("number"!=typeof e)throw new Error("You can only set the limit to a numeric value");return this._limit=e,this}include(...e){return e.forEach(e=>{Array.isArray(e)?this._include=this._include.concat(e):this._include.push(e)}),this}select(...e){return this._select||(this._select=[]),e.forEach(e=>{Array.isArray(e)?this._select=this._select.concat(e):this._select.push(e)}),this}subscribe(){return a.default.getLiveQueryController().subscribe(this)}static or(...e){var t=null;e.forEach(e=>{if(t||(t=e.className),t!==e.className)throw new Error("All queries must be for the same class.")});var r=new h(t);return r._orQuery(e),r}}var f={find:(e,t,r)=>a.default.getRESTController().request("GET","classes/"+e,t,r),aggregate:(e,t,r)=>a.default.getRESTController().request("GET","aggregate/"+e,t,r)};a.default.setQueryController(f),t.default=h},function(e,t,r){"use strict";function s(){throw new Error("setTimeout has not been defined")}function n(){throw new Error("clearTimeout has not been defined")}function o(e){if(c===setTimeout)return setTimeout(e,0);if((c===s||!c)&&setTimeout)return c=setTimeout,setTimeout(e,0);try{return c(e,0)}catch(t){try{return c.call(null,e,0)}catch(t){return c.call(this,e,0)}}}function a(){m&&f&&(m=!1,f.length?p=f.concat(p):_=-1,p.length&&i())}function i(){if(!m){var e=o(a);m=!0;for(var t=p.length;t;){for(f=p,p=[];++_<t;)f&&f[_].run();_=-1,t=p.length}f=null,m=!1,function(e){if(d===clearTimeout)return clearTimeout(e);if((d===n||!d)&&clearTimeout)return d=clearTimeout,clearTimeout(e);try{d(e)}catch(t){try{return d.call(null,e)}catch(t){return d.call(this,e)}}}(e)}}function l(e,t){this.fun=e,this.array=t}function u(){}var c,d,h=e.exports={};!function(){try{c="function"==typeof setTimeout?setTimeout:s}catch(e){c=s}try{d="function"==typeof clearTimeout?clearTimeout:n}catch(e){d=n}}();var f,p=[],m=!1,_=-1;h.nextTick=function(e){var t=new Array(arguments.length-1);if(arguments.length>1)for(var r=1;r<arguments.length;r++)t[r-1]=arguments[r];p.push(new l(e,t)),1!==p.length||m||o(i)},l.prototype.run=function(){this.fun.apply(null,this.array)},h.title="browser",h.browser=!0,h.env={},h.argv=[],h.version="",h.versions={},h.on=u,h.addListener=u,h.once=u,h.off=u,h.removeListener=u,h.removeAllListeners=u,h.emit=u,h.prependListener=u,h.prependOnceListener=u,h.listeners=function(e){return[]},h.binding=function(e){throw new Error("process.binding is not supported")},h.cwd=function(){return"/"},h.chdir=function(e){throw new Error("process.chdir is not supported")},h.umask=function(){return 0}},function(e,t,r){"use strict";function s(e){return e&&e.__esModule?e:{default:e}}Object.defineProperty(t,"__esModule",{value:!0});var n=s(r(0)),o=s(r(23)),a=s(r(3)),i=s(r(2)),l=s(r(1)),u=s(r(24)),c=s(r(11)),d="currentUser",h=!n.default.get("IS_NODE"),f=!1,p=null,m={};class _ extends i.default{constructor(e){if(super("_User"),e&&"object"==typeof e&&!this.set(e||{}))throw new Error("Can't create an invalid Mmbs User")}_upgradeToRevocableSession(e){var t={};return(e=e||{}).hasOwnProperty("useMasterKey")&&(t.useMasterKey=e.useMasterKey),n.default.getUserController().upgradeToRevocableSession(this,t)._thenRunCallbacks(e)}_linkWith(e,t){var r;if("string"==typeof e?(r=e,e=m[e]):r=e.getAuthType(),t&&t.hasOwnProperty("authData")){var s=this.get("authData")||{};if("object"!=typeof s)throw new Error("Invalid type: authData field should be an object");return s[r]=t.authData,n.default.getUserController().linkWith(this,s)._thenRunCallbacks(t,this)}var o=new l.default;return e.authenticate({success:(e,r)=>{var s={};s.authData=r,t.success&&(s.success=t.success),t.error&&(s.error=t.error),this._linkWith(e,s).then(()=>{o.resolve(this)},e=>{o.reject(e)})},error:(e,r)=>{"function"==typeof t.error&&t.error(this,r),o.reject(r)}}),o}_synchronizeAuthData(e){if(this.isCurrent()&&e){var t;"string"==typeof e?e=m[t=e]:t=e.getAuthType();var r=this.get("authData");e&&r&&"object"==typeof r&&(e.restoreAuthentication(r[t])||this._unlinkFrom(e))}}_synchronizeAllAuthData(){var e=this.get("authData");if("object"==typeof e)for(var t in e)this._synchronizeAuthData(t)}_cleanupAuthData(){if(this.isCurrent()){var e=this.get("authData");if("object"==typeof e)for(var t in e)e[t]||delete e[t]}}_unlinkFrom(e,t){return"string"==typeof e?e=m[e]:e.getAuthType(),this._linkWith(e,{authData:null}).then(()=>(this._synchronizeAuthData(e),l.default.as(this)))._thenRunCallbacks(t)}_isLinked(e){var t;t="string"==typeof e?e:e.getAuthType();var r=this.get("authData")||{};return"object"==typeof r&&!!r[t]}_logOutWithAll(){var e=this.get("authData");if("object"==typeof e)for(var t in e)this._logOutWith(t)}_logOutWith(e){this.isCurrent()&&("string"==typeof e&&(e=m[e]),e&&e.deauthenticate&&e.deauthenticate())}_preserveFieldsOnFetch(){return{sessionToken:this.get("sessionToken")}}isCurrent(){var e=_.current();return!!e&&e.id===this.id}getUsername(){const e=this.get("username");return null==e||"string"==typeof e?e:""}setUsername(e){var t=this.get("authData");t&&"object"==typeof t&&t.hasOwnProperty("anonymous")&&(t.anonymous=null),this.set("username",e)}setPassword(e){this.set("password",e)}getEmail(){const e=this.get("email");return null==e||"string"==typeof e?e:""}setEmail(e){this.set("email",e)}getSessionToken(){const e=this.get("sessionToken");return null==e||"string"==typeof e?e:""}authenticated(){var e=_.current();return!!this.get("sessionToken")&&!!e&&e.id===this.id}signUp(e,t){var r={};return(t=t||{}).hasOwnProperty("useMasterKey")&&(r.useMasterKey=t.useMasterKey),t.hasOwnProperty("installationId")&&(r.installationId=t.installationId),n.default.getUserController().signUp(this,e,r)._thenRunCallbacks(t,this)}logIn(e){var t={};return(e=e||{}).hasOwnProperty("useMasterKey")&&(t.useMasterKey=e.useMasterKey),e.hasOwnProperty("installationId")&&(t.installationId=e.installationId),n.default.getUserController().logIn(this,t)._thenRunCallbacks(e,this)}save(...e){return super.save.apply(this,e).then(()=>this.isCurrent()?n.default.getUserController().updateUserOnDisk(this):this)}destroy(...e){return super.destroy.apply(this,e).then(()=>this.isCurrent()?n.default.getUserController().removeUserFromDisk():this)}fetch(...e){return super.fetch.apply(this,e).then(()=>this.isCurrent()?n.default.getUserController().updateUserOnDisk(this):this)}static readOnlyAttributes(){return["sessionToken"]}static extend(e,t){if(e)for(var r in e)"className"!==r&&Object.defineProperty(_.prototype,r,{value:e[r],enumerable:!1,writable:!0,configurable:!0});if(t)for(var r in t)"className"!==r&&Object.defineProperty(_,r,{value:t[r],enumerable:!1,writable:!0,configurable:!0});return _}static current(){return h?n.default.getUserController().currentUser():null}static currentAsync(){return h?n.default.getUserController().currentUserAsync():l.default.as(null)}static signUp(e,t,r,s){return(r=r||{}).username=e,r.password=t,new _(r).signUp({},s)}static logIn(e,t,r){if("string"!=typeof e)return l.default.error(new a.default(a.default.OTHER_CAUSE,"Username must be a string."));if("string"!=typeof t)return l.default.error(new a.default(a.default.OTHER_CAUSE,"Password must be a string."));var s=new _;return s._finishFetch({username:e,password:t}),s.logIn(r)}static become(e,t){if(!h)throw new Error("It is not memory-safe to become a user in a server environment");var r={sessionToken:e};return(t=t||{}).hasOwnProperty("useMasterKey")&&(r.useMasterKey=t.useMasterKey),n.default.getUserController().become(r)._thenRunCallbacks(t)}static logInWith(e,t){return _._logInWith(e,t)}static logOut(){if(!h)throw new Error("There is no current user on a node.js server environment.");return n.default.getUserController().logOut()}static requestPasswordReset(e,t){var r={};return(t=t||{}).hasOwnProperty("useMasterKey")&&(r.useMasterKey=t.useMasterKey),n.default.getUserController().requestPasswordReset(e,r)._thenRunCallbacks(t)}static allowCustomUserClass(e){n.default.set("PERFORM_USER_REWRITE",!e)}static enableRevocableSession(e){if(e=e||{},n.default.set("FORCE_REVOCABLE_SESSION",!0),h){var t=_.current();if(t)return t._upgradeToRevocableSession(e)}return l.default.as()._thenRunCallbacks(e)}static enableUnsafeCurrentUser(){h=!0}static disableUnsafeCurrentUser(){h=!1}static _registerAuthenticationProvider(e){m[e.getAuthType()]=e,_.currentAsync().then(t=>{t&&t._synchronizeAuthData(e.getAuthType())})}static _logInWith(e,t){return(new _)._linkWith(e,t)}static _clearCache(){p=null,f=!1}static _setCurrentUserCache(e){p=e}}i.default.registerSubclass("_User",_);var y={updateUserOnDisk(e){var t=c.default.generatePath(d),r=e.toJSON();return r.className="_User",c.default.setItemAsync(t,JSON.stringify(r)).then(()=>e)},removeUserFromDisk(){let e=c.default.generatePath(d);return f=!0,p=null,c.default.removeItemAsync(e)},setCurrentUser:e=>(p=e,e._cleanupAuthData(),e._synchronizeAllAuthData(),y.updateUserOnDisk(e)),currentUser(){if(p)return p;if(f)return null;if(c.default.async())throw new Error("Cannot call currentUser() when using a platform with an async storage system. Call currentUserAsync() instead.");var e=c.default.generatePath(d),t=c.default.getItem(e);if(f=!0,!t)return p=null,null;(t=JSON.parse(t)).className||(t.className="_User"),t._id&&(t.objectId!==t._id&&(t.objectId=t._id),delete t._id),t._sessionToken&&(t.sessionToken=t._sessionToken,delete t._sessionToken);var r=i.default.fromJSON(t);return p=r,r._synchronizeAllAuthData(),r},currentUserAsync(){if(p)return l.default.as(p);if(f)return l.default.as(null);var e=c.default.generatePath(d);return c.default.getItemAsync(e).then(e=>{if(f=!0,!e)return p=null,l.default.as(null);(e=JSON.parse(e)).className||(e.className="_User"),e._id&&(e.objectId!==e._id&&(e.objectId=e._id),delete e._id),e._sessionToken&&(e.sessionToken=e._sessionToken,delete e._sessionToken);var t=i.default.fromJSON(e);return p=t,t._synchronizeAllAuthData(),l.default.as(t)})},signUp(e,t,r){var s=t&&t.username||e.get("username"),n=t&&t.password||e.get("password");return s&&s.length?n&&n.length?e.save(t,r).then(()=>(e._finishFetch({password:void 0}),h?y.setCurrentUser(e):e)):l.default.error(new a.default(a.default.OTHER_CAUSE,"Cannot sign up user with an empty password.")):l.default.error(new a.default(a.default.OTHER_CAUSE,"Cannot sign up user with an empty name."))},logIn(e,t){var r=n.default.getRESTController(),s=n.default.getObjectStateController(),o={username:e.get("username"),password:e.get("password")};return r.request("GET","login",o,t).then((t,r)=>(e._migrateId(t.objectId),e._setExisted(!0),s.setPendingOp(e._getStateIdentifier(),"username",void 0),s.setPendingOp(e._getStateIdentifier(),"password",void 0),t.password=void 0,e._finishFetch(t),h?y.setCurrentUser(e):l.default.as(e)))},become(e){var t=new _;return n.default.getRESTController().request("GET","users/me",{},e).then((e,r)=>(t._finishFetch(e),t._setExisted(!0),y.setCurrentUser(t)))},logOut:()=>y.currentUserAsync().then(e=>{var t=c.default.generatePath(d),r=c.default.removeItemAsync(t),s=n.default.getRESTController();if(null!==e){var a=e.getSessionToken();a&&(0,o.default)(a)&&(r=r.then(()=>s.request("POST","logout",{},{sessionToken:a}))),e._logOutWithAll(),e._finishFetch({sessionToken:void 0})}return f=!0,p=null,r}),requestPasswordReset:(e,t)=>n.default.getRESTController().request("POST","requestPasswordReset",{email:e},t),upgradeToRevocableSession(e,t){var r=e.getSessionToken();return r?(t.sessionToken=r,n.default.getRESTController().request("POST","upgradeToRevocableSession",{},t).then(t=>{var r=new u.default;return r._finishFetch(t),e._finishFetch({sessionToken:r.getSessionToken()}),e.isCurrent()?y.setCurrentUser(e):l.default.as(e)})):l.default.error(new a.default(a.default.SESSION_MISSING,"Cannot upgrade a user with no session token"))},linkWith:(e,t)=>e.save({authData:t}).then(()=>h?y.setCurrentUser(e):e)};n.default.setUserController(y),t.default=_},function(e,t,r){"use strict";e.exports=r(46).EventEmitter},function(e,t,r){"use strict";function s(e){return e&&e.__esModule?e:{default:e}}Object.defineProperty(t,"__esModule",{value:!0});var n=s(r(8)),o=s(r(3)),a=s(r(2));class i extends a.default{constructor(e,t){super("_Role"),"string"==typeof e&&t instanceof n.default&&(this.setName(e),this.setACL(t))}getName(){const e=this.get("name");return null==e||"string"==typeof e?e:""}setName(e,t){return this.set("name",e,t)}getUsers(){return this.relation("users")}getRoles(){return this.relation("roles")}validate(e,t){var r=super.validate(e,t);if(r)return r;if("name"in e&&e.name!==this.getName()){var s=e.name;if(this.id&&this.id!==e.objectId)return new o.default(o.default.OTHER_CAUSE,"A role's name can only be set before it has been saved.");if("string"!=typeof s)return new o.default(o.default.OTHER_CAUSE,"A role's name must be a String.")}return!1}}a.default.registerSubclass("_Role",i),t.default=i},function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.default=function(e,t){if(e.indexOf(t)>-1)return!0;for(var r=0;r<e.length;r++)if(e[r]instanceof s.default&&e[r].className===t.className&&e[r]._getId()===t._getId())return!0;return!1};var s=function(e){return e&&e.__esModule?e:{default:e}}(r(2))},function(e,t,r){"use strict";function s(e){return e&&e.__esModule?e:{default:e}}Object.defineProperty(t,"__esModule",{value:!0}),t.default=function(e){var t=[];return e.forEach(e=>{e instanceof o.default?(0,n.default)(t,e)||t.push(e):t.indexOf(e)<0&&t.push(e)}),t};var n=s(r(18)),o=s(r(2))},function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.default=function(e){return e.replace(/[&<>\/'"]/g,function(e){return s[e]})};var s={"&":"&amp;","<":"&lt;",">":"&gt;","/":"&#x2F;","'":"&#x27;",'"':"&quot;"}},function(e,t,r){"use strict";function s(e){return e&&e.__esModule?e:{default:e}}function n(e){let t=e.shift();return e.length||(e[0]={}),t}Object.defineProperty(t,"__esModule",{value:!0}),t.defaultState=function(){return{serverData:{},pendingOps:[{}],objectCache:{},tasks:new u.default,existed:!1}},t.setServerData=function(e,t){for(let r in t)void 0!==t[r]?e[r]=t[r]:delete e[r]},t.setPendingOp=function(e,t,r){let s=e.length-1;r?e[s][t]=r:delete e[s][t]},t.pushPendingState=function(e){e.push({})},t.popPendingState=n,t.mergeFirstPendingState=function(e){let t=n(e),r=e[0];for(let e in t)if(r[e]&&t[e]){let s=r[e].mergeWith(t[e]);s&&(r[e]=s)}else r[e]=t[e]},t.estimateAttribute=function(e,t,r,s,n){let o=e[n];for(let e=0;e<t.length;e++)t[e][n]&&(t[e][n]instanceof c.RelationOp?s&&(o=t[e][n].applyTo(o,{className:r,id:s},n)):o=t[e][n].applyTo(o));return o},t.estimateAttributes=function(e,t,r,s){let n,o={};for(n in e)o[n]=e[n];for(let e=0;e<t.length;e++)for(n in t[e])t[e][n]instanceof c.RelationOp?s&&(o[n]=t[e][n].applyTo(o[n],{className:r,id:s},n)):o[n]=t[e][n].applyTo(o[n]);return o},t.commitServerChanges=function(e,t,r){for(let s in r){let n=r[s];if(e[s]=n,n&&"object"==typeof n&&!(n instanceof i.default)&&!(n instanceof a.default)&&!(n instanceof l.default)){let e=(0,o.default)(n,!1,!0);t[s]=JSON.stringify(e)}}};var o=s(r(6)),a=s(r(4)),i=s(r(2)),l=(s(r(1)),s(r(5))),u=s(r(22)),c=r(9)},function(e,t,r){"use strict";var s=function(e){return e&&e.__esModule?e:{default:e}}(r(1));e.exports=class{constructor(){this.queue=[]}enqueue(e){var t=new s.default;return this.queue.push({task:e,_completion:t}),1===this.queue.length&&e().then(()=>{this._dequeue(),t.resolve()},e=>{this._dequeue(),t.reject(e)}),t}_dequeue(){if(this.queue.shift(),this.queue.length){var e=this.queue[0];e.task().then(()=>{this._dequeue(),e._completion.resolve()},t=>{this._dequeue(),e._completion.reject(t)})}}}},function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.default=function(e){return e.indexOf("r:")>-1}},function(e,t,r){"use strict";function s(e){return e&&e.__esModule?e:{default:e}}Object.defineProperty(t,"__esModule",{value:!0});var n=s(r(0)),o=s(r(23)),a=s(r(2)),i=s(r(1)),l=s(r(15));class u extends a.default{constructor(e){if(super("_Session"),e&&"object"==typeof e&&!this.set(e||{}))throw new Error("Can't create an invalid Session")}getSessionToken(){const e=this.get("sessionToken");return"string"==typeof e?e:""}static readOnlyAttributes(){return["createdWith","expiresAt","installationId","restricted","sessionToken","user"]}static current(e){e=e||{};var t=n.default.getSessionController(),r={};return e.hasOwnProperty("useMasterKey")&&(r.useMasterKey=e.useMasterKey),l.default.currentAsync().then(e=>e?(e.getSessionToken(),r.sessionToken=e.getSessionToken(),t.getSession(r)):i.default.error("There is no current user."))}static isCurrentSessionRevocable(){var e=l.default.current();return!!e&&(0,o.default)(e.getSessionToken()||"")}}a.default.registerSubclass("_Session",u);var c={getSession(e){var t=n.default.getRESTController(),r=new u;return t.request("GET","sessions/me",{},e).then(e=>(r._finishFetch(e),r._setExisted(!0),r))}};n.default.setSessionController(c),t.default=u},function(e,t,r){"use strict";function s(e){return e&&e.__esModule?e:{default:e}}Object.defineProperty(t,"__esModule",{value:!0});var n=s(r(16)),o=s(r(1)),a=s(r(2)),i=s(r(47));const l={INITIALIZED:"initialized",CONNECTING:"connecting",CONNECTED:"connected",CLOSED:"closed",RECONNECTING:"reconnecting",DISCONNECTED:"disconnected"},u={CONNECT:"connect",SUBSCRIBE:"subscribe",UNSUBSCRIBE:"unsubscribe",ERROR:"error"},c={CONNECTED:"connected",SUBSCRIBED:"subscribed",UNSUBSCRIBED:"unsubscribed",ERROR:"error",CREATE:"create",UPDATE:"update",ENTER:"enter",LEAVE:"leave",DELETE:"delete"},d={CLOSE:"close",ERROR:"error",OPEN:"open"},h={OPEN:"open",CLOSE:"close",ERROR:"error",CREATE:"create",UPDATE:"update",ENTER:"enter",LEAVE:"leave",DELETE:"delete"};t.default=class extends n.default{constructor({applicationId:e,serverURL:t,javascriptKey:r,masterKey:s,sessionToken:n,allowAnonymousKey:a}){if(super(),!t||0!==t.indexOf("ws"))throw new Error("You need to set a proper Mmbs LiveQuery server url before using LiveQueryClient");this.reconnectHandle=null,this.attempts=1,this.id=0,this.requestId=1,this.serverURL=t,this.applicationId=e,this.javascriptKey=r,this.allowAnonymousKey=a,this.masterKey=s,this.sessionToken=n,this.connectPromise=new o.default,this.subscriptions=new Map,this.state=l.INITIALIZED}shouldOpen(){return this.state===l.INITIALIZED||this.state===l.DISCONNECTED}subscribe(e,t){if(!e)return;let r=e.className,s=e.toJSON(),n=s.where,o=s.keys?s.keys.split(","):void 0,a={op:u.SUBSCRIBE,requestId:this.requestId,query:{className:r,where:n,fields:o}};t&&(a.sessionToken=t);let l=new i.default(this.requestId,e,t);return this.subscriptions.set(this.requestId,l),this.requestId+=1,this.connectPromise.then(()=>{this.socket.send(JSON.stringify(a))}),l.on("error",()=>{}),l}unsubscribe(e){if(!e)return;this.subscriptions.delete(e.id);let t={op:u.UNSUBSCRIBE,requestId:e.id};this.connectPromise.then(()=>{this.socket.send(JSON.stringify(t))})}open(){let e=this._getWebSocketImplementation();e?(this.state!==l.RECONNECTING&&(this.state=l.CONNECTING),this.socket=new e(this.serverURL),this.socket.onopen=(()=>{this._handleWebSocketOpen()}),this.socket.onmessage=(e=>{this._handleWebSocketMessage(e)}),this.socket.onclose=(()=>{this._handleWebSocketClose()}),this.socket.onerror=(e=>{this._handleWebSocketError(e)})):this.emit(d.ERROR,"Can not find WebSocket implementation")}resubscribe(){this.subscriptions.forEach((e,t)=>{let r=e.query,s=r.toJSON(),n=s.where,o=s.keys?s.keys.split(","):void 0,a=r.className,i=e.sessionToken,l={op:u.SUBSCRIBE,requestId:t,query:{className:a,where:n,fields:o}};i&&(l.sessionToken=i),this.connectPromise.then(()=>{this.socket.send(JSON.stringify(l))})})}close(){if(this.state!==l.INITIALIZED&&this.state!==l.DISCONNECTED){this.state=l.DISCONNECTED,this.socket.close();for(let e of this.subscriptions.values())e.emit(h.CLOSE);this._handleReset(),this.emit(d.CLOSE)}}_getWebSocketImplementation(){return r(48)}_handleReset(){this.attempts=1,this.id=0,this.requestId=1,this.connectPromise=new o.default,this.subscriptions=new Map}_handleWebSocketOpen(){this.attempts=1;let e={op:u.CONNECT,applicationId:this.applicationId,javascriptKey:this.javascriptKey,masterKey:this.masterKey,sessionToken:this.sessionToken,allowAnonymousKey:this.allowAnonymousKey};this.socket.send(JSON.stringify(e))}_handleWebSocketMessage(e){let t=e.data;"string"==typeof t&&(t=JSON.parse(t));let r=null;switch(t.requestId&&(r=this.subscriptions.get(t.requestId)),t.op){case c.CONNECTED:this.state===l.RECONNECTING&&this.resubscribe(),this.emit(d.OPEN),this.id=t.clientId,this.connectPromise.resolve(),this.state=l.CONNECTED;break;case c.SUBSCRIBED:r&&r.emit(h.OPEN);break;case c.ERROR:t.requestId?r&&r.emit(h.ERROR,t.error):this.emit(d.ERROR,t.error);break;case c.UNSUBSCRIBED:break;default:let e=t.object.className;delete t.object.__type,delete t.object.className;let s=new a.default(e);if(s._finishFetch(t.object),!r)break;r.emit(t.op,s)}}_handleWebSocketClose(){if(this.state!==l.DISCONNECTED){this.state=l.CLOSED,this.emit(d.CLOSE);for(let e of this.subscriptions.values())e.emit(h.CLOSE);this._handleReconnect()}}_handleWebSocketError(e){this.emit(d.ERROR,e);for(let e of this.subscriptions.values())e.emit(h.ERROR);this._handleReconnect()}_handleReconnect(){if(this.state===l.DISCONNECTED)return;this.state=l.RECONNECTING;let e=(e=>Math.random()*Math.min(30,Math.pow(2,e)-1)*1e3)(this.attempts);this.reconnectHandle&&clearTimeout(this.reconnectHandle),this.reconnectHandle=setTimeout((()=>{this.attempts++,this.connectPromise=new o.default,this.open()}).bind(this),e)}}},function(e,t,r){"use strict";e.exports=r(27)},function(e,t,r){"use strict";function s(e){return e&&e.__esModule?e:{default:e}}var n=s(r(7)),o=s(r(6)),a=s(r(0)),i=s(r(36)),l=function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var r in e)Object.prototype.hasOwnProperty.call(e,r)&&(t[r]=e[r]);return t.default=e,t}(r(9)),u=s(r(37)),c={initialize(e,t){c._initialize(e,t)},_initialize(e,t,r,s){a.default.set("APPLICATION_ID",e),a.default.set("JAVASCRIPT_KEY",t),a.default.set("MASTER_KEY",r),a.default.set("USE_MASTER_KEY",!1),a.default.set("ALLOW_ANONYMOUS_KEY",s)},setAsyncStorage(e){a.default.setAsyncStorage(e)}};Object.defineProperty(c,"applicationId",{get:()=>a.default.get("APPLICATION_ID"),set(e){a.default.set("APPLICATION_ID",e)}}),Object.defineProperty(c,"javaScriptKey",{get:()=>a.default.get("JAVASCRIPT_KEY"),set(e){a.default.set("JAVASCRIPT_KEY",e)}}),Object.defineProperty(c,"masterKey",{get:()=>a.default.get("MASTER_KEY"),set(e){a.default.set("MASTER_KEY",e)}}),Object.defineProperty(c,"allowAnonymousKey",{get:()=>a.default.get("ALLOW_ANONYMOUS_KEY"),set(e){a.default.set("ALLOW_ANONYMOUS_KEY",e)}}),Object.defineProperty(c,"useAllowAnonymousKey",{get:()=>a.default.get("USE_ALLOW_ANONYMOUS_KEY"),set(e){a.default.set("USE_ALLOW_ANONYMOUS_KEY",e)}}),Object.defineProperty(c,"serverURL",{get:()=>a.default.get("SERVER_URL"),set(e){a.default.set("SERVER_URL",e)}}),Object.defineProperty(c,"liveQueryServerURL",{get:()=>a.default.get("LIVEQUERY_SERVER_URL"),set(e){a.default.set("LIVEQUERY_SERVER_URL",e)}}),c.ACL=r(8).default,c.Analytics=r(39),c.Cloud=r(40),c.CoreManager=r(0),c.Config=r(41).default,c.Error=r(3).default,c.File=r(4).default,c.GeoPoint=r(10).default,c.Polygon=r(12).default,c.Installation=r(42).default,c.Object=r(2).default,c.Op={Set:l.SetOp,Unset:l.UnsetOp,Increment:l.IncrementOp,Add:l.AddOp,Remove:l.RemoveOp,AddUnique:l.AddUniqueOp,Relation:l.RelationOp},c.Promise=r(1).default,c.Push=r(43),c.Query=r(13).default,c.Relation=r(5).default,c.Role=r(17).default,c.Schema=r(44).default,c.Session=r(24).default,c.Storage=r(11),c.User=r(15).default,c.LiveQuery=r(45).default,c.LiveQueryClient=r(25).default,c._request=function(...e){return a.default.getRESTController().request.apply(null,e)},c._ajax=function(...e){return a.default.getRESTController().ajax.apply(null,e)},c._decode=function(e,t){return(0,n.default)(t)},c._encode=function(e,t,r){return(0,o.default)(e,r)},c._getInstallationId=function(){return a.default.getInstallationController().currentInstallationId()},a.default.setInstallationController(i.default),a.default.setRESTController(u.default),c.initialize=c._initialize,c.Cloud=c.Cloud||{},c.Cloud.useMasterKey=function(){a.default.set("USE_MASTER_KEY",!0)},c.Hooks=r(49),c.Mmbs=c,e.exports=c},function(e,t){e.exports={name:"parse",version:"1.11.0",description:"The Mmbs JavaScript SDK",homepage:"https://www.cmetamap.com",keywords:["cloud","mobile","api"],license:"BSD-3-Clause",repository:{type:"git",url:"https://github.com/MmbsPlatform/Mmbs-SDK-JS"},bugs:"https://github.com/MmbsPlatform/Mmbs-SDK-JS/issues",files:["index.js","node.js","react-native.js","dist/","lib/","LICENSE","PATENTS","README.md"],browser:{"react-native":!1},dependencies:{"babel-runtime":"^6.11.6",ws:"^3.3.1",xmlhttprequest:"^1.7.0"},devDependencies:{babel:"^6.23.0","babel-cli":"^6.26.0","babel-core":"^6.26.0","babel-eslint":"^8.0.3","babel-jest":"^19.0.0","babel-loader":"^7.1.2","babel-plugin-flow-comments":"^6.3.19","babel-plugin-inline-package-json":"~2.0.0","babel-plugin-minify-dead-code-elimination":"0.1.4","babel-plugin-syntax-flow":"^6.18.0","babel-plugin-transform-flow-strip-types":"^6.22.0","babel-plugin-transform-inline-environment-variables":"^6.8.0","babel-plugin-transform-runtime":"^6.15.0","babel-preset-env":"^1.6.1","babel-preset-es2015":"^6.24.1","babel-preset-react":"^6.11.1","babel-preset-stage-2":"^6.13.0","babel-preset-stage-3":"^6.24.1","babel-register":"^6.26.0",browserify:"^14.3.0","codecov.io":"^0.1.6","cross-env":"^5.1.1",eslint:"^4.12.1","eslint-plugin-flowtype":"^2.39.1",gulp:"^3.9.1","gulp-babel":"^6.1.2","gulp-derequire":"^2.1.0","gulp-insert":"^0.5.0","gulp-rename":"^1.2.2","gulp-replace":"^0.5.4","gulp-uglify":"^2.1.2","jasmine-reporters":"~2.2.1","jest-cli":"^19.0.2",jsdoc:"^3.5.5","jsdoc-babel":"^0.3.0",minami:"^1.2.3","uglifyjs-webpack-plugin":"^1.1.2","vinyl-source-stream":"^1.1.0",webpack:"^3.10.0","webpack-node-externals":"^1.6.0"},scripts:{build:"./build_releases.sh",release:"./build_releases.sh && npm publish",test:"MMBS_BUILD=node jest",docs:"jsdoc -c ./jsdoc-conf.json ./src",release_docs:"./release_docs.sh"},jest:{automock:!0,collectCoverage:!0,roots:["src/"],testPathIgnorePatterns:["/node_modules/","/test_helpers/"],transform:{".*":"./babel-jest.js"},setupTestFrameworkScriptFile:"./setup-jest.js"}}},function(e,t,r){"use strict";function s(e){return e&&e.__esModule?e:{default:e}}function n(e){if("object"!=typeof e)return!0;if(e instanceof i.default)return!0;if(e instanceof a.default)return!!e.id;if(e instanceof o.default)return!!e.url();if(Array.isArray(e)){for(var t=0;t<e.length;t++)if(!n(e[t]))return!1;return!0}for(var r in e)if(!n(e[r]))return!1;return!0}Object.defineProperty(t,"__esModule",{value:!0}),t.default=function(e){if(!(e instanceof a.default))return!0;var t=e.attributes;for(var r in t)if(!n(t[r]))return!1;return!0};var o=s(r(4)),a=s(r(2)),i=s(r(5))},function(e,t,r){"use strict";function s(e){return e&&e.__esModule?e:{default:e}}function n(e,t){if(typeof e!=typeof t)return!1;if(!e||"object"!=typeof e)return e===t;if(Array.isArray(e)||Array.isArray(t)){if(!Array.isArray(e)||!Array.isArray(t))return!1;if(e.length!==t.length)return!1;for(var r=e.length;r--;)if(!n(e[r],t[r]))return!1;return!0}if(e instanceof o.default||e instanceof a.default||e instanceof i.default||e instanceof l.default)return e.equals(t);if(Object.keys(e).length!==Object.keys(t).length)return!1;for(var s in e)if(!n(e[s],t[s]))return!1;return!0}Object.defineProperty(t,"__esModule",{value:!0}),t.default=n;var o=s(r(8)),a=s(r(4)),i=s(r(10)),l=s(r(2))},function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.default=function(e){var t=new RegExp("^([0-9]{1,4})-([0-9]{1,2})-([0-9]{1,2})T([0-9]{1,2}):([0-9]{1,2}):([0-9]{1,2})(.([0-9]+))?Z$").exec(e);if(!t)return null;var r=t[1]||0,s=(t[2]||1)-1,n=t[3]||0,o=t[4]||0,a=t[5]||0,i=t[6]||0,l=t[8]||0;return new Date(Date.UTC(r,s,n,o,a,i,l))}},function(e,t,r){"use strict";function s(e){let t=l[e.className];return t?t[e.id]||null:null}function n(e,t){let r=s(e);return r||(l[e.className]||(l[e.className]={}),t||(t=i.defaultState()),r=l[e.className][e.id]=t)}function o(e){let t=s(e);return t?t.serverData:{}}function a(e){let t=s(e);return t?t.pendingOps:[{}]}Object.defineProperty(t,"__esModule",{value:!0}),t.getState=s,t.initializeState=n,t.removeState=function(e){let t=s(e);return null===t?null:(delete l[e.className][e.id],t)},t.getServerData=o,t.setServerData=function(e,t){let r=n(e).serverData;i.setServerData(r,t)},t.getPendingOps=a,t.setPendingOp=function(e,t,r){let s=n(e).pendingOps;i.setPendingOp(s,t,r)},t.pushPendingState=function(e){let t=n(e).pendingOps;i.pushPendingState(t)},t.popPendingState=function(e){let t=n(e).pendingOps;return i.popPendingState(t)},t.mergeFirstPendingState=function(e){let t=a(e);i.mergeFirstPendingState(t)},t.getObjectCache=function(e){let t=s(e);return t?t.objectCache:{}},t.estimateAttribute=function(e,t){let r=o(e),s=a(e);return i.estimateAttribute(r,s,e.className,e.id,t)},t.estimateAttributes=function(e){let t=o(e),r=a(e);return i.estimateAttributes(t,r,e.className,e.id)},t.commitServerChanges=function(e,t){let r=n(e);i.commitServerChanges(r.serverData,r.objectCache,t)},t.enqueueTask=function(e,t){return n(e).tasks.enqueue(t)},t.clearAllState=function(){l={}},t.duplicateState=function(e,t){t.id=e.id};var i=function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var r in e)Object.prototype.hasOwnProperty.call(e,r)&&(t[r]=e[r]);return t.default=e,t}(r(21));let l={}},function(e,t,r){"use strict";function s(e){return u.get(e)||null}function n(e,t){let r=s(e);return r||(t||(t={serverData:{},pendingOps:[{}],objectCache:{},tasks:new l.default,existed:!1}),r=t,u.set(e,r),r)}function o(e){let t=s(e);return t?t.serverData:{}}function a(e){let t=s(e);return t?t.pendingOps:[{}]}Object.defineProperty(t,"__esModule",{value:!0}),t.getState=s,t.initializeState=n,t.removeState=function(e){let t=s(e);return null===t?null:(u.delete(e),t)},t.getServerData=o,t.setServerData=function(e,t){let r=n(e).serverData;i.setServerData(r,t)},t.getPendingOps=a,t.setPendingOp=function(e,t,r){let s=n(e).pendingOps;i.setPendingOp(s,t,r)},t.pushPendingState=function(e){let t=n(e).pendingOps;i.pushPendingState(t)},t.popPendingState=function(e){let t=n(e).pendingOps;return i.popPendingState(t)},t.mergeFirstPendingState=function(e){let t=a(e);i.mergeFirstPendingState(t)},t.getObjectCache=function(e){let t=s(e);return t?t.objectCache:{}},t.estimateAttribute=function(e,t){let r=o(e),s=a(e);return i.estimateAttribute(r,s,e.className,e.id,t)},t.estimateAttributes=function(e){let t=o(e),r=a(e);return i.estimateAttributes(t,r,e.className,e.id)},t.commitServerChanges=function(e,t){let r=n(e);i.commitServerChanges(r.serverData,r.objectCache,t)},t.enqueueTask=function(e,t){return n(e).tasks.enqueue(t)},t.duplicateState=function(e,t){let r=n(e),s=n(t);for(let e in r.serverData)s.serverData[e]=r.serverData[e];for(let e=0;e<r.pendingOps.length;e++)for(let t in r.pendingOps[e])s.pendingOps[e][t]=r.pendingOps[e][t];for(let e in r.objectCache)s.objectCache[e]=r.objectCache[e];s.existed=r.existed},t.clearAllState=function(){u=new WeakMap};var i=function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var r in e)Object.prototype.hasOwnProperty.call(e,r)&&(t[r]=e[r]);return t.default=e,t}(r(21)),l=function(e){return e&&e.__esModule?e:{default:e}}(r(22));let u=new WeakMap},function(e,t,r){"use strict";function s(e){return e&&e.__esModule?e:{default:e}}function n(e,t,r,s){if(e instanceof a.default){if(!e.id&&r)throw new Error("Cannot create a pointer to an unsaved Object.");var l=e.className+":"+e._getId();if(!t.objects[l]){t.objects[l]=!e.dirty()||e;var u=e.attributes;for(var c in u)"object"==typeof u[c]&&n(u[c],t,!s,s)}}else if(e instanceof o.default)!e.url()&&t.files.indexOf(e)<0&&t.files.push(e);else if(!(e instanceof i.default)){Array.isArray(e)&&e.forEach(e=>{"object"==typeof e&&n(e,t,r,s)});for(var d in e)"object"==typeof e[d]&&n(e[d],t,r,s)}}Object.defineProperty(t,"__esModule",{value:!0}),t.default=function(e,t){var r={objects:{},files:[]},s=e.className+":"+e._getId();r.objects[s]=!e.dirty()||e;var o=e.attributes;for(var a in o)"object"==typeof o[a]&&n(o[a],r,!1,!!t);var i=[];for(var l in r.objects)l!==s&&!0!==r.objects[l]&&i.push(r.objects[l]);return i.concat(r.files)};var o=s(r(4)),a=s(r(2)),i=s(r(5))},function(e,t,r){"use strict";var s={},n={async:0,getItem:e=>s.hasOwnProperty(e)?s[e]:null,setItem(e,t){s[e]=String(t)},removeItem(e){delete s[e]},clear(){for(var e in s)s.hasOwnProperty(e)&&delete s[e]}};e.exports=n},function(e,t,r){"use strict";function s(e){return e&&e.__esModule?e:{default:e}}function n(){return Math.floor(65536*(1+Math.random())).toString(16).substring(1)}s(r(0));var o=s(r(1)),a=s(r(11)),i=null,l={currentInstallationId(){if("string"==typeof i)return o.default.as(i);var e=a.default.generatePath("installationId");return a.default.getItemAsync(e).then(t=>t?(i=t,t):(t=n()+n()+"-"+n()+"-"+n()+"-"+n()+"-"+n()+n()+n(),a.default.setItemAsync(e,t).then(()=>(i=t,t))))},_clearCache(){i=null},_setInstallationIdCache(e){i=e}};e.exports=l},function(e,t,r){"use strict";(function(t){function s(e){return e&&e.__esModule?e:{default:e}}var n=s(r(0)),o=s(r(3)),a=s(r(1)),i=(s(r(11)),null);"undefined"!=typeof XMLHttpRequest&&(i=XMLHttpRequest),i=r(38).XMLHttpRequest;var l=!1;"undefined"==typeof XDomainRequest||"withCredentials"in new XMLHttpRequest||(l=!0);const u={ajax(e,r,s,u){if(l)return function(e,t,r){var s=new a.default,n=new XDomainRequest;return n.onload=function(){var e;try{e=JSON.parse(n.responseText)}catch(e){s.reject(e)}e&&s.resolve(e)},n.onerror=n.ontimeout=function(){var e={responseText:JSON.stringify({code:o.default.X_DOMAIN_REQUEST,error:"IE's XDomainRequest does not supply error info."})};s.reject(e)},n.onprogress=function(){},n.open(e,t),n.send(r),s}(e,r,s);var c=new a.default,d=0,h=function(){if(null==i)throw new Error("Cannot make a request: No definition of XMLHttpRequest was found.");var o=!1,a=new i;a.onreadystatechange=function(){if(4===a.readyState&&!o)if(o=!0,a.status>=200&&a.status<300){var e;try{e=JSON.parse(a.responseText)}catch(e){c.reject(e.toString())}e&&c.resolve(e,a.status,a)}else if(a.status>=500||0===a.status)if(++d<n.default.get("REQUEST_ATTEMPT_LIMIT")){var t=Math.round(125*Math.random()*Math.pow(2,d));setTimeout(h,t)}else 0===a.status?c.reject("Unable to connect to the Mmbs API"):c.reject(a);else c.reject(a)},"string"!=typeof(u=u||{})["Content-Type"]&&(u["Content-Type"]="text/plain"),n.default.get("IS_NODE")&&(u["User-Agent"]="Mmbs/"+n.default.get("VERSION")+" (NodeJS "+t.versions.node+")"),a.open(e,r,!0);for(var l in u)a.setRequestHeader(l,u[l]);a.send(s)};return h(),c},request(e,t,r,s){s=s||{};var i=n.default.get("SERVER_URL");"/"!==i[i.length-1]&&(i+="/"),i+=t;var l={};if(r&&"object"==typeof r)for(var c in r)l[c]=r[c];"POST"!==e&&(l._method=e,e="POST"),l._ApplicationId=n.default.get("APPLICATION_ID");let d=n.default.get("JAVASCRIPT_KEY");d&&(l._JavaScriptKey=d),l._ClientVersion=n.default.get("VERSION");var h=s.useAllowAnonymousKey;if(void 0===h&&(h=n.default.get("USE_ALLOW_ANONYMOUS_KEY")),h){if(!n.default.get("ALLOW_ANONYMOUS_KEY"))throw new Error("Cannot use the AllowAnonymous Key, it has not been provided.");l._AllowAnonymousKey=n.default.get("ALLOW_ANONYMOUS_KEY")}var f=s.useMasterKey;if(void 0===f&&(f=n.default.get("USE_MASTER_KEY")),f){if(!n.default.get("MASTER_KEY"))throw new Error("Cannot use the Master Key, it has not been provided.");delete l._AllowAnonymousKey,delete l._JavaScriptKey,l._MasterKey=n.default.get("MASTER_KEY")}n.default.get("FORCE_REVOCABLE_SESSION")&&(l._RevocableSession="1");var p=s.installationId;return(p&&"string"==typeof p?a.default.as(p):n.default.getInstallationController().currentInstallationId()).then(e=>{l._InstallationId=e;var t=n.default.getUserController();return s&&"string"==typeof s.sessionToken?a.default.as(s.sessionToken):t?t.currentUserAsync().then(e=>e?a.default.as(e.getSessionToken()):a.default.as(null)):a.default.as(null)}).then(t=>{t&&(l._SessionToken=t);var r=JSON.stringify(l);return u.ajax(e,i,r)}).then(null,function(e){var t;if(e&&e.responseText)try{var r=JSON.parse(e.responseText);t=new o.default(r.code,r.error)}catch(r){t=new o.default(o.default.INVALID_JSON,"Received an error with invalid JSON from Mmbs: "+e.responseText)}else t=new o.default(o.default.CONNECTION_FAILED,"XMLHttpRequest failed: "+JSON.stringify(e));return a.default.error(t)})},_setXHR(e){i=e}};e.exports=u}).call(t,r(14))},function(e,t){e.exports=r(1)},function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.track=function(e,t,r){if(e=e||"",e=e.replace(/^\s*/,""),0===(e=e.replace(/\s*$/,"")).length)throw new TypeError("A name for the custom event must be provided");for(var n in t)if("string"!=typeof n||"string"!=typeof t[n])throw new TypeError('track() dimensions expects keys and values of type "string".');return r=r||{},s.default.getAnalyticsController().track(e,t)._thenRunCallbacks(r)};var s=function(e){return e&&e.__esModule?e:{default:e}}(r(0)),n={track(e,t){var r="events/"+e;return s.default.getRESTController().request("POST",r,{dimensions:t})}};s.default.setAnalyticsController(n)},function(e,t,r){"use strict";function s(e){return e&&e.__esModule?e:{default:e}}Object.defineProperty(t,"__esModule",{value:!0}),t.run=function(e,t,r){if(r=r||{},"string"!=typeof e||0===e.length)throw new TypeError("Cloud function name must be a string.");var s={};return r.useMasterKey&&(s.useMasterKey=r.useMasterKey),r.sessionToken&&(s.sessionToken=r.sessionToken),n.default.getCloudController().run(e,t,s)._thenRunCallbacks(r)},t.runJob=function(e,t,r){if(r=r||{},"string"!=typeof e||0===e.length)throw new TypeError("Cloud job name must be a string.");var s={};return r.useMasterKey&&(s.useMasterKey=r.useMasterKey),r.sessionToken&&(s.sessionToken=r.sessionToken),n.default.getCloudController().runJob(e,t,s)._thenRunCallbacks(r)};var n=s(r(0)),o=s(r(7)),a=s(r(6)),i=s(r(3)),l=s(r(1)),u={run(e,t,r){var s=n.default.getRESTController(),u=(0,a.default)(t,!0),c={};return r.hasOwnProperty("useMasterKey")&&(c.useMasterKey=r.useMasterKey),r.hasOwnProperty("sessionToken")&&(c.sessionToken=r.sessionToken),s.request("POST","functions/"+e,u,c).then(function(e){var t=(0,o.default)(e);return t&&t.hasOwnProperty("result")?l.default.as(t.result):l.default.error(new i.default(i.default.INVALID_JSON,"The server returned an invalid response."))})._thenRunCallbacks(r)},runJob(e,t,r){var s=n.default.getRESTController(),u=(0,a.default)(t,!0),c={};return r.hasOwnProperty("useMasterKey")&&(c.useMasterKey=r.useMasterKey),r.hasOwnProperty("sessionToken")&&(c.sessionToken=r.sessionToken),s.request("POST","jobs/"+e,u,c).then(function(e){var t=(0,o.default)(e);return t&&t.hasOwnProperty("result")?l.default.as(t.result):l.default.error(new i.default(i.default.INVALID_JSON,"The server returned an invalid response."))})._thenRunCallbacks(r)}};n.default.setCloudController(u)},function(e,t,r){"use strict";function s(e){return e&&e.__esModule?e:{default:e}}function n(e){try{var t=JSON.parse(e);if(t&&"object"==typeof t)return(0,a.default)(t)}catch(e){return null}}Object.defineProperty(t,"__esModule",{value:!0});var o=s(r(0)),a=s(r(7)),i=(s(r(6)),s(r(20))),l=s(r(3)),u=s(r(1)),c=s(r(11));class d{constructor(){this.attributes={},this._escapedAttributes={}}get(e){return this.attributes[e]}escape(e){var t=this._escapedAttributes[e];if(t)return t;var r=this.attributes[e],s="";return null!=r&&(s=(0,i.default)(r.toString())),this._escapedAttributes[e]=s,s}static current(){return o.default.getConfigController().current()}static get(e){return e=e||{},o.default.getConfigController().get()._thenRunCallbacks(e)}}var h=null,f={current(){if(h)return h;var e,t=new d,r=c.default.generatePath("currentConfig");if(!c.default.async()){if(e=c.default.getItem(r)){var s=n(e);s&&(t.attributes=s,h=t)}return t}return c.default.getItemAsync(r).then(e=>{if(e){var r=n(e);r&&(t.attributes=r,h=t)}return t})},get:()=>o.default.getRESTController().request("GET","config",{},{}).then(e=>{if(!e||!e.params){var t=new l.default(l.default.INVALID_JSON,"Config JSON response invalid.");return u.default.error(t)}var r=new d;r.attributes={};for(var s in e.params)r.attributes[s]=(0,a.default)(e.params[s]);return h=r,c.default.setItemAsync(c.default.generatePath("currentConfig"),JSON.stringify(e.params)).then(()=>r)})};o.default.setConfigController(f),t.default=d},function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var s=function(e){return e&&e.__esModule?e:{default:e}}(r(2));class n extends s.default{constructor(e){if(super("_Installation"),e&&"object"==typeof e&&!this.set(e||{}))throw new Error("Can't create an invalid Session")}}t.default=n,s.default.registerSubclass("_Installation",n)},function(e,t,r){"use strict";function s(e){return e&&e.__esModule?e:{default:e}}Object.defineProperty(t,"__esModule",{value:!0}),t.send=function(e,t){if(t=t||{},e.where&&e.where instanceof o.default&&(e.where=e.where.toJSON().where),e.push_time&&"object"==typeof e.push_time&&(e.push_time=e.push_time.toJSON()),e.expiration_time&&"object"==typeof e.expiration_time&&(e.expiration_time=e.expiration_time.toJSON()),e.expiration_time&&e.expiration_interval)throw new Error("expiration_time and expiration_interval cannot both be set.");return n.default.getPushController().send(e,{useMasterKey:t.useMasterKey})._thenRunCallbacks(t)};var n=s(r(0)),o=s(r(13)),a={send:(e,t)=>n.default.getRESTController().request("POST","push",e,{useMasterKey:!!t.useMasterKey})._thenRunCallbacks(t)};n.default.setPushController(a)},function(e,t,r){"use strict";function s(e){return e&&e.__esModule?e:{default:e}}Object.defineProperty(t,"__esModule",{value:!0});var n=s(r(0));s(r(1));const o=["String","Number","Boolean","Date","File","GeoPoint","Array","Object","Pointer","Relation"],a={send(e,t,r,s){const o=n.default.getRESTController(),a={useMasterKey:!0};return s.hasOwnProperty("sessionToken")&&(a.sessionToken=s.sessionToken),o.request(t,`schemas/${e}`,r,a)},get(e,t){return this.send(e,"GET",{},t)},create(e,t,r){return this.send(e,"POST",t,r)},update(e,t,r){return this.send(e,"PUT",t,r)},delete(e,t){return this.send(e,"DELETE",{},t)}};n.default.setSchemaController(a),t.default=class{constructor(e){"string"==typeof e&&("User"===e&&n.default.get("PERFORM_USER_REWRITE")?this.className="_User":this.className=e),this._fields={},this._indexes={},this._classLevelPermissions={}}static all(e){return e=e||{},n.default.getSchemaController().get("",e).then(e=>{if(0===e.results.length)throw new Error("Schema not found.");return e.results})._thenRunCallbacks(e)}get(e){return this.assertClassName(),e=e||{},n.default.getSchemaController().get(this.className,e).then(e=>{if(!e)throw new Error("Schema not found.");return this._classLevelPermissions=e.classLevelPermissions,e})._thenRunCallbacks(e)}save(e){this.assertClassName(),e=e||{};const t=n.default.getSchemaController(),r={className:this.className,fields:this._fields,indexes:this._indexes,classLevelPermissions:this._classLevelPermissions};return t.create(this.className,r,e).then(e=>e)._thenRunCallbacks(e)}update(e){this.assertClassName(),e=e||{};const t=n.default.getSchemaController(),r={className:this.className,fields:this._fields,indexes:this._indexes,classLevelPermissions:this._classLevelPermissions};return this._fields={},this._indexes={},this._classLevelPermissions={},t.update(this.className,r,e).then(e=>e)._thenRunCallbacks(e)}delete(e){return this.assertClassName(),e=e||{},n.default.getSchemaController().delete(this.className,e).then(e=>e)._thenRunCallbacks(e)}assertClassName(){if(!this.className)throw new Error("You must set a Class Name before making any request.")}addField(e,t){if(t=t||"String",!e)throw new Error("field name may not be null.");if(-1===o.indexOf(t))throw new Error(`${t} is not a valid type.`);return this._fields[e]={type:t},this}addIndex(e,t){if(!e)throw new Error("index name may not be null.");if(!t)throw new Error("index may not be null.");return this._indexes[e]=t,this}addString(e){return this.addField(e,"String")}addNumber(e){return this.addField(e,"Number")}addBoolean(e){return this.addField(e,"Boolean")}addDate(e){return this.addField(e,"Date")}addFile(e){return this.addField(e,"File")}addGeoPoint(e){return this.addField(e,"GeoPoint")}addArray(e){return this.addField(e,"Array")}addObject(e){return this.addField(e,"Object")}addPointer(e,t){if(!e)throw new Error("field name may not be null.");if(!t)throw new Error("You need to set the targetClass of the Pointer.");return this._fields[e]={type:"Pointer",targetClass:t},this}addRelation(e,t){if(!e)throw new Error("field name may not be null.");if(!t)throw new Error("You need to set the targetClass of the Relation.");return this._fields[e]={type:"Relation",targetClass:t},this}deleteField(e){this._fields[e]={__op:"Delete"}}deleteIndex(e){this._indexes[e]={__op:"Delete"}}updateClassLevelPermissions(e,t,r){if(["read","write","find","get","create","update","delete","addField"].indexOf(e)<0)throw new Error("method name may not find.use [find, get, create, update, delete, addField]");if(!t)throw new Error("You need to set the Role name.");this._classLevelPermissions=this._classLevelPermissions||{},"read"==e?(this._classLevelPermissions.find=this._classLevelPermissions.find||{},this._classLevelPermissions.get=this._classLevelPermissions.get||{}):"write"==e?(this._classLevelPermissions.create=this._classLevelPermissions.create||{},this._classLevelPermissions.update=this._classLevelPermissions.update||{},this._classLevelPermissions.delete=this._classLevelPermissions.delete||{},this._classLevelPermissions.addField=this._classLevelPermissions.addField||{}):this._classLevelPermissions[e]=this._classLevelPermissions[e]||{};var s=("*"===t?"":"role:")+t;return r?"read"==e?(this._classLevelPermissions.find[s]=!0,this._classLevelPermissions.get[s]=!0):"write"==e?(this._classLevelPermissions.create[s]=!0,this._classLevelPermissions.update[s]=!0,this._classLevelPermissions.delete[s]=!0,this._classLevelPermissions.addField[s]=!0):this._classLevelPermissions[e][s]=!0:"read"==e?(delete this._classLevelPermissions.find[s],delete this._classLevelPermissions.get[s]):"write"==e?(delete this._classLevelPermissions.create[s],delete this._classLevelPermissions.update[s],delete this._classLevelPermissions.delete[s],delete this._classLevelPermissions.addField[s]):delete this._classLevelPermissions[e][s],this}getClassLevelPermissions(){return this._classLevelPermissions}}},function(e,t,r){"use strict";function s(e){return e&&e.__esModule?e:{default:e}}function n(){return l.default.getUserController().currentUserAsync().then(e=>e?e.getSessionToken():void 0)}function o(){return l.default.getLiveQueryController().getDefaultLiveQueryClient()}Object.defineProperty(t,"__esModule",{value:!0});var a=s(r(16)),i=s(r(25)),l=s(r(0)),u=s(r(1));let c=new a.default;c.open=function(){l.default.getLiveQueryController().open()},c.close=function(){l.default.getLiveQueryController().close()},c.on("error",()=>{}),t.default=c;let d;const h={setDefaultLiveQueryClient(e){d=e},getDefaultLiveQueryClient:()=>d?u.default.as(d):n().then(e=>{let t=l.default.get("LIVEQUERY_SERVER_URL");if(t&&0!==t.indexOf("ws"))throw new Error("You need to set a proper Mmbs LiveQuery server url before using LiveQueryClient");if(!t){const e=l.default.get("SERVER_URL");let r="ws://";0===e.indexOf("https")&&(r="wss://"),t=r+e.replace(/^https?:\/\//,""),l.default.set("LIVEQUERY_SERVER_URL",t)}const r=l.default.get("APPLICATION_ID"),s=l.default.get("JAVASCRIPT_KEY"),n=l.default.get("MASTER_KEY"),o=l.default.get("ALLOW_ANONYMOUS_KEY");return(d=new i.default({applicationId:r,serverURL:t,javascriptKey:s,masterKey:n,sessionToken:e,allowAnonymousKey:o})).on("error",e=>{c.emit("error",e)}),d.on("open",()=>{c.emit("open")}),d.on("close",()=>{c.emit("close")}),d}),open(){o().then(e=>{this.resolve(e.open())})},close(){o().then(e=>{this.resolve(e.close())})},subscribe(e){let t=new a.default;return o().then(r=>(r.shouldOpen()&&r.open(),n().then(s=>{let n=r.subscribe(e,s);t.id=n.id,t.query=n.query,t.sessionToken=n.sessionToken,t.unsubscribe=n.unsubscribe,n.on("open",()=>{t.emit("open")}),n.on("create",e=>{t.emit("create",e)}),n.on("update",e=>{t.emit("update",e)}),n.on("enter",e=>{t.emit("enter",e)}),n.on("leave",e=>{t.emit("leave",e)}),n.on("delete",e=>{t.emit("delete",e)}),n.on("close",e=>{t.emit("close",e)}),n.on("error",e=>{t.emit("error",e)}),this.resolve()}))),t},unsubscribe(e){o().then(t=>{this.resolve(t.unsubscribe(e))})},_clearCachedDefaultClient(){d=null}};l.default.setLiveQueryController(h)},function(e,t){e.exports=r(2)},function(e,t,r){"use strict";function s(e){return e&&e.__esModule?e:{default:e}}Object.defineProperty(t,"__esModule",{value:!0});var n=s(r(16)),o=s(r(0));t.default=class extends n.default{constructor(e,t,r){super(),this.id=e,this.query=t,this.sessionToken=r}unsubscribe(){let e=this;o.default.getLiveQueryController().getDefaultLiveQueryClient().then(t=>{t.unsubscribe(e),e.emit("close"),this.resolve()})}}},function(e,t){e.exports=r(3)},function(e,t,r){"use strict";function s(e){return e&&e.__esModule?e:{default:e}}function n(e){return i.default.getHooksController().create(e)}function o(e){return i.default.getHooksController().update(e)}function a(e){return i.default.getHooksController().remove(e)}Object.defineProperty(t,"__esModule",{value:!0}),t.getFunctions=function(){return i.default.getHooksController().get("functions")},t.getTriggers=function(){return i.default.getHooksController().get("triggers")},t.getFunction=function(e){return i.default.getHooksController().get("functions",e)},t.getTrigger=function(e,t){return i.default.getHooksController().get("triggers",e,t)},t.createFunction=function(e,t){return n({functionName:e,url:t})},t.createTrigger=function(e,t,r){return n({className:e,triggerName:t,url:r})},t.create=n,t.updateFunction=function(e,t){return o({functionName:e,url:t})},t.updateTrigger=function(e,t,r){return o({className:e,triggerName:t,url:r})},t.update=o,t.removeFunction=function(e){return a({functionName:e})},t.removeTrigger=function(e,t){return a({className:e,triggerName:t})},t.remove=a;var i=s(r(0)),l=s(r(7)),u=(s(r(6)),s(r(3))),c=s(r(1)),d={get(e,t,r){var s="/hooks/"+e;return t&&(s+="/"+t,r&&(s+="/"+r)),this.sendRequest("GET",s)},create(e){var t;if(e.functionName&&e.url)t="/hooks/functions";else{if(!(e.className&&e.triggerName&&e.url))return Promise.reject({error:"invalid hook declaration",code:143});t="/hooks/triggers"}return this.sendRequest("POST",t,e)},remove(e){var t;if(e.functionName)t="/hooks/functions/"+e.functionName,delete e.functionName;else{if(!e.className||!e.triggerName)return Promise.reject({error:"invalid hook declaration",code:143});t="/hooks/triggers/"+e.className+"/"+e.triggerName,delete e.className,delete e.triggerName}return this.sendRequest("PUT",t,{__op:"Delete"})},update(e){var t;if(e.functionName&&e.url)t="/hooks/functions/"+e.functionName,delete e.functionName;else{if(!(e.className&&e.triggerName&&e.url))return Promise.reject({error:"invalid hook declaration",code:143});t="/hooks/triggers/"+e.className+"/"+e.triggerName,delete e.className,delete e.triggerName}return this.sendRequest("PUT",t,e)},sendRequest:(e,t,r)=>i.default.getRESTController().request(e,t,r,{useMasterKey:!0}).then(e=>{var t=(0,l.default)(e);return t?c.default.as(t):c.default.error(new u.default(u.default.INVALID_JSON,"The server returned an invalid response."))})};i.default.setHooksController(d)}])},function(e,t){e.exports=r(5)},function(e,t){e.exports=r(2)},function(e,t){e.exports=r(3)}])})},function(e,t){e.exports=require("events")},function(e,t){e.exports=require("ws")},function(module,exports,__webpack_require__){!function(e,t){module.exports=t()}("undefined"!=typeof self&&self,function(){return function(e){function t(s){if(r[s])return r[s].exports;var n=r[s]={i:s,l:!1,exports:{}};return e[s].call(n.exports,n,n.exports,t),n.l=!0,n.exports}var r={};return t.m=e,t.c=r,t.d=function(e,r,s){t.o(e,r)||Object.defineProperty(e,r,{configurable:!1,enumerable:!0,get:s})},t.n=function(e){var r=e&&e.__esModule?function(){return e.default}:function(){return e};return t.d(r,"a",r),r},t.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},t.p="",t(t.s=59)}([function(e,t){e.exports=__webpack_require__(1)},function(e,t,r){"use strict";function s(){return i}Object.defineProperty(t,"__esModule",{value:!0}),t.setLogger=function(e){i=e},t.getLogger=s;var n=function(e){return e&&e.__esModule?e:{default:e}}(r(10)),o=r(32),a=r(34);let i=function(){const e={logsFolder:n.default.logsFolder,jsonLogs:n.default.jsonLogs,verbose:n.default.verbose,silent:n.default.silent},t=new o.WinstonLoggerAdapter(e);return new a.LoggerController(t,null,e)}();Object.defineProperty(e.exports,"default",{get:s}),Object.defineProperty(e.exports,"logger",{get:s})},function(e,t,r){"use strict";function s(e){return e&&e.__esModule?e:{default:e}}function n(e,t){if("className"==e){if(t.match(/_?[A-Za-z][A-Za-z_0-9]*/))return t}else{if("objectId"!=e)return t;if(t.match(/[A-Za-z0-9]+/))return t}}function o(e,t){return function(e,r,s){try{const n=function(e){let t=e.originalUrl.toString();"GET"===e.method&&e.originalUrl.includes("/login")&&!e.originalUrl.includes("classes")&&(t=l.default.maskSensitiveUrl(t));return t}(e),o=Object.assign({},e.body),a=e.method,i=e.headers;l.default.logRequest({method:a,url:n,headers:i,body:o}),t(e).then(e=>{if(!e.response&&!e.location&&!e.text)throw l.default.error('the handler did not include a "response" or a "location" field'),"control should not get here";l.default.logResponse({method:a,url:n,result:e});var t=e.status||200;r.status(t),e.text?r.send(e.text):!e.location||(r.set("Location",e.location),e.response)?(e.headers&&Object.keys(e.headers).forEach(t=>{r.set(t,e.headers[t])}),r.json(e.response)):r.send("Found. Redirecting to "+e.location)},e=>{l.default.error(`Error generating response. ${(0,u.inspect)(e)}`,{error:e}),s(e)})}catch(e){l.default.error(`Error handling request: ${(0,u.inspect)(e)}`,{error:e}),s(e)}}}Object.defineProperty(t,"__esModule",{value:!0});var a=s(r(0)),i=s(r(24)),l=s(r(1)),u=r(77);const c=r(78);t.default=class{constructor(e=[],t){this.routes=e,this.appId=t,this.mountRoutes()}mountRoutes(){}merge(e){for(var t of e.routes)this.routes.push(t)}route(e,t,...r){switch(e){case"POST":case"GET":case"PUT":case"DELETE":break;default:throw"cannot route method: "+e}let s=r[0];r.length>1&&(s=function(e){return r.reduce((t,r)=>t.then(()=>r(e)),Promise.resolve())}),this.routes.push({path:t,method:e,handler:s,layer:new c(t,null,s)})}match(e,t){for(var r of this.routes){if(r.method!=e)continue;const s=r.layer||new c(r.path,null,r.handler);if(s.match(t)){const e=s.params;return Object.keys(e).forEach(t=>{e[t]=n(t,e[t])}),{params:e,handler:r.handler}}}}mountOnto(e){return this.routes.forEach(t=>{const r=t.method.toLowerCase(),s=o(this.appId,t.handler);e[r].call(e,t.path,s)}),e}expressRouter(){return this.mountOnto(i.default.Router())}tryRouteRequest(e,t,r){var s=this.match(e,t);if(!s)throw new a.default.Error(a.default.Error.INVALID_JSON,"cannot route "+e+" "+t);return r.params=s.params,new Promise((e,t)=>{s.handler(r).then(e,t)})}}},function(e,t){e.exports=__webpack_require__(6)},function(e,t,r){"use strict";function s(e,t,r){return r.some(r=>d.getTrigger(e,d.Types[r],t.applicationId))}function n(e,t){return t.liveQueryController&&t.liveQueryController.hasLiveQuery(e)}function o(e,t,r,s,n,o){return a("find",r,t),d.maybeRunQueryTrigger(d.Types.beforeFind,r,s,n,e,t).then(a=>{s=a.restWhere||s,n=a.restOptions||n;return new u(e,t,r,s,n,o).execute()})}function a(e,t,r){if("_Installation"===t&&!r.isMaster&&("delete"===e||"find"===e)){const t=`Clients aren't allowed to perform the ${e} operation on the installation collection.`;throw new l.Error(l.Error.OPERATION_FORBIDDEN,t)}if(h.indexOf(t)>=0&&!r.isMaster){const r=`Clients aren't allowed to perform the ${e} operation on the ${t} collection.`;throw new l.Error(l.Error.OPERATION_FORBIDDEN,r)}if(r.isReadOnly&&("delete"===e||"create"===e||"update"===e)){const t=`read-only masterKey isn't allowed to perform the ${e} operation.`;throw new l.Error(l.Error.OPERATION_FORBIDDEN,t)}if(r.isAnonymousForbid&&("find"===e||"get"===e||"delete"===e||"create"===e||"update"===e)){const t=`anonymous  user isn't allowed to perform the ${e} operation.`;throw new l.Error(l.Error.OPERATION_FORBIDDEN,t)}}var i=function(e){return e&&e.__esModule?e:{default:e}}(r(6)),l=r(0).Mmbs,u=r(17),c=r(23),d=r(9);const h=["_JobStatus","_PushStatus","_Hooks","_GlobalConfig","_JobSchedule"];e.exports={create:function(e,t,r,s,n){return a("create",r,t),new c(e,t,r,null,s,null,n).execute()},del:function(e,t,r,u){if("string"!=typeof u)throw new l.Error(l.Error.INVALID_JSON,"bad objectId");if("_User"===r&&!t.couldUpdateUserId(u))throw new l.Error(l.Error.SESSION_MISSING,"insufficient auth to delete user");a("delete",r,t);var c;return Promise.resolve().then(()=>{const a=s(r,e,["beforeDelete","afterDelete"]),h=n(r,e);return a||h||"_Session"==r?o(e,i.default.master(e),r,{objectId:u}).then(s=>{if(s&&s.results&&s.results.length){const n=s.results[0];if(n.className=r,!("_Session"!==r||t.isMaster||t.user&&n.user.objectId===t.user.id))throw new l.Error(l.Error.INVALID_SESSION_TOKEN,"invalid session token");return e.cacheController.user.del(n.sessionToken),c=l.Object.fromJSON(n),e.liveQueryController.onAfterDelete(c.className,c),d.maybeRunTrigger(d.Types.beforeDelete,t,c,null,e)}throw new l.Error(l.Error.OBJECT_NOT_FOUND,"Object not found for delete.")}):Promise.resolve({})}).then(()=>t.isMaster?void 0:t.getUserRoles()).then(()=>{var s={};return t.isMaster||(s.acl=["*"],t.user&&(s.acl.push(t.user.id),s.acl=s.acl.concat(t.userRoles))),e.database.destroy(r,{objectId:u},s)}).then(()=>d.maybeRunTrigger(d.Types.afterDelete,t,c,null,e))},find:o,get:(e,t,r,s,n,o)=>{var i={objectId:s};return a("get",r,t),d.maybeRunQueryTrigger(d.Types.beforeFind,r,i,n,e,t,!0).then(s=>(i=s.restWhere||i,n=s.restOptions||n,new u(e,t,r,i,n,o).execute()))},update:function(e,t,r,l,u,d){return a("update",r,t),Promise.resolve().then(()=>{const t=s(r,e,["beforeSave","afterSave"]),a=n(r,e);return t||a?o(e,i.default.master(e),r,l):Promise.resolve({})}).then(s=>{var n;return s&&s.results&&s.results.length&&(n=s.results[0]),new c(e,t,r,l,u,n,d).execute()})}}},function(e,t,r){"use strict";function s(e){return e&&e.__esModule?e:{default:e}}function n(e,t){t.status(403),t.end('{"error":"unauthorized"}')}Object.defineProperty(t,"__esModule",{value:!0}),t.handleMmbsHeaders=function(e,t,r){var s=e.originalUrl.length-e.url.length,d=e.originalUrl.slice(0,s),h=e.protocol+"://"+e.get("host")+d,f={appId:e.get("X-Mmbs-Application-Id"),sessionToken:e.get("X-Mmbs-Session-Token"),masterKey:e.get("X-Mmbs-Master-Key"),allowAnonymousKey:e.get("X-Mmbs-AllowAnonymous-Key"),installationId:e.get("X-Mmbs-Installation-Id"),clientKey:e.get("X-Mmbs-Client-Key"),javascriptKey:e.get("X-Mmbs-Javascript-Key"),dotNetKey:e.get("X-Mmbs-Windows-Key"),restAPIKey:e.get("X-Mmbs-REST-API-Key"),clientVersion:e.get("X-Mmbs-Client-Version")},p=function(e){if((e.req||e).headers.authorization){var t,r,s,n,o=(e.req||e).headers.authorization;if(0==o.toLowerCase().indexOf("basic ")){var a=o.substring("basic ".length,o.length),i=function(e){return new Buffer(e,"base64").toString()}(a).split(":");if(2==i.length){t=i[0];var l=i[1],u=l.indexOf("javascript-key=");0==u?s=l.substring("javascript-key=".length,l.length):r=l;let e=(l=r).indexOf("allow_anonymous_key=");0==e?n=l.substring("allow_anonymous_key=".length,l.length):r=l}}return{appId:t,masterKey:r,javascriptKey:s,allowAnonymousKey:n}}}(e);if(p){var m=p.appId;o.default.get(m)&&(f.appId=m,f.masterKey=p.masterKey||f.masterKey,f.javascriptKey=p.javascriptKey||f.javascriptKey,f.allowAnonymousKey=p.allowAnonymousKey||f.allowAnonymousKey)}e.body&&delete e.body._noBody;var _=!1;if(!f.appId||!o.default.get(f.appId)){if(e.body instanceof Buffer&&(e.body=JSON.parse(e.body),_=!0),e.body&&delete e.body._RevocableSession,!(e.body&&e.body._ApplicationId&&o.default.get(e.body._ApplicationId))||f.masterKey&&o.default.get(e.body._ApplicationId).masterKey!==f.masterKey)return n(0,t);f.appId=e.body._ApplicationId,f.javascriptKey=e.body._JavaScriptKey||"",delete e.body._ApplicationId,delete e.body._JavaScriptKey,e.body._ClientVersion&&(f.clientVersion=e.body._ClientVersion,delete e.body._ClientVersion),e.body._InstallationId&&(f.installationId=e.body._InstallationId,delete e.body._InstallationId),e.body._SessionToken&&(f.sessionToken=e.body._SessionToken,delete e.body._SessionToken),e.body._AllowAnonymousKey&&(f.allowAnonymousKey=e.body._AllowAnonymousKey,delete e.body._AllowAnonymousKey),e.body._MasterKey&&(f.masterKey=e.body._MasterKey,delete e.body._MasterKey),e.body._ContentType&&(e.headers["content-type"]=e.body._ContentType,delete e.body._ContentType)}if(f.clientVersion&&(f.clientSDK=c.default.fromString(f.clientVersion)),_){var y=e.body.base64;e.body=new Buffer(y,"base64")}const b=function(e){return e.headers["x-forwarded-for"]?e.headers["x-forwarded-for"].split(",")[0]:e.connection&&e.connection.remoteAddress?e.connection.remoteAddress:e.socket?e.socket.remoteAddress:e.connection&&e.connection.socket?e.connection.socket.remoteAddress:e.ip}(e);if(f.app=o.default.get(f.appId),e.config=u.default.get(f.appId,h),e.config.headers=e.headers||{},e.config.ip=b,e.info=f,f.masterKey&&e.config.masterKeyIps&&0!==e.config.masterKeyIps.length&&-1===e.config.masterKeyIps.indexOf(b))return n(0,t);if(f.masterKey===e.config.masterKey)return e.auth=new l.default.Auth({config:e.config,installationId:f.installationId,isMaster:!0}),void r();var g=f.masterKey===e.config.readOnlyMasterKey;if(void 0!==e.config.readOnlyMasterKey&&e.config.readOnlyMasterKey&&g)return e.auth=new l.default.Auth({config:e.config,installationId:f.installationId,isMaster:!0,isReadOnly:!0}),void r();const v=["clientKey","javascriptKey","dotNetKey","restAPIKey"],E=v.some(function(t){return void 0!==e.config[t]}),S=v.some(function(t){return void 0!==e.config[t]&&f[t]===e.config[t]});if(E&&!S)return n(0,t);if("/login"==e.url&&delete f.sessionToken,!f.sessionToken){let t=!1;if(!0===e.config.isForbidAnonymousUser){t="/login"!=e.url;let r=f.allowAnonymousKey===e.config.allowAnonymousKey;void 0!==e.config.allowAnonymousKey&&e.config.allowAnonymousKey&&r&&(t=!1)}return e.auth=new l.default.Auth({config:e.config,installationId:f.installationId,isMaster:!1,isAnonymousForbid:t}),void r()}return Promise.resolve().then(()=>f.sessionToken&&"/upgradeToRevocableSession"===e.url&&0!=f.sessionToken.indexOf("r:")?l.default.getAuthForLegacySessionToken({config:e.config,installationId:f.installationId,sessionToken:f.sessionToken}):l.default.getAuthForSessionToken({config:e.config,installationId:f.installationId,sessionToken:f.sessionToken})).then(t=>{t&&(e.auth=t,r())}).catch(e=>{if(!(e instanceof i.default.Error))throw a.default.error("error getting auth for sessionToken",e),new i.default.Error(i.default.Error.UNKNOWN_ERROR,e);r(e)})},t.allowCrossDomain=function(e,t,r){t.header("Access-Control-Allow-Origin","*"),t.header("Access-Control-Allow-Methods","GET,PUT,POST,DELETE,OPTIONS"),t.header("Access-Control-Allow-Headers","X-Mmbs-Master-Key, X-Mmbs-REST-API-Key, X-Mmbs-Javascript-Key, X-Mmbs-Application-Id, X-Mmbs-Client-Version, X-Mmbs-Session-Token, X-Requested-With, X-Mmbs-Revocable-Session, Content-Type"),"OPTIONS"==e.method?t.sendStatus(200):r()},t.allowMethodOverride=function(e,t,r){"POST"===e.method&&e.body._method&&(e.originalMethod=e.method,e.method=e.body._method,delete e.body._method),r()},t.handleMmbsErrors=function(e,t,r,s){if(e instanceof i.default.Error){let t;switch(e.code){case i.default.Error.INTERNAL_SERVER_ERROR:t=500;break;case i.default.Error.OBJECT_NOT_FOUND:t=404;break;default:t=400}r.status(t),r.json({code:e.code,error:e.message}),a.default.error(e.message,e)}else e.status&&e.message?(r.status(e.status),r.json({error:e.message}),s(e)):(a.default.error("Uncaught internal server error.",e,e.stack),r.status(500),r.json({code:i.default.Error.INTERNAL_SERVER_ERROR,message:"Internal server error."}),s(e))},t.enforceMasterKeyAccess=function(e,t,r){if(!e.auth.isMaster)return t.status(403),void t.end('{"error":"unauthorized: master key is required"}');r()},t.promiseEnforceMasterKeyAccess=function(e){if(!e.auth.isMaster){const e=new Error;throw e.status=403,e.message="unauthorized: master key is required",e}return Promise.resolve()};var o=s(r(20)),a=s(r(1)),i=s(r(0)),l=s(r(6)),u=s(r(8)),c=s(r(38))},function(e,t,r){"use strict";function s({config:e,isMaster:t=!1,isReadOnly:r=!1,user:s,installationId:n,isAnonymousForbid:o=!1}={}){this.config=e,this.installationId=n,this.isMaster=t,this.user=s,this.isReadOnly=r,this.isAnonymousForbid=o,this.userRoles=[],this.fetchedRoles=!1,this.rolePromise=null}function n(e){return new s({config:e,isMaster:!0})}var o=r(0).Mmbs,a=r(17);s.prototype.couldUpdateUserId=function(e){return!!this.isMaster||(!(!this.user||this.user.id!==e)||(!this.config||1!=this.config.forbidUpdateUser))};s.prototype.getUserRoles=function(){return this.isMaster||!this.user?Promise.resolve([]):this.fetchedRoles?Promise.resolve(this.userRoles):this.rolePromise?this.rolePromise:(this.rolePromise=this._loadRoles(),this.rolePromise)},s.prototype._loadRoles=function(){var e=this.config.cacheController;return e.role.get(this.user.id).then(t=>{if(null!=t)return this.fetchedRoles=!0,this.userRoles=t,Promise.resolve(t);var r={users:{__type:"Pointer",className:"_User",objectId:this.user.id}};return new a(this.config,n(this.config),"_Role",r,{}).execute().then(t=>{var r=t.results;if(!r.length)return this.userRoles=[],this.fetchedRoles=!0,this.rolePromise=null,e.role.put(this.user.id,Array(...this.userRoles)),Promise.resolve(this.userRoles);var s=r.reduce((e,t)=>(e.names.push(t.name),e.ids.push(t.objectId),e),{ids:[],names:[]});return this._getAllRolesNamesForRoleIds(s.ids,s.names).then(t=>(this.userRoles=t.map(e=>"role:"+e),this.fetchedRoles=!0,this.rolePromise=null,e.role.put(this.user.id,Array(...this.userRoles)),Promise.resolve(this.userRoles)))})})},s.prototype._getAllRolesNamesForRoleIds=function(e,t=[],r={}){const s=e.filter(e=>!0!==r[e]).map(e=>(r[e]=!0,{__type:"Pointer",className:"_Role",objectId:e}));if(0==s.length)return Promise.resolve([...new Set(t)]);let o;o=1==s.length?{roles:s[0]}:{roles:{$in:s}};return new a(this.config,n(this.config),"_Role",o,{}).execute().then(e=>{var s=e.results;if(!s.length)return Promise.resolve(t);const n=s.reduce((e,t)=>(e.names.push(t.name),e.ids.push(t.objectId),e),{ids:[],names:[]});return t=t.concat(n.names),this._getAllRolesNamesForRoleIds(n.ids,t,r)}).then(e=>Promise.resolve([...new Set(e)]))},e.exports={Auth:s,master:n,nobody:function(e){return new s({config:e,isMaster:!1})},readOnly:function(e){return new s({config:e,isMaster:!0,isReadOnly:!0})},getAuthForSessionToken:function({config:e,sessionToken:t,installationId:r}={}){return e.cacheController.user.get(t).then(i=>{if(i){const t=o.Object.fromJSON(i);return Promise.resolve(new s({config:e,isMaster:!1,installationId:r,user:t}))}return new a(e,n(e),"_Session",{sessionToken:t},{limit:1,include:"user"}).execute().then(n=>{var a=n.results;if(1!==a.length||!a[0].user)throw new o.Error(o.Error.INVALID_SESSION_TOKEN,"invalid session token");var i=new Date;if((a[0].expiresAt?new Date(a[0].expiresAt.iso):void 0)<i)throw new o.Error(o.Error.INVALID_SESSION_TOKEN,"Session token is expired.");var l=a[0].user;delete l.password,l.className="_User",l.sessionToken=t,e.cacheController.user.put(t,l);const u=o.Object.fromJSON(l);return new s({config:e,isMaster:!1,installationId:r,user:u})})})},getAuthForLegacySessionToken:function({config:e,sessionToken:t,installationId:r}={}){return new a(e,n(e),"_User",{sessionToken:t},{limit:1}).execute().then(t=>{var n=t.results;if(1!==n.length)throw new o.Error(o.Error.INVALID_SESSION_TOKEN,"invalid legacy session token");const a=n[0];a.className="_User";const i=o.Object.fromJSON(a);return new s({config:e,isMaster:!1,installationId:r,user:i})})}}},function(e,t){e.exports=__webpack_require__(7)},function(e,t,r){"use strict";function s(e){return e&&e.__esModule?e:{default:e}}Object.defineProperty(t,"__esModule",{value:!0}),t.Config=void 0;var n=s(r(20)),o=s(r(35)),a=s(r(36)),i=s(r(67));class l{static get(e,t){const r=n.default.get(e);if(!r)return;const s=new l;return s.applicationId=e,Object.keys(r).forEach(e=>{if("databaseController"==e){const e=new o.default(r.cacheController,r.schemaCacheTTL,r.enableSingleSchemaCache);s.database=new a.default(r.databaseController.adapter,e)}else s[e]=r[e]}),s.mount=function(e){return e?(e.endsWith("/")&&(e=e.substr(0,e.length-1)),e):e}(t),s.generateSessionExpiresAt=s.generateSessionExpiresAt.bind(s),s.generateEmailVerifyTokenExpiresAt=s.generateEmailVerifyTokenExpiresAt.bind(s),s}static put(e){return l.validate(e),n.default.put(e.appId,e),l.setupPasswordValidator(e.passwordPolicy),e}static validate({verifyUserEmails:e,userController:t,appName:r,publicServerURL:s,revokeSessionOnPasswordReset:n,expireInactiveSessions:o,sessionLength:a,maxLimit:i,emailVerifyTokenValidityDuration:l,accountLockout:u,passwordPolicy:c,masterKeyIps:d,masterKey:h,readOnlyMasterKey:f,allowAnonymousKey:p}){if(h===f)throw new Error("masterKey and readOnlyMasterKey should be different");if(h===p)throw new Error("masterKey and allowAnonymousKey should be different");if(f===p)throw new Error("readOnlyMasterKey and allowAnonymousKey should be different");const m=t.adapter;if(e&&this.validateEmailConfiguration({emailAdapter:m,appName:r,publicServerURL:s,emailVerifyTokenValidityDuration:l}),this.validateAccountLockoutPolicy(u),this.validatePasswordPolicy(c),"boolean"!=typeof n)throw"revokeSessionOnPasswordReset must be a boolean value";if(s&&!s.startsWith("http://")&&!s.startsWith("https://"))throw"publicServerURL should be a valid HTTPS URL starting with https://";this.validateSessionConfiguration(a,o),this.validateMasterKeyIps(d),this.validateMaxLimit(i)}static validateAccountLockoutPolicy(e){if(e){if("number"!=typeof e.duration||e.duration<=0||e.duration>99999)throw"Account lockout duration should be greater than 0 and less than 100000";if(!Number.isInteger(e.threshold)||e.threshold<1||e.threshold>999)throw"Account lockout threshold should be an integer greater than 0 and less than 1000"}}static validatePasswordPolicy(e){if(e){if(void 0!==e.maxPasswordAge&&("number"!=typeof e.maxPasswordAge||e.maxPasswordAge<0))throw"passwordPolicy.maxPasswordAge must be a positive number";if(void 0!==e.resetTokenValidityDuration&&("number"!=typeof e.resetTokenValidityDuration||e.resetTokenValidityDuration<=0))throw"passwordPolicy.resetTokenValidityDuration must be a positive number";if(e.validatorPattern)if("string"==typeof e.validatorPattern)e.validatorPattern=new RegExp(e.validatorPattern);else if(!(e.validatorPattern instanceof RegExp))throw"passwordPolicy.validatorPattern must be a regex string or RegExp object.";if(e.validatorCallback&&"function"!=typeof e.validatorCallback)throw"passwordPolicy.validatorCallback must be a function.";if(e.doNotAllowUsername&&"boolean"!=typeof e.doNotAllowUsername)throw"passwordPolicy.doNotAllowUsername must be a boolean value.";if(e.maxPasswordHistory&&(!Number.isInteger(e.maxPasswordHistory)||e.maxPasswordHistory<=0||e.maxPasswordHistory>20))throw"passwordPolicy.maxPasswordHistory must be an integer ranging 0 - 20"}}static setupPasswordValidator(e){e&&e.validatorPattern&&(e.patternValidator=(t=>e.validatorPattern.test(t)))}static validateEmailConfiguration({emailAdapter:e,appName:t,publicServerURL:r,emailVerifyTokenValidityDuration:s}){if(!e)throw"An emailAdapter is required for e-mail verification and password resets.";if("string"!=typeof t)throw"An app name is required for e-mail verification and password resets.";if("string"!=typeof r)throw"A public server url is required for e-mail verification and password resets.";if(s){if(isNaN(s))throw"Email verify token validity duration must be a valid number.";if(s<=0)throw"Email verify token validity duration must be a value greater than 0."}}static validateMasterKeyIps(e){for(const t of e)if(!i.default.isIP(t))throw`Invalid ip in masterKeyIps: ${t}`}get mount(){var e=this._mount;return this.publicServerURL&&(e=this.publicServerURL),e}set mount(e){this._mount=e}static validateSessionConfiguration(e,t){if(t){if(isNaN(e))throw"Session length must be a valid number.";if(e<=0)throw"Session length must be a value greater than 0."}}static validateMaxLimit(e){if(e<=0)throw"Max limit must be a value greater than 0."}generateEmailVerifyTokenExpiresAt(){if(this.verifyUserEmails&&this.emailVerifyTokenValidityDuration){var e=new Date;return new Date(e.getTime()+1e3*this.emailVerifyTokenValidityDuration)}}generatePasswordResetTokenExpiresAt(){if(!this.passwordPolicy||!this.passwordPolicy.resetTokenValidityDuration)return;const e=new Date;return new Date(e.getTime()+1e3*this.passwordPolicy.resetTokenValidityDuration)}generateSessionExpiresAt(){if(this.expireInactiveSessions){var e=new Date;return new Date(e.getTime()+1e3*this.sessionLength)}}get invalidLinkURL(){return this.customPages.invalidLink||`${this.publicServerURL}/apps/invalid_link.html`}get invalidVerificationLinkURL(){return this.customPages.invalidVerificationLink||`${this.publicServerURL}/apps/invalid_verification_link.html`}get linkSendSuccessURL(){return this.customPages.linkSendSuccess||`${this.publicServerURL}/apps/link_send_success.html`}get linkSendFailURL(){return this.customPages.linkSendFail||`${this.publicServerURL}/apps/link_send_fail.html`}get verifyEmailSuccessURL(){return this.customPages.verifyEmailSuccess||`${this.publicServerURL}/apps/verify_email_success.html`}get choosePasswordURL(){return this.customPages.choosePassword||`${this.publicServerURL}/apps/choose_password`}get requestResetPasswordURL(){return`${this.publicServerURL}/apps/${this.applicationId}/request_password_reset`}get passwordResetSuccessURL(){return this.customPages.passwordResetSuccess||`${this.publicServerURL}/apps/password_reset_success.html`}get parseFrameURL(){return this.customPages.parseFrameURL}get verifyEmailURL(){return`${this.publicServerURL}/apps/${this.applicationId}/verify_email`}}t.Config=l,t.default=l,e.exports=l},function(e,t,r){"use strict";function s(e,t,r){if(!r)throw"Missing ApplicationID";var s=p[r];if(s&&s.Triggers&&s.Triggers[t]&&s.Triggers[t][e])return s.Triggers[t][e]}function n(e,t,r,s,n){var o={triggerName:e,object:r,master:!1,log:n.loggerController,headers:n.headers,ip:n.ip};return s&&(o.original=s),t?(t.isMaster&&(o.master=!0),t.user&&(o.user=t.user),t.installationId&&(o.installationId=t.installationId),o):o}function o(e,t,r,s,n,o){o=!!o;var a={triggerName:e,query:r,master:!1,count:s,log:n.loggerController,isGet:o,headers:n.headers,ip:n.ip};return t?(t.isMaster&&(a.master=!0),t.user&&(a.user=t.user),t.installationId&&(a.installationId=t.installationId),a):a}function a(e,t,r){return{success:function(r){return e.triggerName===h.afterFind?(r||(r=e.objects),r=r.map(e=>e.toJSON()),t(r)):r&&!e.object.equals(r)&&e.triggerName===h.beforeSave?t(r):(r={},e.triggerName===h.beforeSave&&(r.object=e.object._getSaveJSON()),t(r))},error:function(e,t){t||(t=e,e=c.default.Error.SCRIPT_FAILED);var s=new c.default.Error(e,t);return r(s)}}}function i(e){return e&&e.user?e.user.id:void 0}function l(e,t,r,s){const n=d.logger.truncateLogMessage(JSON.stringify(r));d.logger.info(`${e} triggered for ${t} for user ${i(s)}:\n  Input: ${n}`,{className:t,triggerType:e,user:i(s)})}function u(e,t,r,s,n){const o=d.logger.truncateLogMessage(JSON.stringify(r)),a=d.logger.truncateLogMessage(JSON.stringify(s));d.logger.info(`${e} triggered for ${t} for user ${i(n)}:\n  Input: ${o}\n  Result: ${a}`,{className:t,triggerType:e,user:i(n)})}Object.defineProperty(t,"__esModule",{value:!0}),t.Types=void 0,t.addFunction=function(e,t,r,s){s=s||c.default.applicationId,p[s]=p[s]||f(),p[s].Functions[e]=t,p[s].Validators[e]=r},t.addJob=function(e,t,r){r=r||c.default.applicationId,p[r]=p[r]||f(),p[r].Jobs[e]=t},t.addTrigger=function(e,t,r,s){!function(e,t){if(-1!=["_Session"].indexOf(e))throw`Triggers are not supported for ${e} class.`;if(t==h.beforeSave&&"_PushStatus"===e)throw"Only afterSave is allowed on _PushStatus"}(t,e),s=s||c.default.applicationId,p[s]=p[s]||f(),p[s].Triggers[e][t]=r},t.addLiveQueryEventHandler=function(e,t){t=t||c.default.applicationId,p[t]=p[t]||f(),p[t].LiveQuery.push(e)},t.removeJob=function(e,t){t=t||c.default.applicationId,delete p[t].Jobs[e]},t.removeFunction=function(e,t){t=t||c.default.applicationId,delete p[t].Functions[e]},t.removeTrigger=function(e,t,r){r=r||c.default.applicationId,delete p[r].Triggers[e][t]},t._unregisterAll=function(){Object.keys(p).forEach(e=>delete p[e])},t.getTrigger=s,t.triggerExists=function(e,t,r){return void 0!=s(e,t,r)},t.getFunction=function(e,t){var r=p[t];if(r&&r.Functions)return r.Functions[e]},t.getJob=function(e,t){var r=p[t];if(r&&r.Jobs)return r.Jobs[e]},t.getJobs=function(e){var t=p[e];if(t&&t.Jobs)return t.Jobs},t.getValidator=function(e,t){var r=p[t];if(r&&r.Validators)return r.Validators[e]},t.getRequestObject=n,t.getRequestQueryObject=o,t.getResponseObject=a,t.maybeRunAfterFindTrigger=function(e,t,r,o,i){return new Promise((l,d)=>{const h=s(r,e,i.applicationId);if(!h)return l();const f=n(e,t,null,null,i),p=a(f,e=>{l(e)},e=>{d(e)});u(e,r,"AfterFind",JSON.stringify(o),t),f.objects=o.map(e=>(e.className=r,c.default.Object.fromJSON(e)));const m=h(f,p);return m&&"function"==typeof m.then?m.then(e=>{if(!e)return d(new c.default.Error(c.default.Error.SCRIPT_FAILED,"AfterFind expect results to be returned in the promise"));l(e)}):void 0}).then(s=>(l(e,r,JSON.stringify(s),t),s))},t.maybeRunQueryTrigger=function(e,t,r,n,a,i,l){const u=s(t,e,a.applicationId);if(!u)return Promise.resolve({restWhere:r,restOptions:n});const d=new c.default.Query(t);r&&(d._where=r);let h=!1;n&&(n.include&&n.include.length>0&&(d._include=n.include.split(",")),n.skip&&(d._skip=n.skip),n.limit&&(d._limit=n.limit),h=!!n.count);const f=o(e,i,d,h,a,l);return Promise.resolve().then(()=>u(f)).then(e=>{let t=d;e&&e instanceof c.default.Query&&(t=e);const s=t.toJSON();return s.where&&(r=s.where),s.limit&&((n=n||{}).limit=s.limit),s.skip&&((n=n||{}).skip=s.skip),s.include&&((n=n||{}).include=s.include),s.keys&&((n=n||{}).keys=s.keys),f.readPreference&&((n=n||{}).readPreference=f.readPreference),f.includeReadPreference&&((n=n||{}).includeReadPreference=f.includeReadPreference),f.subqueryReadPreference&&((n=n||{}).subqueryReadPreference=f.subqueryReadPreference),{restWhere:r,restOptions:n}},e=>{throw"string"==typeof e?new c.default.Error(1,e):e})},t.maybeRunTrigger=function(e,t,r,o,f){return r?new Promise(function(p,m){var _=s(r.className,e,f.applicationId);if(!_)return p();var y=n(e,t,r,o,f),b=a(y,s=>{u(e,r.className,r.toJSON(),s,t),p(s)},s=>{!function(e,t,r,s,n){const o=d.logger.truncateLogMessage(JSON.stringify(r));d.logger.error(`${e} failed for ${t} for user ${i(s)}:\n  Input: ${o}\n  Error: ${JSON.stringify(n)}`,{className:t,triggerType:e,error:n,user:i(s)})}(e,r.className,r.toJSON(),t,s),m(s)});c.default.applicationId=f.applicationId,c.default.javascriptKey=f.javascriptKey||"",c.default.masterKey=f.masterKey;var g=_(y,b);return e===h.afterSave||e===h.afterDelete?(l(e,r.className,r.toJSON(),t),g&&"function"==typeof g.then?g.then(p,p):p()):void 0}):Promise.resolve({})},t.inflate=function(e,t){var r="object"==typeof e?e:{className:e};for(var s in t)r[s]=t[s];return c.default.Object.fromJSON(r)},t.runLiveQueryEventHandlers=function(e,t=c.default.applicationId){p&&p[t]&&p[t].LiveQuery&&p[t].LiveQuery.forEach(t=>t(e))};var c=function(e){return e&&e.__esModule?e:{default:e}}(r(0)),d=r(1);const h=t.Types={beforeSave:"beforeSave",afterSave:"afterSave",beforeDelete:"beforeDelete",afterDelete:"afterDelete",beforeFind:"beforeFind",afterFind:"afterFind"},f=function(){const e=Object.keys(h).reduce(function(e,t){return e[t]={},e},{});return Object.freeze({Functions:{},Jobs:{},Validators:{},Triggers:e,LiveQuery:[]})},p={}},function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.DefaultMongoURI=void 0;var s=r(31);const{MmbsServerOptions:n}=r(61),o=(()=>{let e="./logs/";return"undefined"!=typeof process&&"1"===process.env.TESTING&&(e="./test_logs/"),process.env.MMBS_SERVER_LOGS_FOLDER&&(e=(0,s.nullParser)(process.env.MMBS_SERVER_LOGS_FOLDER)),e})(),{verbose:a,level:i}=(()=>{const e=!!process.env.VERBOSE;return{verbose:e,level:e?"verbose":void 0}})(),l=Object.keys(n).reduce((e,t)=>{const r=n[t];return r.hasOwnProperty("default")&&(e[t]=r.default),e},{}),u={jsonLogs:process.env.JSON_LOGS||!1,logsFolder:o,verbose:a,level:i};t.default=Object.assign({},l,u);t.DefaultMongoURI=l.databaseURI},function(e,t){e.exports=__webpack_require__(8)},function(e,t,r){"use strict";function s(e){if(0===e)throw new Error("Zero-length randomHexString is useless.");if(e%2!=0)throw new Error("randomHexString size must be divisible by 2.");return(0,o.randomBytes)(e/2).toString("hex")}function n(e){if(0===e)throw new Error("Zero-length randomString is useless.");const t="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789";let r="";const s=(0,o.randomBytes)(e);for(let e=0;e<s.length;++e)r+=t[s.readUInt8(e)%t.length];return r}Object.defineProperty(t,"__esModule",{value:!0}),t.randomHexString=s,t.randomString=n,t.newObjectId=function(e=10){return n(e)},t.newToken=function(){return s(32)},t.md5Hash=function(e){return(0,o.createHash)("md5").update(e).digest("hex")};var o=r(28)},function(e,t,r){"use strict";function s(e){return e&&e.__esModule?e:{default:e}}Object.defineProperty(t,"__esModule",{value:!0}),t.ClassesRouter=void 0;var n=s(r(2)),o=s(r(4)),a=s(r(7)),i=s(r(0));const l=["keys","include"];class u extends n.default{className(e){return e.params.className}handleFind(e){const t=Object.assign(e.body,u.JSONFromQuery(e.query)),r=u.optionsFromBody(t);return e.config.maxLimit&&t.limit>e.config.maxLimit&&(r.limit=Number(e.config.maxLimit)),t.redirectClassNameForKey&&(r.redirectClassNameForKey=String(t.redirectClassNameForKey)),"string"==typeof t.where&&(t.where=JSON.parse(t.where)),o.default.find(e.config,e.auth,this.className(e),t.where,r,e.info.clientSDK).then(e=>({response:e}))}handleGet(e){const t=Object.assign(e.body,u.JSONFromQuery(e.query)),r={};for(const e of Object.keys(t))if(-1===l.indexOf(e))throw new i.default.Error(i.default.Error.INVALID_QUERY,"Improper encode of parameter");return"string"==typeof t.keys&&(r.keys=t.keys),t.include&&(r.include=String(t.include)),o.default.get(e.config,e.auth,this.className(e),e.params.objectId,r,e.info.clientSDK).then(t=>{if(!t.results||0==t.results.length)throw new i.default.Error(i.default.Error.OBJECT_NOT_FOUND,"Object not found.");if("_User"===this.className(e)){delete t.results[0].sessionToken;const r=t.results[0];e.auth.user&&r.objectId==e.auth.user.id&&(t.results[0].sessionToken=e.info.sessionToken)}return{response:t.results[0]}})}handleCreate(e){return o.default.create(e.config,e.auth,this.className(e),e.body,e.info.clientSDK)}handleUpdate(e){const t={objectId:e.params.objectId};return o.default.update(e.config,e.auth,this.className(e),t,e.body,e.info.clientSDK)}handleDelete(e){return o.default.del(e.config,e.auth,this.className(e),e.params.objectId,e.info.clientSDK).then(()=>({response:{}}))}static JSONFromQuery(e){const t={};for(const[r,s]of a.default.entries(e))try{t[r]=JSON.parse(s)}catch(e){t[r]=s}return t}static optionsFromBody(e){const t=["skip","limit","order","count","keys","include","redirectClassNameForKey","where"];for(const r of Object.keys(e))if(-1===t.indexOf(r))throw new i.default.Error(i.default.Error.INVALID_QUERY,`Invalid parameter for query: ${r}`);const r={};return e.skip&&(r.skip=Number(e.skip)),e.limit||0===e.limit?r.limit=Number(e.limit):r.limit=Number(100),e.order&&(r.order=String(e.order)),e.count&&(r.count=!0),"string"==typeof e.keys&&(r.keys=e.keys),e.include&&(r.include=String(e.include)),r}mountRoutes(){this.route("GET","/classes/:className",e=>this.handleFind(e)),this.route("GET","/classes/:className/:objectId",e=>this.handleGet(e)),this.route("POST","/classes/:className",e=>this.handleCreate(e)),this.route("PUT","/classes/:className/:objectId",e=>this.handleUpdate(e)),this.route("DELETE","/classes/:className/:objectId",e=>this.handleDelete(e))}}t.ClassesRouter=u,t.default=u},function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.AdaptableController=void 0;var s=function(e){return e&&e.__esModule?e:{default:e}}(r(8)),n=Symbol();class o{constructor(e,t,r){this.options=r,this.appId=t,this.adapter=e}set adapter(e){this.validateAdapter(e),this[n]=e}get adapter(){return this[n]}get config(){return s.default.get(this.appId)}expectedAdapterType(){throw new Error("Subclasses should implement expectedAdapterType()")}validateAdapter(e){o.validateAdapter(e,this)}static validateAdapter(e,t,r){if(!e)throw new Error(this.constructor.name+" requires an adapter");const s=r||t.expectedAdapterType();if(!s)return;const n=Object.getOwnPropertyNames(s.prototype).reduce((t,r)=>{const n=typeof e[r],o=typeof s.prototype[r];return n!==o&&(t[r]={expected:o,actual:n}),t},{});if(Object.keys(n).length>0)throw new Error("Adapter prototype don't match expected prototype",e,n)}}t.AdaptableController=o,t.default=o},function(e,t){e.exports=__webpack_require__(9)},function(e,t){e.exports=__webpack_require__(10)},function(e,t,r){"use strict";function s(e,t,r,s={},n={},o){if(t.isAnonymousForbid){throw new l.Error(l.Error.OPERATION_FORBIDDEN,"anonymous  user cannot perform a query operation")}if(this.config=e,this.auth=t,this.className=r,this.restWhere=s,this.restOptions=n,this.clientSDK=o,this.response=null,this.findOptions={},!this.auth.isMaster&&(this.findOptions.acl=this.auth.user?[this.auth.user.id]:null,"_Session"==this.className)){if(!this.findOptions.acl)throw new l.Error(l.Error.INVALID_SESSION_TOKEN,"This session token is invalid.");this.restWhere={$and:[this.restWhere,{user:{__type:"Pointer",className:"_User",objectId:this.auth.user.id}}]}}if(this.doCount=!1,this.include=[],n.hasOwnProperty("keys")){const e=n.keys.split(",").filter(e=>e.split(".").length>1).map(e=>e.slice(0,e.lastIndexOf("."))).join(",");e.length>0&&(n.include&&0!=n.include.length?n.include+=","+e:n.include=e)}for(var a in n)switch(a){case"keys":{const e=n.keys.split(",").concat(c);this.keys=Array.from(new Set(e));break}case"count":this.doCount=!0;break;case"distinct":case"pipeline":case"skip":case"limit":case"readPreference":this.findOptions[a]=n[a];break;case"order":var i=n.order.split(",");this.findOptions.sort=i.reduce((e,t)=>("$score"===(t=t.trim())?e.score={$meta:"textScore"}:"-"==t[0]?e[t.slice(1)]=-1:e[t]=1,e),{});break;case"include":{const e=n.include.split(",").reduce((e,t)=>t.split(".").reduce((e,t,r,s)=>(e[s.slice(0,r+1).join(".")]=!0,e),e),{});this.include=Object.keys(e).map(e=>e.split(".")).sort((e,t)=>e.length-t.length);break}case"redirectClassNameForKey":this.redirectKey=n.redirectClassNameForKey,this.redirectClassName=null;break;case"includeReadPreference":case"subqueryReadPreference":break;default:throw new l.Error(l.Error.INVALID_JSON,"bad option: "+a)}}function n(e,t){if(e instanceof Array){var r=[];for(var s of e)r=r.concat(n(s,t));return r}if("object"!=typeof e||!e)return[];if(0==t.length)return null===e||"Pointer"==e.__type?[e]:[];var o=e[t[0]];return o?n(o,t.slice(1)):[]}function o(e,t,r){if(e instanceof Array)return e.map(e=>o(e,t,r)).filter(e=>void 0!==e);if("object"!=typeof e||!e)return e;if(0===t.length)return e&&"Pointer"===e.__type?r[e.objectId]:e;var s=e[t[0]];if(!s)return e;var n=o(s,t.slice(1),r),a={};for(var i in e)i==t[0]?a[i]=n:a[i]=e[i];return a}function a(e,t){if("object"==typeof e){if(e instanceof Array)for(var r of e){const e=a(r,t);if(e)return e}if(e&&e[t])return e;for(var s in e){const r=a(e[s],t);if(r)return r}}}var i=r(22),l=r(0).Mmbs;const u=r(9),c=["objectId","createdAt","updatedAt"];s.prototype.execute=function(e){return Promise.resolve().then(()=>this.buildRestWhere()).then(()=>this.runFind(e)).then(()=>this.runCount()).then(()=>this.handleInclude()).then(()=>this.runAfterFindTrigger()).then(()=>this.response)},s.prototype.buildRestWhere=function(){return Promise.resolve().then(()=>this.getUserAndRoleACL()).then(()=>this.redirectClassNameForKey()).then(()=>this.validateClientClassCreation()).then(()=>this.replaceSelect()).then(()=>this.replaceDontSelect()).then(()=>this.replaceInQuery()).then(()=>this.replaceNotInQuery()).then(()=>this.replaceEquality())},s.prototype.getUserAndRoleACL=function(){return this.auth.isMaster||!this.auth.user?Promise.resolve():this.auth.getUserRoles().then(e=>{const t=new Set([].concat(this.findOptions.acl,e));return this.findOptions.acl=Array.from(t),Promise.resolve()})},s.prototype.redirectClassNameForKey=function(){return this.redirectKey?this.config.database.redirectClassNameForKey(this.className,this.redirectKey).then(e=>{this.className=e,this.redirectClassName=e}):Promise.resolve()},s.prototype.validateClientClassCreation=function(){return!1!==this.config.allowClientClassCreation||this.auth.isMaster||-1!==i.systemClasses.indexOf(this.className)?Promise.resolve():this.config.database.loadSchema().then(e=>e.hasClass(this.className)).then(e=>{if(!0!==e)throw new l.Error(l.Error.OPERATION_FORBIDDEN,"This user is not allowed to access non-existent class: "+this.className)})},s.prototype.replaceInQuery=function(){var e=a(this.restWhere,"$inQuery");if(!e)return;var t=e.$inQuery;if(!t.where||!t.className)throw new l.Error(l.Error.INVALID_QUERY,"improper usage of $inQuery");const r={redirectClassNameForKey:t.redirectClassNameForKey};this.restOptions.subqueryReadPreference&&(r.readPreference=this.restOptions.subqueryReadPreference,r.subqueryReadPreference=this.restOptions.subqueryReadPreference);var n=new s(this.config,this.auth,t.className,t.where,r);return n.execute().then(t=>((function(e,t,r){var s=[];for(var n of r)s.push({__type:"Pointer",className:t,objectId:n.objectId});delete e.$inQuery,Array.isArray(e.$in)?e.$in=e.$in.concat(s):e.$in=s})(e,n.className,t.results),this.replaceInQuery()))},s.prototype.replaceNotInQuery=function(){var e=a(this.restWhere,"$notInQuery");if(!e)return;var t=e.$notInQuery;if(!t.where||!t.className)throw new l.Error(l.Error.INVALID_QUERY,"improper usage of $notInQuery");const r={redirectClassNameForKey:t.redirectClassNameForKey};this.restOptions.subqueryReadPreference&&(r.readPreference=this.restOptions.subqueryReadPreference,r.subqueryReadPreference=this.restOptions.subqueryReadPreference);var n=new s(this.config,this.auth,t.className,t.where,r);return n.execute().then(t=>((function(e,t,r){var s=[];for(var n of r)s.push({__type:"Pointer",className:t,objectId:n.objectId});delete e.$notInQuery,Array.isArray(e.$nin)?e.$nin=e.$nin.concat(s):e.$nin=s})(e,n.className,t.results),this.replaceNotInQuery()))};s.prototype.replaceSelect=function(){var e=a(this.restWhere,"$select");if(!e)return;var t=e.$select;if(!t.query||!t.key||"object"!=typeof t.query||!t.query.className||2!==Object.keys(t).length)throw new l.Error(l.Error.INVALID_QUERY,"improper usage of $select");const r={redirectClassNameForKey:t.query.redirectClassNameForKey};this.restOptions.subqueryReadPreference&&(r.readPreference=this.restOptions.subqueryReadPreference,r.subqueryReadPreference=this.restOptions.subqueryReadPreference);return new s(this.config,this.auth,t.query.className,t.query.where,r).execute().then(r=>(((e,t,r)=>{var s=[];for(var n of r)s.push(t.split(".").reduce((e,t)=>e[t],n));delete e.$select,Array.isArray(e.$in)?e.$in=e.$in.concat(s):e.$in=s})(e,t.key,r.results),this.replaceSelect()))};s.prototype.replaceDontSelect=function(){var e=a(this.restWhere,"$dontSelect");if(!e)return;var t=e.$dontSelect;if(!t.query||!t.key||"object"!=typeof t.query||!t.query.className||2!==Object.keys(t).length)throw new l.Error(l.Error.INVALID_QUERY,"improper usage of $dontSelect");const r={redirectClassNameForKey:t.query.redirectClassNameForKey};this.restOptions.subqueryReadPreference&&(r.readPreference=this.restOptions.subqueryReadPreference,r.subqueryReadPreference=this.restOptions.subqueryReadPreference);return new s(this.config,this.auth,t.query.className,t.query.where,r).execute().then(r=>(((e,t,r)=>{var s=[];for(var n of r)s.push(t.split(".").reduce((e,t)=>e[t],n));delete e.$dontSelect,Array.isArray(e.$nin)?e.$nin=e.$nin.concat(s):e.$nin=s})(e,t.key,r.results),this.replaceDontSelect()))};const d=function(e,t,r){if(delete e.password,!(t.isMaster||t.user&&t.user.id===e.objectId))for(const t of r.userSensitiveFields)delete e[t]},h=function(e){e.authData&&(Object.keys(e.authData).forEach(t=>{null===e.authData[t]&&delete e.authData[t]}),0==Object.keys(e.authData).length&&delete e.authData)},f=e=>{if("object"!=typeof e)return e;const t={};let r=!1,s=!1;for(const n in e)0!==n.indexOf("$")?(r=!0,t[n]=e[n]):s=!0;return r&&s&&(e.$eq=t,Object.keys(t).forEach(t=>{delete e[t]})),e};s.prototype.replaceEquality=function(){if("object"==typeof this.restWhere)for(const e in this.restWhere)this.restWhere[e]=f(this.restWhere[e])},s.prototype.runFind=function(e={}){if(0===this.findOptions.limit)return this.response={results:[]},Promise.resolve();const t=Object.assign({},this.findOptions);return this.keys&&(t.keys=this.keys.map(e=>e.split(".")[0])),e.op&&(t.op=e.op),this.config.database.find(this.className,this.restWhere,t).then(e=>{if("_User"===this.className)for(var t of e)d(t,this.auth,this.config),h(t);if(this.config.filesController.expandFilesInObject(this.config,e),this.redirectClassName)for(var r of e)r.className=this.redirectClassName;this.response={results:e}})},s.prototype.runCount=function(){if(this.doCount)return this.findOptions.count=!0,delete this.findOptions.skip,delete this.findOptions.limit,this.config.database.find(this.className,this.restWhere,this.findOptions).then(e=>{this.response.count=e})},s.prototype.handleInclude=function(){if(0!=this.include.length){var e=function(e,t,r,a,i={}){var l=n(r.results,a);if(0==l.length)return r;const u={};for(var c of l){if(!c)continue;const e=c.className;e&&(u[e]=u[e]||new Set,u[e].add(c.objectId))}const d={};if(i.keys){const e=new Set(i.keys.split(",")),t=Array.from(e).reduce((e,t)=>{const r=t.split(".");let s=0;for(;s<a.length;s++)if(a[s]!=r[s])return e;return s<r.length&&e.add(r[s]),e},new Set);t.size>0&&(d.keys=Array.from(t).join(","))}i.includeReadPreference&&(d.readPreference=i.includeReadPreference,d.includeReadPreference=i.includeReadPreference);const h=Object.keys(u).map(r=>{const n=Array.from(u[r]);let o;return o=1===n.length?{objectId:n[0]}:{objectId:{$in:n}},new s(e,t,r,o,d).execute({op:"get"}).then(e=>(e.className=r,Promise.resolve(e)))});return Promise.all(h).then(e=>{var s=e.reduce((e,r)=>{for(var s of r.results)s.__type="Object",s.className=r.className,"_User"!=s.className||t.isMaster||(delete s.sessionToken,delete s.authData),e[s.objectId]=s;return e},{}),n={results:o(r.results,a,s)};return r.count&&(n.count=r.count),n})}(this.config,this.auth,this.response,this.include[0],this.restOptions);return e.then?e.then(e=>(this.response=e,this.include=this.include.slice(1),this.handleInclude())):this.include.length>0?(this.include=this.include.slice(1),this.handleInclude()):e}},s.prototype.runAfterFindTrigger=function(){if(!this.response)return;return u.triggerExists(this.className,u.Types.afterFind,this.config.applicationId)?u.maybeRunAfterFindTrigger(u.Types.afterFind,this.auth,this.className,this.response.results,this.config).then(e=>{this.response.results=e}):Promise.resolve()},e.exports=s},function(e,t){e.exports=__webpack_require__(11)},function(e,t,r){"use strict"},function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.AppCache=void 0;var s=r(65),n=t.AppCache=new s.InMemoryCache({ttl:NaN});t.default=n},function(e,t){e.exports=__webpack_require__(12)},function(e,t,r){"use strict";function s(e,t){e&&Object.keys(e).forEach(r=>{if(-1==y.indexOf(r))throw new d.Error(d.Error.INVALID_JSON,`${r} is not a valid operation for class level permissions`);if("readUserFields"!==r&&"writeUserFields"!==r)Object.keys(e[r]).forEach(t=>{!function(e){if(!_.reduce((t,r)=>t=t||null!=e.match(r),!1))throw new d.Error(d.Error.INVALID_JSON,`'${e}' is not a valid key for class level permissions`)}(t);const s=e[r][t];if(!0!==s)throw new d.Error(d.Error.INVALID_JSON,`'${s}' is not a valid value for class level permissions ${r}:${t}:${s}`)});else{if(!Array.isArray(e[r]))throw new d.Error(d.Error.INVALID_JSON,`'${e[r]}' is not a valid value for class level permissions ${r}`);e[r].forEach(e=>{if(!t[e]||"Pointer"!=t[e].type||"_User"!=t[e].targetClass)throw new d.Error(d.Error.INVALID_JSON,`'${e}' is not a valid column for class level pointer permissions ${r}`)})}})}function n(e){return p.indexOf(e)>-1||b.test(e)||o(e)}function o(e){return g.test(e)}function a(e,t){return!!o(e)&&(!h._Default[e]&&(!h[t]||!h[t][e]))}function i(e){return"Invalid classname: "+e+", classnames can only have alphanumeric characters and _, and must start with an alpha character "}function l(e,t){const r={},s=-1===Object.keys(h).indexOf(e._id)?[]:Object.keys(h[e._id]);for(const n in e)if("_id"!==n&&"ACL"!==n&&"updatedAt"!==n&&"createdAt"!==n&&"objectId"!==n){if(s.length>0&&-1!==s.indexOf(n))continue;t[n]&&"Delete"===t[n].__op||(r[n]=e[n])}for(const e in t)if("objectId"!==e&&"Delete"!==t[e].__op){if(s.length>0&&-1!==s.indexOf(e))continue;r[e]=t[e]}return r}function u(e){if(e instanceof Array)return"Array";if(e.__type){switch(e.__type){case"Pointer":if(e.className)return{type:"Pointer",targetClass:e.className};break;case"Relation":if(e.className)return{type:"Relation",targetClass:e.className};break;case"File":if(e.name)return"File";break;case"Date":if(e.iso)return"Date";break;case"GeoPoint":if(null!=e.latitude&&null!=e.longitude)return"GeoPoint";break;case"Bytes":if(e.base64)return"Bytes";break;case"Polygon":if(e.coordinates)return"Polygon"}throw new d.Error(d.Error.INCORRECT_TYPE,"This is not a valid "+e.__type)}if(e.$ne)return u(e.$ne);if(e.__op)switch(e.__op){case"Increment":return"Number";case"Delete":return null;case"Add":case"AddUnique":case"Remove":return"Array";case"AddRelation":case"RemoveRelation":return{type:"Relation",targetClass:e.objects[0].className};case"Batch":return u(e.ops[0]);default:throw"unexpected op: "+e.__op}return"Object"}Object.defineProperty(t,"__esModule",{value:!0});var c=Object.assign||function(e){for(var t=1;t<arguments.length;t++){var r=arguments[t];for(var s in r)Object.prototype.hasOwnProperty.call(r,s)&&(e[s]=r[s])}return e};const d=r(0).Mmbs,h=Object.freeze({_Default:{objectId:{type:"String"},createdAt:{type:"Date"},updatedAt:{type:"Date"},ACL:{type:"ACL"}},_User:{username:{type:"String"},password:{type:"String"},email:{type:"String"},emailVerified:{type:"Boolean"},authData:{type:"Object"}},_Installation:{installationId:{type:"String"},deviceToken:{type:"String"},channels:{type:"Array"},deviceType:{type:"String"},pushType:{type:"String"},GCMSenderId:{type:"String"},timeZone:{type:"String"},localeIdentifier:{type:"String"},badge:{type:"Number"},appVersion:{type:"String"},appName:{type:"String"},appIdentifier:{type:"String"},MmbsVersion:{type:"String"}},_Role:{name:{type:"String"},users:{type:"Relation",targetClass:"_User"},roles:{type:"Relation",targetClass:"_Role"}},_Session:{restricted:{type:"Boolean"},user:{type:"Pointer",targetClass:"_User"},installationId:{type:"String"},sessionToken:{type:"String"},expiresAt:{type:"Date"},createdWith:{type:"Object"}},_Product:{productIdentifier:{type:"String"},download:{type:"File"},downloadName:{type:"String"},icon:{type:"File"},order:{type:"Number"},title:{type:"String"},subtitle:{type:"String"}},_PushStatus:{pushTime:{type:"String"},source:{type:"String"},query:{type:"String"},payload:{type:"String"},title:{type:"String"},expiry:{type:"Number"},expiration_interval:{type:"Number"},status:{type:"String"},numSent:{type:"Number"},numFailed:{type:"Number"},pushHash:{type:"String"},errorMessage:{type:"Object"},sentPerType:{type:"Object"},failedPerType:{type:"Object"},sentPerUTCOffset:{type:"Object"},failedPerUTCOffset:{type:"Object"},count:{type:"Number"}},_JobStatus:{jobName:{type:"String"},source:{type:"String"},status:{type:"String"},message:{type:"String"},params:{type:"Object"},finishedAt:{type:"Date"}},_JobSchedule:{jobName:{type:"String"},description:{type:"String"},params:{type:"String"},startAfter:{type:"String"},daysOfWeek:{type:"Array"},timeOfDay:{type:"String"},lastRun:{type:"Number"},repeatMinutes:{type:"Number"},cron:{type:"String"},enabled:{type:"Boolean"}},_Hooks:{functionName:{type:"String"},className:{type:"String"},triggerName:{type:"String"},url:{type:"String"}},_GlobalConfig:{objectId:{type:"String"},params:{type:"Object"}},_Audience:{objectId:{type:"String"},name:{type:"String"},query:{type:"String"},lastUsed:{type:"Date"},timesUsed:{type:"Number"}}}),f=Object.freeze({_Product:["productIdentifier","icon","order","title","subtitle"],_Role:["name","ACL"]}),p=Object.freeze(["_User","_Installation","_Role","_Session","_Product","_PushStatus","_JobStatus","_JobSchedule","_Audience"]),m=Object.freeze(["_JobStatus","_PushStatus","_Hooks","_GlobalConfig","_JobSchedule","_Audience"]),_=Object.freeze([/^[a-zA-Z0-9]{10}$/,/^role:.*/,/^\*$/,/^requiresAuthentication$/]),y=Object.freeze(["find","count","get","create","update","delete","addField","readUserFields","writeUserFields"]),b=/^_Join:[A-Za-z0-9_]+:[A-Za-z0-9_]+/,g=/^[A-Za-z][A-Za-z0-9_]*$/,v=new d.Error(d.Error.INVALID_JSON,"invalid JSON"),E=["Number","String","Boolean","Date","Object","Array","GeoPoint","File","Bytes","Polygon"],S=({type:e,targetClass:t})=>["Pointer","Relation"].indexOf(e)>=0?t?"string"!=typeof t?v:n(t)?void 0:new d.Error(d.Error.INVALID_CLASS_NAME,i(t)):new d.Error(135,`type ${e} needs a class name`):"string"!=typeof e?v:E.indexOf(e)<0?new d.Error(d.Error.INCORRECT_TYPE,`invalid field type: ${e}`):void 0,w=e=>(e=I(e),delete e.fields.ACL,e.fields._rperm={type:"Array"},e.fields._wperm={type:"Array"},"_User"===e.className&&(delete e.fields.password,e.fields._hashed_password={type:"String"}),e),O=e=>{let t=function(e,t){var r={};for(var s in e)t.indexOf(s)>=0||Object.prototype.hasOwnProperty.call(e,s)&&(r[s]=e[s]);return r}(e,[]);return delete t.fields._rperm,delete t.fields._wperm,t.fields.ACL={type:"ACL"},"_User"===t.className&&(delete t.fields.authData,delete t.fields._hashed_password,t.fields.password={type:"String"}),t.indexes&&0===Object.keys(t.indexes).length&&delete t.indexes,t},I=({className:e,fields:t,classLevelPermissions:r,indexes:s})=>{const n={className:e,fields:c({},h._Default,h[e]||{},t),classLevelPermissions:r};return s&&0!==Object.keys(s).length&&(n.indexes=s),n},A={className:"_Hooks",fields:h._Hooks},N={className:"_GlobalConfig",fields:h._GlobalConfig},C=w(I({className:"_PushStatus",fields:{},classLevelPermissions:{}})),P=[A,w(I({className:"_JobStatus",fields:{},classLevelPermissions:{}})),w(I({className:"_JobSchedule",fields:{},classLevelPermissions:{}})),C,N,w(I({className:"_Audience",fields:h._Audience}))],T=(e,t)=>e.type===t.type&&(e.targetClass===t.targetClass&&(e===t.type||e.type===t.type)),R=e=>e.targetClass?`${e.type}<${e.targetClass}>`:`${e.type||e}`;class ${constructor(e,t){this._dbAdapter=e,this._cache=t,this.data={},this.perms={},this.indexes={}}reloadData(e={clearCache:!1}){let t=Promise.resolve();return e.clearCache&&(t=t.then(()=>this._cache.clear())),this.reloadDataPromise&&!e.clearCache?this.reloadDataPromise:(this.reloadDataPromise=t.then(()=>this.getAllClasses(e)).then(e=>{const t={},r={},s={};e.forEach(e=>{t[e.className]=I(e).fields,r[e.className]=e.classLevelPermissions,s[e.className]=e.indexes}),m.forEach(e=>{const n=I({className:e});t[e]=n.fields,r[e]=n.classLevelPermissions,s[e]=n.indexes}),this.data=t,this.perms=r,this.indexes=s,delete this.reloadDataPromise},e=>{throw this.data={},this.perms={},this.indexes={},delete this.reloadDataPromise,e}),this.reloadDataPromise)}getAllClasses(e={clearCache:!1}){let t=Promise.resolve();return e.clearCache&&(t=this._cache.clear()),t.then(()=>this._cache.getAllClasses()).then(t=>t&&t.length&&!e.clearCache?Promise.resolve(t):this._dbAdapter.getAllClasses().then(e=>e.map(I)).then(e=>this._cache.setAllClasses(e).then(()=>e)))}getOneSchema(e,t=!1,r={clearCache:!1}){let s=Promise.resolve();return r.clearCache&&(s=this._cache.clear()),s.then(()=>t&&m.indexOf(e)>-1?Promise.resolve({className:e,fields:this.data[e],classLevelPermissions:this.perms[e],indexes:this.indexes[e]}):this._cache.getOneSchema(e).then(t=>t&&!r.clearCache?Promise.resolve(t):this._dbAdapter.getClass(e).then(I).then(t=>this._cache.setOneSchema(e,t).then(()=>t))))}addClassIfNotExists(e,t={},r,s={}){var n=this.validateNewClass(e,t,r);return n?Promise.reject(n):this._dbAdapter.createClass(e,w({fields:t,classLevelPermissions:r,indexes:s,className:e})).then(O).then(e=>this._cache.clear().then(()=>Promise.resolve(e))).catch(t=>{throw t&&t.code===d.Error.DUPLICATE_VALUE?new d.Error(d.Error.INVALID_CLASS_NAME,`Class ${e} already exists.`):t})}updateClass(e,t,r,s,n){return this.getOneSchema(e).then(o=>{const a=o.fields;Object.keys(t).forEach(e=>{const r=t[e];if(a[e]&&"Delete"!==r.__op)throw new d.Error(255,`Field ${e} exists, cannot update.`);if(!a[e]&&"Delete"===r.__op)throw new d.Error(255,`Field ${e} does not exist, cannot delete.`)}),delete a._rperm,delete a._wperm;const i=l(a,t),u=this.validateSchemaData(e,i,r,Object.keys(a));if(u)throw new d.Error(u.code,u.error);const c=[],h=[];Object.keys(t).forEach(e=>{"Delete"===t[e].__op?c.push(e):h.push(e)});let f=Promise.resolve();return c.length>0&&(f=this.deleteFields(c,e,n)),f.then(()=>this.reloadData({clearCache:!0})).then(()=>{const r=h.map(r=>{const s=t[r];return this.enforceFieldExists(e,r,s)});return Promise.all(r)}).then(()=>this.setPermissions(e,r,i)).then(()=>this._dbAdapter.setIndexesWithSchemaFormat(e,s,o.indexes,i)).then(()=>this.reloadData({clearCache:!0})).then(()=>{const t={className:e,fields:this.data[e],classLevelPermissions:this.perms[e]};return this.indexes[e]&&0!==Object.keys(this.indexes[e]).length&&(t.indexes=this.indexes[e]),t})}).catch(t=>{throw void 0===t?new d.Error(d.Error.INVALID_CLASS_NAME,`Class ${e} does not exist.`):t})}enforceClassExists(e){return this.data[e]?Promise.resolve(this):this.addClassIfNotExists(e).then(()=>this.reloadData({clearCache:!0})).catch(()=>this.reloadData({clearCache:!0})).then(()=>{if(this.data[e])return this;throw new d.Error(d.Error.INVALID_JSON,`Failed to add ${e}`)}).catch(()=>{throw new d.Error(d.Error.INVALID_JSON,"schema class name does not revalidate")})}validateNewClass(e,t={},r){if(this.data[e])throw new d.Error(d.Error.INVALID_CLASS_NAME,`Class ${e} already exists.`);return n(e)?this.validateSchemaData(e,t,r,[]):{code:d.Error.INVALID_CLASS_NAME,error:i(e)}}validateSchemaData(e,t,r,n){for(const r in t)if(n.indexOf(r)<0){if(!o(r))return{code:d.Error.INVALID_KEY_NAME,error:"invalid field name: "+r};if(!a(r,e))return{code:136,error:"field "+r+" cannot be added"};const s=S(t[r]);if(s)return{code:s.code,error:s.message}}for(const r in h[e])t[r]=h[e][r];const i=Object.keys(t).filter(e=>t[e]&&"GeoPoint"===t[e].type);if(i.length>1)return{code:d.Error.INCORRECT_TYPE,error:"currently, only one GeoPoint field may exist in an object. Adding "+i[1]+" when "+i[0]+" already exists."};s(r,t)}setPermissions(e,t,r){return void 0===t?Promise.resolve():(s(t,r),this._dbAdapter.setClassLevelPermissions(e,t))}enforceFieldExists(e,t,r){if(t.indexOf(".")>0&&(t=t.split(".")[0],r="Object"),!o(t))throw new d.Error(d.Error.INVALID_KEY_NAME,`Invalid field name: ${t}.`);return r?this.reloadData().then(()=>{const s=this.getExpectedType(e,t);if("string"==typeof r&&(r={type:r}),s){if(!T(s,r))throw new d.Error(d.Error.INCORRECT_TYPE,`schema mismatch for ${e}.${t}; expected ${R(s)} but got ${R(r)}`);return this}return this._dbAdapter.addFieldIfNotExists(e,t,r).then(()=>this.reloadData({clearCache:!0}),e=>{if(e.code==d.Error.INCORRECT_TYPE)throw e;return this.reloadData({clearCache:!0})}).then(()=>{if(!T(this.getExpectedType(e,t),r))throw new d.Error(d.Error.INVALID_JSON,`Could not add field ${t}`);return this._cache.clear(),this})}):Promise.resolve(this)}deleteField(e,t,r){return this.deleteFields([e],t,r)}deleteFields(e,t,r){if(!n(t))throw new d.Error(d.Error.INVALID_CLASS_NAME,i(t));return e.forEach(e=>{if(!o(e))throw new d.Error(d.Error.INVALID_KEY_NAME,`invalid field name: ${e}`);if(!a(e,t))throw new d.Error(136,`field ${e} cannot be changed`)}),this.getOneSchema(t,!1,{clearCache:!0}).catch(e=>{throw void 0===e?new d.Error(d.Error.INVALID_CLASS_NAME,`Class ${t} does not exist.`):e}).then(s=>{e.forEach(e=>{if(!s.fields[e])throw new d.Error(255,`Field ${e} does not exist, cannot delete.`)});const n=c({},s.fields);return r.adapter.deleteFields(t,s,e).then(()=>Promise.all(e.map(e=>{const s=n[e];return s&&"Relation"===s.type?r.adapter.deleteClass(`_Join:${e}:${t}`):Promise.resolve()})))}).then(()=>{this._cache.clear()})}validateObject(e,t,r){let s=0,n=this.enforceClassExists(e);for(const r in t){if(void 0===t[r])continue;const o=function(e){switch(typeof e){case"boolean":return"Boolean";case"string":return"String";case"number":return"Number";case"map":case"object":if(!e)return;return u(e);case"function":case"symbol":case"undefined":default:throw"bad obj: "+e}}(t[r]);if("GeoPoint"===o&&s++,s>1)return n.then(()=>Promise.reject(new d.Error(d.Error.INCORRECT_TYPE,"there can only be one geopoint field in a class")));o&&("ACL"!==r&&(n=n.then(t=>t.enforceFieldExists(e,r,o))))}return n=function(e,t,r,s){return e.then(e=>e.validateRequiredColumns(t,r,s))}(n,e,t,r)}validateRequiredColumns(e,t,r){const s=f[e];if(!s||0==s.length)return Promise.resolve(this);const n=s.filter(function(e){return r&&r.objectId?!(!t[e]||"object"!=typeof t[e])&&"Delete"==t[e].__op:!t[e]});if(n.length>0)throw new d.Error(d.Error.INCORRECT_TYPE,n[0]+" is required.");return Promise.resolve(this)}testBaseCLP(e,t,r){if(!this.perms[e]||!this.perms[e][r])return!0;const s=this.perms[e][r];return!!s["*"]||!!t.some(e=>!0===s[e])}validatePermission(e,t,r){if(this.testBaseCLP(e,t,r))return Promise.resolve();if(!this.perms[e]||!this.perms[e][r])return!0;const s=this.perms[e];if(s[r].requiresAuthentication){if(!t||0==t.length)throw new d.Error(d.Error.OBJECT_NOT_FOUND,"Permission denied, user needs to be authenticated.");if(t.indexOf("*")>-1&&1==t.length)throw new d.Error(d.Error.OBJECT_NOT_FOUND,"Permission denied, user needs to be authenticated.");return Promise.resolve()}const n=["get","find","count"].indexOf(r)>-1?"readUserFields":"writeUserFields";if("writeUserFields"==n&&"create"==r)throw new d.Error(d.Error.OPERATION_FORBIDDEN,`Permission denied for action ${r} on class ${e}.`);if(Array.isArray(s[n])&&s[n].length>0)return Promise.resolve();throw new d.Error(d.Error.OPERATION_FORBIDDEN,`Permission denied for action ${r} on class ${e}.`)}getExpectedType(e,t){if(this.data&&this.data[e]){const r=this.data[e][t];return"map"===r?"Object":r}}hasClass(e){return this.reloadData().then(()=>!!this.data[e])}}t.default=$;t.load=((e,t,r)=>{const s=new $(e,t);return s.reloadData(r).then(()=>s)}),t.classNameIsValid=n,t.fieldNameIsValid=o,t.invalidClassNameMessage=i,t.buildMergedSchemaObject=l,t.systemClasses=p,t.defaultColumns=h,t.convertSchemaToAdapterSchema=w,t.VolatileClassesSchemas=P},function(e,t,r){"use strict";function s(e){return e&&e.__esModule?e:{default:e}}function n(e,t,r,s,n,o,a){if(t.isReadOnly)throw new f.Error(f.Error.OPERATION_FORBIDDEN,"Cannot perform a write operation when using readOnlyMasterKey");if(t.isAnonymousForbid){throw new f.Error(f.Error.OPERATION_FORBIDDEN,"anonymous  user cannot perform a write operation")}if(this.config=e,this.auth=t,this.className=r,this.clientSDK=a,this.storage={},this.runOptions={},!s&&n.objectId)throw new f.Error(f.Error.INVALID_KEY_NAME,"objectId is an invalid field name.");this.response=null,this.query=u(s),this.data=u(n),this.originalData=o,this.updatedAt=f._encode(new Date).iso}Object.defineProperty(t,"__esModule",{value:!0});var o=s(r(17)),a=s(r(7)),i=s(r(1)),l=r(22),u=r(21),c=r(6),d=r(12),h=r(37),f=r(0),p=r(9),m=r(38);n.prototype.execute=function(){return Promise.resolve().then(()=>this.getUserAndRoleACL()).then(()=>this.validateClientClassCreation()).then(()=>this.handleInstallation()).then(()=>this.handleSession()).then(()=>this.validateAuthData()).then(()=>this.runBeforeTrigger()).then(()=>this.validateSchema()).then(()=>this.setRequiredFieldsIfNeeded()).then(()=>this.transformUser()).then(()=>this.expandFilesForExistingObjects()).then(()=>this.destroyDuplicatedSessions()).then(()=>this.runDatabaseOperation()).then(()=>this.createSessionTokenIfNeeded()).then(()=>this.handleFollowup()).then(()=>this.runAfterTrigger()).then(()=>this.cleanUserAuthData()).then(()=>this.response)},n.prototype.getUserAndRoleACL=function(){return this.auth.isMaster?Promise.resolve():(this.runOptions.acl=["*"],this.auth.user?this.auth.getUserRoles().then(e=>{this.runOptions.acl=this.runOptions.acl.concat(e,[this.auth.user.id])}):Promise.resolve())},n.prototype.validateClientClassCreation=function(){return!1!==this.config.allowClientClassCreation||this.auth.isMaster||-1!==l.systemClasses.indexOf(this.className)?Promise.resolve():this.config.database.loadSchema().then(e=>e.hasClass(this.className)).then(e=>{if(!0!==e)throw new f.Error(f.Error.OPERATION_FORBIDDEN,"This user is not allowed to access non-existent class: "+this.className)})},n.prototype.validateSchema=function(){return this.config.database.validateObject(this.className,this.data,this.query,this.runOptions)},n.prototype.runBeforeTrigger=function(){if(this.response)return;if(!p.triggerExists(this.className,p.Types.beforeSave,this.config.applicationId))return Promise.resolve();var e={className:this.className};this.query&&this.query.objectId&&(e.objectId=this.query.objectId);let t=null;const r=this.buildUpdatedObject(e);return this.query&&this.query.objectId&&(t=p.inflate(e,this.originalData)),Promise.resolve().then(()=>p.maybeRunTrigger(p.Types.beforeSave,this.auth,r,t,this.config)).then(e=>{e&&e.object&&(this.storage.fieldsChangedByTrigger=a.default.reduce(e.object,(e,t,r)=>(a.default.isEqual(this.data[r],t)||e.push(r),e),[]),this.data=e.object,this.query&&this.query.objectId&&delete this.data.objectId)})},n.prototype.setRequiredFieldsIfNeeded=function(){return this.data&&(this.data.updatedAt=this.updatedAt,this.query||(this.data.createdAt=this.updatedAt,this.data.objectId||(this.data.objectId=d.newObjectId(this.config.objectIdSize)))),Promise.resolve()},n.prototype.validateAuthData=function(){if("_User"===this.className){if(!this.query&&!this.data.authData){if("string"!=typeof this.data.username||a.default.isEmpty(this.data.username))throw new f.Error(f.Error.USERNAME_MISSING,"bad or missing username");if("string"!=typeof this.data.password||a.default.isEmpty(this.data.password))throw new f.Error(f.Error.PASSWORD_MISSING,"password is required")}if(this.data.authData&&Object.keys(this.data.authData).length){var e=this.data.authData,t=Object.keys(e);if(t.length>0){if(t.reduce((t,r)=>{var s=e[r],n=s&&s.id;return t&&(n||null==s)},!0))return this.handleAuthData(e)}throw new f.Error(f.Error.UNSUPPORTED_SERVICE,"This authentication method is unsupported.")}}},n.prototype.handleAuthDataValidation=function(e){const t=Object.keys(e).map(t=>{if(null===e[t])return Promise.resolve();const r=this.config.authDataManager.getValidatorForProvider(t);if(!r)throw new f.Error(f.Error.UNSUPPORTED_SERVICE,"This authentication method is unsupported.");return r(e[t])});return Promise.all(t)},n.prototype.findUsersWithAuthData=function(e){const t=Object.keys(e).reduce((t,r)=>{if(!e[r])return t;const s={};return s[`authData.${r}.id`]=e[r].id,t.push(s),t},[]).filter(e=>void 0!==e);let r=Promise.resolve([]);return t.length>0&&(r=this.config.database.find(this.className,{$or:t},{})),r},n.prototype.handleAuthData=function(e){let t;return this.findUsersWithAuthData(e).then(r=>{if((t=r).length>1)throw new f.Error(f.Error.ACCOUNT_ALREADY_LINKED,"this auth is already used");if(this.storage.authProvider=Object.keys(e).join(","),t.length>0){const r=t[0],s={};Object.keys(e).forEach(t=>{const n=e[t],o=r.authData[t];a.default.isEqual(n,o)||(s[t]=n)});const n=0!==Object.keys(s).length;let o;if(this.query&&this.query.objectId?o=this.query.objectId:this.auth&&this.auth.user&&this.auth.user.id&&(o=this.auth.user.id),!o||o===r.objectId){if(delete t[0].password,this.data.objectId=r.objectId,this.query&&this.query.objectId||(this.response={response:r,location:this.location()}),!n)return;return this.handleAuthDataValidation(s).then(()=>{if(this.response)return Object.keys(s).forEach(e=>{this.response.response.authData[e]=s[e]}),this.config.database.update(this.className,{objectId:this.data.objectId},{authData:s},{})})}if(o){if(r.objectId!==o)throw new f.Error(f.Error.ACCOUNT_ALREADY_LINKED,"this auth is already used");if(!n)return}}return this.handleAuthDataValidation(e)})},n.prototype.transformUser=function(){var e=Promise.resolve();if("_User"!==this.className)return e;if(!this.auth.isMaster&&"emailVerified"in this.data){throw new f.Error(f.Error.OPERATION_FORBIDDEN,"Clients aren't allowed to manually update email verification.")}return this.query&&this.objectId()&&(e=new o.default(this.config,c.master(this.config),"_Session",{user:{__type:"Pointer",className:"_User",objectId:this.objectId()}}).execute().then(e=>{e.results.forEach(e=>this.config.cacheController.user.del(e.sessionToken))})),e.then(()=>void 0===this.data.password?Promise.resolve():(this.query&&(this.storage.clearSessions=!0,this.auth.isMaster||(this.storage.generateNewSession=!0)),this._validatePasswordPolicy().then(()=>h.hash(this.data.password).then(e=>{this.data._hashed_password=e,delete this.data.password})))).then(()=>this._validateUserName()).then(()=>this._validateEmail())},n.prototype._validateUserName=function(){return this.data.username?this.config.database.find(this.className,{username:this.data.username,objectId:{$ne:this.objectId()}},{limit:1}).then(e=>{if(e.length>0)throw new f.Error(f.Error.USERNAME_TAKEN,"Account already exists for this username.")}):(this.query||(this.data.username=d.randomString(25),this.responseShouldHaveUsername=!0),Promise.resolve())},n.prototype._validateEmail=function(){return this.data.email&&"Delete"!==this.data.email.__op?this.data.email.match(/^.+@.+$/)?this.config.database.find(this.className,{email:this.data.email,objectId:{$ne:this.objectId()}},{limit:1}).then(e=>{if(e.length>0)throw new f.Error(f.Error.EMAIL_TAKEN,"Account already exists for this email address.");this.data.authData&&Object.keys(this.data.authData).length&&(1!==Object.keys(this.data.authData).length||"anonymous"!==Object.keys(this.data.authData)[0])||(this.storage.sendVerificationEmail=!0,this.config.userController.setEmailVerifyToken(this.data))}):Promise.reject(new f.Error(f.Error.INVALID_EMAIL_ADDRESS,"Email address format is invalid.")):Promise.resolve()},n.prototype._validatePasswordPolicy=function(){return this.config.passwordPolicy?this._validatePasswordRequirements().then(()=>this._validatePasswordHistory()):Promise.resolve()},n.prototype._validatePasswordRequirements=function(){const e="Password does not meet the Password Policy requirements.";if(this.config.passwordPolicy.patternValidator&&!this.config.passwordPolicy.patternValidator(this.data.password)||this.config.passwordPolicy.validatorCallback&&!this.config.passwordPolicy.validatorCallback(this.data.password))return Promise.reject(new f.Error(f.Error.VALIDATION_ERROR,e));if(!0===this.config.passwordPolicy.doNotAllowUsername){if(!this.data.username)return this.config.database.find("_User",{objectId:this.objectId()}).then(t=>{if(1!=t.length)throw void 0;return this.data.password.indexOf(t[0].username)>=0?Promise.reject(new f.Error(f.Error.VALIDATION_ERROR,e)):Promise.resolve()});if(this.data.password.indexOf(this.data.username)>=0)return Promise.reject(new f.Error(f.Error.VALIDATION_ERROR,e))}return Promise.resolve()},n.prototype._validatePasswordHistory=function(){return this.query&&this.config.passwordPolicy.maxPasswordHistory?this.config.database.find("_User",{objectId:this.objectId()},{keys:["_password_history","_hashed_password"]}).then(e=>{if(1!=e.length)throw void 0;const t=e[0];let r=[];t._password_history&&(r=a.default.take(t._password_history,this.config.passwordPolicy.maxPasswordHistory-1)),r.push(t.password);const s=this.data.password,n=r.map(function(e){return h.compare(s,e).then(e=>e?Promise.reject("REPEAT_PASSWORD"):Promise.resolve())});return Promise.all(n).then(()=>Promise.resolve()).catch(e=>{if("REPEAT_PASSWORD"===e)return Promise.reject(new f.Error(f.Error.VALIDATION_ERROR,`New password should not be the same as last ${this.config.passwordPolicy.maxPasswordHistory} passwords.`));throw e})}):Promise.resolve()},n.prototype.createSessionTokenIfNeeded=function(){if("_User"===this.className&&!this.query&&(this.storage.authProvider||!this.config.preventLoginWithUnverifiedEmail||!this.config.verifyUserEmails))return this.createSessionToken()},n.prototype.createSessionToken=function(){if(!this.auth.installationId||"cloud"!==this.auth.installationId){var e="r:"+d.newToken(),t=this.config.generateSessionExpiresAt(),r={sessionToken:e,user:{__type:"Pointer",className:"_User",objectId:this.objectId()},createdWith:{action:this.storage.authProvider?"login":"signup",authProvider:this.storage.authProvider||"password"},restricted:!1,installationId:this.auth.installationId,expiresAt:f._encode(t)};return this.response&&this.response.response&&(this.response.response.sessionToken=e),new n(this.config,c.master(this.config),"_Session",null,r).execute()}},n.prototype.destroyDuplicatedSessions=function(){if("_Session"!=this.className||this.query)return;const{user:e,installationId:t,sessionToken:r}=this.data;e&&t&&e.objectId&&this.config.database.destroy("_Session",{user:e,installationId:t,sessionToken:{$ne:r}})},n.prototype.handleFollowup=function(){if(this.storage&&this.storage.clearSessions&&this.config.revokeSessionOnPasswordReset){var e={user:{__type:"Pointer",className:"_User",objectId:this.objectId()}};return delete this.storage.clearSessions,this.config.database.destroy("_Session",e).then(this.handleFollowup.bind(this))}return this.storage&&this.storage.generateNewSession?(delete this.storage.generateNewSession,this.createSessionToken().then(this.handleFollowup.bind(this))):this.storage&&this.storage.sendVerificationEmail?(delete this.storage.sendVerificationEmail,this.config.userController.sendVerificationEmail(this.data),this.handleFollowup.bind(this)):void 0},n.prototype.handleSession=function(){if(!this.response&&"_Session"===this.className){if(!this.auth.user&&!this.auth.isMaster)throw new f.Error(f.Error.INVALID_SESSION_TOKEN,"Session token required.");if(this.data.ACL)throw new f.Error(f.Error.INVALID_KEY_NAME,"Cannot set ACL on a Session.");if(this.query){if(this.data.user&&!this.auth.isMaster&&this.data.user.objectId!=this.auth.user.id)throw new f.Error(f.Error.INVALID_KEY_NAME);if(this.data.installationId)throw new f.Error(f.Error.INVALID_KEY_NAME);if(this.data.sessionToken)throw new f.Error(f.Error.INVALID_KEY_NAME)}if(!this.query&&!this.auth.isMaster){var e="r:"+d.newToken(),t=this.config.generateSessionExpiresAt(),r={sessionToken:e,user:{__type:"Pointer",className:"_User",objectId:this.auth.user.id},createdWith:{action:"create"},restricted:!0,expiresAt:f._encode(t)};for(var s in this.data)"objectId"!==s&&"user"!==s&&(r[s]=this.data[s]);return new n(this.config,c.master(this.config),"_Session",null,r).execute().then(e=>{if(!e.response)throw new f.Error(f.Error.INTERNAL_SERVER_ERROR,"Error creating session.");r.objectId=e.response.objectId,this.response={status:201,location:e.location,response:r}})}}},n.prototype.handleInstallation=function(){if(this.response||"_Installation"!==this.className)return;if(!(this.query||this.data.deviceToken||this.data.installationId||this.auth.installationId))throw new f.Error(135,"at least one ID field (deviceToken, installationId) must be specified in this operation");this.data.deviceToken&&64==this.data.deviceToken.length&&(this.data.deviceToken=this.data.deviceToken.toLowerCase()),this.data.installationId&&(this.data.installationId=this.data.installationId.toLowerCase());let e=this.data.installationId;if(e||this.auth.isMaster||(e=this.auth.installationId),e&&(e=e.toLowerCase()),this.query&&!this.data.deviceToken&&!e&&!this.data.deviceType)return;var t,r,s,n=Promise.resolve(),o=[];const a=[];return this.query&&this.query.objectId&&a.push({objectId:this.query.objectId}),e&&a.push({installationId:e}),this.data.deviceToken&&a.push({deviceToken:this.data.deviceToken}),0!=a.length?n=n.then(()=>this.config.database.find("_Installation",{$or:a},{})).then(n=>{if(n.forEach(t=>{this.query&&this.query.objectId&&t.objectId==this.query.objectId&&(r=t),t.installationId==e&&(s=t),t.deviceToken==this.data.deviceToken&&o.push(t)}),this.query&&this.query.objectId){if(!r)throw new f.Error(f.Error.OBJECT_NOT_FOUND,"Object not found for update.");if(this.data.installationId&&r.installationId&&this.data.installationId!==r.installationId)throw new f.Error(136,"installationId may not be changed in this operation");if(this.data.deviceToken&&r.deviceToken&&this.data.deviceToken!==r.deviceToken&&!this.data.installationId&&!r.installationId)throw new f.Error(136,"deviceToken may not be changed in this operation");if(this.data.deviceType&&this.data.deviceType&&this.data.deviceType!==r.deviceType)throw new f.Error(136,"deviceType may not be changed in this operation")}if(this.query&&this.query.objectId&&r&&(t=r),e&&s&&(t=s),!this.query&&!this.data.deviceType&&!t)throw new f.Error(135,"deviceType must be specified in this operation")}).then(()=>{if(t){if(1!=o.length||o[0].installationId){if(this.data.deviceToken&&t.deviceToken!=this.data.deviceToken){const e={deviceToken:this.data.deviceToken};if(this.data.installationId)e.installationId={$ne:this.data.installationId};else{if(!t.objectId||!this.data.objectId||t.objectId!=this.data.objectId)return t.objectId;e.objectId={$ne:t.objectId}}this.data.appIdentifier&&(e.appIdentifier=this.data.appIdentifier),this.config.database.destroy("_Installation",e).catch(e=>{if(e.code!=f.Error.OBJECT_NOT_FOUND)throw e})}return t.objectId}{const e={objectId:t.objectId};return this.config.database.destroy("_Installation",e).then(()=>o[0].objectId).catch(e=>{if(e.code!=f.Error.OBJECT_NOT_FOUND)throw e})}}if(o.length){if(1!=o.length||o[0].installationId&&e){if(this.data.installationId){var r={deviceToken:this.data.deviceToken,installationId:{$ne:e}};return this.data.appIdentifier&&(r.appIdentifier=this.data.appIdentifier),void this.config.database.destroy("_Installation",r).catch(e=>{if(e.code!=f.Error.OBJECT_NOT_FOUND)throw e})}throw new f.Error(132,"Must specify installationId when deviceToken matches multiple Installation objects")}return o[0].objectId}}).then(e=>{e&&(this.query={objectId:e},delete this.data.objectId,delete this.data.createdAt)}):void 0},n.prototype.expandFilesForExistingObjects=function(){this.response&&this.response.response&&this.config.filesController.expandFilesInObject(this.config,this.response.response)},n.prototype.runDatabaseOperation=function(){if(!this.response){if("_Role"===this.className&&this.config.cacheController.role.clear(),"_User"===this.className&&this.query&&!this.auth.couldUpdateUserId(this.query.objectId))throw new f.Error(f.Error.SESSION_MISSING,`Cannot modify user ${this.query.objectId}.`);if("_Product"===this.className&&this.data.download&&(this.data.downloadName=this.data.download.name),this.data.ACL&&this.data.ACL["*unresolved"])throw new f.Error(f.Error.INVALID_ACL,"Invalid ACL.");if(this.query){"_User"===this.className&&this.data.ACL&&(this.data.ACL[this.query.objectId]={read:!0,write:!0}),"_User"===this.className&&this.data._hashed_password&&this.config.passwordPolicy&&this.config.passwordPolicy.maxPasswordAge&&(this.data._password_changed_at=f._encode(new Date)),delete this.data.createdAt;let e=Promise.resolve();return"_User"===this.className&&this.data._hashed_password&&this.config.passwordPolicy&&this.config.passwordPolicy.maxPasswordHistory&&(e=this.config.database.find("_User",{objectId:this.objectId()},{keys:["_password_history","_hashed_password"]}).then(e=>{if(1!=e.length)throw void 0;const t=e[0];let r=[];for(t._password_history&&(r=a.default.take(t._password_history,this.config.passwordPolicy.maxPasswordHistory));r.length>this.config.passwordPolicy.maxPasswordHistory-2;)r.shift();r.push(t.password),this.data._password_history=r})),e.then(()=>this.config.database.update(this.className,this.query,this.data,this.runOptions).then(e=>{e.updatedAt=this.updatedAt,this._updateResponseWithData(e,this.data),this.response={response:e}}))}if("_User"===this.className){var e=this.data.ACL;e||((e={})["*"]={read:!0,write:!1}),e[this.data.objectId]={read:!0,write:!0},this.data.ACL=e,this.config.passwordPolicy&&this.config.passwordPolicy.maxPasswordAge&&(this.data._password_changed_at=f._encode(new Date))}return this.config.database.create(this.className,this.data,this.runOptions).catch(e=>{if("_User"!==this.className||e.code!==f.Error.DUPLICATE_VALUE)throw e;if(e&&e.userInfo&&"username"===e.userInfo.duplicated_field)throw new f.Error(f.Error.USERNAME_TAKEN,"Account already exists for this username.");if(e&&e.userInfo&&"email"===e.userInfo.duplicated_field)throw new f.Error(f.Error.EMAIL_TAKEN,"Account already exists for this email address.");return this.config.database.find(this.className,{username:this.data.username,objectId:{$ne:this.objectId()}},{limit:1}).then(e=>{if(e.length>0)throw new f.Error(f.Error.USERNAME_TAKEN,"Account already exists for this username.");return this.config.database.find(this.className,{email:this.data.email,objectId:{$ne:this.objectId()}},{limit:1})}).then(e=>{if(e.length>0)throw new f.Error(f.Error.EMAIL_TAKEN,"Account already exists for this email address.");throw new f.Error(f.Error.DUPLICATE_VALUE,"A duplicate value for a field with unique values was provided")})}).then(e=>{e.objectId=this.data.objectId,e.createdAt=this.data.createdAt,this.responseShouldHaveUsername&&(e.username=this.data.username),this._updateResponseWithData(e,this.data),this.response={status:201,response:e,location:this.location()}})}},n.prototype.runAfterTrigger=function(){if(!this.response||!this.response.response)return;const e=p.triggerExists(this.className,p.Types.afterSave,this.config.applicationId),t=this.config.liveQueryController.hasLiveQuery(this.className);if(!e&&!t)return Promise.resolve();var r={className:this.className};this.query&&this.query.objectId&&(r.objectId=this.query.objectId);let s;this.query&&this.query.objectId&&(s=p.inflate(r,this.originalData));const n=this.buildUpdatedObject(r);return n._handleSaveResponse(this.response.response,this.response.status||200),this.config.liveQueryController.onAfterSave(n.className,n,s),p.maybeRunTrigger(p.Types.afterSave,this.auth,n,s,this.config).catch(function(e){i.default.warn("afterSave caught an error",e)})},n.prototype.location=function(){var e="_User"===this.className?"/users/":"/classes/"+this.className+"/";return this.config.mount+e+this.data.objectId},n.prototype.objectId=function(){return this.data.objectId||this.query.objectId},n.prototype.sanitizedData=function(){const e=Object.keys(this.data).reduce((e,t)=>(/^[A-Za-z][0-9A-Za-z_]*$/.test(t)||delete e[t],e),u(this.data));return f._decode(void 0,e)},n.prototype.buildUpdatedObject=function(e){const t=p.inflate(e,this.originalData);return Object.keys(this.data).reduce(function(e,r){if(r.indexOf(".")>0){const s=r.split("."),n=s[0];let o=t.get(n);"object"!=typeof o&&(o={}),o[s[1]]=e[r],t.set(n,o),delete e[r]}return e},u(this.data)),t.set(this.sanitizedData()),t},n.prototype.cleanUserAuthData=function(){if(this.response&&this.response.response&&"_User"===this.className){const e=this.response.response;e.authData&&(Object.keys(e.authData).forEach(t=>{null===e.authData[t]&&delete e.authData[t]}),0==Object.keys(e.authData).length&&delete e.authData)}},n.prototype._updateResponseWithData=function(e,t){if(a.default.isEmpty(this.storage.fieldsChangedByTrigger))return e;const r=m.supportsForwardDelete(this.clientSDK);return this.storage.fieldsChangedByTrigger.forEach(s=>{const n=t[s];e.hasOwnProperty(s)||(e[s]=n),e[s]&&e[s].__op&&(delete e[s],r&&"Delete"==n.__op&&(e[s]=n))}),e},t.default=n,e.exports=n},function(e,t){e.exports=__webpack_require__(13)},function(e,t,r){"use strict";function s(e,t,r){if(!e)return t?s(t,void 0,r):r;if("function"==typeof e)try{return e(r)}catch(t){if("TypeError"===t.name){return new e(r)}throw t}else{if("string"==typeof e)return(e=require(e)).default&&(e=e.default),s(e,void 0,r);if(e.module)return s(e.module,void 0,e.options);if(e.class)return s(e.class,void 0,e.options);if(e.adapter)return s(e.adapter,void 0,e.options)}return e}Object.defineProperty(t,"__esModule",{value:!0}),t.loadAdapter=s,t.default=s},function(e,t){e.exports=__webpack_require__(14)},function(e,t){e.exports=__webpack_require__(15)},function(e,t){e.exports=__webpack_require__(16)},function(e,t,r){"use strict";function s(e){return e&&e.__esModule?e:{default:e}}function n(e){for(var t=[],r=0;r<e.length;r++)Array.isArray(e[r])?t=t.concat(n(e[r])):t.push(e[r]);return t}Object.defineProperty(t,"__esModule",{value:!0}),t.flatten=n,t.jobStatusHandler=function(e){let t;const r=(0,o.newObjectId)(e.objectIdSize),s=e.database,n=function(e,t){let r=Promise.resolve();return Object.freeze({create:function(s){return r=r.then(()=>t.create(e,s).then(()=>Promise.resolve(s)))},update:function(s,n){return r=r.then(()=>t.update(e,s,n))}})}(c,s),a=function(e,t){const s={status:e,finishedAt:new Date};return t&&"string"==typeof t&&(s.message=t),n.update({objectId:r},s)};return Object.freeze({setRunning:function(e,s){if(s&&s.input&&s.input.noLogStatus)return Promise.resolve();const o=new Date;return t={objectId:r,jobName:e,params:s,status:"running",source:"api",createdAt:o,ACL:{}},n.create(t)},setSucceeded:function(e){return a("succeeded",e)},setMessage:function(e){return e&&"string"==typeof e?n.update({objectId:r},{message:e}):Promise.resolve()},setFailed:function(e){return a("failed",e)}})},t.pushStatusHandler=function(e,t){let r;const s=e.database,c=function(e,t){let r=Promise.resolve();const s=l.default.master(t);return Object.freeze({create:function(n){return r=r.then(()=>i.default.create(t,s,e,n).then(({response:e})=>Promise.resolve(Object.assign({},n,e))))},update:function(n,o){return r=r.then(()=>i.default.update(t,s,e,{objectId:n.objectId},o).then(({response:e})=>Promise.resolve(Object.assign({},o,e))))}})}(u,e);let h=t;const f={setInitial:function(t={},s,n={source:"rest"}){let i=(new Date).toISOString(),l="pending";t.hasOwnProperty("push_time")&&(e.hasPushScheduledSupport?(i=t.push_time,l="scheduled"):(a.logger.warn("Trying to schedule a push while server is not configured."),a.logger.warn("Push will be sent immediately")));const u=t.data||{},d=JSON.stringify(u);let f;f="string"==typeof u.alert?(0,o.md5Hash)(u.alert):"object"==typeof u.alert?(0,o.md5Hash)(JSON.stringify(u.alert)):"d41d8cd98f00b204e9800998ecf8427e";const p={pushTime:i,query:JSON.stringify(s),payload:d,source:n.source,title:n.title,expiry:t.expiration_time,expiration_interval:t.expiration_interval,status:l,numSent:0,pushHash:f,ACL:{}};return c.create(p).then(e=>(h=e.objectId,r={objectId:h},Promise.resolve(r)))},setRunning:function(e){return a.logger.verbose(`_PushStatus ${h}: sending push to installations with %d batches`,e),c.update({status:"pending",objectId:h},{status:"running",count:e})},trackSent:function(e,t,r=process.env.MMBS_SERVER_CLEANUP_INVALID_INSTALLATIONS){const o={numSent:0,numFailed:0},i=[];return Array.isArray(e)&&(e=n(e)).reduce((e,r)=>{if(!r||!r.device||!r.device.deviceType)return e;const s=r.device.deviceType,n=r.transmitted?`sentPerType.${s}`:`failedPerType.${s}`;if(e[n]=d(e,n),void 0!==t){const s=r.transmitted?`sentPerUTCOffset.${t}`:`failedPerUTCOffset.${t}`;e[s]=d(e,s)}if(r.transmitted)e.numSent++;else{if(r&&r.response&&r.response.error&&r.device&&r.device.deviceToken){const e=r.device.deviceToken,t=r.response.error;"NotRegistered"!==t&&"InvalidRegistration"!==t||i.push(e),"Unregistered"!==t&&"BadDeviceToken"!==t||i.push(e)}e.numFailed++}return e},o),a.logger.verbose(`_PushStatus ${h}: sent push! %d success, %d failures`,o.numSent,o.numFailed),a.logger.verbose(`_PushStatus ${h}: needs cleanup`,{devicesToRemove:i}),["numSent","numFailed"].forEach(e=>{o[e]>0?o[e]={__op:"Increment",amount:o[e]}:delete o[e]}),i.length>0&&r&&(a.logger.info(`Removing device tokens on ${i.length} _Installations`),s.update("_Installation",{deviceToken:{$in:i}},{deviceToken:{__op:"Delete"}},{acl:void 0,many:!0})),d(o,"count",-1),c.update({objectId:h},o).then(e=>{if(e&&0===e.count)return this.complete()})},complete:function(){return c.update({objectId:h},{status:"succeeded",count:{__op:"Delete"}})},fail:function(e){"string"==typeof e&&(e={message:e});const t={errorMessage:e,status:"failed"};return c.update({objectId:h},t)}};return Object.defineProperty(f,"objectId",{get:()=>h}),Object.freeze(f)};var o=r(12),a=r(1),i=s(r(4)),l=s(r(6));const u="_PushStatus",c="_JobStatus",d=function(e={},t,r=1){return e[t]?e[t].amount+=r:e[t]={__op:"Increment",amount:r},e[t]}},function(e,t,r){"use strict";function s(e){return e&&e.__esModule?e:{default:e}}function n(e,t){return e.data?(e=(0,i.default)(e),l.forEach(r=>{const s=e.data[`${r}-${t}`];s&&(e.data[r]=s)}),o(e)):e}function o(e){return e.data?(Object.keys(e.data).forEach(t=>{l.forEach(r=>{0==t.indexOf(`${r}-`)&&delete e.data[t]})}),e):e}Object.defineProperty(t,"__esModule",{value:!0}),t.isPushIncrementing=function(e){return e.data&&e.data.badge&&"string"==typeof e.data.badge&&"increment"==e.data.badge.toLowerCase()},t.getLocalesFromPush=function(e){const t=e.data;return t?[...new Set(Object.keys(t).reduce((e,t)=>(l.forEach(r=>{0==t.indexOf(`${r}-`)&&e.push(t.slice(r.length+1))}),e),[]))]:[]},t.transformPushBodyForLocale=n,t.stripLocalesFromBody=o,t.bodiesPerLocales=function(e,t=[]){const r=t.reduce((t,r)=>(t[r]=n(e,r),t),{});return r.default=o(e),r},t.groupByLocaleIdentifier=function(e,t=[]){return e.reduce((e,r)=>{let s=!1;return t.forEach(t=>{s||r.localeIdentifier&&0===r.localeIdentifier.indexOf(t)&&(s=!0,e[t]=e[t]||[],e[t].push(r))}),s||e.default.push(r),e},{default:[]})},t.validatePushType=function(e={},t=[]){var r=e.deviceType||{},s=[];"string"==typeof r?s.push(r):Array.isArray(r.$in)&&s.concat(r.$in);for(var n=0;n<s.length;n++){var o=s[n];if(t.indexOf(o)<0)throw new a.default.Error(a.default.Error.PUSH_MISCONFIGURED,o+" is not supported push type.")}},t.applyDeviceTokenExists=function(e){return(e=(0,i.default)(e)).hasOwnProperty("deviceToken")||(e.deviceToken={$exists:!0}),e};var a=s(r(0)),i=s(r(21));const l=["alert","title"]},function(e,t,r){"use strict";function s(e){return function(t){const r=parseInt(t);if(!Number.isInteger(r))throw new Error(`Key ${e} has invalid value ${t}`);return r}}e.exports={numberParser:s,numberOrBoolParser:function(e){return function(t){return"boolean"==typeof t?t:"true"===t||"false"!==t&&s(e)(t)}},nullParser:function(e){return"null"==e?null:e},booleanParser:function(e){return 1==e||"true"==e||"1"==e},moduleOrObjectParser:function(e){if("object"==typeof e)return e;try{return JSON.parse(e)}catch(e){}return e},arrayParser:function(e){if(Array.isArray(e))return e;if("string"==typeof e)return e.split(",");throw new Error(`${e} should be a comma separated string or an array`)},objectParser:function(e){return"object"==typeof e?e:JSON.parse(e)}}},function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.WinstonLoggerAdapter=void 0;var s=r(33),n=r(62);const o=864e5;class a extends s.LoggerAdapter{constructor(e){super(),e&&(0,n.configureLogger)(e)}log(){return n.logger.log.apply(n.logger,arguments)}addTransport(e){(0,n.addTransport)(e)}query(e,t=(()=>{})){e||(e={});const r=e.from||new Date(Date.now()-7*o),s=e.until||new Date,a=e.size||10,i=e.order||"desc",l=e.level||"info",u={from:r,until:s,limit:a,order:i};return new Promise((e,r)=>{n.logger.query(u,(s,n)=>{if(s)return t(s),r(s);"error"==l?(t(n["mmbs-server-error"]),e(n["mmbs-server-error"])):(t(n["mmbs-server"]),e(n["mmbs-server"]))})})}}t.WinstonLoggerAdapter=a,t.default=a},function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0});class s{constructor(e){}log(e,t){}}t.LoggerAdapter=s,t.default=s},function(e,t,r){"use strict";function s(e){return e&&e.__esModule?e:{default:e}}Object.defineProperty(t,"__esModule",{value:!0}),t.LoggerController=t.LogOrder=t.LogLevel=void 0;var n=r(0),o=s(r(14)),a=r(33),i=s(r(15));const l=864e5,u=1e3,c="... (truncated)",d=t.LogLevel={INFO:"info",ERROR:"error"},h=t.LogOrder={DESCENDING:"desc",ASCENDING:"asc"},f=["error","warn","info","debug","verbose","silly"];class p extends o.default{constructor(e,t,r={logLevel:"info"}){super(e,t,r);let s="info";r.verbose&&(s="verbose"),r.logLevel&&(s=r.logLevel);const n=f.indexOf(s);f.forEach((e,t)=>{t>n&&(this[e]=(()=>{}))})}maskSensitiveUrl(e){const t=i.default.parse(e,!0).query.password;return t&&(e=e.replace("password="+t,"password=********")),e}maskSensitive(e){return e.map(e=>{if(!e)return e;if("string"==typeof e)return e.replace(/(password".?:.?")[^"]*"/g,'$1********"');if(e.url&&("string"==typeof e.url?e.url=this.maskSensitiveUrl(e.url):Array.isArray(e.url)&&(e.url=e.url.map(e=>"string"==typeof e?this.maskSensitiveUrl(e):e))),e.body)for(const t of Object.keys(e.body))if("password"===t){e.body[t]="********";break}if(e.params)for(const t of Object.keys(e.params))if("password"===t){e.params[t]="********";break}return e})}log(e,t){t=this.maskSensitive([...t]),t=[].concat(e,t.map(e=>"function"==typeof e?e():e)),this.adapter.log.apply(this.adapter,t)}info(){return this.log("info",arguments)}error(){return this.log("error",arguments)}warn(){return this.log("warn",arguments)}verbose(){return this.log("verbose",arguments)}debug(){return this.log("debug",arguments)}silly(){return this.log("silly",arguments)}logRequest({method:e,url:t,headers:r,body:s}){this.verbose(()=>{const r=JSON.stringify(s,null,2);return`REQUEST for [${e}] ${t}: ${r}`},{method:e,url:t,headers:r,body:s})}logResponse({method:e,url:t,result:r}){this.verbose(()=>{const s=JSON.stringify(r,null,2);return`RESPONSE from [${e}] ${t}: ${s}`},{result:r})}static validDateTime(e){return e?(e=new Date(e),isNaN(e.getTime())?null:e):null}truncateLogMessage(e){if(e&&e.length>u){return e.substring(0,u)+c}return e}static parseOptions(e={}){return{from:p.validDateTime(e.from)||new Date(Date.now()-7*l),until:p.validDateTime(e.until)||new Date,size:Number(e.size)||10,order:e.order||h.DESCENDING,level:e.level||d.INFO}}getLogs(e={}){if(!this.adapter)throw new n.Mmbs.Error(n.Mmbs.Error.PUSH_MISCONFIGURED,"Logger adapter is not available");if("function"!=typeof this.adapter.query)throw new n.Mmbs.Error(n.Mmbs.Error.PUSH_MISCONFIGURED,"Querying logs is not supported with this adapter");return e=p.parseOptions(e),this.adapter.query(e)}expectedAdapterType(){return a.LoggerAdapter}}t.LoggerController=p,t.default=p},function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var s=r(12),n=function(e){return e&&e.__esModule?e:{default:e}}(r(10));const o="__MAIN_SCHEMA",a="__SCHEMA",i="__ALL_KEYS";t.default=class{constructor(e,t=n.default.schemaCacheTTL,r=!1){this.ttl=t,"string"==typeof t&&(this.ttl=parseInt(t)),this.cache=e,this.prefix=a,r||(this.prefix+=(0,s.randomString)(20))}put(e,t){return this.cache.get(this.prefix+i).then(r=>(r=r||{},r[e]=!0,Promise.all([this.cache.put(this.prefix+i,r,this.ttl),this.cache.put(e,t,this.ttl)])))}getAllClasses(){return this.ttl?this.cache.get(this.prefix+o):Promise.resolve(null)}setAllClasses(e){return this.ttl?this.put(this.prefix+o,e):Promise.resolve(null)}setOneSchema(e,t){return this.ttl?this.put(this.prefix+e,t):Promise.resolve(null)}getOneSchema(e){return this.ttl?this.cache.get(this.prefix+e).then(t=>t?Promise.resolve(t):this.cache.get(this.prefix+o).then(r=>(r=r||[],(t=r.find(t=>t.className===e))?Promise.resolve(t):Promise.resolve(null)))):Promise.resolve(null)}clear(){return this.cache.get(this.prefix+i).then(e=>{if(!e)return;const t=Object.keys(e).map(e=>this.cache.del(e));return Promise.all(t)})}}},function(e,t,r){"use strict";function s(e){return e&&e.__esModule?e:{default:e}}function n(e,t){var r={};for(var s in e)t.indexOf(s)>=0||Object.prototype.hasOwnProperty.call(e,s)&&(r[s]=e[s]);return r}function o(e,t){const r=h.default.cloneDeep(e);return r._wperm={$in:[null,...t]},r}function a(e,t){this.adapter=e,this.schemaCache=t,this.schemaPromise=null}function i(e,t,r){if(t.indexOf(".")<0)return e[t]=r[t],e;const s=t.split("."),n=s[0],o=s.slice(1).join(".");return e[n]=i(e[n]||{},o,r[n]),delete e[t],e}function l(e,t){const r={};return t?(Object.keys(e).forEach(s=>{const n=e[s];n&&"object"==typeof n&&n.__op&&["Add","AddUnique","Remove","Increment"].indexOf(n.__op)>-1&&i(r,s,t)}),Promise.resolve(r)):Promise.resolve(r)}function u(e,t){return`_Join:${t}:${e}`}var c=Object.assign||function(e){for(var t=1;t<arguments.length;t++){var r=arguments[t];for(var s in r)Object.prototype.hasOwnProperty.call(r,s)&&(e[s]=r[s])}return e},d=r(0),h=s(r(7)),f=s(r(66)),p=s(r(21)),m=s(r(1)),_=function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var r in e)Object.prototype.hasOwnProperty.call(e,r)&&(t[r]=e[r]);return t.default=e,t}(r(22));const y=e=>{let{ACL:t}=e,r=n(e,["ACL"]);if(!t)return r;r._wperm=[],r._rperm=[];for(const e in t)t[e].read&&r._rperm.push(e),t[e].write&&r._wperm.push(e);return r},b=["$and","$or","_rperm","_wperm","_perishable_token","_email_verify_token","_email_verify_token_expires_at","_account_lockout_expires_at","_failed_login_count"],g=e=>{if(e.ACL)throw new d.Mmbs.Error(d.Mmbs.Error.INVALID_QUERY,"Cannot query on ACL.");if(e.$or){if(!(e.$or instanceof Array))throw new d.Mmbs.Error(d.Mmbs.Error.INVALID_QUERY,"Bad $or format - use an array value.");e.$or.forEach(g),Object.keys(e).forEach(t=>{const r=!e.$or.some(e=>e.hasOwnProperty(t));let s=!1;null!=e[t]&&"object"==typeof e[t]&&(s="$near"in e[t]||"$nearSphere"in e[t]),"$or"!=t&&r&&!s&&(e.$or.forEach(r=>{r[t]=e[t]}),delete e[t])}),e.$or.forEach(g)}if(e.$and){if(!(e.$and instanceof Array))throw new d.Mmbs.Error(d.Mmbs.Error.INVALID_QUERY,"Bad $and format - use an array value.");e.$and.forEach(g)}Object.keys(e).forEach(t=>{if(e&&e[t]&&e[t].$regex&&"string"==typeof e[t].$options&&!e[t].$options.match(/^[imxs]+$/))throw new d.Mmbs.Error(d.Mmbs.Error.INVALID_QUERY,`Bad $options value for query: ${e[t].$options}`);if(!(e=>b.indexOf(e)>=0)(t)&&!t.match(/^[a-zA-Z][a-zA-Z0-9_\.]*$/))throw new d.Mmbs.Error(d.Mmbs.Error.INVALID_KEY_NAME,`Invalid key name: ${t}`)})};a.prototype.collectionExists=function(e){return this.adapter.classExists(e)},a.prototype.purgeCollection=function(e){return this.loadSchema().then(t=>t.getOneSchema(e)).then(t=>this.adapter.deleteObjectsByQuery(e,t,{}))},a.prototype.validateClassName=function(e){return _.classNameIsValid(e)?Promise.resolve():Promise.reject(new d.Mmbs.Error(d.Mmbs.Error.INVALID_CLASS_NAME,"invalid className: "+e))},a.prototype.loadSchema=function(e={clearCache:!1}){return this.schemaPromise||(this.schemaPromise=_.load(this.adapter,this.schemaCache,e),this.schemaPromise.then(()=>delete this.schemaPromise,()=>delete this.schemaPromise)),this.schemaPromise},a.prototype.redirectClassNameForKey=function(e,t){return this.loadSchema().then(r=>{var s=r.getExpectedType(e,t);return s&&"Relation"==s.type?s.targetClass:e})},a.prototype.validateObject=function(e,t,r,{acl:s}){let n;const o=void 0===s;var a=s||[];return this.loadSchema().then(r=>(n=r,o?Promise.resolve():this.canAddField(n,e,t,a))).then(()=>n.validateObject(e,t,r))};const v=["_hashed_password","_perishable_token","_email_verify_token","_email_verify_token_expires_at","_account_lockout_expires_at","_failed_login_count","_perishable_token_expires_at","_password_changed_at","_password_history"];a.prototype.update=function(e,t,r,{acl:s,many:n,upsert:a}={},i=!1){const u=t,c=r;r=(0,p.default)(r);var h=[],f=void 0===s,m=s||[];return this.loadSchema().then(p=>(f?Promise.resolve():p.validatePermission(e,m,"update")).then(()=>(h=this.collectRelationUpdates(e,u.objectId,r),f||(t=this.addPointerPermissions(p,e,"update",t,m)),t?(s&&(t=o(t,s)),g(t),p.getOneSchema(e,!0).catch(e=>{if(void 0===e)return{fields:{}};throw e}).then(s=>{Object.keys(r).forEach(e=>{if(e.match(/^authData\.([a-zA-Z0-9_]+)\.id$/))throw new d.Mmbs.Error(d.Mmbs.Error.INVALID_KEY_NAME,`Invalid field name for update: ${e}`);if(e=e.split(".")[0],!_.fieldNameIsValid(e)&&!(e=>v.indexOf(e)>=0)(e))throw new d.Mmbs.Error(d.Mmbs.Error.INVALID_KEY_NAME,`Invalid field name for update: ${e}`)});for(const e in r)if(Object.keys(e).some(e=>e.includes("$")||e.includes(".")))throw new d.Mmbs.Error(d.Mmbs.Error.INVALID_NESTED_KEY,"Nested keys should not contain the '$' or '.' characters");return r=y(r),S(e,r,s),n?this.adapter.updateObjectsByQuery(e,s,t,r):a?this.adapter.upsertOneObject(e,s,t,r):this.adapter.findOneAndUpdate(e,s,t,r)})):Promise.resolve())).then(t=>t?this.handleRelationUpdates(e,u.objectId,r,h).then(()=>t):Promise.reject(new d.Mmbs.Error(d.Mmbs.Error.OBJECT_NOT_FOUND,"Object not found."))).then(e=>i?Promise.resolve(e):l(c,e)))},a.prototype.collectRelationUpdates=function(e,t,r){var s=[],n=[];t=r.objectId||t;var o=(e,t)=>{if(e&&("AddRelation"==e.__op&&(s.push({key:t,op:e}),n.push(t)),"RemoveRelation"==e.__op&&(s.push({key:t,op:e}),n.push(t)),"Batch"==e.__op))for(var r of e.ops)o(r,t)};for(const e in r)o(r[e],e);for(const e of n)delete r[e];return s},a.prototype.handleRelationUpdates=function(e,t,r,s){var n=[];return t=r.objectId||t,s.forEach(({key:r,op:s})=>{if(s){if("AddRelation"==s.__op)for(const o of s.objects)n.push(this.addRelation(r,e,t,o.objectId));if("RemoveRelation"==s.__op)for(const o of s.objects)n.push(this.removeRelation(r,e,t,o.objectId))}}),Promise.all(n)};const E={fields:{relatedId:{type:"String"},owningId:{type:"String"}}};a.prototype.addRelation=function(e,t,r,s){const n={relatedId:s,owningId:r};return this.adapter.upsertOneObject(`_Join:${e}:${t}`,E,n,n)},a.prototype.removeRelation=function(e,t,r,s){var n={relatedId:s,owningId:r};return this.adapter.deleteObjectsByQuery(`_Join:${e}:${t}`,E,n).catch(e=>{if(e.code!=d.Mmbs.Error.OBJECT_NOT_FOUND)throw e})},a.prototype.destroy=function(e,t,{acl:r}={}){const s=void 0===r,n=r||[];return this.loadSchema().then(a=>(s?Promise.resolve():a.validatePermission(e,n,"delete")).then(()=>{if(!s&&!(t=this.addPointerPermissions(a,e,"delete",t,n)))throw new d.Mmbs.Error(d.Mmbs.Error.OBJECT_NOT_FOUND,"Object not found.");return r&&(t=o(t,r)),g(t),a.getOneSchema(e).catch(e=>{if(void 0===e)return{fields:{}};throw e}).then(r=>this.adapter.deleteObjectsByQuery(e,r,t)).catch(t=>{if("_Session"===e&&t.code===d.Mmbs.Error.OBJECT_NOT_FOUND)return Promise.resolve({});throw t})}))};const S=(e,t,r)=>{t.authData&&"_User"===e&&(Object.keys(t.authData).forEach(e=>{const s=t.authData[e],n=`_auth_data_${e}`;null==s?t[n]={__op:"Delete"}:(t[n]=s,r.fields[n]={type:"Object"})}),delete t.authData)};a.prototype.create=function(e,t,{acl:r}={}){const s=t;(t=y(t)).createdAt={iso:t.createdAt,__type:"Date"},t.updatedAt={iso:t.updatedAt,__type:"Date"};var n=void 0===r,o=r||[];const a=this.collectRelationUpdates(e,null,t);return this.validateClassName(e).then(()=>this.loadSchema()).then(r=>(n?Promise.resolve():r.validatePermission(e,o,"create")).then(()=>r.enforceClassExists(e)).then(()=>r.reloadData()).then(()=>r.getOneSchema(e,!0)).then(r=>(S(e,t,r),(e=>{for(const t in e)if(e[t]&&e[t].__op)switch(e[t].__op){case"Increment":if("number"!=typeof e[t].amount)throw new d.Mmbs.Error(d.Mmbs.Error.INVALID_JSON,"objects to add must be an array");e[t]=e[t].amount;break;case"Add":case"AddUnique":if(!(e[t].objects instanceof Array))throw new d.Mmbs.Error(d.Mmbs.Error.INVALID_JSON,"objects to add must be an array");e[t]=e[t].objects;break;case"Remove":if(!(e[t].objects instanceof Array))throw new d.Mmbs.Error(d.Mmbs.Error.INVALID_JSON,"objects to add must be an array");e[t]=[];break;case"Delete":delete e[t];break;default:throw new d.Mmbs.Error(d.Mmbs.Error.COMMAND_UNAVAILABLE,`The ${e[t].__op} operator is not supported yet.`)}})(t),this.adapter.createObject(e,_.convertSchemaToAdapterSchema(r),t))).then(r=>this.handleRelationUpdates(e,null,t,a).then(()=>l(s,r.ops[0]))))},a.prototype.canAddField=function(e,t,r,s){const n=e.data[t];if(!n)return Promise.resolve();const o=Object.keys(r),a=Object.keys(n);return o.filter(e=>a.indexOf(e)<0).length>0?e.validatePermission(t,s,"addField"):Promise.resolve()},a.prototype.deleteEverything=function(){return this.schemaPromise=null,Promise.all([this.adapter.deleteAllClasses(),this.schemaCache.clear()])},a.prototype.relatedIds=function(e,t,r,s){const{skip:n,limit:o,sort:a}=s,i={};return a&&a.createdAt&&this.adapter.canSortOnJoinTables&&(i.sort={_id:a.createdAt},i.limit=o,i.skip=n,s.skip=0),this.adapter.find(u(e,t),E,{owningId:r},i).then(e=>e.map(e=>e.relatedId))},a.prototype.owningIds=function(e,t,r){return this.adapter.find(u(e,t),E,{relatedId:{$in:r}},{}).then(e=>e.map(e=>e.owningId))},a.prototype.reduceInRelation=function(e,t,r){if(t.$or){const s=t.$or;return Promise.all(s.map((s,n)=>this.reduceInRelation(e,s,r).then(e=>{t.$or[n]=e}))).then(()=>Promise.resolve(t))}const s=Object.keys(t).map(s=>{const n=r.getExpectedType(e,s);if(!n||"Relation"!==n.type)return Promise.resolve(t);let o=null;o=t[s]&&(t[s].$in||t[s].$ne||t[s].$nin||"Pointer"==t[s].__type)?Object.keys(t[s]).map(e=>{let r,n=!1;if("objectId"===e)r=[t[s].objectId];else if("$in"==e)r=t[s].$in.map(e=>e.objectId);else if("$nin"==e)n=!0,r=t[s].$nin.map(e=>e.objectId);else{if("$ne"!=e)return;n=!0,r=[t[s].$ne.objectId]}return{isNegation:n,relatedIds:r}}):[{isNegation:!1,relatedIds:[]}],delete t[s];const a=o.map(r=>r?this.owningIds(e,s,r.relatedIds).then(e=>(r.isNegation?this.addNotInObjectIdsIds(e,t):this.addInObjectIdsIds(e,t),Promise.resolve())):Promise.resolve());return Promise.all(a).then(()=>Promise.resolve())});return Promise.all(s).then(()=>Promise.resolve(t))},a.prototype.reduceRelationKeys=function(e,t,r){if(t.$or)return Promise.all(t.$or.map(t=>this.reduceRelationKeys(e,t,r)));var s=t.$relatedTo;return s?this.relatedIds(s.object.className,s.key,s.object.objectId,r).then(s=>(delete t.$relatedTo,this.addInObjectIdsIds(s,t),this.reduceRelationKeys(e,t,r))):void 0},a.prototype.addInObjectIdsIds=function(e=null,t){const r=["string"==typeof t.objectId?[t.objectId]:null,t.objectId&&t.objectId.$eq?[t.objectId.$eq]:null,t.objectId&&t.objectId.$in?t.objectId.$in:null,e].filter(e=>null!==e);let s=[];return s=r.reduce((e,t)=>e+t.length,0)>125?f.default.big(r):(0,f.default)(r),"objectId"in t?"string"==typeof t.objectId&&(t.objectId={$eq:t.objectId}):t.objectId={},t.objectId.$in=s,t},a.prototype.addNotInObjectIdsIds=function(e=[],t){let r=[...t.objectId&&t.objectId.$nin?t.objectId.$nin:[],...e].filter(e=>null!==e);return r=[...new Set(r)],"objectId"in t?"string"==typeof t.objectId&&(t.objectId={$eq:t.objectId}):t.objectId={},t.objectId.$nin=r,t},a.prototype.find=function(e,t,{skip:r,limit:s,acl:n,sort:o={},count:a,keys:i,op:l,distinct:u,pipeline:c,readPreference:f}={}){const p=void 0===n,m=n||[];l=l||("string"==typeof t.objectId&&1===Object.keys(t).length?"get":"find"),l=!0===a?"count":l;let y=!0;return this.loadSchema().then(n=>n.getOneSchema(e,p).catch(e=>{if(void 0===e)return y=!1,{fields:{}};throw e}).then(b=>{o._created_at&&(o.createdAt=o._created_at,delete o._created_at),o._updated_at&&(o.updatedAt=o._updated_at,delete o._updated_at),Object.keys(o).forEach(e=>{if(e.match(/^authData\.([a-zA-Z0-9_]+)\.id$/))throw new d.Mmbs.Error(d.Mmbs.Error.INVALID_KEY_NAME,`Cannot sort by ${e}`);if(!_.fieldNameIsValid(e))throw new d.Mmbs.Error(d.Mmbs.Error.INVALID_KEY_NAME,`Invalid field name: ${e}.`)});const v={skip:r,limit:s,sort:o,keys:i,readPreference:f};return(p?Promise.resolve():n.validatePermission(e,m,l)).then(()=>this.reduceRelationKeys(e,t,v)).then(()=>this.reduceInRelation(e,t,n)).then(()=>{if(p||(t=this.addPointerPermissions(n,e,l,t,m)),!t){if("get"==l)throw new d.Mmbs.Error(d.Mmbs.Error.OBJECT_NOT_FOUND,"Object not found.");return[]}return p||(t=function(e,t){const r=h.default.cloneDeep(e);return r._rperm={$in:[null,"*",...t]},r}(t,m)),g(t),a?y?this.adapter.count(e,b,t,f):0:u?y?this.adapter.distinct(e,b,t,u):[]:c?y?this.adapter.aggregate(e,b,c,f):[]:y?this.adapter.find(e,b,t,v).then(t=>t.map(t=>(t=w(t),((e,t,r,s)=>"_User"!==r?s:(s.password=s._hashed_password,delete s._hashed_password,delete s.sessionToken,e?s:(delete s._email_verify_token,delete s._perishable_token,delete s._perishable_token_expires_at,delete s._tombstone,delete s._email_verify_token_expires_at,delete s._failed_login_count,delete s._account_lockout_expires_at,delete s._password_changed_at,t.indexOf(s.objectId)>-1?s:(delete s.authData,s))))(p,m,e,t)))).catch(e=>{throw new d.Mmbs.Error(d.Mmbs.Error.INTERNAL_SERVER_ERROR,e)}):[]})}))};const w=e=>{let{_rperm:t,_wperm:r}=e,s=n(e,["_rperm","_wperm"]);return(t||r)&&(s.ACL={},(t||[]).forEach(e=>{s.ACL[e]?s.ACL[e].read=!0:s.ACL[e]={read:!0}}),(r||[]).forEach(e=>{s.ACL[e]?s.ACL[e].write=!0:s.ACL[e]={write:!0}})),s};a.prototype.deleteSchema=function(e){return this.loadSchema(!0).then(t=>t.getOneSchema(e,!0)).catch(e=>{if(void 0===e)return{fields:{}};throw e}).then(t=>this.collectionExists(e).then(()=>this.adapter.count(e,{fields:{}})).then(t=>{if(t>0)throw new d.Mmbs.Error(255,`Class ${e} is not empty, contains ${t} objects, cannot drop schema.`);return this.adapter.deleteClass(e)}).then(r=>{if(r){const r=Object.keys(t.fields).filter(e=>"Relation"===t.fields[e].type);return Promise.all(r.map(t=>this.adapter.deleteClass(u(e,t))))}return Promise.resolve()}))},a.prototype.addPointerPermissions=function(e,t,r,s,n=[]){if(e.testBaseCLP(t,n,r))return s;const o=e.perms[t],a=["get","find"].indexOf(r)>-1?"readUserFields":"writeUserFields",i=n.filter(e=>0!=e.indexOf("role:")&&"*"!=e);if(o&&o[a]&&o[a].length>0){if(1!=i.length)return;const e={__type:"Pointer",className:"_User",objectId:i[0]},t=o[a].map(t=>{const r={[t]:e};return s.hasOwnProperty(t)?{$and:[r,s]}:Object.assign({},s,{[`${t}`]:e})});return t.length>1?{$or:t}:t[0]}return s},a.prototype.performInitialization=function(){const e={fields:c({},_.defaultColumns._Default,_.defaultColumns._User)},t={fields:c({},_.defaultColumns._Default,_.defaultColumns._Role)},r=this.loadSchema().then(e=>e.enforceClassExists("_User")),s=this.loadSchema().then(e=>e.enforceClassExists("_Role")),n=r.then(()=>this.adapter.ensureUniqueness("_User",e,["username"])).catch(e=>{throw m.default.warn("Unable to ensure uniqueness for usernames: ",e),e}),o=r.then(()=>this.adapter.ensureUniqueness("_User",e,["email"])).catch(e=>{throw m.default.warn("Unable to ensure uniqueness for user email addresses: ",e),e}),a=s.then(()=>this.adapter.ensureUniqueness("_Role",t,["name"])).catch(e=>{throw m.default.warn("Unable to ensure uniqueness for role name: ",e),e}),i=this.adapter.updateSchemaWithIndexes(),l=this.adapter.performInitialization({VolatileClassesSchemas:_.VolatileClassesSchemas});return Promise.all([n,o,a,l,i])},a._validateQuery=g,e.exports=a},function(e,t,r){"use strict";var s=r(69);try{s=r(70)}catch(e){}e.exports={hash:function(e){return s.hash(e,10)},compare:function(e,t){return e&&t?s.compare(e,t):Promise.resolve(!1)}}},function(e,t,r){"use strict";function s(e){return function(t){if("string"==typeof t&&(t=n(t)),!t)return!0;const r=t.version,s=e[t.sdk];return o.satisfies(r,s)}}function n(e){const t=e.toLowerCase().match(/([-a-zA-Z]+)([0-9\.]+)/);if(t&&3===t.length)return{sdk:t[1],version:t[2]}}var o=r(71);e.exports={compatible:s,supportsForwardDelete:function(e){return s({js:">=1.9.0"})(e)},fromString:n}},function(e,t,r){"use strict";function s(e){return e&&e.className?e.className:e}var n=r(0),o=function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var r in e)Object.prototype.hasOwnProperty.call(e,r)&&(t[r]=e[r]);return t.default=e,t}(r(9)),a={};a.define=function(e,t,r){o.addFunction(e,t,r,n.Mmbs.applicationId)},a.job=function(e,t){o.addJob(e,t,n.Mmbs.applicationId)},a.beforeSave=function(e,t){var r=s(e);o.addTrigger(o.Types.beforeSave,r,t,n.Mmbs.applicationId)},a.beforeDelete=function(e,t){var r=s(e);o.addTrigger(o.Types.beforeDelete,r,t,n.Mmbs.applicationId)},a.afterSave=function(e,t){var r=s(e);o.addTrigger(o.Types.afterSave,r,t,n.Mmbs.applicationId)},a.afterDelete=function(e,t){var r=s(e);o.addTrigger(o.Types.afterDelete,r,t,n.Mmbs.applicationId)},a.beforeFind=function(e,t){var r=s(e);o.addTrigger(o.Types.beforeFind,r,t,n.Mmbs.applicationId)},a.afterFind=function(e,t){const r=s(e);o.addTrigger(o.Types.afterFind,r,t,n.Mmbs.applicationId)},a.onLiveQueryEvent=function(e){o.addLiveQueryEventHandler(e,n.Mmbs.applicationId)},a._removeAllHooks=(()=>{o._unregisterAll()}),a.useMasterKey=(()=>{n.Mmbs.CoreManager.set("USE_MASTER_KEY",!0)}),a.httpRequest=r(75),e.exports=a},function(e,t){e.exports=__webpack_require__(17)},function(e,t){e.exports=__webpack_require__(18)},function(e,t,r){"use strict";function s(e){const t=e.redisURL;return void 0!==t&&""!==t}Object.defineProperty(t,"__esModule",{value:!0}),t.MmbsPubSub=void 0;var n=r(25),o=r(102),a=r(103);const i={};i.createPublisher=function(e){if(s(e))return a.RedisPubSub.createPublisher(e);{const t=(0,n.loadAdapter)(e.pubSubAdapter,o.EventEmitterPubSub,e);if("function"!=typeof t.createPublisher)throw"pubSubAdapter should have createPublisher()";return t.createPublisher(e)}},i.createSubscriber=function(e){if(s(e))return a.RedisPubSub.createSubscriber(e);{const t=(0,n.loadAdapter)(e.pubSubAdapter,o.EventEmitterPubSub,e);if("function"!=typeof t.createSubscriber)throw"pubSubAdapter should have createSubscriber()";return t.createSubscriber(e)}},t.MmbsPubSub=i},function(e,t){e.exports=__webpack_require__(2)},function(e,t){e.exports=__webpack_require__(19)},function(e,t){e.exports=__webpack_require__(20)},function(e,t,r){"use strict";function s(e){return e&&e.__esModule?e:{default:e}}Object.defineProperty(t,"__esModule",{value:!0}),t.UsersRouter=void 0;var n=s(r(0)),o=s(r(8)),a=s(r(112)),i=s(r(13)),l=s(r(4)),u=s(r(6)),c=s(r(37)),d=s(r(23));const h=r(12);class f extends i.default{className(){return"_User"}static removeHiddenProperties(e){for(var t in e)e.hasOwnProperty(t)&&("__type"===t||/^[A-Za-z][0-9A-Za-z_]*$/.test(t)||delete e[t])}handleMe(e){if(!e.info||!e.info.sessionToken)throw new n.default.Error(n.default.Error.INVALID_SESSION_TOKEN,"invalid session token");const t=e.info.sessionToken;return l.default.find(e.config,u.default.master(e.config),"_Session",{sessionToken:t},{include:"user"},e.info.clientSDK).then(e=>{if(e.results&&0!=e.results.length&&e.results[0].user){const r=e.results[0].user;return r.sessionToken=t,f.removeHiddenProperties(r),{response:r}}throw new n.default.Error(n.default.Error.INVALID_SESSION_TOKEN,"invalid session token")})}handleLogIn(e){let t=e.body;(!t.username&&e.query.username||!t.email&&e.query.email)&&(t=e.query);const{username:r,email:s,password:o}=t;if(!r&&!s)throw new n.default.Error(n.default.Error.USERNAME_MISSING,"username/email is required.");if(!o)throw new n.default.Error(n.default.Error.PASSWORD_MISSING,"password is required.");if("string"!=typeof o||s&&"string"!=typeof s||r&&"string"!=typeof r)throw new n.default.Error(n.default.Error.OBJECT_NOT_FOUND,"Invalid username/password.");let i,l=!1;const p=Object.assign({},r?{username:r}:{},s?{email:s}:{});return e.config.database.find("_User",p).then(t=>{if(!t.length)throw new n.default.Error(n.default.Error.OBJECT_NOT_FOUND,"Invalid username/password.");if(i=t[0],e.config.verifyUserEmails&&e.config.preventLoginWithUnverifiedEmail&&!i.emailVerified)throw new n.default.Error(n.default.Error.EMAIL_NOT_FOUND,"User email is not verified.");return c.default.compare(o,i.password)}).then(t=>{l=t;return new a.default(i,e.config).handleLoginAttempt(l)}).then(()=>{if(!l)throw new n.default.Error(n.default.Error.OBJECT_NOT_FOUND,"Invalid username/password.");if(e.config.passwordPolicy&&e.config.passwordPolicy.maxPasswordAge){let t=i._password_changed_at;if(t){"Date"==t.__type&&(t=new Date(t.iso));if(new Date(t.getTime()+864e5*e.config.passwordPolicy.maxPasswordAge)<new Date)throw new n.default.Error(n.default.Error.OBJECT_NOT_FOUND,"Your password has expired. Please reset your password.")}else t=new Date,e.config.database.update("_User",{username:i.username},{_password_changed_at:n.default._encode(t)})}const t="r:"+h.newToken();i.sessionToken=t,delete i.password,f.removeHiddenProperties(i),i.authData&&(Object.keys(i.authData).forEach(e=>{null===i.authData[e]&&delete i.authData[e]}),0==Object.keys(i.authData).length&&delete i.authData),e.config.filesController.expandFilesInObject(e.config,i);const r=e.config.generateSessionExpiresAt(),s={sessionToken:t,user:{__type:"Pointer",className:"_User",objectId:i.objectId},createdWith:{action:"login",authProvider:"password"},restricted:!1,expiresAt:n.default._encode(r)};e.info.installationId&&(s.installationId=e.info.installationId);return new d.default(e.config,u.default.master(e.config),"_Session",null,s).execute()}).then(()=>({response:i}))}handleLogOut(e){const t={response:{}};return e.info&&e.info.sessionToken?l.default.find(e.config,u.default.master(e.config),"_Session",{sessionToken:e.info.sessionToken},void 0,e.info.clientSDK).then(r=>r.results&&r.results.length?l.default.del(e.config,u.default.master(e.config),"_Session",r.results[0].objectId).then(()=>Promise.resolve(t)):Promise.resolve(t)):Promise.resolve(t)}_throwOnBadEmailConfig(e){try{o.default.validateEmailConfiguration({emailAdapter:e.config.userController.adapter,appName:e.config.appName,publicServerURL:e.config.publicServerURL,emailVerifyTokenValidityDuration:e.config.emailVerifyTokenValidityDuration})}catch(e){throw"string"==typeof e?new n.default.Error(n.default.Error.INTERNAL_SERVER_ERROR,"An appName, publicServerURL, and emailAdapter are required for password reset and email verification functionality."):e}}handleResetRequest(e){this._throwOnBadEmailConfig(e);const{email:t}=e.body;if(!t)throw new n.default.Error(n.default.Error.EMAIL_MISSING,"you must provide an email");if("string"!=typeof t)throw new n.default.Error(n.default.Error.INVALID_EMAIL_ADDRESS,"you must provide a valid email string");return e.config.userController.sendPasswordResetEmail(t).then(()=>Promise.resolve({response:{}}),e=>{throw e.code===n.default.Error.OBJECT_NOT_FOUND?new n.default.Error(n.default.Error.EMAIL_NOT_FOUND,`No user found with email ${t}.`):e})}handleVerificationEmailRequest(e){this._throwOnBadEmailConfig(e);const{email:t}=e.body;if(!t)throw new n.default.Error(n.default.Error.EMAIL_MISSING,"you must provide an email");if("string"!=typeof t)throw new n.default.Error(n.default.Error.INVALID_EMAIL_ADDRESS,"you must provide a valid email string");return e.config.database.find("_User",{email:t}).then(r=>{if(!r.length||r.length<1)throw new n.default.Error(n.default.Error.EMAIL_NOT_FOUND,`No user found with email ${t}`);const s=r[0];if(s.emailVerified)throw new n.default.Error(n.default.Error.OTHER_CAUSE,`Email ${t} is already verified.`);return e.config.userController.sendVerificationEmail(s),{response:{}}})}mountRoutes(){this.route("GET","/users",e=>this.handleFind(e)),this.route("POST","/users",e=>this.handleCreate(e)),this.route("GET","/users/me",e=>this.handleMe(e)),this.route("GET","/users/:objectId",e=>this.handleGet(e)),this.route("PUT","/users/:objectId",e=>this.handleUpdate(e)),this.route("DELETE","/users/:objectId",e=>this.handleDelete(e)),this.route("GET","/login",e=>this.handleLogIn(e)),this.route("POST","/login",e=>this.handleLogIn(e)),this.route("POST","/logout",e=>this.handleLogOut(e)),this.route("POST","/requestPasswordReset",e=>this.handleResetRequest(e)),this.route("POST","/verificationEmailRequest",e=>this.handleVerificationEmailRequest(e))}}t.UsersRouter=f,t.default=f},function(e,t,r){"use strict";function s(e,t){if(Array.isArray(t)){const r=e.consumer_key;if(!r)throw a.error("Twitter Auth","Multiple twitter configurations are available, by no consumer_key was sent by the client."),new o.Error(o.Error.OBJECT_NOT_FOUND,"Twitter auth is invalid for this user.");if(0==(t=t.filter(e=>e.consumer_key==r)).length)throw a.error("Twitter Auth","Cannot find a configuration for the provided consumer_key"),new o.Error(o.Error.OBJECT_NOT_FOUND,"Twitter auth is invalid for this user.");t=t[0]}return t}var n=r(126),o=r(0).Mmbs,a=r(1).default;e.exports={validateAppId:function(){return Promise.resolve()},validateAuthData:function(e,t){if(!t)throw new o.Error(o.Error.INTERNAL_SERVER_ERROR,"Twitter auth configuration missing");t=s(e,t);var r=new n(t);return r.host="api.twitter.com",r.auth_token=e.auth_token,r.auth_token_secret=e.auth_token_secret,r.get("/1.1/account/verify_credentials.json").then(t=>{if(!t||t.id_str!=""+e.id)throw new o.Error(o.Error.OBJECT_NOT_FOUND,"Twitter auth is invalid for this user.")})},handleMultipleConfigurations:s}},function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0});class s{createFile(e,t,r){}deleteFile(e){}getFileData(e){}getFileLocation(e,t){}}t.FilesAdapter=s,t.default=s},function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0});class s{appOpened(e,t){return Promise.resolve({})}trackEvent(e,t,r){return Promise.resolve({})}}t.AnalyticsAdapter=s,t.default=s},function(e,t,r){"use strict";function s(e){return e&&e.__esModule?e:{default:e}}Object.defineProperty(t,"__esModule",{value:!0}),t.PushQueue=void 0;var n=r(51),o=s(r(4)),a=r(30),i=s(r(0));const l="mmbs-server-push",u=100;class c{constructor(e={}){this.channel=e.channel||c.defaultPushChannel(),this.batchSize=e.batchSize||u,this.parsePublisher=n.MmbsMessageQueue.createPublisher(e)}static defaultPushChannel(){return`${i.default.applicationId}-${l}`}enqueue(e,t,r,s,n){const i=this.batchSize;t=(0,a.applyDeviceTokenExists)(t);return Promise.resolve().then(()=>o.default.find(r,s,"_Installation",t,{limit:0,count:!0})).then(({results:s,count:o})=>{if(!s||0==o)return Promise.reject({error:"PushController: no results in query"});n.setRunning(Math.ceil(o/i));let a=0;for(;a<o;){const s={body:e,query:{where:t,limit:i,skip:a,order:"objectId"},pushStatus:{objectId:n.objectId},applicationId:r.applicationId};this.parsePublisher.publish(this.channel,JSON.stringify(s)),a+=i}})}}t.PushQueue=c},function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.MmbsMessageQueue=void 0;var s=r(25),n=r(144);const o={};o.createPublisher=function(e){const t=(0,s.loadAdapter)(e.messageQueueAdapter,n.EventEmitterMQ,e);if("function"!=typeof t.createPublisher)throw"pubSubAdapter should have createPublisher()";return t.createPublisher(e)},o.createSubscriber=function(e){const t=(0,s.loadAdapter)(e.messageQueueAdapter,n.EventEmitterMQ,e);if("function"!=typeof t.createSubscriber)throw"messageQueueAdapter should have createSubscriber()";return t.createSubscriber(e)},t.MmbsMessageQueue=o},function(e,t,r){"use strict";function s(e){return e&&e.__esModule?e:{default:e}}Object.defineProperty(t,"__esModule",{value:!0}),t.PushWorker=void 0;var n=s(r(21)),o=s(r(14)),a=r(6),i=s(r(8)),l=r(145),u=s(r(4)),c=r(29),d=function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var r in e)Object.prototype.hasOwnProperty.call(e,r)&&(t[r]=e[r]);return t.default=e,t}(r(30)),h=r(51),f=r(50),p=s(r(1));class m{constructor(e,t={}){if(o.default.validateAdapter(e,this,l.PushAdapter),this.adapter=e,this.channel=t.channel||f.PushQueue.defaultPushChannel(),this.subscriber=h.MmbsMessageQueue.createSubscriber(t),this.subscriber){const e=this.subscriber;e.subscribe(this.channel),e.on("message",(e,t)=>{const r=JSON.parse(t);this.run(r)})}}unsubscribe(){this.subscriber&&this.subscriber.unsubscribe(this.channel)}run({body:e,query:t,pushStatus:r,applicationId:s,UTCOffset:n}){const o=i.default.get(s),l=(0,a.master)(o),h=d.applyDeviceTokenExists(t.where);return delete t.where,r=(0,c.pushStatusHandler)(o,r.objectId),u.default.find(o,l,"_Installation",h,t).then(({results:t})=>{if(0!=t.length)return this.sendToAdapter(e,t,r,o,n)},e=>{throw e})}sendToAdapter(e,t,r,s,o){const a=d.getLocalesFromPush(e);if(a.length>0){const n=d.bodiesPerLocales(e,a),i=d.groupByLocaleIdentifier(t,a),l=Object.keys(i).map(e=>{const t=i[e],a=n[e];return this.sendToAdapter(a,t,r,s,o)});return Promise.all(l)}if(!d.isPushIncrementing(e))return p.default.verbose(`Sending push to ${t.length}`),this.adapter.send(e,t,r.objectId).then(e=>r.trackSent(e,o).then(()=>e));const i=function(e){return e.reduce((e,t)=>{const r=t.badge+"";return e[r]=e[r]||[],e[r].push(t),e},{})}(t),l=Object.keys(i).map(t=>{const a=(0,n.default)(e);a.data.badge=parseInt(t);const l=i[t];return this.sendToAdapter(a,l,r,s,o)});return Promise.all(l)}}t.PushWorker=m,t.default=m},function(e,t,r){"use strict";function s(e){let t=(e=e||{}).filesSubDirectory||"";if(this._filesDir=t,this._mkdir(this._getApplicationDir()),!this._applicationDirExist())throw"Files directory doesn't exist."}var n=r(27),o=r(11),a=r(11).sep;s.prototype.createFile=function(e,t){return new Promise((r,s)=>{let o=this._getLocalFilePath(e);n.writeFile(o,t,e=>{if(null!==e)return s(e);r(t)})})},s.prototype.deleteFile=function(e){return new Promise((t,r)=>{let s=this._getLocalFilePath(e);n.readFile(s,function(e,o){if(null!==e)return r(e);n.unlink(s,s=>{if(null!==e)return r(s);t(o)})})})},s.prototype.getFileData=function(e){return new Promise((t,r)=>{let s=this._getLocalFilePath(e);n.readFile(s,function(e,s){if(null!==e)return r(e);t(s)})})},s.prototype.getFileLocation=function(e,t){return e.mount+"/files/"+e.applicationId+"/"+encodeURIComponent(t)},s.prototype._getApplicationDir=function(){return this._filesDir?o.join("files",this._filesDir):"files"},s.prototype._applicationDirExist=function(){return n.existsSync(this._getApplicationDir())},s.prototype._getLocalFilePath=function(e){let t=this._getApplicationDir();return n.existsSync(t)||this._mkdir(t),o.join(t,encodeURIComponent(e))},s.prototype._mkdir=function(e){let t=e.split(a);for(var r="";t.length>0;){var s=t.shift();if(""===s&&(r=a),!n.existsSync(o.join(r,s)))try{n.mkdirSync(o.join(r,s))}catch(e){if("EACCES"==e.code)throw new Error("PERMISSION ERROR: In order to use the FileSystemAdapter, write access to the server's file system is required.")}r=o.join(r,s,a)}},e.exports=s,e.exports.default=s},function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.InMemoryCacheAdapter=void 0;var s=r(55);class n{constructor(e){this.cache=new s.LRUCache(e)}get(e){const t=this.cache.get(e);return null===t?Promise.resolve(null):Promise.resolve(t)}put(e,t,r){return this.cache.put(e,t,r),Promise.resolve()}del(e){return this.cache.del(e),Promise.resolve()}clear(){return this.cache.clear(),Promise.resolve()}}t.InMemoryCacheAdapter=n,t.default=n},function(e,t,r){"use strict";function s(e){return e&&e.__esModule?e:{default:e}}Object.defineProperty(t,"__esModule",{value:!0}),t.LRUCache=void 0;var n=s(r(45)),o=s(r(10));class a{constructor({ttl:e=o.default.cacheTTL,maxSize:t=o.default.cacheMaxSize}){this.cache=new n.default({max:t,maxAge:e})}get(e){return this.cache.get(e)||null}put(e,t,r=this.ttl){this.cache.set(e,t,r)}del(e){this.cache.del(e)}clear(){this.cache.reset()}}t.LRUCache=a,t.default=a},function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0});r(26).Collection;t.default=class{constructor(e){this._mongoCollection=e}find(e,{skip:t,limit:r,sort:s,keys:n,maxTimeMS:o,readPreference:a}={}){return n&&n.$score&&(delete n.$score,n.score={$meta:"textScore"}),this._rawFind(e,{skip:t,limit:r,sort:s,keys:n,maxTimeMS:o,readPreference:a}).catch(i=>{if(17007!=i.code&&!i.message.match(/unable to find index for .geoNear/))throw i;const l=i.message.match(/field=([A-Za-z_0-9]+) /)[1];if(!l)throw i;var u={};return u[l]="2d",this._mongoCollection.createIndex(u).then(()=>this._rawFind(e,{skip:t,limit:r,sort:s,keys:n,maxTimeMS:o,readPreference:a}))})}_rawFind(e,{skip:t,limit:r,sort:s,keys:n,maxTimeMS:o,readPreference:a}={}){let i=this._mongoCollection.find(e,{skip:t,limit:r,sort:s,readPreference:a});return n&&(i=i.project(n)),o&&(i=i.maxTimeMS(o)),i.toArray()}count(e,{skip:t,limit:r,sort:s,maxTimeMS:n,readPreference:o}={}){return this._mongoCollection.count(e,{skip:t,limit:r,sort:s,maxTimeMS:n,readPreference:o})}distinct(e,t){return this._mongoCollection.distinct(e,t)}aggregate(e,{maxTimeMS:t,readPreference:r}={}){return this._mongoCollection.aggregate(e,{maxTimeMS:t,readPreference:r}).toArray()}insertOne(e){return this._mongoCollection.insertOne(e)}upsertOne(e,t){return this._mongoCollection.update(e,t,{upsert:!0})}updateOne(e,t){return this._mongoCollection.updateOne(e,t)}updateMany(e,t){return this._mongoCollection.updateMany(e,t)}deleteMany(e){return this._mongoCollection.deleteMany(e)}_ensureSparseUniqueIndexInBackground(e){return new Promise((t,r)=>{this._mongoCollection.ensureIndex(e,{unique:!0,background:!0,sparse:!0},e=>{e?r(e):t()})})}drop(){return this._mongoCollection.drop()}}},function(e,t){e.exports=__webpack_require__(21)},function(e,t){function r(e){throw new Error("Cannot find module '"+e+"'.")}r.keys=function(){return[]},r.resolve=r,e.exports=r,r.id=58},function(e,t,r){"use strict";function s(e){return e&&e.__esModule?e:{default:e}}Object.defineProperty(t,"__esModule",{value:!0}),t.MmbsServer=t.PushWorker=t.TestUtils=t.LRUCacheAdapter=t.RedisCacheAdapter=t.NullCacheAdapter=t.InMemoryCacheAdapter=t.FileSystemAdapter=void 0;var n=s(r(60)),o=s(r(53)),a=s(r(54)),i=s(r(164)),l=s(r(165)),u=s(r(55)),c=function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var r in e)Object.prototype.hasOwnProperty.call(e,r)&&(t[r]=e[r]);return t.default=e,t}(r(166)),d=(r(167),r(1)),h=r(52);r(19);const f=function(e){return new n.default(e).app};f.createLiveQueryServer=n.default.createLiveQueryServer,f.start=n.default.start,Object.defineProperty(e.exports,"logger",{get:d.getLogger}),t.default=n.default,t.FileSystemAdapter=o.default,t.InMemoryCacheAdapter=a.default,t.NullCacheAdapter=i.default,t.RedisCacheAdapter=l.default,t.LRUCacheAdapter=u.default,t.TestUtils=c,t.PushWorker=h.PushWorker,t.MmbsServer=f},function(e,t,r){"use strict";function s(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var r in e)Object.prototype.hasOwnProperty.call(e,r)&&(t[r]=e[r]);return t.default=e,t}function n(e){return e&&e.__esModule?e:{default:e}}function o(){const e=r(39);Object.assign(F.Cloud,e),global.Mmbs=F}function a(e){const t=e.server,r={};t.on("connection",e=>{const t=e.remoteAddress+":"+e.remotePort;r[t]=e,e.on("close",()=>{delete r[t]})});const s=function(){process.stdout.write("Termination signal received. Shutting down."),function(){for(const e in r)try{r[e].destroy()}catch(e){}}(),t.close(),e.handleShutdown()};process.on("SIGTERM",s),process.on("SIGINT",s)}Object.defineProperty(t,"__esModule",{value:!0});r(19);var i=n(r(10)),l=s(r(1)),u=n(r(8)),c=n(r(68)),d=n(r(2)),h=n(r(79)),f=r(80),p=r(13),m=r(81),_=r(83),y=r(84),b=r(85),g=r(86),v=r(87),E=r(88),S=r(89),w=r(90),O=r(106),I=r(107),A=r(108),N=r(109),C=r(110),P=r(111),T=r(46),R=r(113),$=r(114),j=r(115),k=r(116),M=s(r(118)),L=r(162),x=r(40),D=r(24),U=r(5),F=r(0).Mmbs;r(11);o();class q{constructor(e){!function(e){Object.keys(i.default).forEach(t=>{e.hasOwnProperty(t)||(e[t]=i.default[t])}),e.hasOwnProperty("serverURL")||(e.serverURL=`http://localhost:${e.port}${e.mountPath}`),e.userSensitiveFields=Array.from(new Set(e.userSensitiveFields.concat(i.default.userSensitiveFields,e.userSensitiveFields))),e.masterKeyIps=Array.from(new Set(e.masterKeyIps.concat(i.default.masterKeyIps,e.masterKeyIps)))}(e);const{appId:t=(0,h.default)("You must provide an appId!"),masterKey:r=(0,h.default)("You must provide a masterKey!"),cloud:s,javascriptKey:n,allowAnonymousKey:a,serverURL:d=(0,h.default)("You must provide a serverURL!"),__indexBuildCompletionCallbackForTests:f=(()=>{}),webHookServerURL:p,runCronManual:m,initUser:_,isForbidAnonymousUser:y}=e;F.initialize(t,n||"unused",r,a),F.serverURL=d,y&&(F.useAllowAnonymousKey=!0);const b=M.getControllers(e),{loggerController:g,databaseController:v,hooksController:E}=b;this.config=u.default.put(Object.assign({},e,b)),l.setLogger(g);const S=v.performInitialization();if(E.load(p),process.env.TESTING&&f(S),s)if(o(),"function"==typeof s)s(F);else{if("string"!=typeof s)throw"argument 'cloud' must either be a string or a function";require(s)}m||(this.crobTab=new c.default(t),this.crobTab.start()),_&&_.username&&_.password&&setTimeout(()=>{new F.Query(F.User,{useMasterKey:!0}).count().then(e=>{if(0==e){const e=new F.User;for(let t in _)"role"!==t&&e.set(t,_[t]);return e.save(null,{useMasterKey:!0})}return F.Promise.as({})}).then(e=>{if(_.role&&e.id){var t=new F.ACL;t.setPublicReadAccess(!0);var r=new F.Role(_.role,t);return r.relation("users").add(e),r.save(null,{useMasterKey:!0})}return F.Promise.as({})}).catch(e=>{throw e})},3e3)}get app(){return this._app||(this._app=q.app(this.config)),this._app}handleShutdown(){const{adapter:e}=this.config.databaseController;e&&"function"==typeof e.handleShutdown&&e.handleShutdown()}static app({maxUploadSize:e="100mb",appId:t}){var r=D();r.use("/",U.allowCrossDomain,(new _.FilesRouter).expressRouter({maxUploadSize:e})),r.use("/health",function(e,t){t.json({status:"ok"})}),r.use("/",x.urlencoded({extended:!1}),(new O.PublicAPIRouter).expressRouter()),r.use(x.json({type:"*/*",limit:e})),r.use(U.allowCrossDomain),r.use(U.allowMethodOverride),r.use(U.handleMmbsHeaders);const s=q.promiseRouter({appId:t});return r.use(s.expressRouter()),r.use(U.handleMmbsErrors),process.env.TESTING||(process.on("uncaughtException",e=>{if("EADDRINUSE"!==e.code)throw e;process.stderr.write(`Unable to listen on port ${e.port}. The port is already in use.`),process.exit(0)}),r.on("mount",function(){q.verifyServerUrl()})),"1"===process.env.MMBS_SERVER_ENABLE_EXPERIMENTAL_DIRECT_ACCESS&&F.CoreManager.setRESTController((0,k.MmbsServerRESTController)(t,s)),r}static promiseRouter({appId:e}){const t=[new p.ClassesRouter,new T.UsersRouter,new P.SessionsRouter,new N.RolesRouter,new f.AnalyticsRouter,new E.InstallationsRouter,new y.FunctionsRouter,new C.SchemasRouter,new I.PushRouter,new S.LogsRouter,new v.IAPValidationRouter,new m.FeaturesRouter,new b.GlobalConfigRouter,new R.PurgeRouter,new g.HooksRouter,new A.CloudCodeRouter,new $.AudiencesRouter,new j.AggregateRouter].reduce((e,t)=>e.concat(t.routes),[]),r=new d.default(t,e);return L.mountOnto(r),r}start(e,t){const r=D();if(e.middleware){let t;t="string"==typeof e.middleware?require(e.middleware):e.middleware,r.use(t)}r.use(e.mountPath,this.app);const s=r.listen(e.port,e.host,t);return this.server=s,(e.startLiveQueryServer||e.liveQueryServerOptions)&&(this.liveQueryServer=q.createLiveQueryServer(s,e.liveQueryServerOptions)),process.env.TESTING||a(this),this.expressApp=r,this}static start(e,t){return new q(e).start(e,t)}static createLiveQueryServer(e,t){if(!e||t&&t.port){var s=D();(e=r(163).createServer(s)).listen(t.port)}return new w.MmbsLiveQueryServer(e,t)}static verifyServerUrl(e){if(F.serverURL){r(18)(F.serverURL.replace(/\/$/,"")+"/health",function(t,r,s){let n;try{n=JSON.parse(s)}catch(e){n=null}t||200!==r.statusCode||!n||n&&"ok"!==n.status?(console.warn(`\nWARNING, Unable to connect to '${F.serverURL}'.`+" Cloud code and push notifications may be unavailable!\n"),e&&e(!1)):e&&e(!0)})}}}t.default=q},function(e,t,r){"use strict";var s=r(31);e.exports.MmbsServerOptions={appId:{env:"MMBS_SERVER_APPLICATION_ID",help:"Your Mmbs Application ID",required:!0},masterKey:{env:"MMBS_SERVER_MASTER_KEY",help:"Your Mmbs Master Key",required:!0},serverURL:{env:"MMBS_SERVER_URL",help:"URL to your mmbs server with http:// or https://.",required:!0},masterKeyIps:{env:"MMBS_SERVER_MASTER_KEY_IPS",help:"Restrict masterKey to be used by only these ips. defaults to [] (allow all ips)",action:s.arrayParser,default:[]},appName:{env:"MMBS_SERVER_APP_NAME",help:"Sets the app name"},analyticsAdapter:{env:"MMBS_SERVER_ANALYTICS_ADAPTER",help:"Adapter module for the analytics",action:s.moduleOrObjectParser},filesAdapter:{env:"MMBS_SERVER_FILES_ADAPTER",help:"Adapter module for the files sub-system",action:s.moduleOrObjectParser},push:{env:"MMBS_SERVER_PUSH",help:"Configuration for push, as stringified JSON. See http://docs.parseplatform.org/mmbs-server/guide/#push-notifications",action:s.objectParser},scheduledPush:{env:"MMBS_SERVER_SCHEDULED_PUSH",help:"Configuration for push scheduling. Defaults to false.",action:s.booleanParser,default:!1},loggerAdapter:{env:"MMBS_SERVER_LOGGER_ADAPTER",help:"Adapter module for the logging sub-system",action:s.moduleOrObjectParser},jsonLogs:{env:"JSON_LOGS",help:"Log as structured JSON objects",action:s.booleanParser},logsFolder:{env:"MMBS_SERVER_LOGS_FOLDER",help:"Folder for the logs (defaults to './logs'); set to null to disable file based logging",default:"./logs"},verbose:{env:"VERBOSE",help:"Set the logging to verbose",action:s.booleanParser},logLevel:{env:"MMBS_SERVER_LOG_LEVEL",help:"Sets the level for logs"},silent:{env:"SILENT",help:"Disables console output",action:s.booleanParser},databaseURI:{env:"MMBS_SERVER_DATABASE_URI",help:"The full URI to your mongodb database",required:!0,default:"mongodb://localhost:27017/mmbs"},databaseOptions:{env:"MMBS_SERVER_DATABASE_OPTIONS",help:"Options to pass to the mongodb client",action:s.objectParser},databaseAdapter:{env:"MMBS_SERVER_DATABASE_ADAPTER",help:"Adapter module for the database",action:s.moduleOrObjectParser},cloud:{env:"MMBS_SERVER_CLOUD",help:"Full path to your cloud code main.js"},collectionPrefix:{env:"MMBS_SERVER_COLLECTION_PREFIX",help:"A collection prefix for the classes",default:""},clientKey:{env:"MMBS_SERVER_CLIENT_KEY",help:"Key for iOS, MacOS, tvOS clients"},javascriptKey:{env:"MMBS_SERVER_JAVASCRIPT_KEY",help:"Key for the Javascript SDK"},dotNetKey:{env:"MMBS_SERVER_DOT_NET_KEY",help:"Key for Unity and .Net SDK"},restAPIKey:{env:"MMBS_SERVER_REST_API_KEY",help:"Key for REST calls"},readOnlyMasterKey:{env:"MMBS_SERVER_READ_ONLY_MASTER_KEY",help:"Read-only key, which has the same capabilities as MasterKey without writes"},webhookKey:{env:"MMBS_SERVER_WEBHOOK_KEY",help:"Key sent with outgoing webhook calls"},fileKey:{env:"MMBS_SERVER_FILE_KEY",help:"Key for your files"},userSensitiveFields:{env:"MMBS_SERVER_USER_SENSITIVE_FIELDS",help:"Personally identifiable information fields in the user table the should be removed for non-authorized users.",action:s.arrayParser,default:["email"]},enableAnonymousUsers:{env:"MMBS_SERVER_ENABLE_ANON_USERS",help:"Enable (or disable) anon users, defaults to true",action:s.booleanParser,default:!0},allowClientClassCreation:{env:"MMBS_SERVER_ALLOW_CLIENT_CLASS_CREATION",help:"Enable (or disable) client class creation, defaults to true",action:s.booleanParser,default:!0},auth:{env:"MMBS_SERVER_AUTH_PROVIDERS",help:"Configuration for your authentication providers, as stringified JSON. See http://docs.parseplatform.org/mmbs-server/guide/#oauth-and-3rd-party-authentication",action:s.objectParser},maxUploadSize:{env:"MMBS_SERVER_MAX_UPLOAD_SIZE",help:"Max file size for uploads. defaults to 20mb",default:"20mb"},verifyUserEmails:{env:"MMBS_SERVER_VERIFY_USER_EMAILS",help:"Enable (or disable) user email validation, defaults to false",action:s.booleanParser,default:!1},preventLoginWithUnverifiedEmail:{env:"MMBS_SERVER_PREVENT_LOGIN_WITH_UNVERIFIED_EMAIL",help:"Prevent user from login if email is not verified and MMBS_SERVER_VERIFY_USER_EMAILS is true, defaults to false",action:s.booleanParser,default:!1},emailVerifyTokenValidityDuration:{env:"MMBS_SERVER_EMAIL_VERIFY_TOKEN_VALIDITY_DURATION",help:"Email verification token validity duration",action:s.numberParser("emailVerifyTokenValidityDuration")},accountLockout:{env:"MMBS_SERVER_ACCOUNT_LOCKOUT",help:"account lockout policy for failed login attempts",action:s.objectParser},passwordPolicy:{env:"MMBS_SERVER_PASSWORD_POLICY",help:"Password policy for enforcing password related rules",action:s.objectParser},cacheAdapter:{env:"MMBS_SERVER_CACHE_ADAPTER",help:"Adapter module for the cache",action:s.moduleOrObjectParser},emailAdapter:{env:"MMBS_SERVER_EMAIL_ADAPTER",help:"Adapter module for the email sending",action:s.moduleOrObjectParser},publicServerURL:{env:"MMBS_PUBLIC_SERVER_URL",help:"Public URL to your mmbs server with http:// or https://."},customPages:{env:"MMBS_SERVER_CUSTOM_PAGES",help:"custom pages for password validation and reset",action:s.objectParser,default:{}},liveQuery:{env:"MMBS_SERVER_LIVE_QUERY",help:"mmbs-server's LiveQuery configuration object",action:s.objectParser},sessionLength:{env:"MMBS_SERVER_SESSION_LENGTH",help:"Session duration, in seconds, defaults to 1 year",action:s.numberParser("sessionLength"),default:31536e3},maxLimit:{env:"MMBS_SERVER_MAX_LIMIT",help:"Max value for limit option on queries, defaults to unlimited",action:s.numberParser("maxLimit")},expireInactiveSessions:{env:"MMBS_SERVER_EXPIRE_INACTIVE_SESSIONS",help:"Sets wether we should expire the inactive sessions, defaults to true",action:s.booleanParser,default:!0},revokeSessionOnPasswordReset:{env:"MMBS_SERVER_REVOKE_SESSION_ON_PASSWORD_RESET",help:"When a user changes their password, either through the reset password email or while logged in, all sessions are revoked if this is true. Set to false if you don't want to revoke sessions.",action:s.booleanParser,default:!0},schemaCacheTTL:{env:"MMBS_SERVER_SCHEMA_CACHE_TTL",help:"The TTL for caching the schema for optimizing read/write operations. You should put a long TTL when your DB is in production. default to 5000; set 0 to disable.",action:s.numberParser("schemaCacheTTL"),default:5e3},cacheTTL:{env:"MMBS_SERVER_CACHE_TTL",help:"Sets the TTL for the in memory cache (in ms), defaults to 5000 (5 seconds)",action:s.numberParser("cacheTTL"),default:5e3},cacheMaxSize:{env:"MMBS_SERVER_CACHE_MAX_SIZE",help:"Sets the maximum size for the in memory cache, defaults to 10000",action:s.numberParser("cacheMaxSize"),default:1e4},enableSingleSchemaCache:{env:"MMBS_SERVER_ENABLE_SINGLE_SCHEMA_CACHE",help:"Use a single schema cache shared across requests. Reduces number of queries made to _SCHEMA. Defaults to false, i.e. unique schema cache per request.",action:s.booleanParser,default:!1},objectIdSize:{env:"MMBS_SERVER_OBJECT_ID_SIZE",help:"Sets the number of characters in generated object id's, default 10",action:s.numberParser("objectIdSize"),default:10},port:{env:"PORT",help:"The port to run the MmbsServer. defaults to 1337.",action:s.numberParser("port"),default:1337},host:{env:"MMBS_SERVER_HOST",help:"The host to serve MmbsServer on. defaults to 0.0.0.0",default:"0.0.0.0"},mountPath:{env:"MMBS_SERVER_MOUNT_PATH",help:"Mount path for the server, defaults to /mmbs",default:"/mmbs"},cluster:{env:"MMBS_SERVER_CLUSTER",help:"Run with cluster, optionally set the number of processes default to os.cpus().length",action:s.numberOrBooleanParser},middleware:{env:"MMBS_SERVER_MIDDLEWARE",help:"middleware for express server, can be string or function"},startLiveQueryServer:{env:"MMBS_SERVER_START_LIVE_QUERY_SERVER",help:"Starts the liveQuery server",action:s.booleanParser},liveQueryServerOptions:{env:"MMBS_SERVER_LIVE_QUERY_SERVER_OPTIONS",help:"Live query server configuration options (will start the liveQuery server)",action:s.objectParser}},e.exports.CustomPagesOptions={invalidLink:{env:"MMBS_SERVER_CUSTOM_PAGES_INVALID_LINK",help:"invalid link page path"},verifyEmailSuccess:{env:"MMBS_SERVER_CUSTOM_PAGES_VERIFY_EMAIL_SUCCESS",help:"verify email success page path"},choosePassword:{env:"MMBS_SERVER_CUSTOM_PAGES_CHOOSE_PASSWORD",help:"choose password page path"},passwordResetSuccess:{env:"MMBS_SERVER_CUSTOM_PAGES_PASSWORD_RESET_SUCCESS",help:"password reset success page path"}},e.exports.LiveQueryOptions={classNames:{env:"MMBS_SERVER_LIVEQUERY_CLASSNAMES",help:"mmbs-server's LiveQuery classNames",action:s.arrayParser},redisURL:{env:"MMBS_SERVER_LIVEQUERY_REDIS_URL",help:"mmbs-server's LiveQuery redisURL"},pubSubAdapter:{env:"MMBS_SERVER_LIVEQUERY_PUB_SUB_ADAPTER",help:"LiveQuery pubsub adapter",action:s.moduleOrObjectParser}},e.exports.LiveQueryServerOptions={appId:{env:"MMBS_LIVE_QUERY_SERVER_APP_ID",help:"This string should match the appId in use by your Mmbs Server. If you deploy the LiveQuery server alongside Mmbs Server, the LiveQuery server will try to use the same appId."},masterKey:{env:"MMBS_LIVE_QUERY_SERVER_MASTER_KEY",help:"This string should match the masterKey in use by your Mmbs Server. If you deploy the LiveQuery server alongside Mmbs Server, the LiveQuery server will try to use the same masterKey."},serverURL:{env:"MMBS_LIVE_QUERY_SERVER_SERVER_URL",help:"This string should match the serverURL in use by your Mmbs Server. If you deploy the LiveQuery server alongside Mmbs Server, the LiveQuery server will try to use the same serverURL."},keyPairs:{env:"MMBS_LIVE_QUERY_SERVER_KEY_PAIRS",help:"A JSON object that serves as a whitelist of keys. It is used for validating clients when they try to connect to the LiveQuery server. Check the following Security section and our protocol specification for details.",action:s.objectParser},websocketTimeout:{env:"MMBS_LIVE_QUERY_SERVER_WEBSOCKET_TIMEOUT",help:"Number of milliseconds between ping/pong frames. The WebSocket server sends ping/pong frames to the clients to keep the WebSocket alive. This value defines the interval of the ping/pong frame from the server to clients. Defaults to 10 * 1000 ms (10 s).",action:s.numberParser("websocketTimeout")},cacheTimeout:{env:"MMBS_LIVE_QUERY_SERVER_CACHE_TIMEOUT",help:"Number in milliseconds. When clients provide the sessionToken to the LiveQuery server, the LiveQuery server will try to fetch its MmbsUser's objectId from mmbs server and store it in the cache. The value defines the duration of the cache. Check the following Security section and our protocol specification for details. Defaults to 30 * 24 * 60 * 60 * 1000 ms (~30 days).",action:s.numberParser("cacheTimeout")},logLevel:{env:"MMBS_LIVE_QUERY_SERVER_LOG_LEVEL",help:"This string defines the log level of the LiveQuery server. We support VERBOSE, INFO, ERROR, NONE. Defaults to INFO."},port:{env:"MMBS_LIVE_QUERY_SERVER_PORT",help:"The port to run the MmbsServer. defaults to 1337.",action:s.numberParser("port"),default:1337},redisURL:{env:"MMBS_LIVE_QUERY_SERVER_REDIS_URL",help:"mmbs-server's LiveQuery redisURL"},pubSubAdapter:{env:"MMBS_LIVE_QUERY_SERVER_PUB_SUB_ADAPTER",help:"LiveQuery pubsub adapter",action:s.moduleOrObjectParser}}},function(e,t,r){"use strict";function s(e){return e&&e.__esModule?e:{default:e}}function n(e){const t=Object.assign({},d.transports);if(e){const r=e.silent;delete e.silent,u.default.isNull(e.dirname)?(delete t["mmbs-server"],delete t["mmbs-server-error"]):u.default.isUndefined(e.dirname)||(t["mmbs-server"]=new l.default(Object.assign({},{filename:"mmbs-server.info",name:"mmbs-server"},e,{timestamp:!0})),t["mmbs-server-error"]=new l.default(Object.assign({},{filename:"mmbs-server.err",name:"mmbs-server-error"},e,{level:"error",timestamp:!0}))),t.console=new o.default.transports.Console(Object.assign({colorize:!0,name:"console",silent:r},e))}h.forEach(e=>{t[e.name]=e}),d.configure({transports:u.default.values(t)})}Object.defineProperty(t,"__esModule",{value:!0}),t.logger=void 0,t.configureLogger=function({logsFolder:e=c.default.logsFolder,jsonLogs:t=c.default.jsonLogs,logLevel:r=o.default.level,verbose:s=c.default.verbose,silent:l=c.default.silent}={}){s&&(r="verbose"),o.default.level=r;const u={};if(e){i.default.isAbsolute(e)||(e=i.default.resolve(process.cwd(),e));try{a.default.mkdirSync(e)}catch(e){}}u.dirname=e,u.level=r,u.silent=l,t&&(u.json=!0,u.stringify=!0),n(u)},t.addTransport=function(e){h.push(e),n()},t.removeTransport=function(e){const t="string"==typeof e?e:e.name,r=Object.assign({},d.transports);delete r[t],d.configure({transports:u.default.values(r)}),u.default.remove(h,e=>e.name===t)};var o=s(r(63)),a=s(r(27)),i=s(r(11)),l=s(r(64)),u=s(r(7)),c=s(r(10));const d=new o.default.Logger,h=[];t.logger=d,t.default=d},function(e,t){e.exports=__webpack_require__(22)},function(e,t){e.exports=__webpack_require__(23)},function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0});const s=5e3;class n{constructor({ttl:e=s}){this.ttl=e,this.cache=Object.create(null)}get(e){const t=this.cache[e];return null==t?null:isNaN(t.expire)||t.expire>=Date.now()?t.value:(delete this.cache[e],null)}put(e,t,r=this.ttl){(r<0||isNaN(r))&&(r=NaN);var s={value:t,expire:r+Date.now()};isNaN(s.expire)||(s.timeout=setTimeout(()=>{this.del(e)},r)),this.cache[e]=s}del(e){var t=this.cache[e];null!=t&&(t.timeout&&clearTimeout(t.timeout),delete this.cache[e])}clear(){this.cache=Object.create(null)}}t.InMemoryCache=n,t.default=n},function(e,t){e.exports=__webpack_require__(24)},function(e,t){e.exports=__webpack_require__(25)},function(module,exports,__webpack_require__){"use strict";function _interopRequireDefault(e){return e&&e.__esModule?e:{default:e}}Object.defineProperty(exports,"__esModule",{value:!0});var _rest=__webpack_require__(4),_rest2=_interopRequireDefault(_rest),_Auth=__webpack_require__(6),_Auth2=_interopRequireDefault(_Auth),_Config=__webpack_require__(8),_Config2=_interopRequireDefault(_Config),Mmbs=__webpack_require__(0);const CronJob=__webpack_require__(72).CronJob,Mock=__webpack_require__(73),csvtojson=__webpack_require__(74),request=__webpack_require__(18),MmbsCloud=__webpack_require__(39);class CrobTab{constructor(e){this.applicationId=e,this.crobJobs={},this.unMockValue="__SYS_MOCK_NO_BEGIN__",Mmbs._csvtojson=csvtojson,Mmbs._request=request,Mmbs.Cloud.job("_built_in_job",(e,t)=>{try{if(e.params&&e.params.input){let r=e.params.input.vars?e.params.input.vars:{},s=[],n=[],o={};for(let e in r)o[e]=this.unMockValue;let a={};for(let e in r){r[e].indexOf&&-1==r[e].indexOf("return")&&(r[e]="return "+r[e]);let t=this.replaceVar(r[e],o);t.indexOf&&t.indexOf(this.unMockValue)>=0?a[e]=r[e]:(s.push(new Function(r[e])()),n.push(e))}Mmbs.Promise.all(s).then(e=>{let r={};for(let t=0;t<e.length;t++)r[n[t]]=e[t];for(let e in a){let s=this.replaceVar(a[e],r);if((s=this.replaceVar(s,o)).indexOf&&s.indexOf(this.unMockValue)>=0)return void t.error(`vars ${e} cannot calc value`);r[e]=new Function(s)()}return Mmbs.Promise.as(r)}).then(r=>this.run_built_in_job(e,t,e.params.input,r),e=>{t.error(e.message)})}else t.error("params error, no input")}catch(e){t.error(e.message)}}),Mmbs.Cloud.afterSave("_JobSchedule",e=>this.updateCrob(e.object.id)),Mmbs.Cloud.afterDelete("_JobSchedule",e=>(this.deleteCrob(e.object.id),Mmbs.Promise.as([])))}isString(e){return"[object String]"===Object.prototype.toString.call(e)}replaceAll(e,t,r){return this.isString(e)?(r=JSON.stringify(r),e.split(t).join(r)):e}_mock_expression_val(expr){return eval("Mock.mock({expr})")}_eval_expression_val(expr){return eval(expr)}_function_expression_val(e){return new Function(e)()}replaceVar(e,t){for(let r in t)e=this.replaceAll(e,r,t[r]);return e}_getRefObject(e,t,r){let s=this._parse_class_name(e),n=s.name,o=s.id;if(o){var a=new(Mmbs.Object.extend(n));return a.id=o,a}{let e=this._parse_object_name(n,!0),s=e.name,o=e.count;if(t[s][o])return t[s][o].object;if(r&&Object.getOwnPropertyNames(t[s]).length==e.count){let r=[];for(let n=0;n<e.count;n++)r.push(t[s][n].object);return r}}return null}_mock_object_att(e,t,r,s,n,o,a,i,l){let u=l[e][t],c=u.object,d="mock";s.op&&(d=s.op,s=s.expr),s=this.replaceVar(s,n),s=this.replaceVar(s,a),s=this.replaceVar(s,i);let h=this.replaceVar(s,o);if(!(h.indexOf&&h.indexOf(this.unMockValue)>=0)){if("mock"==d)(s=this._mock_expression_val(s))&&void 0!==s.expr&&(s=s.expr);else if("eval"==d)s=this._eval_expression_val(s);else if("function"==d)s=this._function_expression_val(s);else if("pointer"==d){if(null==(s=this._getRefObject(s,l)))throw new Error(`object name:${e} field:${r} set error, can not mock pointer value`)}else if("relation"==d){let t=c.relation(r),n=s.split(";");for(let o in n)if(""!=n[o]){if(null==(s=this._getRefObject(n[o],l,!0)))throw new Error(`object name:${e} field:${r} set error, can not mock relation value ${o}`);if(s instanceof Array==1)for(let e in s)t.add(s[e]);else t.add(s)}}"relation"!=d&&c.set(r,s),i["this."+r]=s,0==t&&(a[e+"."+r]=s),a[e+"|"+t+"."+r]=s,u.field[r]=!0}}_parse_class_name(e){let t=e.split("::");return t.length>=2?{name:t.slice(0,t.length-1).join("::"),id:t[t.length-1]}:{name:e,id:null}}_parse_object_name(e,t){let r=e.split("|"),s=1;return r.length>=2?(s=parseInt(r[r.length-1]))<=0?t?{name:r.slice(0,r.length-1).join("|"),count:s}:{name:e,count:1}:{name:r.slice(0,r.length-1).join("|"),count:s}:{name:e,count:t?0:1}}run_build_in_job_exec(e,t,r){let s=[];for(let e in t.exec){let n=t.exec[e];n=this.replaceVar(n,r),n=this._function_expression_val(n),s.push(n)}return s}run_build_in_job_mock(e,t,r){let s=[],n=t.mock._mock_count?t.mock._mock_count:1;for(let e=0;e<n;e++){r._build_in_var_mock_count_current=e;let n={},o={};for(let e in t.mock){if("_mock_count"==e)continue;let s=t.mock[e];e=this.replaceVar(e,r);let a=(e=this._parse_object_name(e)).count;e=e.name;let i=Mmbs.Object.extend(e);n[e]={};for(let t=0;t<a;t++){n[e][t]={},n[e][t].object=new i,n[e][t].field={};for(let r in s)0==t&&(o[e+"."+r]=this.unMockValue),o[e+"|"+t+"."+r]=this.unMockValue}}for(let e=0;e<2;e++){let a={};for(let i in t.mock){if("_mock_count"==i)continue;let l=t.mock[i];i=this.replaceVar(i,r);let u=(i=this._parse_object_name(i)).count;i=i.name;for(let t=0;t<u;t++){let u=n[i][t],c={};c["this._build_in_var_index"]=t;for(let e in l)u.field[e]||(c["this."+e]=this.unMockValue);for(let e in l){if(u.field[e])continue;let s=l[e];this._mock_object_att(i,t,e,s,r,o,a,c,n)}if(1==e){for(let e in l)if(!u.field[e])throw new Error(`object name:${i} field:${e} set error, can not mock value`);s.push(u.object.save())}}}}}return delete r._build_in_var_mock_count_current,s}run_built_in_job(e,t,r,s){try{let n=[];r.mock&&(n=n.concat(this.run_build_in_job_mock(e,r,s)));let o="";Mmbs.Promise.all(n).then(t=>(t.length>0&&(o=`success mock ${t.length}`),n=[],r.exec&&(n=n.concat(this.run_build_in_job_exec(e,r,s))),n)).then(e=>{e.length>0&&(o+=`success exec ${e.length}`),t.success(o)},e=>{t.error(e.message)})}catch(e){t.error(e.message)}}getCrob(e){const t=_Config2.default.get(this.applicationId),r=new _Auth2.default.Auth({config:t,isMaster:!0});return e?_rest2.default.find(t,r,"_JobSchedule",{objectId:e},{}):_rest2.default.find(t,r,"_JobSchedule",{},{})}updateCrob(e){try{this.getCrob(e).then(e=>{const t=e.results;if(1==t.length)return this.deleteCrob(t[0].objectId),this.newJob(t[0]),Promise.resolve()})}catch(e){console.log(e)}}deleteCrob(e){let t=this.crobJobs[e];t&&(t.stop(),delete this.crobJobs[e])}newJob(e){let t=null;if(e.enabled)try{let r='{"params":{"autoRun":true, "description": schedule.description, "input":'+(""==e.params?"{}":e.params)+"}}";try{r=JSON.parse(r)}catch(e){r=null}t=new CronJob(e.cron,function(){Mmbs.Cloud.runJob(e.jobName,this.params,{useMasterKey:!0}).then(function(e){},function(e){})},null,!0,"Asia/Shanghai",r)}catch(e){console.log(e)}this.crobJobs[e.objectId]=t}start(){try{this.getCrob().then(e=>{const t=e.results;Object.keys(t).forEach(e=>this.newJob(t[e]))})}catch(e){console.log(e)}}stop(){Object.keys(this.crobJobs).forEach(e=>{deleteCrob(e)}),this.crobJobs={}}}exports.default=CrobTab},function(e,t){e.exports=__webpack_require__(26)},function(e,t){e.exports=__webpack_require__(27)},function(e,t){e.exports=__webpack_require__(28)},function(e,t){e.exports=__webpack_require__(29)},function(e,t){e.exports=__webpack_require__(30)},function(e,t){e.exports=__webpack_require__(31)},function(e,t,r){"use strict";function s(e){return e&&e.__esModule?e:{default:e}}var n=s(r(18)),o=s(r(0)),a=s(r(76)),i=s(r(16)),l=s(r(1)),u=function({body:e,headers:t={}}){if("object"!=typeof e)return{body:e,headers:t};var r=Object.keys(t).filter(e=>null!=e.match(/content-type/i));if(0==r.length)e=i.default.stringify(e),t["Content-Type"]="application/x-www-form-urlencoded";else{r.length>1&&l.default.error("Mmbs.Cloud.httpRequest","multiple content-type headers are set.");var s=r[0];t[s].match(/application\/json/i)?e=JSON.stringify(e):t[s].match(/application\/x-www-form-urlencoded/i)&&(e=i.default.stringify(e))}return{body:e,headers:t}};e.exports=function(e){var t=new o.default.Promise,r={success:e.success,error:e.error};return delete e.success,delete e.error,delete e.uri,e=Object.assign(e,u(e)),e.followRedirect=1==e.followRedirects,"object"==typeof e.params?e.qs=e.params:"string"==typeof e.params&&(e.qs=i.default.parse(e.params)),e.encoding=null,(0,n.default)(e,(e,s,n)=>{if(e)return r.error&&r.error(e),t.reject(e);const o=new a.default(s,n);return o.status<200||o.status>=400?(r.error&&r.error(o),t.reject(o)):(r.success&&r.success(o),t.resolve(o))}),t},e.exports.encodeBody=u},function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0});t.default=class{constructor(e,t){let r,s;this.status=e.statusCode,this.headers=e.headers||{},this.cookies=this.headers["set-cookie"],"string"==typeof t?r=t:Buffer.isBuffer(t)?this.buffer=t:"object"==typeof t&&(s=t);const n=()=>(!r&&this.buffer?r=this.buffer.toString("utf-8"):!r&&s&&(r=JSON.stringify(s)),r);Object.defineProperty(this,"body",{get:()=>t}),Object.defineProperty(this,"text",{enumerable:!0,get:n}),Object.defineProperty(this,"data",{enumerable:!0,get:()=>{if(!s)try{s=JSON.parse(n())}catch(e){}return s}})}}},function(e,t){e.exports=__webpack_require__(32)},function(e,t){e.exports=__webpack_require__(33)},function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.default=(e=>{throw e})},function(e,t,r){"use strict";function s(e){return e.config.analyticsController.appOpened(e)}function n(e){return e.config.analyticsController.trackEvent(e)}Object.defineProperty(t,"__esModule",{value:!0}),t.AnalyticsRouter=void 0;var o=function(e){return e&&e.__esModule?e:{default:e}}(r(2));t.AnalyticsRouter=class extends o.default{mountRoutes(){this.route("POST","/events/AppOpened",s),this.route("POST","/events/:eventName",n)}}},function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.FeaturesRouter=void 0;var s=r(82),n=function(e){return e&&e.__esModule?e:{default:e}}(r(2)),o=function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var r in e)Object.prototype.hasOwnProperty.call(e,r)&&(t[r]=e[r]);return t.default=e,t}(r(5));t.FeaturesRouter=class extends n.default{mountRoutes(){this.route("GET","/serverInfo",o.promiseEnforceMasterKeyAccess,e=>({response:{features:{globalConfig:{create:!0,read:!0,update:!0,delete:!0},hooks:{create:!0,read:!0,update:!0,delete:!0},cloudCode:{jobs:!0},logs:{level:!0,size:!0,order:!0,until:!0,from:!0},push:{immediatePush:e.config.hasPushSupport,scheduledPush:e.config.hasPushScheduledSupport,storedPushData:e.config.hasPushSupport,pushAudiences:!0,localization:!0},schemas:{addField:!0,removeField:!0,addClass:!0,removeClass:!0,clearAllDataFromClass:!0,exportClass:!1,editClassLevelPermissions:!0,editPointerPermissions:!0}},parseServerVersion:s.version}}))}}},function(e,t){e.exports={name:"mmbs-server",version:"2.7.1",description:"An express module providing a Mmbs-compatible API server",main:"lib/index.js",repository:{type:"git",url:"https://github.com/MmbsPlatform/mmbs-server"},files:["bin/","lib/","public_html/","views/","LICENSE","PATENTS","README.md"],license:"BSD-3-Clause",dependencies:{bcryptjs:"2.4.3","body-parser":"1.18.2",commander:"2.12.1",cron:"^1.3.0",csvtojson:"^1.1.9",deepcopy:"0.6.3",express:"4.16.2",intersect:"1.0.1",lodash:"4.17.4","lru-cache":"4.1.1",mime:"2.0.3",mockjs:"^1.0.1-beta3",mongodb:"2.2.33",multer:"1.3.0",mysql2:"^1.5.1",npmlog:"^4.1.2",parse:"1.11.0","pg-promise":"7.3.2",redis:"2.8.0",request:"2.83.0",semver:"5.4.1",tv4:"1.3.0",uuid:"^3.1.0",winston:"2.4.0","winston-daily-rotate-file":"1.7.2",ws:"3.3.2"},devDependencies:{"babel-cli":"6.26.0","babel-core":"6.26.0","babel-eslint":"^8.0.0","babel-plugin-transform-flow-strip-types":"6.22.0","babel-plugin-transform-object-rest-spread":"^6.26.0","babel-preset-env":"1.6.1","bcrypt-nodejs":"0.0.3","cross-env":"5.1.1","deep-diff":"0.3.8",eslint:"^4.9.0","eslint-plugin-flowtype":"^2.39.1",gaze:"1.1.2",jasmine:"2.8.0","jasmine-spec-reporter":"^4.1.0","mongodb-runner":"3.6.1",nodemon:"1.12.1",nyc:"^11.0.2","request-promise":"4.2.2","uglifyjs-webpack-plugin":"^1.1.2",webpack:"^3.10.0","webpack-node-externals":"^1.6.0"},scripts:{dev:"npm run build && node bin/dev",lint:"eslint --cache ./",build:"babel src/ -d lib/ --copy-files",pretest:"npm run lint",test:"cross-env MONGODB_VERSION=${MONGODB_VERSION:=3.2.6} MONGODB_STORAGE_ENGINE=mmapv1 TESTING=1 jasmine",coverage:"cross-env MONGODB_VERSION=${MONGODB_VERSION:=3.2.6} MONGODB_STORAGE_ENGINE=mmapv1 TESTING=1 nyc jasmine",start:"node ./bin/mmbs-server",prepublish:"npm run build"},engines:{node:">=6.11.4"},bin:{"mmbs-server":"./bin/mmbs-server"},optionalDependencies:{bcrypt:"1.0.3",uws:"^9.14.0"},collective:{type:"opencollective",url:"https://opencollective.com/mmbs-server",logo:"https://opencollective.com/mmbs-server/logo.txt?reverse=true&variant=binary"}}},function(e,t,r){"use strict";function s(e){return e&&e.__esModule?e:{default:e}}function n(e,t,r,s){let{start:n,end:o}=function(e){const t=e.get("Range").replace(/bytes=/,"").split("-");return{start:parseInt(t[0],10),end:parseInt(t[1],10)}}(t);const a=!n&&0!==n;!o&&0!==o&&(o=e.length-1),a&&(o=(n=e.length-o)+o-1),o-n>=1048576&&(o=n+1048576-1);const i=o-n+1;r.writeHead(206,{"Content-Range":"bytes "+n+"-"+o+"/"+e.length,"Accept-Ranges":"bytes","Content-Length":i,"Content-Type":s}),e.seek(n,function(){const t=e.stream(!0);let s=0,n=i,o=0;t.on("data",function(t){if((s+=t.length)>0){const e=t.slice(0,n);r.write(e),o+=e.length,n-=t.length,s-=e.length}o>=i&&(e.close(),r.end(),this.destroy())})})}Object.defineProperty(t,"__esModule",{value:!0}),t.FilesRouter=void 0;var o=s(r(24)),a=s(r(40)),i=function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var r in e)Object.prototype.hasOwnProperty.call(e,r)&&(t[r]=e[r]);return t.default=e,t}(r(5)),l=s(r(0)),u=s(r(8)),c=s(r(41)),d=s(r(1));t.FilesRouter=class{expressRouter({maxUploadSize:e="100Mb"}={}){var t=o.default.Router();return t.get("/files/:appId/:filename",this.getHandler),t.post("/files",function(e,t,r){r(new l.default.Error(l.default.Error.INVALID_FILE_NAME,"Filename not provided."))}),t.post("/files/:filename",i.allowCrossDomain,a.default.raw({type:()=>!0,limit:e}),i.handleMmbsHeaders,this.createHandler),t.delete("/files/:filename",i.allowCrossDomain,i.handleMmbsHeaders,i.enforceMasterKeyAccess,this.deleteHandler),t}getHandler(e,t){const r=u.default.get(e.params.appId),s=r.filesController,o=e.params.filename,a=c.default.getType(o);!function(e,t){return e.get("Range")&&"function"==typeof t.adapter.getFileStream}(e,s)?s.getFileData(r,o).then(e=>{t.status(200),t.set("Content-Type",a),t.set("Content-Length",e.length),t.end(e)}).catch(()=>{t.status(404),t.set("Content-Type","text/plain"),t.end("File not found.")}):s.getFileStream(r,o).then(r=>{n(r,e,t,a)}).catch(()=>{t.status(404),t.set("Content-Type","text/plain"),t.end("File not found.")})}createHandler(e,t,r){if(!e.body||!e.body.length)return void r(new l.default.Error(l.default.Error.FILE_SAVE_ERROR,"Invalid file upload."));if(e.params.filename.length>128)return void r(new l.default.Error(l.default.Error.INVALID_FILE_NAME,"Filename too long."));const s=e.params.filename,n=e.get("Content-type"),o=e.config;o.filesController.createFile(o,s,e.body,n).then(e=>{t.status(201),t.set("Location",e.url),t.json(e)}).catch(e=>{d.default.error(e.message,e),r(new l.default.Error(l.default.Error.FILE_SAVE_ERROR,"Could not store file."))})}deleteHandler(e,t,r){e.config.filesController.deleteFile(e.config,e.params.filename).then(()=>{t.status(200),t.end()}).catch(()=>{r(new l.default.Error(l.default.Error.FILE_DELETE_ERROR,"Could not delete file."))})}}},function(e,t,r){"use strict";function s(e){return e&&e.__esModule?e:{default:e}}function n(e){return Array.isArray(e)?e.map(e=>n(e)):e&&"Date"==e.__type?Object.assign(new Date(e.iso),e):e&&"File"==e.__type?d.File.fromJSON(e):e&&"object"==typeof e?o(e):e}function o(e){return u.default.mapValues(e,n)}Object.defineProperty(t,"__esModule",{value:!0}),t.FunctionsRouter=void 0;var a=s(r(2)),i=r(5),l=r(29),u=s(r(7)),c=r(1),d=r(0).Mmbs,h=r(9);class f extends a.default{mountRoutes(){this.route("POST","/functions/:functionName",f.handleCloudFunction),this.route("POST","/jobs/:jobName",i.promiseEnforceMasterKeyAccess,function(e){return f.handleCloudJob(e)}),this.route("POST","/jobs",i.promiseEnforceMasterKeyAccess,function(e){return f.handleCloudJob(e)})}static handleCloudJob(e){const t=e.params.jobName||e.body.jobName,r=e.config.applicationId,s=(0,l.jobStatusHandler)(e.config),n=h.getJob(t,r);if(!n)throw new d.Error(d.Error.SCRIPT_FAILED,"Invalid job.");let a=Object.assign({},e.body,e.query);const i={params:a=o(a),log:e.config.loggerController,headers:e.config.headers,ip:e.config.ip,jobName:t},u={success:s.setSucceeded.bind(s),error:s.setFailed.bind(s),message:s.setMessage.bind(s)},c={success:()=>{},error:()=>{},message:()=>{}};return s.setRunning(t,a).then(e=>(i.jobId=e&&e.objectId?e.objectId:null,process.nextTick(()=>{n(i,a&&a.input&&a.input.noLogStatus?c:u)}),{headers:{"X-Mmbs-Job-Status-Id":i.jobId},response:{result:i.jobId}}))}static createResponseObject(e,t,r){return{success:function(t){e({response:{result:d._encode(t)}})},error:function(e,r){r||(r=e,e=d.Error.SCRIPT_FAILED),t(new d.Error(e,r))},message:r}}static handleCloudFunction(e){const t=e.params.functionName,r=e.config.applicationId,s=h.getFunction(t,r),n=h.getValidator(e.params.functionName,r);if(s){let r=Object.assign({},e.body,e.query);var a={params:r=o(r),master:e.auth&&e.auth.isMaster,user:e.auth&&e.auth.user,installationId:e.info.installationId,log:e.config.loggerController,headers:e.config.headers,ip:e.config.ip,functionName:t};if(n&&"function"==typeof n){if(!n(a))throw new d.Error(d.Error.VALIDATION_ERROR,"Validation failed.")}return new Promise(function(n,o){const i=e.auth&&e.auth.user?e.auth.user.id:void 0,l=c.logger.truncateLogMessage(JSON.stringify(r));var u=f.createResponseObject(e=>{try{const s=c.logger.truncateLogMessage(JSON.stringify(e.response.result));c.logger.info(`Ran cloud function ${t} for user ${i} with:\n  Input: ${l}\n  Result: ${s}`,{functionName:t,params:r,user:i}),n(e)}catch(e){o(e)}},e=>{try{c.logger.error(`Failed running cloud function ${t} for user ${i} with:\n  Input: ${l}\n  Error: `+JSON.stringify(e),{functionName:t,error:e,params:r,user:i}),o(e)}catch(e){o(e)}});d.applicationId=e.config.applicationId,d.javascriptKey=e.config.javascriptKey,d.masterKey=e.config.masterKey,s(a,u)})}throw new d.Error(d.Error.SCRIPT_FAILED,`Invalid function: "${t}"`)}}t.FunctionsRouter=f},function(e,t,r){"use strict";function s(e){return e&&e.__esModule?e:{default:e}}Object.defineProperty(t,"__esModule",{value:!0}),t.GlobalConfigRouter=void 0;var n=s(r(0)),o=s(r(2)),a=function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var r in e)Object.prototype.hasOwnProperty.call(e,r)&&(t[r]=e[r]);return t.default=e,t}(r(5));class i extends o.default{getGlobalConfig(e){return e.config.database.find("_GlobalConfig",{objectId:"1"},{limit:1}).then(e=>{if(1!=e.length)return{response:{params:{}}};return{response:{params:e[0].params}}})}updateGlobalConfig(e){if(e.auth.isReadOnly)throw new n.default.Error(n.default.Error.OPERATION_FORBIDDEN,"read-only masterKey isn't allowed to update the config.");const t=e.body.params,r=Object.keys(t).reduce((e,r)=>(e[`params.${r}`]=t[r],e),{});return e.config.database.update("_GlobalConfig",{objectId:"1"},r,{upsert:!0}).then(()=>({response:{result:!0}}))}mountRoutes(){this.route("GET","/config",e=>this.getGlobalConfig(e)),this.route("PUT","/config",a.promiseEnforceMasterKeyAccess,e=>this.updateGlobalConfig(e))}}t.GlobalConfigRouter=i,t.default=i},function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.HooksRouter=void 0;var s=r(0),n=function(e){return e&&e.__esModule?e:{default:e}}(r(2)),o=function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var r in e)Object.prototype.hasOwnProperty.call(e,r)&&(t[r]=e[r]);return t.default=e,t}(r(5));class a extends n.default{createHook(e,t){return t.hooksController.createHook(e).then(e=>({response:e}))}updateHook(e,t){return t.hooksController.updateHook(e).then(e=>({response:e}))}handlePost(e){return this.createHook(e.body,e.config)}handleGetJobs(e){var t=e.config.hooksController;return e.params.jobName?t.getJob(e.params.jobName).then(t=>{if(!t)throw new s.Mmbs.Error(143,`no job named: ${e.params.jobName} is defined`);return Promise.resolve({response:t})}):t.getJobs().then(e=>({response:e||[]}),e=>{throw e})}handleGetFunctions(e){var t=e.config.hooksController;return e.params.functionName?t.getFunction(e.params.functionName).then(t=>{if(!t)throw new s.Mmbs.Error(143,`no function named: ${e.params.functionName} is defined`);return Promise.resolve({response:t})}):t.getFunctions().then(e=>({response:e||[]}),e=>{throw e})}handleGetTriggers(e){var t=e.config.hooksController;return e.params.className&&e.params.triggerName?t.getTrigger(e.params.className,e.params.triggerName).then(t=>{if(!t)throw new s.Mmbs.Error(143,`class ${e.params.className} does not exist`);return Promise.resolve({response:t})}):t.getTriggers().then(e=>({response:e||[]}))}handleDelete(e){var t=e.config.hooksController;return e.params.functionName?t.deleteFunction(e.params.functionName).then(()=>({response:{}})):e.params.jobName?t.deleteJob(e.params.jobName).then(()=>({response:{}})):e.params.className&&e.params.triggerName?t.deleteTrigger(e.params.className,e.params.triggerName).then(()=>({response:{}})):Promise.resolve({response:{}})}handleUpdate(e){var t;if(e.params.functionName&&e.body.url)(t={}).functionName=e.params.functionName,t.url=e.body.url;else if(e.params.jobName&&e.body.url)(t={}).jobName=e.params.jobName,t.url=e.body.url;else{if(!(e.params.className&&e.params.triggerName&&e.body.url))throw new s.Mmbs.Error(143,"invalid hook declaration");(t={}).className=e.params.className,t.triggerName=e.params.triggerName,t.url=e.body.url}return this.updateHook(t,e.config)}handlePut(e){return"Delete"==e.body.__op?this.handleDelete(e):this.handleUpdate(e)}mountRoutes(){this.route("GET","/hooks/jobs",o.promiseEnforceMasterKeyAccess,this.handleGetFunctions.bind(this)),this.route("GET","/hooks/functions",o.promiseEnforceMasterKeyAccess,this.handleGetFunctions.bind(this)),this.route("GET","/hooks/triggers",o.promiseEnforceMasterKeyAccess,this.handleGetTriggers.bind(this)),this.route("GET","/hooks/jobs/:jobName",o.promiseEnforceMasterKeyAccess,this.handleGetJobs.bind(this)),this.route("GET","/hooks/functions/:functionName",o.promiseEnforceMasterKeyAccess,this.handleGetFunctions.bind(this)),this.route("GET","/hooks/triggers/:className/:triggerName",o.promiseEnforceMasterKeyAccess,this.handleGetTriggers.bind(this)),this.route("POST","/hooks/jobs",o.promiseEnforceMasterKeyAccess,this.handlePost.bind(this)),this.route("POST","/hooks/functions",o.promiseEnforceMasterKeyAccess,this.handlePost.bind(this)),this.route("POST","/hooks/triggers",o.promiseEnforceMasterKeyAccess,this.handlePost.bind(this)),this.route("PUT","/hooks/jobs/:jobName",o.promiseEnforceMasterKeyAccess,this.handlePut.bind(this)),this.route("PUT","/hooks/functions/:functionName",o.promiseEnforceMasterKeyAccess,this.handlePut.bind(this)),this.route("PUT","/hooks/triggers/:className/:triggerName",o.promiseEnforceMasterKeyAccess,this.handlePut.bind(this))}}t.HooksRouter=a,t.default=a},function(e,t,r){"use strict";function s(e){return e&&e.__esModule?e:{default:e}}function n(e,t){return new Promise(function(r,s){l.post({url:e,body:{"receipt-data":t},json:!0},function(e,t,n){return 0==n.status?r():s(n)})})}function o(e,t){return u.find(t.config,t.auth,"_Product",{productIdentifier:e},void 0,t.info.clientSDK).then(function(e){const t=e.results;if(!t||1!=t.length)throw new i.default.Error(i.default.Error.OBJECT_NOT_FOUND,"Object not found.");var r=t[0].download;return Promise.resolve({response:r})})}Object.defineProperty(t,"__esModule",{value:!0}),t.IAPValidationRouter=void 0;var a=s(r(2)),i=s(r(0)),l=r(18),u=r(4);const c="https://sandbox.itunes.apple.com/verifyReceipt",d="https://buy.itunes.apple.com/verifyReceipt",h={21e3:"The App Store could not read the JSON object you provided.",21002:"The data in the receipt-data property was malformed or missing.",21003:"The receipt could not be authenticated.",21004:"The shared secret you provided does not match the shared secret on file for your account.",21005:"The receipt server is not currently available.",21006:"This receipt is valid but the subscription has expired.",21007:"This receipt is from the test environment, but it was sent to the production environment for verification. Send it to the test environment instead.",21008:"This receipt is from the production environment, but it was sent to the test environment for verification. Send it to the production environment instead."};t.IAPValidationRouter=class extends a.default{handleRequest(e){function t(){return o(a,e)}function r(e){return Promise.resolve({response:function(e){return{status:e=parseInt(e),error:h[e]||"unknown error."}}(e.status)})}let s=e.body.receipt;const a=e.body.productIdentifier;if(!s||!a)throw new i.default.Error(i.default.Error.INVALID_JSON,"missing receipt or productIdentifier");return"object"==typeof s&&"Bytes"==s.__type&&(s=s.base64),"1"==process.env.TESTING&&e.body.bypassAppStoreValidation?o(a,e):n(d,s).then(()=>t(),e=>21007==e.status?n(c,s).then(()=>t(),e=>r(e)):r(e))}mountRoutes(){this.route("POST","/validate_purchase",this.handleRequest)}}},function(e,t,r){"use strict";function s(e){return e&&e.__esModule?e:{default:e}}Object.defineProperty(t,"__esModule",{value:!0}),t.InstallationsRouter=void 0;var n=s(r(13)),o=s(r(4));class a extends n.default{className(){return"_Installation"}handleFind(e){const t=Object.assign(e.body,n.default.JSONFromQuery(e.query)),r=n.default.optionsFromBody(t);return o.default.find(e.config,e.auth,"_Installation",t.where,r,e.info.clientSDK).then(e=>({response:e}))}mountRoutes(){this.route("GET","/installations",e=>this.handleFind(e)),this.route("GET","/installations/:objectId",e=>this.handleGet(e)),this.route("POST","/installations",e=>this.handleCreate(e)),this.route("PUT","/installations/:objectId",e=>this.handleUpdate(e)),this.route("DELETE","/installations/:objectId",e=>this.handleDelete(e))}}t.InstallationsRouter=a,t.default=a},function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.LogsRouter=void 0;var s=r(0),n=function(e){return e&&e.__esModule?e:{default:e}}(r(2)),o=function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var r in e)Object.prototype.hasOwnProperty.call(e,r)&&(t[r]=e[r]);return t.default=e,t}(r(5));class a extends n.default{mountRoutes(){this.route("GET","/scriptlog",o.promiseEnforceMasterKeyAccess,this.validateRequest,e=>this.handleGET(e))}validateRequest(e){if(!e.config||!e.config.loggerController)throw new s.Mmbs.Error(s.Mmbs.Error.PUSH_MISCONFIGURED,"Logger adapter is not available")}handleGET(e){const t=e.query.from,r=e.query.until;let s=e.query.size;e.query.n&&(s=e.query.n);const n={from:t,until:r,size:s,order:e.query.order,level:e.query.level};return e.config.loggerController.getLogs(n).then(e=>Promise.resolve({response:e}))}}t.LogsRouter=a,t.default=a},function(e,t,r){"use strict";function s(e){return e&&e.__esModule?e:{default:e}}Object.defineProperty(t,"__esModule",{value:!0}),t.MmbsLiveQueryServer=void 0;var n=s(r(91)),o=s(r(0)),a=r(92),i=r(93),l=r(94),u=s(r(1)),c=s(r(97)),d=r(98),h=r(42),f=r(104),p=s(r(7)),m=s(r(105)),_=r(9),y=s(r(20));t.MmbsLiveQueryServer=class{constructor(e,t){this.server=e,this.clients=new Map,this.subscriptions=new Map;const r=(t=t||{}).keyPairs||{};this.keyPairs=new Map;for(const e of Object.keys(r))this.keyPairs.set(e,r[e]);u.default.verbose("Support key pairs",this.keyPairs),o.default.Object.disableSingleInstance();const s=t.serverURL||o.default.serverURL;o.default.serverURL=s;const n=t.appId||o.default.applicationId,a=o.default.javaScriptKey,i=t.masterKey||o.default.masterKey,c=t.allowAnonymousKey||o.default.allowAnonymousKey;o.default.initialize(n,a,i,c),this.appinfo=y.default.get(n)||{},void 0!==t.isForbidAnonymousUser&&(this.appinfo.isForbidAnonymousUser=t.isForbidAnonymousUser),void 0!==t.isAllowAnonymousUserLiveQuery&&(this.appinfo.isAllowAnonymousUserLiveQuery=t.isAllowAnonymousUserLiveQuery),void 0!==t.allowAnonymousKey&&(this.appinfo.allowAnonymousKey=t.allowAnonymousKey),this.parseWebSocketServer=new l.MmbsWebSocketServer(e,e=>this._onConnect(e),t.websocketTimeout),this.subscriber=h.MmbsPubSub.createSubscriber(t),this.subscriber.subscribe(o.default.applicationId+"afterSave"),this.subscriber.subscribe(o.default.applicationId+"afterDelete"),this.subscriber.on("message",(e,t)=>{u.default.verbose("Subscribe messsage %j",t);let r;try{r=JSON.parse(t)}catch(e){return void u.default.error("unable to parse message",t,e)}this._inflateMmbsObject(r),e===o.default.applicationId+"afterSave"?this._onAfterSave(r):e===o.default.applicationId+"afterDelete"?this._onAfterDelete(r):u.default.error("Get message %s from unknown channel %j",r,e)}),this.sessionTokenCache=new f.SessionTokenCache(t.cacheTimeout)}_inflateMmbsObject(e){const t=e.currentMmbsObject;let r=t.className,s=new o.default.Object(r);s._finishFetch(t),e.currentMmbsObject=s;const n=e.originalMmbsObject;n&&(r=n.className,(s=new o.default.Object(r))._finishFetch(n),e.originalMmbsObject=s)}_onAfterDelete(e){u.default.verbose(o.default.applicationId+"afterDelete is triggered");const t=e.currentMmbsObject.toJSON(),r=t.className;u.default.verbose("ClassName: %j | ObjectId: %s",r,t.id),u.default.verbose("Current client number : %d",this.clients.size);const s=this.subscriptions.get(r);if(void 0!==s){for(const r of s.values())if(this._matchesSubscription(t,r))for(const[s,n]of p.default.entries(r.clientRequestIds)){const r=this.clients.get(s);if(void 0!==r)for(const s of n){const n=e.currentMmbsObject.getACL();this._matchesACL(n,r,s).then(e=>{if(!e)return null;r.pushDelete(s,t)},e=>{u.default.error("Matching ACL error : ",e)})}}}else u.default.debug("Can not find subscriptions under this class "+r)}_onAfterSave(e){u.default.verbose(o.default.applicationId+"afterSave is triggered");let t=null;e.originalMmbsObject&&(t=e.originalMmbsObject.toJSON());const r=e.currentMmbsObject.toJSON(),s=r.className;u.default.verbose("ClassName: %s | ObjectId: %s",s,r.id),u.default.verbose("Current client number : %d",this.clients.size);const n=this.subscriptions.get(s);if(void 0!==n)for(const s of n.values()){const n=this._matchesSubscription(t,s),a=this._matchesSubscription(r,s);for(const[i,l]of p.default.entries(s.clientRequestIds)){const c=this.clients.get(i);if(void 0!==c)for(const i of l){let l;if(n){let t;e.originalMmbsObject&&(t=e.originalMmbsObject.getACL()),l=this._matchesACL(t,c,i)}else l=o.default.Promise.as(!1);let d;if(a){const t=e.currentMmbsObject.getACL();d=this._matchesACL(t,c,i)}else d=o.default.Promise.as(!1);o.default.Promise.when(l,d).then((e,o)=>{u.default.verbose("Original %j | Current %j | Match: %s, %s, %s, %s | Query: %s",t,r,n,a,e,o,s.hash);let l;if(e&&o)l="Update";else if(e&&!o)l="Leave";else{if(e||!o)return null;l=t?"Enter":"Create"}c["push"+l](i,r)},e=>{u.default.error("Matching ACL error : ",e)})}}}else u.default.debug("Can not find subscriptions under this class "+s)}_onConnect(e){e.on("message",t=>{if("string"==typeof t)try{t=JSON.parse(t)}catch(e){return void u.default.error("unable to parse request",t,e)}if(u.default.verbose("Request: %j",t),!n.default.validate(t,c.default.general)||!n.default.validate(t,c.default[t.op]))return i.Client.pushError(e,1,n.default.error.message),void u.default.error("Connect message error %s",n.default.error.message);switch(t.op){case"connect":this._handleConnect(e,t);break;case"subscribe":this._handleSubscribe(e,t);break;case"update":this._handleUpdateSubscription(e,t);break;case"unsubscribe":this._handleUnsubscribe(e,t);break;default:i.Client.pushError(e,3,"Get unknown operation"),u.default.error("Get unknown operation",t.op)}}),e.on("error",t=>{u.default.info(`Client socket error: ${e.clientId}`);const r=e.clientId;if(!this.clients.has(r))return(0,_.runLiveQueryEventHandlers)({event:"ws_disconnect_error",clients:this.clients.size,subscriptions:this.subscriptions.size,error:`client ${r} on error. Message ${t.message}`}),void u.default.error(`client ${r} on error. Message ${t.message}`);const s=this.clients.get(r);this.clients.delete(r);for(const[e,t]of p.default.entries(s.subscriptionInfos)){const s=t.subscription;s.deleteClientSubscription(r,e);const n=this.subscriptions.get(s.className);s.hasSubscribingClient()||n.delete(s.hash),0===n.size&&this.subscriptions.delete(s.className)}u.default.verbose("Current clients %d",this.clients.size),u.default.verbose("Current subscriptions %d",this.subscriptions.size),(0,_.runLiveQueryEventHandlers)({event:"ws_disconnect",clients:this.clients.size,subscriptions:this.subscriptions.size})}),e.on("disconnect",()=>{u.default.info(`Client disconnect: ${e.clientId}`);const t=e.clientId;if(!this.clients.has(t))return(0,_.runLiveQueryEventHandlers)({event:"ws_disconnect_error",clients:this.clients.size,subscriptions:this.subscriptions.size,error:`Unable to find client ${t}`}),void u.default.error(`Can not find client ${t} on disconnect`);const r=this.clients.get(t);this.clients.delete(t);for(const[e,s]of p.default.entries(r.subscriptionInfos)){const r=s.subscription;r.deleteClientSubscription(t,e);const n=this.subscriptions.get(r.className);r.hasSubscribingClient()||n.delete(r.hash),0===n.size&&this.subscriptions.delete(r.className)}u.default.verbose("Current clients %d",this.clients.size),u.default.verbose("Current subscriptions %d",this.subscriptions.size),(0,_.runLiveQueryEventHandlers)({event:"ws_disconnect",clients:this.clients.size,subscriptions:this.subscriptions.size})}),(0,_.runLiveQueryEventHandlers)({event:"ws_connect",clients:this.clients.size,subscriptions:this.subscriptions.size})}_matchesSubscription(e,t){return!!e&&(0,d.matchesQuery)(e,t.query)}_matchesACL(e,t,r){var s=this.appinfo.isForbidAnonymousUser&&!t.hasAllowAnonymousKey;!0===this.appinfo.isAllowAnonymousUserLiveQuery&&(s=!1);var n=!1;if(!e||e.getPublicReadAccess()||t.hasMasterKey){if(!s||t.hasMasterKey)return o.default.Promise.as(!0);n=!0}const a=t.getSubscriptionInfo(r);if(void 0===a)return o.default.Promise.as(!1);const i=a.sessionToken;return s&&!i?o.default.Promise.as(!1):this.sessionTokenCache.getUserId(i).then(t=>n?o.default.Promise.as(!0):e.getReadAccess(t)).then(t=>t?o.default.Promise.as(!0):new o.default.Promise((t,r)=>{if(!Object.keys(e.permissionsById).some(e=>e.startsWith("role:")))return t(!1);this.sessionTokenCache.getUserId(i).then(e=>{if(!e)return o.default.Promise.as(null);var t=new o.default.User;return t.id=e,t}).then(e=>{if(!e)return o.default.Promise.as([]);var t=new o.default.Query(o.default.Role);return t.equalTo("users",e),t.find({useMasterKey:!0})}).then(r=>{for(const s of r)if(e.getRoleReadAccess(s))return t(!0);t(!1)}).catch(e=>{r(e)})})).then(r=>{if(r)return o.default.Promise.as(!0);const s=t.sessionToken;return this.sessionTokenCache.getUserId(s).then(t=>e.getReadAccess(t))}).then(e=>o.default.Promise.as(e),()=>o.default.Promise.as(!1))}_handleConnect(e,t){if(!this._validateKeys(t,this.keyPairs))return i.Client.pushError(e,4,"Key in request is not valid"),void u.default.error("Key in request is not valid");const r=this._hasMasterKey(t,this.keyPairs),s=t.allowAnonymousKey==this.appinfo.allowAnonymousKey&&!!this.appinfo.allowAnonymousKey,n=(0,m.default)(),o=new i.Client(n,e,r,s);e.clientId=n,this.clients.set(e.clientId,o),u.default.info(`Create new client: ${e.clientId}`),o.pushConnect(),(0,_.runLiveQueryEventHandlers)({event:"connect",clients:this.clients.size,subscriptions:this.subscriptions.size})}_hasMasterKey(e,t){return!!(t&&0!=t.size&&t.has("masterKey")&&e&&e.hasOwnProperty("masterKey")&&e.masterKey===t.get("masterKey"))}_validateKeys(e,t){if(!t||0==t.size)return!0;let r=!1;for(const[s,n]of t)if(e[s]&&e[s]===n){r=!0;break}return r}_handleSubscribe(e,t){if(!e.hasOwnProperty("clientId"))return i.Client.pushError(e,2,"Can not find this client, make sure you connect to server before subscribing"),void u.default.error("Can not find this client, make sure you connect to server before subscribing");const r=this.clients.get(e.clientId),s=(0,d.queryHash)(t.query),n=t.query.className;this.subscriptions.has(n)||this.subscriptions.set(n,new Map);const o=this.subscriptions.get(n);let l;o.has(s)?l=o.get(s):(l=new a.Subscription(n,t.query.where,s),o.set(s,l));const c={subscription:l};t.query.fields&&(c.fields=t.query.fields),t.sessionToken&&(c.sessionToken=t.sessionToken),r.addSubscriptionInfo(t.requestId,c),l.addClientSubscription(e.clientId,t.requestId),r.pushSubscribe(t.requestId),u.default.verbose(`Create client ${e.clientId} new subscription: ${t.requestId}`),u.default.verbose("Current client number: %d",this.clients.size),(0,_.runLiveQueryEventHandlers)({event:"subscribe",clients:this.clients.size,subscriptions:this.subscriptions.size})}_handleUpdateSubscription(e,t){this._handleUnsubscribe(e,t,!1),this._handleSubscribe(e,t)}_handleUnsubscribe(e,t,r=!0){if(!e.hasOwnProperty("clientId"))return i.Client.pushError(e,2,"Can not find this client, make sure you connect to server before unsubscribing"),void u.default.error("Can not find this client, make sure you connect to server before unsubscribing");const s=t.requestId,n=this.clients.get(e.clientId);if(void 0===n)return i.Client.pushError(e,2,"Cannot find client with clientId "+e.clientId+". Make sure you connect to live query server before unsubscribing."),void u.default.error("Can not find this client "+e.clientId);const o=n.getSubscriptionInfo(s);if(void 0===o)return i.Client.pushError(e,2,"Cannot find subscription with clientId "+e.clientId+" subscriptionId "+s+". Make sure you subscribe to live query server before unsubscribing."),void u.default.error("Can not find subscription with clientId "+e.clientId+" subscriptionId "+s);n.deleteSubscriptionInfo(s);const a=o.subscription,l=a.className;a.deleteClientSubscription(e.clientId,s);const c=this.subscriptions.get(l);a.hasSubscribingClient()||c.delete(a.hash),0===c.size&&this.subscriptions.delete(l),(0,_.runLiveQueryEventHandlers)({event:"unsubscribe",clients:this.clients.size,subscriptions:this.subscriptions.size}),r&&(n.pushUnsubscribe(t.requestId),u.default.verbose(`Delete client: ${e.clientId} | subscription: ${t.requestId}`))}}},function(e,t){e.exports=__webpack_require__(34)},function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.Subscription=void 0;var s=function(e){return e&&e.__esModule?e:{default:e}}(r(1));t.Subscription=class{constructor(e,t,r){this.className=e,this.query=t,this.hash=r,this.clientRequestIds=new Map}addClientSubscription(e,t){this.clientRequestIds.has(e)||this.clientRequestIds.set(e,[]),this.clientRequestIds.get(e).push(t)}deleteClientSubscription(e,t){const r=this.clientRequestIds.get(e);if(void 0===r)return void s.default.error("Can not find client %d to delete",e);const n=r.indexOf(t);n<0?s.default.error("Can not find client %d subscription %d to delete",e,t):(r.splice(n,1),0==r.length&&this.clientRequestIds.delete(e))}hasSubscribingClient(){return this.clientRequestIds.size>0}}},function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.Client=void 0;var s=function(e){return e&&e.__esModule?e:{default:e}}(r(1));const n=["className","objectId","updatedAt","createdAt","ACL"];class o{constructor(e,t,r,s){this.id=e,this.parseWebSocket=t,this.hasMasterKey=r,this.hasAllowAnonymousKey=s,this.roles=[],this.subscriptionInfos=new Map,this.pushConnect=this._pushEvent("connected"),this.pushSubscribe=this._pushEvent("subscribed"),this.pushUnsubscribe=this._pushEvent("unsubscribed"),this.pushCreate=this._pushEvent("create"),this.pushEnter=this._pushEvent("enter"),this.pushUpdate=this._pushEvent("update"),this.pushDelete=this._pushEvent("delete"),this.pushLeave=this._pushEvent("leave")}static pushResponse(e,t){s.default.verbose("Push Response : %j",t),e.send(t)}static pushError(e,t,r,s=!0){o.pushResponse(e,JSON.stringify({op:"error",error:r,code:t,reconnect:s}))}addSubscriptionInfo(e,t){this.subscriptionInfos.set(e,t)}getSubscriptionInfo(e){return this.subscriptionInfos.get(e)}deleteSubscriptionInfo(e){return this.subscriptionInfos.delete(e)}_pushEvent(e){return function(t,r){const s={op:e,clientId:this.id};if(void 0!==t&&(s.requestId=t),void 0!==r){let e;this.subscriptionInfos.has(t)&&(e=this.subscriptionInfos.get(t).fields),s.object=this._toJSONWithFields(r,e)}o.pushResponse(this.parseWebSocket,JSON.stringify(s))}}_toJSONWithFields(e,t){if(!t)return e;const r={};for(const t of n)r[t]=e[t];for(const s of t)s in e&&(r[s]=e[s]);return r}}t.Client=o},function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.MmbsWebSocket=t.MmbsWebSocketServer=void 0;var s=function(e){return e&&e.__esModule?e:{default:e}}(r(1));const n=new Map([["disconnect","close"]]),o=function(){try{return r(95)}catch(e){return r(96)}};t.MmbsWebSocketServer=class{constructor(e,t,r=1e4){const n=new(0,o().Server)({server:e});n.on("listening",()=>{s.default.info("Mmbs LiveQuery Server starts running")}),n.on("connection",e=>{t(new a(e));const s=setInterval(()=>{e.readyState==e.OPEN?e.ping():clearInterval(s)},r)}),this.server=n}};class a{constructor(e){this.ws=e}on(e,t){const r=n.has(e)?n.get(e):e;this.ws.on(r,t)}send(e){this.ws.send(e)}}t.MmbsWebSocket=a},function(e,t){e.exports=__webpack_require__(35)},function(e,t){e.exports=__webpack_require__(3)},function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0});const s={general:{title:"General request schema",type:"object",properties:{op:{type:"string",enum:["connect","subscribe","unsubscribe","update"]}}},connect:{title:"Connect operation schema",type:"object",properties:{op:"connect",applicationId:{type:"string"},javascriptKey:{type:"string"},masterKey:{type:"string"},clientKey:{type:"string"},allowAnonymousKey:{type:"string"},windowsKey:{type:"string"},restAPIKey:{type:"string"},sessionToken:{type:"string"}},required:["op","applicationId"],additionalProperties:!1},subscribe:{title:"Subscribe operation schema",type:"object",properties:{op:"subscribe",requestId:{type:"number"},query:{title:"Query field schema",type:"object",properties:{className:{type:"string"},where:{type:"object"},fields:{type:"array",items:{type:"string"},minItems:1,uniqueItems:!0}},required:["where","className"],additionalProperties:!1},sessionToken:{type:"string"}},required:["op","requestId","query"],additionalProperties:!1},update:{title:"Update operation schema",type:"object",properties:{op:"update",requestId:{type:"number"},query:{title:"Query field schema",type:"object",properties:{className:{type:"string"},where:{type:"object"},fields:{type:"array",items:{type:"string"},minItems:1,uniqueItems:!0}},required:["where","className"],additionalProperties:!1},sessionToken:{type:"string"}},required:["op","requestId","query"],additionalProperties:!1},unsubscribe:{title:"Unsubscribe operation schema",type:"object",properties:{op:"unsubscribe",requestId:{type:"number"}},required:["op","requestId"],additionalProperties:!1}};t.default=s},function(e,t,r){"use strict";function s(e){if("object"!=typeof e||null===e)return"string"==typeof e?'"'+e.replace(/\|/g,"%|")+'"':e+"";if(Array.isArray(e)){var t=e.map(s);return t.sort(),"["+t.join(",")+"]"}var r=[],n=Object.keys(e);n.sort();for(var o=0;o<n.length;o++)r.push(s(n[o])+":"+s(e[n[o]]));return"{"+r.join(",")+"}"}function n(e,t){if(t&&t.__type&&"Pointer"===t.__type){for(const r in e){const s=e[r];if("string"==typeof s&&s===t.objectId)return!0;if(s.className===t.className&&s.objectId===t.objectId)return!0}return!1}return e.indexOf(t)>-1}function o(e,t){if(t instanceof c.Query){return(e.id instanceof u?e.id.className:e.className)===t.className&&o(e,t._where)}for(var r in t)if(!i(e,r,t[r]))return!1;return!0}function a(e,t,r){if(Array.isArray(e)){for(var s=0;s<e.length;s++)if(r(e[s],t))return!0;return!1}return r(e,t)}function i(e,t,r){if(null===r)return!1;if(t.indexOf(".")>=0){var s=t.split("."),u=s[0],d=s.slice(1).join(".");return i(e[u]||{},d,r)}var h;if("$or"===t){for(h=0;h<r.length;h++)if(o(e,r[h]))return!0;return!1}if("$relatedTo"===t)return!1;if("object"!=typeof r)return Array.isArray(e[t])?e[t].indexOf(r)>-1:e[t]===r;var f;if(r.__type)return"Pointer"===r.__type?a(e[t],r,function(e,t){return void 0!==e&&t.className===e.className&&t.objectId===e.objectId}):a(e[t],c._decode(t,r),l);for(var p in r)switch((f=r[p]).__type&&(f=c._decode(t,f)),p){case"$lt":if(e[t]>=f)return!1;break;case"$lte":if(e[t]>f)return!1;break;case"$gt":if(e[t]<=f)return!1;break;case"$gte":if(e[t]<f)return!1;break;case"$ne":if(l(e[t],f))return!1;break;case"$in":if(!n(f,e[t]))return!1;break;case"$nin":if(n(f,e[t]))return!1;break;case"$all":for(h=0;h<f.length;h++)if(e[t].indexOf(f[h])<0)return!1;break;case"$exists":{const s=void 0!==e[t],n=r.$exists;if("boolean"!=typeof r.$exists)break;if(!s&&n||s&&!n)return!1;break}case"$regex":if("object"==typeof f)return f.test(e[t]);for(var m="",_=-2,y=f.indexOf("\\Q");y>-1;)m+=f.substring(_+2,y),(_=f.indexOf("\\E",y))>-1&&(m+=f.substring(y+2,_).replace(/\\\\\\\\E/g,"\\E").replace(/\W/g,"\\$&")),y=f.indexOf("\\Q",_);m+=f.substring(Math.max(y,_+2));if(!new RegExp(m,r.$options||"").test(e[t]))return!1;break;case"$nearSphere":if(!f||!e[t])return!1;return f.radiansTo(e[t])<=(r.$maxDistance||1/0);case"$within":if(!f||!e[t])return!1;var b=f.$box[0],g=f.$box[1];return!(b.latitude>g.latitude||b.longitude>g.longitude)&&(e[t].latitude>b.latitude&&e[t].latitude<g.latitude&&e[t].longitude>b.longitude&&e[t].longitude<g.longitude);case"$options":case"$maxDistance":break;case"$select":case"$dontSelect":default:return!1}return!0}var l=r(99),u=r(100),c=r(0),d={queryHash:function(e){e instanceof c.Query&&(e={className:e.className,where:e._where});var t,r=function(e){if(!e.hasOwnProperty("$or"))return e;for(var t=[],r=0;r<e.$or.length;r++)t=t.concat(e.$or[r]);return t}(e.where||{}),n=[],o=[];if(Array.isArray(r)){var a={};for(t=0;t<r.length;t++){var i={},l=Object.keys(r[t]);l.sort();for(var u=0;u<l.length;u++)i[l[u]]=r[t][l[u]],a[l[u]]=!0;o.push(i)}(n=Object.keys(a)).sort()}else for((n=Object.keys(r)).sort(),t=0;t<n.length;t++)o.push(r[n[t]]);var d=[n.join(","),s(o)];return e.className+":"+d.join("|")},matchesQuery:o};e.exports=d},function(e,t,r){"use strict";function s(e,t){if(typeof e!=typeof t)return!1;if("object"!=typeof e)return e===t;if(e===t)return!0;if("[object Date]"===n.call(e))return"[object Date]"===n.call(t)&&+e==+t;if(Array.isArray(e)){if(Array.isArray(t)){if(e.length!==t.length)return!1;for(var r=0;r<e.length;r++)if(!s(e[r],t[r]))return!1;return!0}return!1}if(Object.keys(e).length!==Object.keys(t).length)return!1;for(var o in e)if(!s(e[o],t[o]))return!1;return!0}var n=Object.prototype.toString;e.exports=s},function(e,t,r){"use strict";class s{constructor(e,t){this.className=e,this.objectId=t}toString(){return this.className+":"+this.objectId}static fromString(e){var t=e.split(":");if(2!==t.length)throw new TypeError("Cannot create Id object from this string");return new s(t[0],t[1])}}e.exports=s},function(e,t){function r(e){throw new Error("Cannot find module '"+e+"'.")}r.keys=function(){return[]},r.resolve=r,e.exports=r,r.id=101},function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.EventEmitterPubSub=void 0;var s=function(e){return e&&e.__esModule?e:{default:e}}(r(43));const n=new s.default.EventEmitter;class o{constructor(e){this.emitter=e}publish(e,t){this.emitter.emit(e,t)}}class a extends s.default.EventEmitter{constructor(e){super(),this.emitter=e,this.subscriptions=new Map}subscribe(e){const t=t=>{this.emit("message",e,t)};this.subscriptions.set(e,t),this.emitter.on(e,t)}unsubscribe(e){this.subscriptions.has(e)&&(this.emitter.removeListener(e,this.subscriptions.get(e)),this.subscriptions.delete(e))}}const i={createPublisher:function(){return new o(n)},createSubscriber:function(){return new a(n)}};t.EventEmitterPubSub=i},function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.RedisPubSub=void 0;var s=function(e){return e&&e.__esModule?e:{default:e}}(r(44));const n={createPublisher:function({redisURL:e}){return s.default.createClient(e,{no_ready_check:!0})},createSubscriber:function({redisURL:e}){return s.default.createClient(e,{no_ready_check:!0})}};t.RedisPubSub=n},function(e,t,r){"use strict";function s(e){return e&&e.__esModule?e:{default:e}}Object.defineProperty(t,"__esModule",{value:!0}),t.SessionTokenCache=void 0;var n=s(r(0)),o=s(r(45)),a=s(r(1));t.SessionTokenCache=class{constructor(e=2592e6,t=1e4){this.cache=new o.default({max:t,maxAge:e})}getUserId(e){if(!e)return n.default.Promise.error("Empty sessionToken");const t=this.cache.get(e);return t?(a.default.verbose("Fetch userId %s of sessionToken %s from Cache",t,e),n.default.Promise.as(t)):function(e){var t=new n.default.Query("_Session");return t.equalTo("sessionToken",e),t.first({useMasterKey:!0}).then(function(e){return e?e.get("user"):n.default.Promise.error("No session found for session token")})}(e).then(t=>{a.default.verbose("Fetch userId %s of sessionToken %s from Mmbs",t.id,e);const r=t.id;return this.cache.set(e,r),n.default.Promise.as(r)},t=>(a.default.error("Can not fetch userId for sessionToken %j, error %j",e,t),n.default.Promise.error(t)))}}},function(e,t){e.exports=__webpack_require__(36)},function(e,t,r){"use strict";(function(e){function s(e){return e&&e.__esModule?e:{default:e}}Object.defineProperty(t,"__esModule",{value:!0}),t.PublicAPIRouter=void 0;var n=s(r(2)),o=s(r(8)),a=s(r(24)),i=s(r(11)),l=s(r(27)),u=s(r(16));const c=i.default.resolve(e,"../../public_html"),d=i.default.resolve(e,"../../views");class h extends n.default{verifyEmail(e){const{token:t,username:r}=e.query,s=e.params.appId,n=o.default.get(s);if(n||this.invalidRequest(),!n.publicServerURL)return this.missingPublicServerURL();if(!t||!r)return this.invalidLink(e);return n.userController.verifyEmail(r,t).then(()=>{const e=u.default.stringify({username:r});return Promise.resolve({status:302,location:`${n.verifyEmailSuccessURL}?${e}`})},()=>this.invalidVerificationLink(e))}resendVerificationEmail(e){const t=e.body.username,r=e.params.appId,s=o.default.get(r);if(s||this.invalidRequest(),!s.publicServerURL)return this.missingPublicServerURL();if(!t)return this.invalidLink(e);return s.userController.resendVerificationEmail(t).then(()=>Promise.resolve({status:302,location:`${s.linkSendSuccessURL}`}),()=>Promise.resolve({status:302,location:`${s.linkSendFailURL}`}))}changePassword(e){return new Promise((t,r)=>{const s=o.default.get(e.query.id);if(s||this.invalidRequest(),!s.publicServerURL)return t({status:404,text:"Not found."});l.default.readFile(i.default.resolve(d,"choose_password"),"utf-8",(e,n)=>{if(e)return r(e);n=n.replace("MMBS_SERVER_URL",`'${s.publicServerURL}'`),t({text:n})})})}requestResetPassword(e){const t=e.config;if(t||this.invalidRequest(),!t.publicServerURL)return this.missingPublicServerURL();const{username:r,token:s}=e.query;return r&&s?t.userController.checkResetTokenValidity(r,s).then(()=>{const e=u.default.stringify({token:s,id:t.applicationId,username:r,app:t.appName});return Promise.resolve({status:302,location:`${t.choosePasswordURL}?${e}`})},()=>this.invalidLink(e)):this.invalidLink(e)}resetPassword(e){const t=e.config;if(t||this.invalidRequest(),!t.publicServerURL)return this.missingPublicServerURL();const{username:r,token:s,new_password:n}=e.body;return r&&s&&n?t.userController.updatePassword(r,s,n).then(()=>{const e=u.default.stringify({username:r});return Promise.resolve({status:302,location:`${t.passwordResetSuccessURL}?${e}`})},e=>{const n=u.default.stringify({username:r,token:s,id:t.applicationId,error:e,app:t.appName});return Promise.resolve({status:302,location:`${t.choosePasswordURL}?${n}`})}):this.invalidLink(e)}invalidLink(e){return Promise.resolve({status:302,location:e.config.invalidLinkURL})}invalidVerificationLink(e){const t=e.config;if(e.query.username&&e.params.appId){const r=u.default.stringify({username:e.query.username,appId:e.params.appId});return Promise.resolve({status:302,location:`${t.invalidVerificationLinkURL}?${r}`})}return this.invalidLink(e)}missingPublicServerURL(){return Promise.resolve({text:"Not found.",status:404})}invalidRequest(){const e=new Error;throw e.status=403,e.message="unauthorized",e}setConfig(e){return e.config=o.default.get(e.params.appId),Promise.resolve()}mountRoutes(){this.route("GET","/apps/:appId/verify_email",e=>{this.setConfig(e)},e=>this.verifyEmail(e)),this.route("POST","/apps/:appId/resend_verification_email",e=>{this.setConfig(e)},e=>this.resendVerificationEmail(e)),this.route("GET","/apps/choose_password",e=>this.changePassword(e)),this.route("POST","/apps/:appId/request_password_reset",e=>{this.setConfig(e)},e=>this.resetPassword(e)),this.route("GET","/apps/:appId/request_password_reset",e=>{this.setConfig(e)},e=>this.requestResetPassword(e))}expressRouter(){const e=a.default.Router();return e.use("/apps",a.default.static(c)),e.use("/",super.expressRouter()),e}}t.PublicAPIRouter=h,t.default=h}).call(t,"/")},function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.PushRouter=void 0;var s=function(e){return e&&e.__esModule?e:{default:e}}(r(2)),n=function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var r in e)Object.prototype.hasOwnProperty.call(e,r)&&(t[r]=e[r]);return t.default=e,t}(r(5)),o=r(0);class a extends s.default{mountRoutes(){this.route("POST","/push",n.promiseEnforceMasterKeyAccess,a.handlePOST)}static handlePOST(e){if(e.auth.isReadOnly)throw new o.Mmbs.Error(o.Mmbs.Error.OPERATION_FORBIDDEN,"read-only masterKey isn't allowed to send push notifications.");const t=e.config.pushController;if(!t)throw new o.Mmbs.Error(o.Mmbs.Error.PUSH_MISCONFIGURED,"Push controller is not set");const r=a.getQueryCondition(e);let s;const n=new Promise(e=>{s=e});let i;return t.sendPush(e.body,r,e.config,e.auth,e=>{s({headers:{"X-Mmbs-Push-Status-Id":i=e},response:{result:!0}})}).catch(t=>{e.config.loggerController.error(`_PushStatus ${i}: error while sending push`,t)}),n}static getQueryCondition(e){const t=e.body||{},r=void 0!==t.where,s=void 0!==t.channels;let n;if(r&&s)throw new o.Mmbs.Error(o.Mmbs.Error.PUSH_MISCONFIGURED,"Channels and query can not be set at the same time.");if(r)n=t.where;else{if(!s)throw new o.Mmbs.Error(o.Mmbs.Error.PUSH_MISCONFIGURED,'Sending a push requires either "channels" or a "where" query.');n={channels:{$in:t.channels}}}return n}}t.PushRouter=a,t.default=a},function(e,t,r){"use strict";function s(e){return e&&e.__esModule?e:{default:e}}function n(e){return void 0===e.startAfter&&(e.startAfter=(new Date).toISOString()),e}function o(e,t){const r=u.getJobs(e.applicationId)||{};if(t.jobName&&!r[t.jobName])throw new i.default.Error(i.default.Error.INTERNAL_SERVER_ERROR,"Cannot Schedule a job that is not deployed")}Object.defineProperty(t,"__esModule",{value:!0}),t.CloudCodeRouter=void 0;var a=s(r(2)),i=s(r(0)),l=s(r(4));const u=r(9),c=r(5);class d extends a.default{mountRoutes(){this.route("GET","/cloud_code/jobs",c.promiseEnforceMasterKeyAccess,d.getJobs),this.route("GET","/cloud_code/jobs/data",c.promiseEnforceMasterKeyAccess,d.getJobsData),this.route("POST","/cloud_code/jobs",c.promiseEnforceMasterKeyAccess,d.createJob),this.route("PUT","/cloud_code/jobs/:objectId",c.promiseEnforceMasterKeyAccess,d.editJob),this.route("DELETE","/cloud_code/jobs/:objectId",c.promiseEnforceMasterKeyAccess,d.deleteJob)}static getJobs(e){return l.default.find(e.config,e.auth,"_JobSchedule",{},{}).then(e=>({response:e.results}))}static getJobsData(e){const t=e.config,r=u.getJobs(t.applicationId)||{};return l.default.find(e.config,e.auth,"_JobSchedule",{},{}).then(e=>({response:{in_use:e.results.map(e=>e.jobName),jobs:Object.keys(r)}}))}static createJob(e){const{job_schedule:t}=e.body;return o(e.config,t),l.default.create(e.config,e.auth,"_JobSchedule",n(t),e.client)}static editJob(e){const{objectId:t}=e.params,{job_schedule:r}=e.body;return o(e.config,r),l.default.update(e.config,e.auth,"_JobSchedule",{objectId:t},n(r)).then(e=>({response:e}))}static deleteJob(e){const{objectId:t}=e.params;return l.default.del(e.config,e.auth,"_JobSchedule",t).then(e=>({response:e}))}}t.CloudCodeRouter=d},function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.RolesRouter=void 0;var s=function(e){return e&&e.__esModule?e:{default:e}}(r(13));class n extends s.default{className(){return"_Role"}mountRoutes(){this.route("GET","/roles",e=>this.handleFind(e)),this.route("GET","/roles/:objectId",e=>this.handleGet(e)),this.route("POST","/roles",e=>this.handleCreate(e)),this.route("PUT","/roles/:objectId",e=>this.handleUpdate(e)),this.route("DELETE","/roles/:objectId",e=>this.handleDelete(e))}}t.RolesRouter=n,t.default=n},function(e,t,r){"use strict";function s(e,t){throw new c.Error(c.Error.INVALID_CLASS_NAME,`Class name mismatch between ${e} and ${t}.`)}function n(e){return e.config.database.loadSchema({clearCache:!0}).then(e=>e.getAllClasses(!0)).then(e=>({response:{results:e}}))}function o(e){const t=e.params.className;return e.config.database.loadSchema({clearCache:!0}).then(e=>e.getOneSchema(t,!0)).then(e=>({response:e})).catch(e=>{throw void 0===e?new c.Error(c.Error.INVALID_CLASS_NAME,`Class ${t} does not exist.`):new c.Error(c.Error.INTERNAL_SERVER_ERROR,"Database adapter error.")})}function a(e){if(e.auth.isReadOnly)throw new c.Error(c.Error.OPERATION_FORBIDDEN,"read-only masterKey isn't allowed to create a schema.");if(e.params.className&&e.body.className&&e.params.className!=e.body.className)return s(e.body.className,e.params.className);const t=e.params.className||e.body.className;if(!t)throw new c.Error(135,`POST ${e.path} needs a class name.`);return e.config.database.loadSchema({clearCache:!0}).then(r=>r.addClassIfNotExists(t,e.body.fields,e.body.classLevelPermissions,e.body.indexes)).then(e=>({response:e}))}function i(e){if(e.auth.isReadOnly)throw new c.Error(c.Error.OPERATION_FORBIDDEN,"read-only masterKey isn't allowed to update a schema.");if(e.body.className&&e.body.className!=e.params.className)return s(e.body.className,e.params.className);const t=e.body.fields||{},r=e.params.className;return e.config.database.loadSchema({clearCache:!0}).then(s=>s.updateClass(r,t,e.body.classLevelPermissions,e.body.indexes,e.config.database)).then(e=>({response:e}))}Object.defineProperty(t,"__esModule",{value:!0}),t.SchemasRouter=void 0;var l=function(e){return e&&e.__esModule?e:{default:e}}(r(2)),u=function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var r in e)Object.prototype.hasOwnProperty.call(e,r)&&(t[r]=e[r]);return t.default=e,t}(r(5)),c=r(0).Mmbs,d=r(22);const h=e=>{if(e.auth.isReadOnly)throw new c.Error(c.Error.OPERATION_FORBIDDEN,"read-only masterKey isn't allowed to delete a schema.");if(!d.classNameIsValid(e.params.className))throw new c.Error(c.Error.INVALID_CLASS_NAME,d.invalidClassNameMessage(e.params.className));return e.config.database.deleteSchema(e.params.className).then(()=>({response:{}}))};t.SchemasRouter=class extends l.default{mountRoutes(){this.route("GET","/schemas",u.promiseEnforceMasterKeyAccess,n),this.route("GET","/schemas/:className",u.promiseEnforceMasterKeyAccess,o),this.route("POST","/schemas",u.promiseEnforceMasterKeyAccess,a),this.route("POST","/schemas/:className",u.promiseEnforceMasterKeyAccess,a),this.route("PUT","/schemas/:className",u.promiseEnforceMasterKeyAccess,i),this.route("DELETE","/schemas/:className",u.promiseEnforceMasterKeyAccess,h)}}},function(e,t,r){"use strict";function s(e){return e&&e.__esModule?e:{default:e}}Object.defineProperty(t,"__esModule",{value:!0}),t.SessionsRouter=void 0;var n=s(r(13)),o=s(r(0)),a=s(r(4)),i=s(r(6)),l=s(r(23)),u=r(12);class c extends n.default{className(){return"_Session"}handleMe(e){if(!e.info||!e.info.sessionToken)throw new o.default.Error(o.default.Error.INVALID_SESSION_TOKEN,"Session token required.");return a.default.find(e.config,i.default.master(e.config),"_Session",{sessionToken:e.info.sessionToken},void 0,e.info.clientSDK).then(e=>{if(!e.results||0==e.results.length)throw new o.default.Error(o.default.Error.INVALID_SESSION_TOKEN,"Session token not found.");return{response:e.results[0]}})}handleUpdateToRevocableSession(e){const t=e.config,r=i.default.master(t),s=e.auth.user;if(!s)throw new o.default.Error(o.default.Error.OBJECT_NOT_FOUND,"invalid session");const n=t.generateSessionExpiresAt(),a={sessionToken:"r:"+(0,u.newToken)(),user:{__type:"Pointer",className:"_User",objectId:s.id},createdWith:{action:"upgrade"},restricted:!1,installationId:e.auth.installationId,expiresAt:o.default._encode(n)};return new l.default(t,r,"_Session",null,a).execute().then(()=>t.database.update("_User",{objectId:s.id},{sessionToken:{__op:"Delete"}})).then(()=>Promise.resolve({response:a}))}mountRoutes(){this.route("GET","/sessions/me",e=>this.handleMe(e)),this.route("GET","/sessions",e=>this.handleFind(e)),this.route("GET","/sessions/:objectId",e=>this.handleGet(e)),this.route("POST","/sessions",e=>this.handleCreate(e)),this.route("PUT","/sessions/:objectId",e=>this.handleUpdate(e)),this.route("DELETE","/sessions/:objectId",e=>this.handleDelete(e)),this.route("POST","/upgradeToRevocableSession",e=>this.handleUpdateToRevocableSession(e))}}t.SessionsRouter=c,t.default=c},function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.AccountLockout=void 0;var s=function(e){return e&&e.__esModule?e:{default:e}}(r(0));class n{constructor(e,t){this._user=e,this._config=t}_setFailedLoginCount(e){const t={username:this._user.username},r={_failed_login_count:e};return this._config.database.update("_User",t,r)}_isFailedLoginCountSet(){const e={username:this._user.username,_failed_login_count:{$exists:!0}};return this._config.database.find("_User",e).then(e=>!!(Array.isArray(e)&&e.length>0))}_initFailedLoginCount(){return this._isFailedLoginCountSet().then(e=>{if(!e)return this._setFailedLoginCount(0)})}_incrementFailedLoginCount(){const e={username:this._user.username};return this._config.database.update("_User",e,{_failed_login_count:{__op:"Increment",amount:1}})}_setLockoutExpiration(){const e={username:this._user.username,_failed_login_count:{$gte:this._config.accountLockout.threshold}},t=new Date,r={_account_lockout_expires_at:s.default._encode(new Date(t.getTime()+60*this._config.accountLockout.duration*1e3))};return this._config.database.update("_User",e,r).catch(e=>{if(!(e&&e.code&&e.message&&101===e.code&&"Object not found."===e.message))throw e})}_notLocked(){const e={username:this._user.username,_account_lockout_expires_at:{$gt:s.default._encode(new Date)},_failed_login_count:{$gte:this._config.accountLockout.threshold}};return this._config.database.find("_User",e).then(e=>{if(Array.isArray(e)&&e.length>0)throw new s.default.Error(s.default.Error.OBJECT_NOT_FOUND,"Your account is locked due to multiple failed login attempts. Please try again after "+this._config.accountLockout.duration+" minute(s)")})}_handleFailedLoginAttempt(){return this._initFailedLoginCount().then(()=>this._incrementFailedLoginCount()).then(()=>this._setLockoutExpiration())}handleLoginAttempt(e){return this._config.accountLockout?this._notLocked().then(()=>e?this._setFailedLoginCount(0):this._handleFailedLoginAttempt()):Promise.resolve()}}t.AccountLockout=n,t.default=n},function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.PurgeRouter=void 0;var s=function(e){return e&&e.__esModule?e:{default:e}}(r(2)),n=function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var r in e)Object.prototype.hasOwnProperty.call(e,r)&&(t[r]=e[r]);return t.default=e,t}(r(5));class o extends s.default{handlePurge(e){return e.config.database.purgeCollection(e.params.className).then(()=>{var t=e.config.cacheController;return"_Session"==e.params.className?t.user.clear():"_Role"==e.params.className&&t.role.clear(),{response:{}}})}mountRoutes(){this.route("DELETE","/purge/:className",n.promiseEnforceMasterKeyAccess,e=>this.handlePurge(e))}}t.PurgeRouter=o,t.default=o},function(e,t,r){"use strict";function s(e){return e&&e.__esModule?e:{default:e}}Object.defineProperty(t,"__esModule",{value:!0}),t.AudiencesRouter=void 0;var n=s(r(13)),o=s(r(4)),a=function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var r in e)Object.prototype.hasOwnProperty.call(e,r)&&(t[r]=e[r]);return t.default=e,t}(r(5));class i extends n.default{className(){return"_Audience"}handleFind(e){const t=Object.assign(e.body,n.default.JSONFromQuery(e.query)),r=n.default.optionsFromBody(t);return o.default.find(e.config,e.auth,"_Audience",t.where,r,e.info.clientSDK).then(e=>(e.results.forEach(e=>{e.query=JSON.parse(e.query)}),{response:e}))}handleGet(e){return super.handleGet(e).then(e=>(e.response.query=JSON.parse(e.response.query),e))}mountRoutes(){this.route("GET","/push_audiences",a.promiseEnforceMasterKeyAccess,e=>this.handleFind(e)),this.route("GET","/push_audiences/:objectId",a.promiseEnforceMasterKeyAccess,e=>this.handleGet(e)),this.route("POST","/push_audiences",a.promiseEnforceMasterKeyAccess,e=>this.handleCreate(e)),this.route("PUT","/push_audiences/:objectId",a.promiseEnforceMasterKeyAccess,e=>this.handleUpdate(e)),this.route("DELETE","/push_audiences/:objectId",a.promiseEnforceMasterKeyAccess,e=>this.handleDelete(e))}}t.AudiencesRouter=i,t.default=i},function(e,t,r){"use strict";function s(e){return e&&e.__esModule?e:{default:e}}Object.defineProperty(t,"__esModule",{value:!0}),t.AggregateRouter=void 0;var n=s(r(13)),o=s(r(4)),a=(function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var r in e)Object.prototype.hasOwnProperty.call(e,r)&&(t[r]=e[r]);t.default=e}(r(5)),s(r(0))),i=s(r(46));const l=["where","distinct","project","match","redact","limit","skip","unwind","group","sample","sort","geoNear","lookup","out","indexStats","facet","bucket","bucketAuto","sortByCount","addFields","replaceRoot","count","graphLookup"];class u extends n.default{handleFind(e){const t=Object.assign(e.body,n.default.JSONFromQuery(e.query)),r={},s=[];for(const e in t){if(-1===l.indexOf(e))throw new a.default.Error(a.default.Error.INVALID_QUERY,`Invalid parameter for query: ${e}`);if("group"===e){if(t[e].hasOwnProperty("_id"))throw new a.default.Error(a.default.Error.INVALID_QUERY,"Invalid parameter for query: group. Please use objectId instead of _id");if(!t[e].hasOwnProperty("objectId"))throw new a.default.Error(a.default.Error.INVALID_QUERY,"Invalid parameter for query: group. objectId is required");t[e]._id=t[e].objectId,delete t[e].objectId}s.push({[`$${e}`]:t[e]})}return t.distinct&&(r.distinct=String(t.distinct)),r.pipeline=s,"string"==typeof t.where&&(t.where=JSON.parse(t.where)),o.default.find(e.config,e.auth,this.className(e),t.where,r,e.info.clientSDK).then(e=>{for(const t of e.results)"object"==typeof t&&i.default.removeHiddenProperties(t);return{response:e}})}mountRoutes(){this.route("GET","/aggregate/:className",e=>this.handleFind(e))}}t.AggregateRouter=u,t.default=u},function(e,t,r){"use strict";function s(e={},t){const r=e.installationId||"cloud";return e.useMasterKey?u.Promise.as(new a.Auth({config:t,isMaster:!0,installationId:r})):function(e){return e&&"string"==typeof e.sessionToken?u.Promise.as(e.sessionToken):u.Promise.as(null)}(e).then(s=>s?(e.sessionToken=s,a.getAuthForSessionToken({config:t,sessionToken:s,installationId:r})):u.Promise.as(new a.Auth({config:t,installationId:r})))}function n(e,t){function r(n,a,c={},d={}){const h=arguments,f=o.get(e),p=l.parse(f.serverURL);if(0===a.indexOf(p.path)&&(a=a.slice(p.path.length,a.length)),"/"!==a[0]&&(a="/"+a),"/batch"===a){const e=c.requests.map(e=>r(e.method,e.path,e.body,d).then(e=>u.Promise.as({success:e}),e=>u.Promise.as({error:{code:e.code,error:e.message}})));return u.Promise.all(e)}let m;return"GET"===n&&(m=c),new u.Promise((r,o)=>{s(d,f).then(s=>{const l={body:c,config:f,auth:s,info:{applicationId:e,sessionToken:d.sessionToken},query:m};return Promise.resolve().then(()=>t.tryRouteRequest(n,a,l)).then(e=>{r(e.response,e.status,e)},e=>{e instanceof u.Error&&e.code==u.Error.INVALID_JSON&&e.message==`cannot route ${n} ${a}`?i._request.apply(null,h).then(r,o):o(e)})},o)})}return{request:r,ajax:i._ajax}}Object.defineProperty(t,"__esModule",{value:!0});const o=r(8),a=r(6),i=r(117),l=r(15),u=r(0);t.default=n,t.MmbsServerRESTController=n},function(e,t){e.exports=__webpack_require__(1)},function(e,t,r){"use strict";function s(e){return e&&e.__esModule?e:{default:e}}function n(e){const{appId:t,jsonLogs:r,logsFolder:s,verbose:n,logLevel:o,silent:a,loggerAdapter:i}=e,l={jsonLogs:r,logsFolder:s,verbose:n,logLevel:o,silent:a},u=(0,_.loadAdapter)(i,j.WinstonLoggerAdapter,l);return new g.LoggerController(u,t,l)}function o(e){const{appId:t,databaseURI:r,filesAdapter:s,databaseAdapter:n,filesSubDirectory:o}=e;if(!s&&n)throw"When using an explicit database adapter, you must also use an explicit filesAdapter.";let a=null;return a="GridStoreAdapter"==s?new $.GridStoreAdapter(r):(0,_.loadAdapter)(s,()=>new R.default({filesSubDirectory:o})),new v.FilesController(a,t)}function a(e){const{appId:t,emailAdapter:r,verifyUserEmails:s}=e,n=(0,_.loadAdapter)(r);return new S.UserController(n,t,{verifyUserEmails:s})}function i(e){const{appId:t,cacheAdapter:r,cacheTTL:s,cacheMaxSize:n}=e,o=(0,_.loadAdapter)(r,k.InMemoryCacheAdapter,{appId:t,ttl:s,maxSize:n});return new w.CacheController(o,t)}function l(e){const{analyticsAdapter:t}=e,r=(0,_.loadAdapter)(t,M.AnalyticsAdapter);return new I.AnalyticsController(r)}function u(e){return new O.LiveQueryController(e.liveQuery)}function c(e,t){const{databaseURI:r,databaseOptions:s,collectionPrefix:n,schemaCacheTTL:o,enableSingleSchemaCache:a}=e;let{databaseAdapter:i}=e;if((s||r&&r!==y.default.databaseURI||n!==y.default.collectionPrefix)&&i)throw"You cannot specify both a databaseAdapter and a databaseURI/databaseOptions/collectionPrefix.";return i=i?(0,_.loadAdapter)(i):p(r,n,s),new P.default(i,new T.default(t,o,a))}function d(e,t){const{appId:r,webhookKey:s}=e;return new E.HooksController(r,t,s)}function h(e){const{scheduledPush:t,push:r}=e,s=Object.assign({},r),n=s.queueOptions||{};s.queueOptions&&delete s.queueOptions;const o=(0,_.loadAdapter)(s&&s.adapter,U.default,s),a=new A.PushController,i=!(!o||!r),l=i&&!0===t,{disablePushWorker:u}=n,c=new N.PushQueue(n);let d;return u||(d=new C.PushWorker(o,n)),{pushController:a,hasPushSupport:i,hasPushScheduledSupport:l,pushControllerQueue:c,pushWorker:d}}function f(e){const{auth:t,enableAnonymousUsers:r}=e;return(0,m.default)(t,r)}function p(e,t,r){let s;try{const t=b.default.parse(e);s=t.protocol?t.protocol.toLowerCase():null}catch(e){}switch(s){case"postgres:":return new x.default({uri:e,collectionPrefix:t,databaseOptions:r});case"mysql:":return new D.default({uri:e,collectionPrefix:t,databaseOptions:r});default:return new L.default({uri:e,collectionPrefix:t,mongoOptions:r})}}Object.defineProperty(t,"__esModule",{value:!0}),t.getControllers=function(e){const t=n(e),r=o(e),s=a(e),{pushController:p,hasPushScheduledSupport:m,hasPushSupport:_,pushControllerQueue:y,pushWorker:b}=h(e),g=i(e),v=l(e),E=u(e),S=c(e,g);return{loggerController:t,filesController:r,userController:s,pushController:p,hasPushScheduledSupport:m,hasPushSupport:_,pushWorker:b,pushControllerQueue:y,analyticsController:v,cacheController:g,liveQueryController:E,databaseController:S,hooksController:d(e,S),authDataManager:f(e)}},t.getLoggerController=n,t.getFilesController=o,t.getUserController=a,t.getCacheController=i,t.getAnalyticsController=l,t.getLiveQueryController=u,t.getDatabaseController=c,t.getHooksController=d,t.getPushController=h,t.getAuthDataManager=f,t.getDatabaseAdapter=p;var m=s(r(119)),_=(r(19),r(25)),y=s(r(10)),b=s(r(15)),g=r(34),v=r(134),E=r(135),S=r(136),w=r(138),O=r(140),I=r(142),A=r(143),N=r(50),C=r(52),P=s(r(36)),T=s(r(35)),R=s(r(53)),$=r(146),j=r(32),k=r(54),M=r(49),L=s(r(147)),x=s(r(152)),D=s(r(156)),U=s(r(161))},function(e,t,r){"use strict";function s(e,t){const r=o[e],s=Object.assign({},r),a=t[e];if(!r&&!a)return;const i=a?a.appIds:void 0;if(a){const e=(0,n.default)(a,void 0,a);e&&["validateAuthData","validateAppId"].forEach(t=>{e[t]&&(s[t]=e[t])})}return s.validateAuthData&&s.validateAppId?{adapter:s,appIds:i,providerOptions:a}:void 0}var n=function(e){return e&&e.__esModule?e:{default:e}}(r(25));const o={facebook:r(120),instagram:r(121),linkedin:r(122),meetup:r(123),google:r(124),github:r(125),twitter:r(47),spotify:r(127),anonymous:{validateAuthData:()=>Promise.resolve(),validateAppId:()=>Promise.resolve()},digits:r(47),janrainengage:r(128),janraincapture:r(129),vkontakte:r(130),qq:r(131),wechat:r(132),weibo:r(133)};e.exports=function(e={},t=!0){let r=t;return Object.freeze({getValidatorForProvider:function(t){if("anonymous"===t&&!r)return;const{adapter:n,appIds:o,providerOptions:a}=s(t,e);return function(e,t,r){return function(s){return e.validateAuthData(s,r).then(()=>t?e.validateAppId(t,s,r):Promise.resolve())}}(n,o,a)},setEnableAnonymousUsers:function(e){r=e}})},e.exports.loadAuthAdapter=s},function(e,t,r){"use strict";function s(e){return new Promise(function(t,r){n.get("https://graph.facebook.com/v2.5/"+e,function(e){var s="";e.on("data",function(e){s+=e}),e.on("end",function(){try{s=JSON.parse(s)}catch(e){return r(e)}t(s)})}).on("error",function(){r("Failed to validate this access token with Facebook.")})})}var n=r(3),o=r(0).Mmbs;e.exports={validateAppId:function(e,t){var r=t.access_token;if(!e.length)throw new o.Error(o.Error.OBJECT_NOT_FOUND,"Facebook auth is not configured.");return s("app?access_token="+r).then(t=>{if(!t||-1==e.indexOf(t.id))throw new o.Error(o.Error.OBJECT_NOT_FOUND,"Facebook auth is invalid for this user.")})},validateAuthData:function(e){return s("me?fields=id&access_token="+e.access_token).then(t=>{if(!t||t.id!=e.id)throw new o.Error(o.Error.OBJECT_NOT_FOUND,"Facebook auth is invalid for this user.")})}}},function(e,t,r){"use strict";var s=r(3),n=r(0).Mmbs;e.exports={validateAppId:function(){return Promise.resolve()},validateAuthData:function(e){return function(e){return new Promise(function(t,r){s.get("https://api.instagram.com/v1/"+e,function(e){var r="";e.on("data",function(e){r+=e}),e.on("end",function(){r=JSON.parse(r),t(r)})}).on("error",function(){r("Failed to validate this access token with Instagram.")})})}("users/self/?access_token="+e.access_token).then(t=>{if(!t||!t.data||t.data.id!=e.id)throw new n.Error(n.Error.OBJECT_NOT_FOUND,"Instagram auth is invalid for this user.")})}}},function(e,t,r){"use strict";var s=r(3),n=r(0).Mmbs;e.exports={validateAppId:function(){return Promise.resolve()},validateAuthData:function(e){return function(e,t,r){var n={Authorization:"Bearer "+t,"x-li-format":"json"};return r&&(n["x-li-src"]="msdk"),new Promise(function(t,r){s.get({host:"api.linkedin.com",path:"/v1/"+e,headers:n},function(e){var s="";e.on("data",function(e){s+=e}),e.on("end",function(){try{s=JSON.parse(s)}catch(e){return r(e)}t(s)})}).on("error",function(){r("Failed to validate this access token with Linkedin.")})})}("people/~:(id)",e.access_token,e.is_mobile_sdk).then(t=>{if(!t||t.id!=e.id)throw new n.Error(n.Error.OBJECT_NOT_FOUND,"Linkedin auth is invalid for this user.")})}}},function(e,t,r){"use strict";var s=r(3),n=r(0).Mmbs;e.exports={validateAppId:function(){return Promise.resolve()},validateAuthData:function(e){return function(e,t){return new Promise(function(r,n){s.get({host:"api.meetup.com",path:"/2/"+e,headers:{Authorization:"bearer "+t}},function(e){var t="";e.on("data",function(e){t+=e}),e.on("end",function(){try{t=JSON.parse(t)}catch(e){return n(e)}r(t)})}).on("error",function(){n("Failed to validate this access token with Meetup.")})})}("member/self",e.access_token).then(t=>{if(!t||t.id!=e.id)throw new n.Error(n.Error.OBJECT_NOT_FOUND,"Meetup auth is invalid for this user.")})}}},function(e,t,r){"use strict";function s(e,t){return n("tokeninfo?id_token="+t).then(t=>{if(!t||t.sub!=e&&t.user_id!=e)throw new a.Error(a.Error.OBJECT_NOT_FOUND,"Google auth is invalid for this user.")})}function n(e){return new Promise(function(t,r){o.get("https://www.googleapis.com/oauth2/v3/"+e,function(e){var s="";e.on("data",function(e){s+=e}),e.on("end",function(){try{s=JSON.parse(s)}catch(e){return r(e)}t(s)})}).on("error",function(){r("Failed to validate this access token with Google.")})})}var o=r(3),a=r(0).Mmbs;e.exports={validateAppId:function(){return Promise.resolve()},validateAuthData:function(e){return e.id_token?s(e.id,e.id_token):function(e,t){return n("tokeninfo?access_token="+t).then(t=>{if(!t||t.sub!=e&&t.user_id!=e)throw new a.Error(a.Error.OBJECT_NOT_FOUND,"Google auth is invalid for this user.")})}(e.id,e.access_token).then(()=>{},()=>s(e.id,e.access_token))}}},function(e,t,r){"use strict";var s=r(3),n=r(0).Mmbs;e.exports={validateAppId:function(){return Promise.resolve()},validateAuthData:function(e){return function(e,t){return new Promise(function(r,n){s.get({host:"api.github.com",path:"/"+e,headers:{Authorization:"bearer "+t,"User-Agent":"mmbs-server"}},function(e){var t="";e.on("data",function(e){t+=e}),e.on("end",function(){try{t=JSON.parse(t)}catch(e){return n(e)}r(t)})}).on("error",function(){n("Failed to validate this access token with Github.")})})}("user",e.access_token).then(t=>{if(!t||t.id!=e.id)throw new n.Error(n.Error.OBJECT_NOT_FOUND,"Github auth is invalid for this user.")})}}},function(e,t,r){"use strict";var s=r(3),n=r(28),o=r(0).Mmbs,a=function(e){if(!e)throw new o.Error(o.Error.INTERNAL_SERVER_ERROR,"No options passed to OAuth");this.consumer_key=e.consumer_key,this.consumer_secret=e.consumer_secret,this.auth_token=e.auth_token,this.auth_token_secret=e.auth_token_secret,this.host=e.host,this.oauth_params=e.oauth_params||{}};a.prototype.send=function(e,t,r,n){var o=this.buildRequest(e,t,r,n);return new Promise(function(e,t){var r=s.request(o,function(t){var r="";t.on("data",function(e){r+=e}),t.on("end",function(){r=JSON.parse(r),e(r)})}).on("error",function(){t("Failed to make an OAuth request")});o.body&&r.write(o.body),r.end()})},a.prototype.buildRequest=function(e,t,r,s){0!=t.indexOf("/")&&(t="/"+t),r&&Object.keys(r).length>0&&(t+="?"+a.buildParameterString(r));var n={host:this.host,path:t,method:e.toUpperCase()},o=this.oauth_params||{};return o.oauth_consumer_key=this.consumer_key,this.auth_token&&(o.oauth_token=this.auth_token),n=a.signRequest(n,o,this.consumer_secret,this.auth_token_secret),s&&Object.keys(s).length>0&&(n.body=a.buildParameterString(s)),n},a.prototype.get=function(e,t){return this.send("GET",e,t)},a.prototype.post=function(e,t,r){return this.send("POST",e,t,r)},a.encode=function(e){return e=(e+"").toString(),encodeURIComponent(e).replace(/!/g,"%21").replace(/'/g,"%27").replace(/\(/g,"%28").replace(/\)/g,"%29").replace(/\*/g,"%2A")},a.signatureMethod="HMAC-SHA1",a.version="1.0",a.nonce=function(){for(var e="",t="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789",r=0;r<30;r++)e+=t.charAt(Math.floor(Math.random()*t.length));return e},a.buildParameterString=function(e){if(e){return Object.keys(e).sort().map(function(t){return t+"="+a.encode(e[t])}).join("&")}return""},a.buildSignatureString=function(e,t,r){return[e.toUpperCase(),a.encode(t),a.encode(r)].join("&")},a.signature=function(e,t){return n=r(28),a.encode(n.createHmac("sha1",t).update(e).digest("base64"))},a.signRequest=function(e,t,r,s){(t=t||{}).oauth_nonce||(t.oauth_nonce=a.nonce()),t.oauth_timestamp||(t.oauth_timestamp=Math.floor((new Date).getTime()/1e3)),t.oauth_signature_method||(t.oauth_signature_method=a.signatureMethod),t.oauth_version||(t.oauth_version=a.version),s||(s=""),e.method||(e.method="GET");var n={},o=[e.params,e.body,t];for(var i in o){var l=o[i];for(var u in l)n[u]=l[u]}var c=a.buildParameterString(n),d="https://"+e.host+e.path,h=a.buildSignatureString(e.method,d,c),f=[a.encode(r),a.encode(s)].join("&"),p=a.signature(h,f);t.oauth_signature=p,e.headers||(e.headers={});var m=Object.keys(t).sort().map(function(e){return e+'="'+t[e]+'"'}).join(", ");return e.headers.Authorization="OAuth "+m,e.headers["Content-Type"]="application/x-www-form-urlencoded",e},e.exports=a},function(e,t,r){"use strict";function s(e,t){return new Promise(function(r,s){n.get({host:"api.spotify.com",path:"/v1/"+e,headers:{Authorization:"Bearer "+t}},function(e){var t="";e.on("data",function(e){t+=e}),e.on("end",function(){try{t=JSON.parse(t)}catch(e){return s(e)}r(t)})}).on("error",function(){s("Failed to validate this access token with Spotify.")})})}var n=r(3),o=r(0).Mmbs;e.exports={validateAppId:function(e,t){var r=t.access_token;if(!e.length)throw new o.Error(o.Error.OBJECT_NOT_FOUND,"Spotify auth is not configured.");return s("me",r).then(t=>{if(!t||-1==e.indexOf(t.id))throw new o.Error(o.Error.OBJECT_NOT_FOUND,"Spotify auth is invalid for this user.")})},validateAuthData:function(e){return s("me",e.access_token).then(t=>{if(!t||t.id!=e.id)throw new o.Error(o.Error.OBJECT_NOT_FOUND,"Spotify auth is invalid for this user.")})}}},function(e,t,r){"use strict";var s=r(3),n=r(0).Mmbs,o=r(16);e.exports={validateAppId:function(){return Promise.resolve()},validateAuthData:function(e,t){return function(e,t){var r=o.stringify({token:t,apiKey:e,format:"json"}),n={host:"rpxnow.com",path:"/api/v2/auth_info",method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded","Content-Length":r.length}};return new Promise(function(e,t){var o=s.request(n,function(r){var s="";r.setEncoding("utf8"),r.on("data",function(e){s+=e}),r.on("end",function(){try{s=JSON.parse(s)}catch(e){return t(e)}e(s)})});o.write(r),o.end()})}(t.api_key,e.auth_token).then(t=>{if(!t||"ok"!=t.stat||t.profile.identifier!=e.id)throw new n.Error(n.Error.OBJECT_NOT_FOUND,"Janrain engage auth is invalid for this user.")})}}},function(e,t,r){"use strict";var s=r(3),n=r(0).Mmbs,o=r(16);e.exports={validateAppId:function(){return Promise.resolve()},validateAuthData:function(e,t){return function(e,t){var r=o.stringify({access_token:t,attribute_name:"uuid"});return new Promise(function(t,n){s.get({host:e,path:"/entity?"+r},function(e){var r="";e.on("data",function(e){r+=e}),e.on("end",function(){t(JSON.parse(r))})}).on("error",function(){n("Failed to validate this access token with Janrain capture.")})})}(t.janrain_capture_host,e.access_token).then(t=>{if(!t||"ok"!=t.stat||t.result!=e.id)throw new n.Error(n.Error.OBJECT_NOT_FOUND,"Janrain capture auth is invalid for this user.")})}}},function(e,t,r){"use strict";function s(e,t){return new Promise(function(r,s){n.get("https://"+e+"/"+t,function(e){var t="";e.on("data",function(e){t+=e}),e.on("end",function(){try{t=JSON.parse(t)}catch(e){return s(e)}r(t)})}).on("error",function(){s("Failed to validate this access token with Vk.")})})}var n=r(3),o=r(0).Mmbs,a=r(1).default;e.exports={validateAppId:function(){return Promise.resolve()},validateAuthData:function(e,t){return function(e){return new Promise(function(t){if(!(e&&e.appIds&&e.appIds.length&&e.appSecret&&e.appSecret.length))throw a.error("Vk Auth","Vk auth is not configured. Missing appIds or appSecret."),new o.Error(o.Error.OBJECT_NOT_FOUND,"Vk auth is not configured. Missing appIds or appSecret.");t()}).then(function(){return s("oauth.vk.com","access_token?client_id="+e.appIds+"&client_secret="+e.appSecret+"&v=5.59&grant_type=client_credentials")})}(t).then(function(r){if(r&&r.access_token)return s("api.vk.com","method/secure.checkToken?token="+e.access_token+"&client_secret="+t.appSecret+"&access_token="+r.access_token).then(function(t){if(!t||!t.response||t.response.user_id!=e.id)throw new o.Error(o.Error.OBJECT_NOT_FOUND,"Vk auth is invalid for this user.")});throw a.error("Vk Auth","Vk appIds or appSecret is incorrect."),new o.Error(o.Error.OBJECT_NOT_FOUND,"Vk appIds or appSecret is incorrect.")})}}},function(e,t,r){"use strict";var s=r(3),n=r(0).Mmbs;e.exports={validateAppId:function(){return Promise.resolve()},validateAuthData:function(e){return function(e){return new Promise(function(t,r){s.get("https://graph.qq.com/oauth2.0/"+e,function(e){var s="";e.on("data",function(e){s+=e}),e.on("end",function(){var e=s.indexOf("("),o=s.indexOf(")");if(-1==e||-1==o)throw new n.Error(n.Error.OBJECT_NOT_FOUND,"qq auth is invalid for this user.");s=s.substring(e+1,o-1);try{s=JSON.parse(s)}catch(e){return r(e)}t(s)})}).on("error",function(){r("Failed to validate this access token with qq.")})})}("me?access_token="+e.access_token).then(function(t){if(!t||t.openid!=e.id)throw new n.Error(n.Error.OBJECT_NOT_FOUND,"qq auth is invalid for this user.")})}}},function(e,t,r){"use strict";var s=r(3),n=r(0).Mmbs;e.exports={validateAppId:function(){return Promise.resolve()},validateAuthData:function(e){return function(e){return new Promise(function(t,r){s.get("https://api.weixin.qq.com/sns/"+e,function(e){var s="";e.on("data",function(e){s+=e}),e.on("end",function(){try{s=JSON.parse(s)}catch(e){return r(e)}t(s)})}).on("error",function(){r("Failed to validate this access token with wechat.")})})}("auth?access_token="+e.access_token+"&openid="+e.id).then(function(e){if(0!=e.errcode)throw new n.Error(n.Error.OBJECT_NOT_FOUND,"wechat auth is invalid for this user.")})}}},function(e,t,r){"use strict";var s=r(3),n=r(0).Mmbs,o=r(16);e.exports={validateAppId:function(){return Promise.resolve()},validateAuthData:function(e){return function(e){return new Promise(function(t,r){var n=o.stringify({access_token:e}),a={hostname:"api.weibo.com",path:"/oauth2/get_token_info",method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded","Content-Length":Buffer.byteLength(n)}},i=s.request(a,function(e){var s="";e.on("data",function(e){s+=e}),e.on("end",function(){try{s=JSON.parse(s)}catch(e){return r(e)}t(s)}),e.on("error",function(){r("Failed to validate this access token with weibo.")})});i.on("error",function(){r("Failed to validate this access token with weibo.")}),i.write(n),i.end()})}(e.access_token).then(function(t){if(!t||t.uid!=e.id)throw new n.Error(n.Error.OBJECT_NOT_FOUND,"weibo auth is invalid for this user.")})}}},function(e,t,r){"use strict";function s(e){return e&&e.__esModule?e:{default:e}}Object.defineProperty(t,"__esModule",{value:!0}),t.FilesController=void 0;var n=r(12),o=s(r(14)),a=r(48),i=s(r(11)),l=s(r(41));const u=new RegExp("^[0-9a-fA-F]{8}-[0-9a-fA-F]{4}-[0-9a-fA-F]{4}-[0-9a-fA-F]{4}-[0-9a-fA-F]{12}-.*");class c extends o.default{getFileData(e,t){return this.adapter.getFileData(t)}createFile(e,t,r,s){const o=i.default.extname(t).length>0;!o&&s&&l.default.getExtension(s)?t=t+"."+l.default.getExtension(s):o&&!s&&(s=l.default.getType(t)),t=(0,n.randomHexString)(32)+"_"+t;var a=this.adapter.getFileLocation(e,t);return this.adapter.createFile(t,r,s).then(()=>Promise.resolve({url:a,name:t}))}deleteFile(e,t){return this.adapter.deleteFile(t)}expandFilesInObject(e,t){if(t instanceof Array)t.map(t=>this.expandFilesInObject(e,t));else if("object"==typeof t)for(const r in t){const s=t[r];if(s&&"File"===s.__type){if(s.url)continue;const t=s.name;void 0===e.fileKey?s.url=this.adapter.getFileLocation(e,t):0===t.indexOf("tfss-")?s.url="http://files.parsetfss.com/"+e.fileKey+"/"+encodeURIComponent(t):u.test(t)?s.url="http://files.parse.com/"+e.fileKey+"/"+encodeURIComponent(t):s.url=this.adapter.getFileLocation(e,t)}}}expectedAdapterType(){return a.FilesAdapter}getFileStream(e,t){return this.adapter.getFileStream(t)}}t.FilesController=c,t.default=c},function(e,t,r){"use strict";function s(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var r in e)Object.prototype.hasOwnProperty.call(e,r)&&(t[r]=e[r]);return t.default=e,t}Object.defineProperty(t,"__esModule",{value:!0}),t.HooksController=void 0;var n=s(r(9)),o=s(r(0)),a=s(r(18)),i=r(1);const l="_Hooks";class u{constructor(e,t,r){this._applicationId=e,this._webhookKey=r,this.database=t}load(e){if(this._getHooks().then(e=>{(e=e||[]).forEach(e=>{this.addHookToTriggers(e)})}),Array.isArray(e)&&e.length>0)for(const t of e)a.get(t,(e,r,s)=>{if(!e&&200==r.statusCode&&s&&"string"==typeof s)try{let e=JSON.parse(s);Array.isArray(e)?(e=e||[]).forEach(e=>{this.addHookToTriggers(e)}):console.log("webHookServerURL:"+t+" result is not json array")}catch(e){console.log(e)}})}getJob(e){return this._getHooks({jobName:e},1).then(e=>e[0])}getJobs(){return this._getHooks({jobName:{$exists:!0}})}getFunction(e){return this._getHooks({functionName:e},1).then(e=>e[0])}getFunctions(){return this._getHooks({functionName:{$exists:!0}})}getTrigger(e,t){return this._getHooks({className:e,triggerName:t},1).then(e=>e[0])}getTriggers(){return this._getHooks({className:{$exists:!0},triggerName:{$exists:!0}})}deleteJob(e){return n.removeJob(e,this._applicationId),this._removeHooks({jobName:e})}deleteFunction(e){return n.removeFunction(e,this._applicationId),this._removeHooks({functionName:e})}deleteTrigger(e,t){return n.removeTrigger(t,e,this._applicationId),this._removeHooks({className:e,triggerName:t})}_getHooks(e={}){return this.database.find(l,e).then(e=>e.map(e=>(delete e.objectId,e)))}_removeHooks(e){return this.database.destroy(l,e).then(()=>Promise.resolve({}))}saveHook(e){var t;if(e.functionName&&e.url)t={functionName:e.functionName};else if(e.jobName&&e.url)t={jobName:e.jobName};else{if(!(e.triggerName&&e.className&&e.url))throw new o.Error(143,"invalid hook declaration");t={className:e.className,triggerName:e.triggerName}}return this.database.update(l,t,e,{upsert:!0}).then(()=>Promise.resolve(e))}addHookToTriggers(e){var t=function(e,t){return(r,s)=>{const n={};for(var o in r)n[o]=r[o];r.object&&(n.object=r.object.toJSON(),n.object.className=r.object.className),r.original&&(n.original=r.original.toJSON(),n.original.className=r.original.className);const l={headers:{"Content-Type":"application/json"},body:JSON.stringify(n)};t?l.headers["X-Mmbs-Webhook-Key"]=t:i.logger.warn("Making outgoing webhook request without webhookKey being set!"),a.post(e.url,l,function(t,r,n){var o;if(n){if("string"==typeof n)try{n=JSON.parse(n)}catch(e){t={error:"Malformed response",code:-1,partialResponse:n.substring(0,100)}}t||(o=n.success,t=n.error)}return t?s.error(t):"beforeSave"===e.triggerName?("object"==typeof o&&(delete o.createdAt,delete o.updatedAt),s.success({object:o})):s.success(o)})}}(e,this._webhookKey);t.url=e.url,e.className?n.addTrigger(e.triggerName,e.className,t,this._applicationId):e.functionName?n.addFunction(e.functionName,t,null,this._applicationId):e.jobName&&n.addJob(e.jobName,t,this.applicationId)}addHook(e){return this.addHookToTriggers(e),this.saveHook(e)}createOrUpdateHook(e){var t;if(e&&e.functionName&&e.url)(t={}).functionName=e.functionName,t.url=e.url;else if(e&&e.jobName&&e.url)(t={}).jobName=e.jobName,t.url=e.url;else{if(!(e&&e.className&&e.url&&e.triggerName&&n.Types[e.triggerName]))throw new o.Error(143,"invalid hook declaration");(t={}).className=e.className,t.url=e.url,t.triggerName=e.triggerName}return this.addHook(t)}createHook(e){if(e.functionName)return this.getFunction(e.functionName).then(t=>{if(t)throw new o.Error(143,`function name: ${e.functionName} already exits`);return this.createOrUpdateHook(e)});if(e.jobName)return this.getJob(e.jobName).then(t=>{if(t)throw new o.Error(143,`job name: ${e.jobName} already exits`);return this.createOrUpdateHook(e)});if(e.className&&e.triggerName)return this.getTrigger(e.className,e.triggerName).then(t=>{if(t)throw new o.Error(143,`class ${e.className} already has trigger ${e.triggerName}`);return this.createOrUpdateHook(e)});throw new o.Error(143,"invalid hook declaration")}updateHook(e){if(e.functionName)return this.getFunction(e.functionName).then(t=>{if(t)return this.createOrUpdateHook(e);throw new o.Error(143,`no function named: ${e.functionName} is defined`)});if(e.jobName)return this.getJob(e.jobName).then(t=>{if(t)return this.createOrUpdateHook(e);throw new o.Error(143,`no job named: ${e.jobName} is defined`)});if(e.className&&e.triggerName)return this.getTrigger(e.className,e.triggerName).then(t=>{if(t)return this.createOrUpdateHook(e);throw new o.Error(143,`class ${e.className} does not exist`)});throw new o.Error(143,"invalid hook declaration")}}t.HooksController=u,t.default=u},function(e,t,r){"use strict";function s(e){return e&&e.__esModule?e:{default:e}}function n(e,t,r,s){const n=`token=${r}&username=${t}`;if(s.parseFrameURL){const t=e.replace(s.publicServerURL,"");return`${s.parseFrameURL}?link=${encodeURIComponent(t)}&${n}`}return`${e}?${n}`}Object.defineProperty(t,"__esModule",{value:!0}),t.UserController=void 0;var o=r(12),a=r(9),i=s(r(14)),l=s(r(137)),u=s(r(4)),c=s(r(0)),d=r(17),h=r(6);class f extends i.default{constructor(e,t,r={}){super(e,t,r)}validateAdapter(e){(e||this.shouldVerifyEmails)&&super.validateAdapter(e)}expectedAdapterType(){return l.default}get shouldVerifyEmails(){return this.options.verifyUserEmails}setEmailVerifyToken(e){this.shouldVerifyEmails&&(e._email_verify_token=(0,o.randomString)(25),e.emailVerified=!1,this.config.emailVerifyTokenValidityDuration&&(e._email_verify_token_expires_at=c.default._encode(this.config.generateEmailVerifyTokenExpiresAt())))}verifyEmail(e,t){if(!this.shouldVerifyEmails)throw void 0;const r={username:e,_email_verify_token:t},s={emailVerified:!0,_email_verify_token:{__op:"Delete"}};this.config.emailVerifyTokenValidityDuration&&(r.emailVerified=!1,r._email_verify_token_expires_at={$gt:c.default._encode(new Date)},s._email_verify_token_expires_at={__op:"Delete"});const n=h.master(this.config);return new d(this.config,h.master(this.config),"_User",{username:e,emailVerified:!0}).execute().then(e=>e.results.length?Promise.resolve(e.results.length[0]):u.default.update(this.config,n,"_User",r,s))}checkResetTokenValidity(e,t){return this.config.database.find("_User",{username:e,_perishable_token:t},{limit:1}).then(e=>{if(1!=e.length)throw void 0;if(this.config.passwordPolicy&&this.config.passwordPolicy.resetTokenValidityDuration){let t=e[0]._perishable_token_expires_at;if(t&&"Date"==t.__type&&(t=new Date(t.iso)),t<new Date)throw"The password reset link has expired"}return e[0]})}getUserIfNeeded(e){if(e.username&&e.email)return Promise.resolve(e);var t={};e.username&&(t.username=e.username),e.email&&(t.email=e.email);return new d(this.config,h.master(this.config),"_User",t).execute().then(function(e){if(1!=e.results.length)throw void 0;return e.results[0]})}sendVerificationEmail(e){if(!this.shouldVerifyEmails)return;const t=encodeURIComponent(e._email_verify_token);this.getUserIfNeeded(e).then(e=>{const r=encodeURIComponent(e.username),s=n(this.config.verifyEmailURL,r,t,this.config),o={appName:this.config.appName,link:s,user:(0,a.inflate)("_User",e)};this.adapter.sendVerificationEmail?this.adapter.sendVerificationEmail(o):this.adapter.sendMail(this.defaultVerificationEmail(o))})}resendVerificationEmail(e){return this.getUserIfNeeded({username:e}).then(t=>{if(!t||t.emailVerified)throw void 0;return this.setEmailVerifyToken(t),this.config.database.update("_User",{username:e},t).then(()=>{this.sendVerificationEmail(t)})})}setPasswordResetToken(e){const t={_perishable_token:(0,o.randomString)(25)};return this.config.passwordPolicy&&this.config.passwordPolicy.resetTokenValidityDuration&&(t._perishable_token_expires_at=c.default._encode(this.config.generatePasswordResetTokenExpiresAt())),this.config.database.update("_User",{$or:[{email:e},{username:e,email:{$exists:!1}}]},t,{},!0)}sendPasswordResetEmail(e){if(!this.adapter)throw"Trying to send a reset password but no adapter is set";return this.setPasswordResetToken(e).then(e=>{const t=encodeURIComponent(e._perishable_token),r=encodeURIComponent(e.username),s=n(this.config.requestResetPasswordURL,r,t,this.config),o={appName:this.config.appName,link:s,user:(0,a.inflate)("_User",e)};return this.adapter.sendPasswordResetEmail?this.adapter.sendPasswordResetEmail(o):this.adapter.sendMail(this.defaultResetPasswordEmail(o)),Promise.resolve(e)})}updatePassword(e,t,r){return this.checkResetTokenValidity(e,t).then(e=>(function(e,t,r){return u.default.update(r,h.master(r),"_User",{objectId:e},{password:t})})(e.objectId,r,this.config)).then(()=>this.config.database.update("_User",{username:e},{_perishable_token:{__op:"Delete"},_perishable_token_expires_at:{__op:"Delete"}})).catch(e=>e.message?Promise.reject(e.message):Promise.reject(e))}defaultVerificationEmail({link:e,user:t,appName:r}){return{text:"Hi,\n\nYou are being asked to confirm the e-mail address "+t.get("email")+" with "+r+"\n\nClick here to confirm it:\n"+e,to:t.get("email"),subject:"Please verify your e-mail for "+r}}defaultResetPasswordEmail({link:e,user:t,appName:r}){return{text:"Hi,\n\nYou requested to reset your password for "+r+(t.get("username")?" (your username is '"+t.get("username")+"')":"")+".\n\nClick here to reset it:\n"+e,to:t.get("email")||t.get("username"),subject:"Password Reset for "+r}}}t.UserController=f,t.default=f},function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0});class s{sendMail(e){}}t.MailAdapter=s,t.default=s},function(e,t,r){"use strict";function s(e){return e&&e.__esModule?e:{default:e}}function n(...e){return e.join(i)}Object.defineProperty(t,"__esModule",{value:!0}),t.CacheController=t.SubCache=void 0;var o=s(r(14)),a=s(r(139));const i=":";class l{constructor(e,t,r){this.prefix=e,this.cache=t,this.ttl=r}get(e){const t=n(this.prefix,e);return this.cache.get(t)}put(e,t,r){const s=n(this.prefix,e);return this.cache.put(s,t,r)}del(e){const t=n(this.prefix,e);return this.cache.del(t)}clear(){return this.cache.clear()}}t.SubCache=l;class u extends o.default{constructor(e,t,r={}){super(e,t,r),this.role=new l("role",this),this.user=new l("user",this)}get(e){const t=n(this.appId,e);return this.adapter.get(t).then(null,()=>Promise.resolve(null))}put(e,t,r){const s=n(this.appId,e);return this.adapter.put(s,t,r)}del(e){const t=n(this.appId,e);return this.adapter.del(t)}clear(){return this.adapter.clear()}expectedAdapterType(){return a.default}}t.CacheController=u,t.default=u},function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0});t.CacheAdapter=class{get(e){}put(e,t,r){}del(e){}clear(){}}},function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.LiveQueryController=void 0;var s=r(141);r(19);class n{constructor(e){if(e&&e.classNames){if(!(e.classNames instanceof Array))throw"liveQuery.classes should be an array of string";this.classNames=new Set(e.classNames)}else this.classNames=new Set;this.liveQueryPublisher=new s.MmbsCloudCodePublisher(e)}onAfterSave(e,t,r){if(!this.hasLiveQuery(e))return;const s=this._makePublisherRequest(t,r);this.liveQueryPublisher.onCloudCodeAfterSave(s)}onAfterDelete(e,t,r){if(!this.hasLiveQuery(e))return;const s=this._makePublisherRequest(t,r);this.liveQueryPublisher.onCloudCodeAfterDelete(s)}hasLiveQuery(e){return this.classNames.has(e)}_makePublisherRequest(e,t){const r={object:e};return e&&(r.original=t),r}}t.LiveQueryController=n,t.default=n},function(e,t,r){"use strict";function s(e){return e&&e.__esModule?e:{default:e}}Object.defineProperty(t,"__esModule",{value:!0}),t.MmbsCloudCodePublisher=void 0;var n=r(42),o=s(r(0)),a=s(r(1));t.MmbsCloudCodePublisher=class{constructor(e={}){this.parsePublisher=n.MmbsPubSub.createPublisher(e)}onCloudCodeAfterSave(e){this._onCloudCodeMessage(o.default.applicationId+"afterSave",e)}onCloudCodeAfterDelete(e){this._onCloudCodeMessage(o.default.applicationId+"afterDelete",e)}_onCloudCodeMessage(e,t){a.default.verbose("Raw request from cloud code current : %j | original : %j",t.object,t.original);const r={currentMmbsObject:t.object._toFullJSON()};t.original&&(r.originalMmbsObject=t.original._toFullJSON()),this.parsePublisher.publish(e,JSON.stringify(r))}}},function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.AnalyticsController=void 0;var s=function(e){return e&&e.__esModule?e:{default:e}}(r(14)),n=r(49);class o extends s.default{appOpened(e){return Promise.resolve().then(()=>this.adapter.appOpened(e.body,e)).then(e=>({response:e||{}})).catch(()=>({response:{}}))}trackEvent(e){return Promise.resolve().then(()=>this.adapter.trackEvent(e.params.eventName,e.body,e)).then(e=>({response:e||{}})).catch(()=>({response:{}}))}expectedAdapterType(){return n.AnalyticsAdapter}}t.AnalyticsController=o,t.default=o},function(e,t,r){"use strict";function s(e){return e&&e.__esModule?e:{default:e}}Object.defineProperty(t,"__esModule",{value:!0}),t.PushController=void 0;var n=r(0),o=s(r(17)),a=s(r(23)),i=r(6),l=r(29),u=r(30);class c{sendPush(e={},t={},r,s,d=(()=>{}),h=new Date){if(!r.hasPushSupport)throw new n.Mmbs.Error(n.Mmbs.Error.PUSH_MISCONFIGURED,"Missing push configuration");if(e.expiration_time=c.getExpirationTime(e),e.expiration_interval=c.getExpirationInterval(e),e.expiration_time&&e.expiration_interval)throw new n.Mmbs.Error(n.Mmbs.Error.PUSH_MISCONFIGURED,"Both expiration_time and expiration_interval cannot be set");if(e.expiration_interval&&!e.hasOwnProperty("push_time")){const t=1e3*e.expiration_interval;e.expiration_time=new Date(h.valueOf()+t).valueOf()}const f=c.getPushTime(e);f&&"undefined"!==f.date&&(e.push_time=c.formatPushTime(f));let p=()=>Promise.resolve();if(e.data&&e.data.badge){const s=e.data.badge;let n={};if("string"==typeof s&&"increment"===s.toLowerCase())n={badge:{__op:"Increment",amount:1}};else{if(!Number(s))throw"Invalid value for badge, expected number or 'Increment'";n={badge:s}}const l=(0,u.applyDeviceTokenExists)(t);p=(()=>{const e=new o.default(r,(0,i.master)(r),"_Installation",l);return e.buildRestWhere().then(()=>{const t=new a.default(r,(0,i.master)(r),"_Installation",e.restWhere,n);return t.runOptions.many=!0,t.execute()})})}const m=(0,l.pushStatusHandler)(r);return Promise.resolve().then(()=>m.setInitial(e,t)).then(()=>(d(m.objectId),p())).then(()=>{if(e.audience_id){const s=e.audience_id;var t={lastUsed:{__type:"Date",iso:(new Date).toISOString()},timesUsed:{__op:"Increment",amount:1}};new a.default(r,(0,i.master)(r),"_Audience",{objectId:s},t).execute()}return Promise.resolve()}).then(()=>e.hasOwnProperty("push_time")&&r.hasPushScheduledSupport?Promise.resolve():r.pushControllerQueue.enqueue(e,t,r,s,m)).catch(e=>m.fail(e).then(()=>{throw e}))}static getExpirationTime(e={}){if(e.hasOwnProperty("expiration_time")){var t,r=e.expiration_time;if("number"==typeof r)t=new Date(1e3*r);else{if("string"!=typeof r)throw new n.Mmbs.Error(n.Mmbs.Error.PUSH_MISCONFIGURED,e.expiration_time+" is not valid time.");t=new Date(r)}if(!isFinite(t))throw new n.Mmbs.Error(n.Mmbs.Error.PUSH_MISCONFIGURED,e.expiration_time+" is not valid time.");return t.valueOf()}}static getExpirationInterval(e={}){if(e.hasOwnProperty("expiration_interval")){var t=e.expiration_interval;if("number"!=typeof t||t<=0)throw new n.Mmbs.Error(n.Mmbs.Error.PUSH_MISCONFIGURED,"expiration_interval must be a number greater than 0");return t}}static getPushTime(e={}){if(e.hasOwnProperty("push_time")){var t,r=e.push_time,s=!0;if("number"==typeof r)t=new Date(1e3*r);else{if("string"!=typeof r)throw new n.Mmbs.Error(n.Mmbs.Error.PUSH_MISCONFIGURED,e.push_time+" is not valid time.");s=!c.pushTimeHasTimezoneComponent(r),t=new Date(r)}if(!isFinite(t))throw new n.Mmbs.Error(n.Mmbs.Error.PUSH_MISCONFIGURED,e.push_time+" is not valid time.");return{date:t,isLocalTime:s}}}static pushTimeHasTimezoneComponent(e){return e.indexOf("Z")===e.length-1||/(.+)([+-])\d\d:\d\d$/.test(e)}static formatPushTime({date:e,isLocalTime:t}){if(t){const t=e.toISOString();return t.substring(0,t.indexOf("Z"))}return e.toISOString()}}t.PushController=c,t.default=c},function(e,t,r){"use strict";function s(e){a.has(e)&&(o.removeListener(e,a.get(e)),a.delete(e))}Object.defineProperty(t,"__esModule",{value:!0}),t.EventEmitterMQ=void 0;var n=function(e){return e&&e.__esModule?e:{default:e}}(r(43));const o=new n.default.EventEmitter,a=new Map;class i{constructor(e){this.emitter=e}publish(e,t){this.emitter.emit(e,t)}}class l extends n.default.EventEmitter{constructor(e){super(),this.emitter=e}subscribe(e){s(e);const t=t=>{this.emit("message",e,t)};a.set(e,t),this.emitter.on(e,t)}unsubscribe(e){s(e)}}const u={createPublisher:function(){return new i(o)},createSubscriber:function(){return new l(o)}};t.EventEmitterMQ=u},function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0});class s{send(e,t,r){}getValidPushTypes(){return[]}}t.PushAdapter=s,t.default=s},function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.GridStoreAdapter=void 0;var s=r(26),n=r(48),o=function(e){return e&&e.__esModule?e:{default:e}}(r(10));class a extends n.FilesAdapter{constructor(e=o.default.DefaultMongoURI){super(),this._databaseURI=e}_connect(){return this._connectionPromise||(this._connectionPromise=s.MongoClient.connect(this._databaseURI)),this._connectionPromise}createFile(e,t){return this._connect().then(t=>{return new s.GridStore(t,e,"w").open()}).then(e=>e.write(t)).then(e=>e.close())}deleteFile(e){return this._connect().then(t=>{return new s.GridStore(t,e,"r").open()}).then(e=>e.unlink()).then(e=>e.close())}getFileData(e){return this._connect().then(t=>s.GridStore.exist(t,e).then(()=>{return new s.GridStore(t,e,"r").open()})).then(e=>e.read())}getFileLocation(e,t){return e.mount+"/files/"+e.applicationId+"/"+encodeURIComponent(t)}getFileStream(e){return this._connect().then(t=>s.GridStore.exist(t,e).then(()=>{return new s.GridStore(t,e,"r").open()}))}}t.GridStoreAdapter=a,t.default=a},function(e,t,r){"use strict";function s(e){return e&&e.__esModule?e:{default:e}}Object.defineProperty(t,"__esModule",{value:!0}),t.MongoStorageAdapter=void 0;var n=s(r(56)),o=s(r(148)),a=r(149),i=r(151),l=s(r(0)),u=s(r(7)),c=s(r(10));const d=r(26),h=d.MongoClient,f=d.ReadPreference,p="_SCHEMA",m=e=>e.connect().then(()=>e.database.collections()).then(t=>t.filter(t=>!t.namespace.match(/\.system\./)&&0==t.collectionName.indexOf(e._collectionPrefix))),_=e=>{let t=function(e,t){var r={};for(var s in e)t.indexOf(s)>=0||Object.prototype.hasOwnProperty.call(e,s)&&(r[s]=e[s]);return r}(e,[]);return delete t.fields._rperm,delete t.fields._wperm,"_User"===t.className&&delete t.fields._hashed_password,t},y=(e,t,r,s)=>{const n={_id:t,objectId:"string",updatedAt:"string",createdAt:"string"};for(const t in e)n[t]=o.default.parseFieldTypeToMongoFieldType(e[t]);return void 0!==r&&(n._metadata=n._metadata||{},r?n._metadata.class_permissions=r:delete n._metadata.class_permissions),s&&"object"==typeof s&&Object.keys(s).length>0&&(n._metadata=n._metadata||{},n._metadata.indexes=s),n};class b{constructor({uri:e=c.default.DefaultMongoURI,collectionPrefix:t="",mongoOptions:r={}}){this._uri=e,this._collectionPrefix=t,this._mongoOptions=r,this._maxTimeMS=r.maxTimeMS,this.canSortOnJoinTables=!0,delete r.maxTimeMS}connect(){if(this.connectionPromise)return this.connectionPromise;const e=(0,a.format)((0,a.parse)(this._uri));return this.connectionPromise=h.connect(e,this._mongoOptions).then(e=>{e?(e.on("error",()=>{delete this.connectionPromise}),e.on("close",()=>{delete this.connectionPromise}),this.database=e):delete this.connectionPromise}).catch(e=>(delete this.connectionPromise,Promise.reject(e))),this.connectionPromise}handleShutdown(){this.database&&this.database.close(!1)}_adaptiveCollection(e){return this.connect().then(()=>this.database.collection(this._collectionPrefix+e)).then(e=>new n.default(e))}_schemaCollection(){return this.connect().then(()=>this._adaptiveCollection(p)).then(e=>new o.default(e))}classExists(e){return this.connect().then(()=>this.database.listCollections({name:this._collectionPrefix+e}).toArray()).then(e=>e.length>0)}setClassLevelPermissions(e,t){return this._schemaCollection().then(r=>r.updateSchema(e,{$set:{"_metadata.class_permissions":t}}))}setIndexesWithSchemaFormat(e,t,r={},s){if(void 0===t)return Promise.resolve();0===Object.keys(r).length&&(r={_id_:{_id:1}});const n=[],o=[];Object.keys(t).forEach(a=>{const i=t[a];if(r[a]&&"Delete"!==i.__op)throw new l.default.Error(l.default.Error.INVALID_QUERY,`Index ${a} exists, cannot update.`);if(!r[a]&&"Delete"===i.__op)throw new l.default.Error(l.default.Error.INVALID_QUERY,`Index ${a} does not exist, cannot delete.`);if("Delete"===i.__op){const t=this.dropIndex(e,a);n.push(t),delete r[a]}else Object.keys(i).forEach(e=>{if(!s.hasOwnProperty(e))throw new l.default.Error(l.default.Error.INVALID_QUERY,`Field ${e} does not exist, cannot add index.`)}),r[a]=i,o.push({key:i,name:a})});let a=Promise.resolve();return o.length>0&&(a=this.createIndexes(e,o)),Promise.all(n).then(()=>a).then(()=>this._schemaCollection()).then(t=>t.updateSchema(e,{$set:{"_metadata.indexes":r}}))}setIndexesFromMongo(e){return this.getIndexes(e).then(t=>(t=t.reduce((e,t)=>{if(t.key._fts){delete t.key._fts,delete t.key._ftsx;for(const e in t.weights)t.key[e]="text"}return e[t.name]=t.key,e},{}),this._schemaCollection().then(r=>r.updateSchema(e,{$set:{"_metadata.indexes":t}})))).catch(()=>Promise.resolve())}createClass(e,t){t=_(t);const r=y(t.fields,e,t.classLevelPermissions,t.indexes);return r._id=e,this.setIndexesWithSchemaFormat(e,t.indexes,{},t.fields).then(()=>this._schemaCollection()).then(e=>e._collection.insertOne(r)).then(e=>o.default._TESTmongoSchemaToMmbsSchema(e.ops[0])).catch(e=>{throw 11e3===e.code?new l.default.Error(l.default.Error.DUPLICATE_VALUE,"Class already exists."):e})}addFieldIfNotExists(e,t,r){return this._schemaCollection().then(s=>s.addFieldIfNotExists(e,t,r)).then(()=>this.createIndexesIfNeeded(e,t,r))}deleteClass(e){return this._adaptiveCollection(e).then(e=>e.drop()).catch(e=>{if("ns not found"!=e.message)throw e}).then(()=>this._schemaCollection()).then(t=>t.findAndDeleteSchema(e))}deleteAllClasses(){return m(this).then(e=>Promise.all(e.map(e=>e.drop())))}deleteFields(e,t,r){const s={$unset:{}};r.map(e=>"Pointer"===t.fields[e].type?`_p_${e}`:e).forEach(e=>{s.$unset[e]=null});const n={$unset:{}};return r.forEach(e=>{n.$unset[e]=null}),this._adaptiveCollection(e).then(e=>e.updateMany({},s)).then(()=>this._schemaCollection()).then(t=>t.updateSchema(e,n))}getAllClasses(){return this._schemaCollection().then(e=>e._fetchAllSchemasFrom_SCHEMA())}getClass(e){return this._schemaCollection().then(t=>t._fetchOneSchemaFrom_SCHEMA(e))}createObject(e,t,r){t=_(t);const s=(0,i.parseObjectToMongoObjectForCreate)(e,r,t);return this._adaptiveCollection(e).then(e=>e.insertOne(s)).catch(e=>{if(11e3===e.code){const t=new l.default.Error(l.default.Error.DUPLICATE_VALUE,"A duplicate value for a field with unique values was provided");if(t.underlyingError=e,e.message){const r=e.message.match(/index:[\sa-zA-Z0-9_\-\.]+\$?([a-zA-Z_-]+)_1/);r&&Array.isArray(r)&&(t.userInfo={duplicated_field:r[1]})}throw t}throw e})}deleteObjectsByQuery(e,t,r){return t=_(t),this._adaptiveCollection(e).then(s=>{const n=(0,i.transformWhere)(e,r,t);return s.deleteMany(n)}).then(({result:e})=>{if(0===e.n)throw new l.default.Error(l.default.Error.OBJECT_NOT_FOUND,"Object not found.");return Promise.resolve()},()=>{throw new l.default.Error(l.default.Error.INTERNAL_SERVER_ERROR,"Database adapter error")})}updateObjectsByQuery(e,t,r,s){t=_(t);const n=(0,i.transformUpdate)(e,s,t),o=(0,i.transformWhere)(e,r,t);return this._adaptiveCollection(e).then(e=>e.updateMany(o,n))}findOneAndUpdate(e,t,r,s){t=_(t);const n=(0,i.transformUpdate)(e,s,t),o=(0,i.transformWhere)(e,r,t);return this._adaptiveCollection(e).then(e=>e._mongoCollection.findAndModify(o,[],n,{new:!0})).then(r=>(0,i.mongoObjectToMmbsObject)(e,r.value,t))}upsertOneObject(e,t,r,s){t=_(t);const n=(0,i.transformUpdate)(e,s,t),o=(0,i.transformWhere)(e,r,t);return this._adaptiveCollection(e).then(e=>e.upsertOne(o,n))}find(e,t,r,{skip:s,limit:n,sort:o,keys:a,readPreference:l}){t=_(t);const c=(0,i.transformWhere)(e,r,t),d=u.default.mapKeys(o,(r,s)=>(0,i.transformKey)(e,s,t)),h=u.default.reduce(a,(r,s)=>(r[(0,i.transformKey)(e,s,t)]=1,r),{});return l=this._parseReadPreference(l),this.createTextIndexesIfNeeded(e,r,t).then(()=>this._adaptiveCollection(e)).then(e=>e.find(c,{skip:s,limit:n,sort:d,keys:h,maxTimeMS:this._maxTimeMS,readPreference:l})).then(r=>r.map(r=>(0,i.mongoObjectToMmbsObject)(e,r,t)))}ensureUniqueness(e,t,r){t=_(t);const s={};return r.map(r=>(0,i.transformKey)(e,r,t)).forEach(e=>{s[e]=1}),this._adaptiveCollection(e).then(e=>e._ensureSparseUniqueIndexInBackground(s)).catch(e=>{if(11e3===e.code)throw new l.default.Error(l.default.Error.DUPLICATE_VALUE,"Tried to ensure field uniqueness for a class that already has duplicates.");throw e})}_rawFind(e,t){return this._adaptiveCollection(e).then(e=>e.find(t,{maxTimeMS:this._maxTimeMS}))}count(e,t,r,s){return t=_(t),s=this._parseReadPreference(s),this._adaptiveCollection(e).then(n=>n.count((0,i.transformWhere)(e,r,t),{maxTimeMS:this._maxTimeMS,readPreference:s}))}distinct(e,t,r,s){return t=_(t),this._adaptiveCollection(e).then(n=>n.distinct(s,(0,i.transformWhere)(e,r,t))).then(r=>r.map(r=>(0,i.mongoObjectToMmbsObject)(e,r,t)))}aggregate(e,t,r,s){return s=this._parseReadPreference(s),this._adaptiveCollection(e).then(e=>e.aggregate(r,{readPreference:s,maxTimeMS:this._maxTimeMS})).then(e=>(e.forEach(e=>{e.hasOwnProperty("_id")&&(e.objectId=e._id,delete e._id)}),e)).then(r=>r.map(r=>(0,i.mongoObjectToMmbsObject)(e,r,t)))}_parseReadPreference(e){if(e)switch(e){case"PRIMARY":e=f.PRIMARY;break;case"PRIMARY_PREFERRED":e=f.PRIMARY_PREFERRED;break;case"SECONDARY":e=f.SECONDARY;break;case"SECONDARY_PREFERRED":e=f.SECONDARY_PREFERRED;break;case"NEAREST":e=f.NEAREST;break;default:throw new l.default.Error(l.default.Error.INVALID_QUERY,"Not supported read preference.")}return e}performInitialization(){return Promise.resolve()}createIndex(e,t){return this._adaptiveCollection(e).then(e=>e._mongoCollection.createIndex(t))}createIndexes(e,t){return this._adaptiveCollection(e).then(e=>e._mongoCollection.createIndexes(t))}createIndexesIfNeeded(e,t,r){if(r&&"Polygon"===r.type){const r={[t]:"2dsphere"};return this.createIndex(e,r)}return Promise.resolve()}createTextIndexesIfNeeded(e,t,r){for(const s in t){if(!t[s]||!t[s].$text)continue;const n=r.indexes;for(const e in n){if(n[e].hasOwnProperty(s))return Promise.resolve()}const o={[`${s}_text`]:{[s]:"text"}};return this.setIndexesWithSchemaFormat(e,o,n,r.fields).catch(t=>{if(85===t.code)return this.setIndexesFromMongo(e);throw t})}return Promise.resolve()}getIndexes(e){return this._adaptiveCollection(e).then(e=>e._mongoCollection.indexes())}dropIndex(e,t){return this._adaptiveCollection(e).then(e=>e._mongoCollection.dropIndex(t))}dropAllIndexes(e){return this._adaptiveCollection(e).then(e=>e._mongoCollection.dropIndexes())}updateSchemaWithIndexes(){return this.getAllClasses().then(e=>{const t=e.map(e=>this.setIndexesFromMongo(e.className));return Promise.all(t)})}}t.MongoStorageAdapter=b,t.default=b,e.exports=b},function(e,t,r){"use strict";function s(e){return e&&e.__esModule?e:{default:e}}function n(e){let t=d,r={};return e._metadata&&(e._metadata.class_permissions&&(t=i({},c,e._metadata.class_permissions)),e._metadata.indexes&&(r=i({},e._metadata.indexes))),{className:e._id,fields:function(e){var t=Object.keys(e).filter(e=>-1===u.indexOf(e)).reduce((t,r)=>(t[r]=function(e){if("*"===e[0])return{type:"Pointer",targetClass:e.slice(1)};if(e.startsWith("relation<"))return{type:"Relation",targetClass:e.slice("relation<".length,e.length-1)};switch(e){case"number":return{type:"Number"};case"string":return{type:"String"};case"boolean":return{type:"Boolean"};case"date":return{type:"Date"};case"map":case"object":return{type:"Object"};case"array":return{type:"Array"};case"geopoint":return{type:"GeoPoint"};case"file":return{type:"File"};case"bytes":return{type:"Bytes"};case"polygon":return{type:"Polygon"}}}(e[r]),t),{});return t.ACL={type:"ACL"},t.createdAt={type:"Date"},t.updatedAt={type:"Date"},t.objectId={type:"String"},t}(e),classLevelPermissions:t,indexes:r}}function o(e,t){const r={_id:e};return t&&Object.keys(t).forEach(e=>{r[e]=t[e]}),r}function a({type:e,targetClass:t}){switch(e){case"Pointer":return`*${t}`;case"Relation":return`relation<${t}>`;case"Number":return"number";case"String":return"string";case"Boolean":return"boolean";case"Date":return"date";case"Object":return"object";case"Array":return"array";case"GeoPoint":return"geopoint";case"File":return"file";case"Bytes":return"bytes";case"Polygon":return"polygon"}}Object.defineProperty(t,"__esModule",{value:!0});var i=Object.assign||function(e){for(var t=1;t<arguments.length;t++){var r=arguments[t];for(var s in r)Object.prototype.hasOwnProperty.call(r,s)&&(e[s]=r[s])}return e},l=(s(r(56)),s(r(0)));const u=["_id","_metadata","_client_permissions"],c=Object.freeze({find:{},get:{},create:{},update:{},delete:{},addField:{}}),d=Object.freeze({find:{"*":!0},get:{"*":!0},create:{"*":!0},update:{"*":!0},delete:{"*":!0},addField:{"*":!0}});class h{constructor(e){this._collection=e}_fetchAllSchemasFrom_SCHEMA(){return this._collection._rawFind({}).then(e=>e.map(n))}_fetchOneSchemaFrom_SCHEMA(e){return this._collection._rawFind(o(e),{limit:1}).then(e=>{if(1===e.length)return n(e[0]);throw void 0})}findAndDeleteSchema(e){return this._collection._mongoCollection.findAndRemove(o(e),[])}updateSchema(e,t){return this._collection.updateOne(o(e),t)}upsertSchema(e,t,r){return this._collection.upsertOne(o(e,t),r)}addFieldIfNotExists(e,t,r){return this._fetchOneSchemaFrom_SCHEMA(e).then(e=>{if(void 0==e.fields[t]&&"GeoPoint"===r.type&&Object.keys(e.fields).some(t=>"GeoPoint"===e.fields[t].type))throw new l.default.Error(l.default.Error.INCORRECT_TYPE,"MongoDB only supports one GeoPoint field in a class.")},e=>{if(void 0!==e)throw e}).then(()=>this.upsertSchema(e,{[t]:{$exists:!1}},{$set:{[t]:a(r)}}))}}h._TESTmongoSchemaToMmbsSchema=n,h.parseFieldTypeToMongoFieldType=a,t.default=h},function(e,t,r){"use strict";function s(){this.protocol=null,this.slashes=null,this.auth=null,this.host=null,this.port=null,this.hostname=null,this.hash=null,this.search=null,this.query=null,this.pathname=null,this.path=null,this.href=null}function n(e,t,r){if(e instanceof s)return e;var n=new s;return n.parse(e,t,r),n}function o(e,t){for(var r=t,s=r+1,n=e.length;s<n;r+=1,s+=1)e[r]=e[s];e.pop()}const a=r(150);t.parse=n,t.resolve=function(e,t){return n(e,!1,!0).resolve(t)},t.resolveObject=function(e,t){return e?n(e,!1,!0).resolveObject(t):t},t.format=function(e){if("string"==typeof e)e=n(e);else{if("object"!=typeof e||null===e)throw new TypeError('Parameter "urlObj" must be an object, not '+e===null?"null":typeof e);if(!(e instanceof s))return s.prototype.format.call(e)}return e.format()},t.Url=s;const i=/^([a-z0-9.+-]+:)/i,l=/:[0-9]*$/,u=/^(\/\/?(?!\/)[^\?\s]*)(\?[^\s]*)?$/,c={javascript:!0,"javascript:":!0},d={javascript:!0,"javascript:":!0},h={http:!0,"http:":!0,https:!0,"https:":!0,ftp:!0,"ftp:":!0,gopher:!0,"gopher:":!0,file:!0,"file:":!0},f=r(16);s.prototype.parse=function(e,t,r){if("string"!=typeof e)throw new TypeError('Parameter "url" must be a string, not '+typeof e);for(var s=!1,n=-1,o=-1,l="",p=0,m=0,_=!1,y=!1;m<e.length;++m){const t=e.charCodeAt(m),r=32===t||9===t||13===t||10===t||12===t||160===t||65279===t;if(-1===n){if(r)continue;p=n=m}else _?r||(o=-1,_=!1):r&&(o=m,_=!0);if(y)s||35!==t||(s=!0);else switch(t){case 35:s=!0;case 63:y=!0;break;case 92:m-p>0&&(l+=e.slice(p,m)),l+="/",p=m+1}}if(-1!==n&&(p===n?l=-1===o?0===n?e:e.slice(n):e.slice(n,o):-1===o&&p<e.length?l+=e.slice(p):-1!==o&&p<o&&(l+=e.slice(p,o))),!r&&!s){const e=u.exec(l);if(e)return this.path=l,this.href=l,this.pathname=e[1],e[2]?(this.search=e[2],this.query=t?f.parse(this.search.slice(1)):this.search.slice(1)):t&&(this.search="",this.query={}),this}var b=i.exec(l);if(b){var g=(b=b[0]).toLowerCase();this.protocol=g,l=l.slice(b.length)}if(r||b||/^\/\/[^@\/]+@[^@\/]+/.test(l)){var v=47===l.charCodeAt(0)&&47===l.charCodeAt(1);!v||b&&d[b]||(l=l.slice(2),this.slashes=!0)}if(!d[b]&&(v||b&&!h[b])){var E=-1,S=-1,w=-1;for(m=0;m<l.length;++m){switch(l.charCodeAt(m)){case 9:case 10:case 13:case 32:case 34:case 37:case 39:case 59:case 60:case 62:case 92:case 94:case 96:case 123:case 124:case 125:-1===w&&(w=m);break;case 35:case 47:case 63:-1===w&&(w=m),E=m;break;case 64:S=m,w=-1}if(-1!==E)break}n=0,-1!==S&&(this.auth=decodeURIComponent(l.slice(0,S)),n=S+1),-1===w?(this.host=l.slice(n),l=""):(this.host=l.slice(n,w),l=l.slice(w)),this.parseHost(),"string"!=typeof this.hostname&&(this.hostname="");var O=this.hostname,I=91===O.charCodeAt(0)&&93===O.charCodeAt(O.length-1);if(!I){const e=function(e,t,r){for(var s,n=0;n<=r.length;++n){var o;if(n<r.length&&(o=r.charCodeAt(n)),46!==o&&n!==r.length){if(!(o>=48&&o<=57||o>=97&&o<=122||45===o||o>=65&&o<=90||43===o||95===o||44===o||58===o||o>127)){if(e.hostname=r.slice(0,n),n<r.length)return"/"+r.slice(n)+t;break}}else{if(n-s>0&&n-s>63)return e.hostname=r.slice(0,s+63),"/"+r.slice(s+63)+t;s=n+1}}}(this,l,O);void 0!==e&&(l=e)}this.hostname.length>255?this.hostname="":this.hostname=this.hostname.toLowerCase(),I||(this.hostname=a.toASCII(this.hostname));var A=this.port?":"+this.port:"",N=this.hostname||"";this.host=N+A,I&&(this.hostname=this.hostname.slice(1,-1),"/"!==l[0]&&(l="/"+l))}if(!c[g]){const e=function(e){for(var t="",r=0,s=0;s<e.length;++s)switch(e.charCodeAt(s)){case 9:s-r>0&&(t+=e.slice(r,s)),t+="%09",r=s+1;break;case 10:s-r>0&&(t+=e.slice(r,s)),t+="%0A",r=s+1;break;case 13:s-r>0&&(t+=e.slice(r,s)),t+="%0D",r=s+1;break;case 32:s-r>0&&(t+=e.slice(r,s)),t+="%20",r=s+1;break;case 34:s-r>0&&(t+=e.slice(r,s)),t+="%22",r=s+1;break;case 39:s-r>0&&(t+=e.slice(r,s)),t+="%27",r=s+1;break;case 60:s-r>0&&(t+=e.slice(r,s)),t+="%3C",r=s+1;break;case 62:s-r>0&&(t+=e.slice(r,s)),t+="%3E",r=s+1;break;case 92:s-r>0&&(t+=e.slice(r,s)),t+="%5C",r=s+1;break;case 94:s-r>0&&(t+=e.slice(r,s)),t+="%5E",r=s+1;break;case 96:s-r>0&&(t+=e.slice(r,s)),t+="%60",r=s+1;break;case 123:s-r>0&&(t+=e.slice(r,s)),t+="%7B",r=s+1;break;case 124:s-r>0&&(t+=e.slice(r,s)),t+="%7C",r=s+1;break;case 125:s-r>0&&(t+=e.slice(r,s)),t+="%7D",r=s+1}if(0!==r)return r<e.length?t+e.slice(r):t}(l);void 0!==e&&(l=e)}var C=-1,P=-1;for(m=0;m<l.length;++m){const e=l.charCodeAt(m);if(35===e){this.hash=l.slice(m),P=m;break}63===e&&-1===C&&(C=m)}-1!==C?(-1===P?(this.search=l.slice(C),this.query=l.slice(C+1)):(this.search=l.slice(C,P),this.query=l.slice(C+1,P)),t&&(this.query=f.parse(this.query))):t&&(this.search="",this.query={});var T=-1!==C&&(-1===P||C<P)?C:P;if(-1===T?l.length>0&&(this.pathname=l):T>0&&(this.pathname=l.slice(0,T)),h[g]&&this.hostname&&!this.pathname&&(this.pathname="/"),this.pathname||this.search){const e=this.pathname||"",t=this.search||"";this.path=e+t}return this.href=this.format(),this},s.prototype.format=function(){var e=this.auth||"";e&&(e=function(e){for(var t="",r=0,s=0;s<e.length;++s){var n=e.charCodeAt(s);if(!(33===n||45===n||46===n||95===n||126===n||n>=39&&n<=42||n>=48&&n<=58||n>=65&&n<=90||n>=97&&n<=122))if(s-r>0&&(t+=e.slice(r,s)),r=s+1,n<128)t+=p[n];else if(n<2048)t+=p[192|n>>6]+p[128|63&n];else if(n<55296||n>=57344)t+=p[224|n>>12]+p[128|n>>6&63]+p[128|63&n];else{var o;o=++s<e.length?1023&e.charCodeAt(s):0,t+=p[240|(n=65536+((1023&n)<<10|o))>>18]+p[128|n>>12&63]+p[128|n>>6&63]+p[128|63&n]}}return 0===r?e:r<e.length?t+e.slice(r):t}(e),e+="@");var t=this.protocol||"",r=this.pathname||"",s=this.hash||"",n=!1,o="";this.host?n=e+this.host:this.hostname&&(n=e+(-1===this.hostname.indexOf(":")?this.hostname:"["+this.hostname+"]"),this.port&&(n+=":"+this.port)),null!==this.query&&"object"==typeof this.query&&(o=f.stringify(this.query));var a=this.search||o&&"?"+o||"";t&&58!==t.charCodeAt(t.length-1)&&(t+=":");for(var i="",l=0,u=0;u<r.length;++u)switch(r.charCodeAt(u)){case 35:u-l>0&&(i+=r.slice(l,u)),i+="%23",l=u+1;break;case 63:u-l>0&&(i+=r.slice(l,u)),i+="%3F",l=u+1}return l>0&&(r=l!==r.length?i+r.slice(l):i),this.slashes||(!t||h[t])&&!1!==n?(n="//"+(n||""),r&&47!==r.charCodeAt(0)&&(r="/"+r)):n||(n=""),a=a.replace("#","%23"),s&&35!==s.charCodeAt(0)&&(s="#"+s),a&&63!==a.charCodeAt(0)&&(a="?"+a),t+n+r+a+s},s.prototype.resolve=function(e){return this.resolveObject(n(e,!1,!0)).format()},s.prototype.resolveObject=function(e){if("string"==typeof e){var t=new s;t.parse(e,!1,!0),e=t}for(var r=new s,n=Object.keys(this),a=0;a<n.length;a++){var i=n[a];r[i]=this[i]}if(r.hash=e.hash,""===e.href)return r.href=r.format(),r;if(e.slashes&&!e.protocol){for(var l=Object.keys(e),u=0;u<l.length;u++){var c=l[u];"protocol"!==c&&(r[c]=e[c])}return h[r.protocol]&&r.hostname&&!r.pathname&&(r.path=r.pathname="/"),r.href=r.format(),r}if(e.protocol&&e.protocol!==r.protocol){if(!h[e.protocol]){for(var f=Object.keys(e),p=0;p<f.length;p++){var m=f[p];r[m]=e[m]}return r.href=r.format(),r}if(r.protocol=e.protocol,e.host||/^file:?$/.test(e.protocol)||d[e.protocol])r.pathname=e.pathname;else{const t=(e.pathname||"").split("/");for(;t.length&&!(e.host=t.shift()););e.host||(e.host=""),e.hostname||(e.hostname=""),""!==t[0]&&t.unshift(""),t.length<2&&t.unshift(""),r.pathname=t.join("/")}if(r.search=e.search,r.query=e.query,r.host=e.host||"",r.auth=e.auth,r.hostname=e.hostname||e.host,r.port=e.port,r.pathname||r.search){var _=r.pathname||"",y=r.search||"";r.path=_+y}return r.slashes=r.slashes||e.slashes,r.href=r.format(),r}var b=r.pathname&&"/"===r.pathname.charAt(0),g=e.host||e.pathname&&"/"===e.pathname.charAt(0),v=g||b||r.host&&e.pathname,E=v,S=r.pathname&&r.pathname.split("/")||[],w=e.pathname&&e.pathname.split("/")||[],O=r.protocol&&!h[r.protocol];if(O&&(r.hostname="",r.port=null,r.host&&(""===S[0]?S[0]=r.host:S.unshift(r.host)),r.host="",e.protocol&&(e.hostname=null,e.port=null,e.host&&(""===w[0]?w[0]=e.host:w.unshift(e.host)),e.host=null),v=v&&(""===w[0]||""===S[0])),g)r.host=e.host||""===e.host?e.host:r.host,r.hostname=e.hostname||""===e.hostname?e.hostname:r.hostname,r.search=e.search,r.query=e.query,S=w;else if(w.length)S||(S=[]),S.pop(),S=S.concat(w),r.search=e.search,r.query=e.query;else if(null!==e.search&&void 0!==e.search){if(O){r.hostname=r.host=S.shift();const e=!!(r.host&&r.host.indexOf("@")>0)&&r.host.split("@");e&&(r.auth=e.shift(),r.host=r.hostname=e.shift())}return r.search=e.search,r.query=e.query,null===r.pathname&&null===r.search||(r.path=(r.pathname?r.pathname:"")+(r.search?r.search:"")),r.href=r.format(),r}if(!S.length)return r.pathname=null,r.search?r.path="/"+r.search:r.path=null,r.href=r.format(),r;for(var I=S.slice(-1)[0],A=(r.host||e.host||S.length>1)&&("."===I||".."===I)||""===I,N=0,C=S.length;C>=0;C--)"."===(I=S[C])?o(S,C):".."===I?(o(S,C),N++):N&&(o(S,C),N--);if(!v&&!E)for(;N--;N)S.unshift("..");!v||""===S[0]||S[0]&&"/"===S[0].charAt(0)||S.unshift(""),A&&"/"!==S.join("/").substr(-1)&&S.push("");var P=""===S[0]||S[0]&&"/"===S[0].charAt(0);if(O){r.hostname=r.host=P?"":S.length?S.shift():"";const e=!!(r.host&&r.host.indexOf("@")>0)&&r.host.split("@");e&&(r.auth=e.shift(),r.host=r.hostname=e.shift())}return(v=v||r.host&&S.length)&&!P&&S.unshift(""),S.length?r.pathname=S.join("/"):(r.pathname=null,r.path=null),null===r.pathname&&null===r.search||(r.path=(r.pathname?r.pathname:"")+(r.search?r.search:"")),r.auth=e.auth||r.auth,r.slashes=r.slashes||e.slashes,r.href=r.format(),r},s.prototype.parseHost=function(){var e=this.host,t=l.exec(e);t&&(":"!==(t=t[0])&&(this.port=t.slice(1)),e=e.slice(0,e.length-t.length)),e&&(this.hostname=e)};for(var p=new Array(256),m=0;m<256;++m)p[m]="%"+((m<16?"0":"")+m.toString(16)).toUpperCase()},function(e,t){e.exports=__webpack_require__(37)},function(e,t,r){"use strict";function s(e){return e&&e.__esModule?e:{default:e}}function n(e,t,r,s){switch(t){case"createdAt":if(g(r))return{key:"_created_at",value:g(r)};t="_created_at";break;case"updatedAt":if(g(r))return{key:"_updated_at",value:g(r)};t="_updated_at";break;case"expiresAt":if(g(r))return{key:"expiresAt",value:g(r)};break;case"_email_verify_token_expires_at":if(g(r))return{key:"_email_verify_token_expires_at",value:g(r)};break;case"objectId":return"_GlobalConfig"===e&&(r=parseInt(r)),{key:"_id",value:r};case"_account_lockout_expires_at":if(g(r))return{key:"_account_lockout_expires_at",value:g(r)};break;case"_failed_login_count":return{key:t,value:r};case"sessionToken":return{key:"_session_token",value:r};case"_perishable_token_expires_at":if(g(r))return{key:"_perishable_token_expires_at",value:g(r)};break;case"_password_changed_at":if(g(r))return{key:"_password_changed_at",value:g(r)};break;case"_rperm":case"_wperm":case"_perishable_token":case"_email_verify_token":return{key:t,value:r};case"$or":return{key:"$or",value:r.map(t=>o(e,t,s))};case"$and":return{key:"$and",value:r.map(t=>o(e,t,s))};case"lastUsed":if(g(r))return{key:"_last_used",value:g(r)};t="_last_used";break;case"timesUsed":return{key:"times_used",value:r};default:{const e=t.match(/^authData\.([a-zA-Z0-9_]+)\.id$/);if(e){return{key:`_auth_data_${e[1]}.id`,value:r}}}}const n=s&&s.fields[t]&&"Array"===s.fields[t].type,l=s&&s.fields[t]&&"Pointer"===s.fields[t].type,c=s&&s.fields[t];(l||!s&&r&&"Pointer"===r.__type)&&(t="_p_"+t);const d=u(r,c);if(d!==a)return d.$text?{key:"$text",value:d.$text}:{key:t,value:d};if(n&&!(r instanceof Array))return{key:t,value:{$all:[S(r)]}};if(i(r)!==a)return{key:t,value:i(r)};throw new _.Error(_.Error.INVALID_JSON,`You cannot use ${r} as a query parameter.`)}function o(e,t,r){const s={};for(const o in t){const a=n(e,o,t[o],r);s[a.key]=a.value}return s}function a(){}function i(e,t){switch(typeof e){case"number":case"boolean":case"undefined":return e;case"string":return t&&"Pointer"===t.type?`${t.targetClass}$${e}`:e;case"symbol":case"function":throw new _.Error(_.Error.INVALID_JSON,`cannot transform value: ${e}`);case"object":return e instanceof Date?e:null===e?e:"Pointer"==e.__type?`${e.className}$${e.objectId}`:O.isValidJSON(e)?O.JSONToDatabase(e):I.isValidJSON(e)?I.JSONToDatabase(e):A.isValidJSON(e)?A.JSONToDatabase(e):N.isValidJSON(e)?N.JSONToDatabase(e):C.isValidJSON(e)?C.JSONToDatabase(e):a;default:throw new _.Error(_.Error.INTERNAL_SERVER_ERROR,`really did not expect value: ${e}`)}}function l(e,t=new Date){let r=(e=e.toLowerCase()).split(" ");const s="in"===(r=r.filter(e=>""!==e))[0],n="ago"===r[r.length-1];if(!s&&!n&&"now"!==e)return{status:"error",info:"Time should either start with 'in' or end with 'ago'"};if(s&&n)return{status:"error",info:"Time cannot have both 'in' and 'ago'"};if((r=s?r.slice(1):r.slice(0,r.length-1)).length%2!=0&&"now"!==e)return{status:"error",info:"Invalid time string. Dangling unit or number."};const o=[];for(;r.length;)o.push([r.shift(),r.shift()]);let a=0;for(const[e,t]of o){const r=Number(e);if(!Number.isInteger(r))return{status:"error",info:`'${e}' is not an integer.`};switch(t){case"yr":case"yrs":case"year":case"years":a+=31536e3*r;break;case"wk":case"wks":case"week":case"weeks":a+=604800*r;break;case"d":case"day":case"days":a+=86400*r;break;case"hr":case"hrs":case"hour":case"hours":a+=3600*r;break;case"min":case"mins":case"minute":case"minutes":a+=60*r;break;case"sec":case"secs":case"second":case"seconds":a+=r;break;default:return{status:"error",info:`Invalid interval: '${t}'`}}}const i=1e3*a;return s?{status:"success",info:"future",result:new Date(t.valueOf()+i)}:n?{status:"success",info:"past",result:new Date(t.valueOf()-i)}:{status:"success",info:"present",result:new Date(t.valueOf())}}function u(e,t){const r=t&&t.type&&"Array"===t.type;if("object"!=typeof e||!e)return a;const s=r?S:i,n=e=>{const r=s(e,t);if(r===a)throw new _.Error(_.Error.INVALID_JSON,`bad atom: ${JSON.stringify(e)}`);return r};var o=Object.keys(e).sort().reverse(),u={};for(var c of o)switch(c){case"$lt":case"$lte":case"$gt":case"$gte":case"$exists":case"$ne":case"$eq":{const r=e[c];if(r&&"object"==typeof r&&r.$relativeTime){if(t&&"Date"!==t.type)throw new _.Error(_.Error.INVALID_JSON,"$relativeTime can only be used with Date field");switch(c){case"$exists":case"$ne":case"$eq":throw new _.Error(_.Error.INVALID_JSON,"$relativeTime can only be used with the $lt, $lte, $gt, and $gte operators")}const e=l(r.$relativeTime);if("success"===e.status){u[c]=e.result;break}throw f.default.info("Error while parsing relative date",e),new _.Error(_.Error.INVALID_JSON,`bad $relativeTime (${c}) value. ${e.info}`)}u[c]=n(r);break}case"$in":case"$nin":{const t=e[c];if(!(t instanceof Array))throw new _.Error(_.Error.INVALID_JSON,"bad "+c+" value");u[c]=p.default.flatMap(t,e=>(t=>Array.isArray(t)?e.map(n):n(t))(e));break}case"$all":{const t=e[c];if(!(t instanceof Array))throw new _.Error(_.Error.INVALID_JSON,"bad "+c+" value");u[c]=t.map(S);break}case"$regex":var d=e[c];if("string"!=typeof d)throw new _.Error(_.Error.INVALID_JSON,"bad regex: "+d);u[c]=d;break;case"$options":u[c]=e[c];break;case"$text":{const t=e[c].$search;if("object"!=typeof t)throw new _.Error(_.Error.INVALID_JSON,"bad $text: $search, should be object");if(!t.$term||"string"!=typeof t.$term)throw new _.Error(_.Error.INVALID_JSON,"bad $text: $term, should be string");if(u[c]={$search:t.$term},t.$language&&"string"!=typeof t.$language)throw new _.Error(_.Error.INVALID_JSON,"bad $text: $language, should be string");if(t.$language&&(u[c].$language=t.$language),t.$caseSensitive&&"boolean"!=typeof t.$caseSensitive)throw new _.Error(_.Error.INVALID_JSON,"bad $text: $caseSensitive, should be boolean");if(t.$caseSensitive&&(u[c].$caseSensitive=t.$caseSensitive),t.$diacriticSensitive&&"boolean"!=typeof t.$diacriticSensitive)throw new _.Error(_.Error.INVALID_JSON,"bad $text: $diacriticSensitive, should be boolean");t.$diacriticSensitive&&(u[c].$diacriticSensitive=t.$diacriticSensitive);break}case"$nearSphere":var h=e[c];u[c]=[h.longitude,h.latitude];break;case"$maxDistance":u[c]=e[c];break;case"$maxDistanceInRadians":u.$maxDistance=e[c];break;case"$maxDistanceInMiles":u.$maxDistance=e[c]/3959;break;case"$maxDistanceInKilometers":u.$maxDistance=e[c]/6371;break;case"$select":case"$dontSelect":throw new _.Error(_.Error.COMMAND_UNAVAILABLE,"the "+c+" constraint is not supported yet");case"$within":var m=e[c].$box;if(!m||2!=m.length)throw new _.Error(_.Error.INVALID_JSON,"malformatted $within arg");u[c]={$box:[[m[0].longitude,m[0].latitude],[m[1].longitude,m[1].latitude]]};break;case"$geoWithin":{const t=e[c].$polygon;if(!(t instanceof Array))throw new _.Error(_.Error.INVALID_JSON,"bad $geoWithin value; $polygon should contain at least 3 GeoPoints");if(t.length<3)throw new _.Error(_.Error.INVALID_JSON,"bad $geoWithin value; $polygon should contain at least 3 GeoPoints");const r=t.map(e=>{if(!A.isValidJSON(e))throw new _.Error(_.Error.INVALID_JSON,"bad $geoWithin value");return _.GeoPoint._validate(e.latitude,e.longitude),[e.longitude,e.latitude]});u[c]={$polygon:r};break}case"$geoIntersects":{const t=e[c].$point;if(!A.isValidJSON(t))throw new _.Error(_.Error.INVALID_JSON,"bad $geoIntersect value; $point should be GeoPoint");_.GeoPoint._validate(t.latitude,t.longitude),u[c]={$geometry:{type:"Point",coordinates:[t.longitude,t.latitude]}};break}default:if(c.match(/^\$+/))throw new _.Error(_.Error.INVALID_JSON,"bad constraint: "+c);return a}return u}function c({__op:e,amount:t,objects:r},s){switch(e){case"Delete":return s?void 0:{__op:"$unset",arg:""};case"Increment":if("number"!=typeof t)throw new _.Error(_.Error.INVALID_JSON,"incrementing must provide a number");return s?t:{__op:"$inc",arg:t};case"Add":case"AddUnique":if(!(r instanceof Array))throw new _.Error(_.Error.INVALID_JSON,"objects to add must be an array");var n=r.map(S);if(s)return n;return{__op:{Add:"$push",AddUnique:"$addToSet"}[e],arg:{$each:n}};case"Remove":if(!(r instanceof Array))throw new _.Error(_.Error.INVALID_JSON,"objects to remove must be an array");var o=r.map(S);return s?[]:{__op:"$pullAll",arg:o};default:throw new _.Error(_.Error.COMMAND_UNAVAILABLE,`The ${e} operator is not supported yet.`)}}function d(e,t){const r={};return Object.keys(e).forEach(s=>{r[s]=t(e[s])}),r}var h=Object.assign||function(e){for(var t=1;t<arguments.length;t++){var r=arguments[t];for(var s in r)Object.prototype.hasOwnProperty.call(r,s)&&(e[s]=r[s])}return e},f=s(r(1)),p=s(r(7)),m=r(26),_=r(0).Mmbs;const y=(e,t,r,s)=>{var n=t,o=!1;switch(n){case"objectId":case"_id":if("_GlobalConfig"===e)return{key:n,value:parseInt(r)};n="_id";break;case"createdAt":case"_created_at":n="_created_at",o=!0;break;case"updatedAt":case"_updated_at":n="_updated_at",o=!0;break;case"sessionToken":case"_session_token":n="_session_token";break;case"expiresAt":case"_expiresAt":n="expiresAt",o=!0;break;case"_email_verify_token_expires_at":n="_email_verify_token_expires_at",o=!0;break;case"_account_lockout_expires_at":n="_account_lockout_expires_at",o=!0;break;case"_failed_login_count":n="_failed_login_count";break;case"_perishable_token_expires_at":n="_perishable_token_expires_at",o=!0;break;case"_password_changed_at":n="_password_changed_at",o=!0;break;case"_rperm":case"_wperm":return{key:n,value:r};case"lastUsed":case"_last_used":n="_last_used",o=!0;break;case"timesUsed":case"times_used":n="times_used",o=!0}(s.fields[n]&&"Pointer"===s.fields[n].type||!s.fields[n]&&r&&"Pointer"==r.__type)&&(n="_p_"+n);var l=i(r);return l!==a?(o&&"string"==typeof l&&(l=new Date(l)),t.indexOf(".")>0?{key:n,value:r}:{key:n,value:l}):r instanceof Array?(l=r.map(b),{key:n,value:l}):"object"==typeof r&&"__op"in r?{key:n,value:c(r,!1)}:(l=d(r,b),{key:n,value:l})},b=e=>{if(null!==e&&"object"==typeof e&&Object.keys(e).some(e=>e.includes("$")||e.includes(".")))throw new _.Error(_.Error.INVALID_NESTED_KEY,"Nested keys should not contain the '$' or '.' characters");var t=S(e);return t!==a?t:e instanceof Array?e.map(b):"object"==typeof e&&"__op"in e?c(e,!0):d(e,b)},g=e=>"string"==typeof e?new Date(e):e instanceof Date&&e,v=(e,t,r)=>{let s,n;switch(e){case"objectId":return{key:"_id",value:t};case"expiresAt":return s=i(t),n="string"==typeof s?new Date(s):s,{key:"expiresAt",value:n};case"_email_verify_token_expires_at":return s=i(t),n="string"==typeof s?new Date(s):s,{key:"_email_verify_token_expires_at",value:n};case"_account_lockout_expires_at":return s=i(t),n="string"==typeof s?new Date(s):s,{key:"_account_lockout_expires_at",value:n};case"_perishable_token_expires_at":return s=i(t),n="string"==typeof s?new Date(s):s,{key:"_perishable_token_expires_at",value:n};case"_password_changed_at":return s=i(t),n="string"==typeof s?new Date(s):s,{key:"_password_changed_at",value:n};case"_failed_login_count":case"_rperm":case"_wperm":case"_email_verify_token":case"_hashed_password":case"_perishable_token":return{key:e,value:t};case"sessionToken":return{key:"_session_token",value:t};default:if(e.match(/^authData\.([a-zA-Z0-9_]+)\.id$/))throw new _.Error(_.Error.INVALID_KEY_NAME,"can only query on "+e);if(e.match(/^_auth_data_[a-zA-Z0-9_]+$/))return{key:e,value:t}}t&&"Bytes"!==t.__type&&(r.fields[e]&&"Pointer"==r.fields[e].type||"Pointer"==t.__type)&&(e="_p_"+e);var o=i(t);if(o!==a)return{key:e,value:o};if("ACL"===e)throw"There was a problem transforming an ACL.";if(t instanceof Array)return o=t.map(b),{key:e,value:o};if(Object.keys(t).some(e=>e.includes("$")||e.includes(".")))throw new _.Error(_.Error.INVALID_NESTED_KEY,"Nested keys should not contain the '$' or '.' characters");return o=d(t,b),{key:e,value:o}},E=e=>{const t=h({},e),r={};return e._wperm&&(e._wperm.forEach(e=>{r[e]={w:!0}}),t._acl=r),e._rperm&&(e._rperm.forEach(e=>{e in r?r[e].r=!0:r[e]={r:!0}}),t._acl=r),t},S=e=>{if("object"!=typeof e||!e||e instanceof Date||"Pointer"!==e.__type){if("function"==typeof e||"symbol"==typeof e)throw new _.Error(_.Error.INVALID_JSON,`cannot transform value: ${e}`);return O.isValidJSON(e)?O.JSONToDatabase(e):I.isValidJSON(e)?I.JSONToDatabase(e):e}return{__type:"Pointer",className:e.className,objectId:e.objectId}},w=e=>{switch(typeof e){case"string":case"number":case"boolean":return e;case"undefined":case"symbol":case"function":throw"bad value in mongoObjectToMmbsObject";case"object":return null===e?null:e instanceof Array?e.map(w):e instanceof Date?_._encode(e):e instanceof m.Long?e.toNumber():e instanceof m.Double?e.value:I.isValidDatabaseObject(e)?I.databaseToJSON(e):e.hasOwnProperty("__type")&&"Date"==e.__type&&e.iso instanceof Date?(e.iso=e.iso.toJSON(),e):d(e,w);default:throw"unknown js type"}};var O={JSONToDatabase:e=>new Date(e.iso),isValidJSON:e=>"object"==typeof e&&null!==e&&"Date"===e.__type},I={base64Pattern:new RegExp("^(?:[A-Za-z0-9+/]{4})*(?:[A-Za-z0-9+/]{2}==|[A-Za-z0-9+/]{3}=)?$"),isBase64Value(e){return"string"==typeof e&&this.base64Pattern.test(e)},databaseToJSON(e){let t;return t=this.isBase64Value(e)?e:e.buffer.toString("base64"),{__type:"Bytes",base64:t}},isValidDatabaseObject(e){return e instanceof m.Binary||this.isBase64Value(e)},JSONToDatabase:e=>new m.Binary(new Buffer(e.base64,"base64")),isValidJSON:e=>"object"==typeof e&&null!==e&&"Bytes"===e.__type},A={databaseToJSON:e=>({__type:"GeoPoint",latitude:e[1],longitude:e[0]}),isValidDatabaseObject:e=>e instanceof Array&&2==e.length,JSONToDatabase:e=>[e.longitude,e.latitude],isValidJSON:e=>"object"==typeof e&&null!==e&&"GeoPoint"===e.__type},N={databaseToJSON:e=>({__type:"Polygon",coordinates:e.coordinates[0]}),isValidDatabaseObject(e){const t=e.coordinates[0];if("Polygon"!==e.type||!(t instanceof Array))return!1;for(let e=0;e<t.length;e++){const r=t[e];if(!A.isValidDatabaseObject(r))return!1;_.GeoPoint._validate(parseFloat(r[1]),parseFloat(r[0]))}return!0},JSONToDatabase(e){const t=e.coordinates;t[0][0]===t[t.length-1][0]&&t[0][1]===t[t.length-1][1]||t.push(t[0]);if(t.filter((e,t,r)=>{let s=-1;for(let t=0;t<r.length;t+=1){const n=r[t];if(n[0]===e[0]&&n[1]===e[1]){s=t;break}}return s===t}).length<3)throw new _.Error(_.Error.INTERNAL_SERVER_ERROR,"GeoJSON: Loop must have at least 3 different vertices");return{type:"Polygon",coordinates:[t]}},isValidJSON:e=>"object"==typeof e&&null!==e&&"Polygon"===e.__type},C={databaseToJSON:e=>({__type:"File",name:e}),isValidDatabaseObject:e=>"string"==typeof e,JSONToDatabase:e=>e.name,isValidJSON:e=>"object"==typeof e&&null!==e&&"File"===e.__type};e.exports={transformKey:(e,t,r)=>{switch(t){case"objectId":return"_id";case"createdAt":return"_created_at";case"updatedAt":return"_updated_at";case"sessionToken":return"_session_token";case"lastUsed":return"_last_used";case"timesUsed":return"times_used"}return r.fields[t]&&"Pointer"==r.fields[t].__type?t="_p_"+t:r.fields[t]&&"Pointer"==r.fields[t].type&&(t="_p_"+t),t},parseObjectToMongoObjectForCreate:(e,t,r)=>{t=E(t);const s={};for(const e in t){if(t[e]&&"Relation"===t[e].__type)continue;const{key:n,value:o}=v(e,t[e],r);void 0!==o&&(s[n]=o)}return s.createdAt&&(s._created_at=new Date(s.createdAt.iso||s.createdAt),delete s.createdAt),s.updatedAt&&(s._updated_at=new Date(s.updatedAt.iso||s.updatedAt),delete s.updatedAt),s},transformUpdate:(e,t,r)=>{const s={},n=E(t);(n._rperm||n._wperm||n._acl)&&(s.$set={},n._rperm&&(s.$set._rperm=n._rperm),n._wperm&&(s.$set._wperm=n._wperm),n._acl&&(s.$set._acl=n._acl));for(var o in t)if(!t[o]||"Relation"!==t[o].__type){var a=y(e,o,t[o],r);"object"==typeof a.value&&null!==a.value&&a.value.__op?(s[a.value.__op]=s[a.value.__op]||{},s[a.value.__op][a.key]=a.value.arg):(s.$set=s.$set||{},s.$set[a.key]=a.value)}return s},transformWhere:o,mongoObjectToMmbsObject:(e,t,r)=>{switch(typeof t){case"string":case"number":case"boolean":return t;case"undefined":case"symbol":case"function":throw"bad value in mongoObjectToMmbsObject";case"object":{if(null===t)return null;if(t instanceof Array)return t.map(w);if(t instanceof Date)return _._encode(t);if(t instanceof m.Long)return t.toNumber();if(t instanceof m.Double)return t.value;if(I.isValidDatabaseObject(t))return I.databaseToJSON(t);const u={};(t._rperm||t._wperm)&&(u._rperm=t._rperm||[],u._wperm=t._wperm||[],delete t._rperm,delete t._wperm);for(var s in t)switch(s){case"_id":u.objectId=""+t[s];break;case"_hashed_password":u._hashed_password=t[s];break;case"_acl":break;case"_email_verify_token":case"_perishable_token":case"_perishable_token_expires_at":case"_password_changed_at":case"_tombstone":case"_email_verify_token_expires_at":case"_account_lockout_expires_at":case"_failed_login_count":case"_password_history":u[s]=t[s];break;case"_session_token":u.sessionToken=t[s];break;case"updatedAt":case"_updated_at":u.updatedAt=_._encode(new Date(t[s])).iso;break;case"createdAt":case"_created_at":u.createdAt=_._encode(new Date(t[s])).iso;break;case"expiresAt":case"_expiresAt":u.expiresAt=_._encode(new Date(t[s]));break;case"lastUsed":case"_last_used":u.lastUsed=_._encode(new Date(t[s])).iso;break;case"timesUsed":case"times_used":u.timesUsed=t[s];break;default:var n=s.match(/^_auth_data_([a-zA-Z0-9_]+)$/);if(n){var o=n[1];u.authData=u.authData||{},u.authData[o]=t[s];break}if(0==s.indexOf("_p_")){var a=s.substring(3);if(!r.fields[a]){f.default.info("transform.js","Found a pointer column not in the schema, dropping it.",e,a);break}if("Pointer"!==r.fields[a].type){f.default.info("transform.js","Found a pointer in a non-pointer column, dropping it.",e,s);break}if(null===t[s])break;var i=t[s].split("$");if(i[0]!==r.fields[a].targetClass)throw"pointer to incorrect className";u[a]={__type:"Pointer",className:i[0],objectId:i[1]};break}if("_"==s[0]&&"__type"!=s)throw"bad key in untransform: "+s;var l=t[s];if(r.fields[s]&&"File"===r.fields[s].type&&C.isValidDatabaseObject(l)){u[s]=C.databaseToJSON(l);break}if(r.fields[s]&&"GeoPoint"===r.fields[s].type&&A.isValidDatabaseObject(l)){u[s]=A.databaseToJSON(l);break}if(r.fields[s]&&"Polygon"===r.fields[s].type&&N.isValidDatabaseObject(l)){u[s]=N.databaseToJSON(l);break}if(r.fields[s]&&"Bytes"===r.fields[s].type&&I.isValidDatabaseObject(l)){u[s]=I.databaseToJSON(l);break}u[s]=w(t[s])}const c={};return Object.keys(r.fields).filter(e=>"Relation"===r.fields[e].type).forEach(e=>{c[e]={__type:"Relation",className:r.fields[e].targetClass}}),h({},u,c)}default:throw"unknown js type"}},relativeTimeToDate:l,transformConstraint:u}},function(e,t,r){"use strict";function s(e){return e&&e.__esModule?e:{default:e}}function n(e){if(e.length<3)throw new u.default.Error(u.default.Error.INVALID_JSON,"Polygon must have at least 3 values");e[0][0]===e[e.length-1][0]&&e[0][1]===e[e.length-1][1]||e.push(e[0]);if(e.filter((e,t,r)=>{let s=-1;for(let t=0;t<r.length;t+=1){const n=r[t];if(n[0]===e[0]&&n[1]===e[1]){s=t;break}}return s===t}).length<3)throw new u.default.Error(u.default.Error.INTERNAL_SERVER_ERROR,"GeoJSON: Loop must have at least 3 different vertices");return`(${e.map(e=>(u.default.GeoPoint._validate(parseFloat(e[1]),parseFloat(e[0])),`(${e[1]}, ${e[0]})`)).join(", ")})`}function o(e){return e.split("").map(e=>null!==e.match(/[0-9a-zA-Z]/)?e:"'"===e?"''":`\\${e}`).join("")}function a(e){const t=e.match(/\\Q((?!\\E).*)\\E$/);if(t&&t.length>1&&t.index>-1){const r=e.substr(0,t.index),s=t[1];return a(r)+o(s)}const r=e.match(/\\Q((?!\\E).*)$/);if(r&&r.length>1&&r.index>-1){const t=e.substr(0,r.index),s=r[1];return a(t)+o(s)}return e.replace(/([^\\])(\\E)/,"$1").replace(/([^\\])(\\Q)/,"$1").replace(/^\\E/,"").replace(/^\\Q/,"").replace(/([^'])'/,"$1''").replace(/^'([^'])/,"''$1")}Object.defineProperty(t,"__esModule",{value:!0}),t.PostgresStorageAdapter=void 0;var i=Object.assign||function(e){for(var t=1;t<arguments.length;t++){var r=arguments[t];for(var s in r)Object.prototype.hasOwnProperty.call(r,s)&&(e[s]=r[s])}return e},l=r(153),u=s(r(0)),c=s(r(7)),d=s(r(155));const h="42P01",f="42P07",p="42701",m="42710",_="23505",y="25P02",b=r(1),g=function(){let e=[...arguments];e=["PG: "+arguments[0]].concat(e.slice(1,e.length));const t=b.getLogger();t.debug.apply(t,e)},v=e=>{switch(e.type){case"String":return"text";case"Date":return"timestamp with time zone";case"Object":return"jsonb";case"File":return"text";case"Boolean":return"boolean";case"Pointer":return"char(10)";case"Number":return"double precision";case"GeoPoint":return"point";case"Bytes":return"jsonb";case"Polygon":return"polygon";case"Array":return e.contents&&"String"===e.contents.type?"text[]":"jsonb";default:throw`no type for ${JSON.stringify(e)} yet`}},E={$gt:">",$lt:"<",$gte:">=",$lte:"<=",$ne:"!="},S=e=>{if("object"==typeof e){if("Date"===e.__type)return e.iso;if("File"===e.__type)return e.name}return e},w=e=>"object"==typeof e&&"Pointer"===e.__type?e.objectId:e,O=Object.freeze({find:{},get:{},create:{},update:{},delete:{},addField:{}}),I=Object.freeze({find:{"*":!0},get:{"*":!0},create:{"*":!0},update:{"*":!0},delete:{"*":!0},addField:{"*":!0}}),A=e=>{"_User"===e.className&&delete e.fields._hashed_password,e.fields&&(delete e.fields._wperm,delete e.fields._rperm);let t=I;e.classLevelPermissions&&(t=i({},O,e.classLevelPermissions));let r={};return e.indexes&&(r=i({},e.indexes)),{className:e.className,fields:e.fields,classLevelPermissions:t,indexes:r}},N=e=>e?(e.fields=e.fields||{},e.fields._wperm={type:"Array",contents:{type:"String"}},e.fields._rperm={type:"Array",contents:{type:"String"}},"_User"===e.className&&(e.fields._hashed_password={type:"String"},e.fields._password_history={type:"Array"}),e):e,C=e=>(Object.keys(e).forEach(t=>{if(t.indexOf(".")>-1){const r=t.split("."),s=r.shift();e[s]=e[s]||{};let n,o=e[s],a=e[t];for(a&&"Delete"===a.__op&&(a=void 0);n=r.shift();)o[n]=o[n]||{},0===r.length&&(o[n]=a),o=o[n];delete e[t]}}),e),P=e=>e.split(".").map((e,t)=>0===t?`"${e}"`:`'${e}'`),T=e=>{if(-1===e.indexOf("."))return`"${e}"`;const t=P(e);let r=t.slice(0,t.length-1).join("->");return r+="->>"+t[t.length-1]},R=e=>e.substr(1),$=e=>{if("object"==typeof e)for(const t in e)if("object"==typeof e[t]&&$(e[t]),t.includes("$")||t.includes("."))throw new u.default.Error(u.default.Error.INVALID_NESTED_KEY,"Nested keys should not contain the '$' or '.' characters")},j=e=>{const t=[];return e&&Object.keys(e.fields).forEach(r=>{"Relation"===e.fields[r].type&&t.push(`_Join:${r}:${e.className}`)}),t},k=({schema:e,query:t,index:r})=>{const s=[];let o=[];const i=[];e=N(e);for(const d in t){const h=e.fields&&e.fields[d]&&"Array"===e.fields[d].type,f=s.length,p=t[d];if(!e.fields[d]&&p&&!1===p.$exists)continue;if(d.indexOf(".")>=0){let e=T(d);if(null===p)s.push(`${e} IS NULL`);else if(p.$in){const t=[];e=P(d).join("->"),p.$in.forEach(e=>{"string"==typeof e?t.push(`"${e}"`):t.push(`${e}`)}),s.push(`(${e})::jsonb @> '[${t.join(",")}]'::jsonb`)}else p.$regex||s.push(`${e} = '${p}'`)}else{if(null===p||void 0===p){s.push(`$${r}:name IS NULL`),o.push(d),r+=1;continue}if("string"==typeof p)s.push(`$${r}:name = $${r+1}`),o.push(d,p),r+=2;else if("boolean"==typeof p)s.push(`$${r}:name = $${r+1}`),o.push(d,p),r+=2;else if("number"==typeof p)s.push(`$${r}:name = $${r+1}`),o.push(d,p),r+=2;else if("$or"===d||"$and"===d){const t=[],n=[];p.forEach(s=>{const o=k({schema:e,query:s,index:r});o.pattern.length>0&&(t.push(o.pattern),n.push(...o.values),r+=o.values.length)});const a="$or"===d?" OR ":" AND ";s.push(`(${t.join(a)})`),o.push(...n)}}if(void 0!==p.$ne){if(h)p.$ne=JSON.stringify([p.$ne]),s.push(`NOT array_contains($${r}:name, $${r+1})`);else{if(null===p.$ne){s.push(`$${r}:name IS NOT NULL`),o.push(d),r+=1;continue}s.push(`($${r}:name <> $${r+1} OR $${r}:name IS NULL)`)}o.push(d,p.$ne),r+=2}p.$eq&&(s.push(`$${r}:name = $${r+1}`),o.push(d,p.$eq),r+=2);const m=Array.isArray(p.$in)||Array.isArray(p.$nin);if(Array.isArray(p.$in)&&h&&e.fields[d].contents&&"String"===e.fields[d].contents.type){const e=[];let t=!1;o.push(d),p.$in.forEach((s,n)=>{null===s?t=!0:(o.push(s),e.push(`$${r+1+n-(t?1:0)}`))}),t?s.push(`($${r}:name IS NULL OR $${r}:name && ARRAY[${e.join(",")}])`):s.push(`$${r}:name && ARRAY[${e.join(",")}]`),r=r+1+e.length}else if(m){var l=(e,t)=>{if(e.length>0){const n=t?" NOT ":"";if(h)s.push(`${n} array_contains($${r}:name, $${r+1})`),o.push(d,JSON.stringify(e)),r+=2;else{if(d.indexOf(".")>=0)return;const t=[];o.push(d),e.forEach((e,s)=>{null!==e&&(o.push(e),t.push(`$${r+1+s}`))}),s.push(`$${r}:name ${n} IN (${t.join(",")})`),r=r+1+t.length}}else t||(o.push(d),s.push(`$${r}:name IS NULL`),r+=1)};p.$in&&l(c.default.flatMap(p.$in,e=>e),!1),p.$nin&&l(c.default.flatMap(p.$nin,e=>e),!0)}if(Array.isArray(p.$all)&&h&&(s.push(`array_contains_all($${r}:name, $${r+1}::jsonb)`),o.push(d,JSON.stringify(p.$all)),r+=2),void 0!==p.$exists&&(p.$exists?s.push(`$${r}:name IS NOT NULL`):s.push(`$${r}:name IS NULL`),o.push(d),r+=1),p.$text){const e=p.$text.$search;let t="english";if("object"!=typeof e)throw new u.default.Error(u.default.Error.INVALID_JSON,"bad $text: $search, should be object");if(!e.$term||"string"!=typeof e.$term)throw new u.default.Error(u.default.Error.INVALID_JSON,"bad $text: $term, should be string");if(e.$language&&"string"!=typeof e.$language)throw new u.default.Error(u.default.Error.INVALID_JSON,"bad $text: $language, should be string");if(e.$language&&(t=e.$language),e.$caseSensitive&&"boolean"!=typeof e.$caseSensitive)throw new u.default.Error(u.default.Error.INVALID_JSON,"bad $text: $caseSensitive, should be boolean");if(e.$caseSensitive)throw new u.default.Error(u.default.Error.INVALID_JSON,"bad $text: $caseSensitive not supported, please use $regex or create a separate lower case column.");if(e.$diacriticSensitive&&"boolean"!=typeof e.$diacriticSensitive)throw new u.default.Error(u.default.Error.INVALID_JSON,"bad $text: $diacriticSensitive, should be boolean");if(!1===e.$diacriticSensitive)throw new u.default.Error(u.default.Error.INVALID_JSON,"bad $text: $diacriticSensitive - false not supported, install Postgres Unaccent Extension");s.push(`to_tsvector($${r}, $${r+1}:name) @@ to_tsquery($${r+2}, $${r+3})`),o.push(t,d,t,e.$term),r+=4}if(p.$nearSphere){const e=p.$nearSphere,t=6371*p.$maxDistance*1e3;s.push(`ST_distance_sphere($${r}:name::geometry, POINT($${r+1}, $${r+2})::geometry) <= $${r+3}`),i.push(`ST_distance_sphere($${r}:name::geometry, POINT($${r+1}, $${r+2})::geometry) ASC`),o.push(d,e.longitude,e.latitude,t),r+=4}if(p.$within&&p.$within.$box){const e=p.$within.$box,t=e[0].longitude,n=e[0].latitude,a=e[1].longitude,i=e[1].latitude;s.push(`$${r}:name::point <@ $${r+1}::box`),o.push(d,`((${t}, ${n}), (${a}, ${i}))`),r+=2}if(p.$geoWithin&&p.$geoWithin.$polygon){const e=p.$geoWithin.$polygon;if(!(e instanceof Array))throw new u.default.Error(u.default.Error.INVALID_JSON,"bad $geoWithin value; $polygon should contain at least 3 GeoPoints");if(e.length<3)throw new u.default.Error(u.default.Error.INVALID_JSON,"bad $geoWithin value; $polygon should contain at least 3 GeoPoints");const t=e.map(e=>{if("object"!=typeof e||"GeoPoint"!==e.__type)throw new u.default.Error(u.default.Error.INVALID_JSON,"bad $geoWithin value");return u.default.GeoPoint._validate(e.latitude,e.longitude),`(${e.longitude}, ${e.latitude})`}).join(", ");s.push(`$${r}:name::point <@ $${r+1}::polygon`),o.push(d,`(${t})`),r+=2}if(p.$geoIntersects&&p.$geoIntersects.$point){const e=p.$geoIntersects.$point;if("object"!=typeof e||"GeoPoint"!==e.__type)throw new u.default.Error(u.default.Error.INVALID_JSON,"bad $geoIntersect value; $point should be GeoPoint");u.default.GeoPoint._validate(e.latitude,e.longitude),s.push(`$${r}:name::polygon @> $${r+1}::point`),o.push(d,`(${e.longitude}, ${e.latitude})`),r+=2}if(p.$regex){let e=p.$regex,t="~";const n=p.$options;n&&(n.indexOf("i")>=0&&(t="~*"),n.indexOf("x")>=0&&(e=function(e){return e.endsWith("\n")||(e+="\n"),e.replace(/([^\\])#.*\n/gim,"$1").replace(/^#.*\n/gim,"").replace(/([^\\])\s+/gim,"$1").replace(/^\s+/,"").trim()}(e)));const i=T(d);e=function(e){return e&&e.startsWith("^")?"^"+a(e.slice(1)):e&&e.endsWith("$")?a(e.slice(0,e.length-1))+"$":a(e)}(e),s.push(`$${r}:raw ${t} '$${r+1}:raw'`),o.push(i,e),r+=2}if("Pointer"===p.__type&&(h?(s.push(`array_contains($${r}:name, $${r+1})`),o.push(d,JSON.stringify([p])),r+=2):(s.push(`$${r}:name = $${r+1}`),o.push(d,p.objectId),r+=2)),"Date"===p.__type&&(s.push(`$${r}:name = $${r+1}`),o.push(d,p.iso),r+=2),"GeoPoint"===p.__type&&(s.push("$"+r+":name ~= POINT($"+(r+1)+", $"+(r+2)+")"),o.push(d,p.longitude,p.latitude),r+=3),"Polygon"===p.__type){const e=n(p.coordinates);s.push(`$${r}:name ~= $${r+1}::polygon`),o.push(d,e),r+=2}if(Object.keys(E).forEach(e=>{if(p[e]){const t=E[e];s.push(`$${r}:name ${t} $${r+1}`),o.push(d,S(p[e])),r+=2}}),f===s.length)throw new u.default.Error(u.default.Error.OPERATION_FORBIDDEN,`Postgres doesn't support this query type yet ${JSON.stringify(p)}`)}return o=o.map(w),{pattern:s.join(" AND "),values:o,sorts:i}};class M{constructor({uri:e,collectionPrefix:t="",databaseOptions:r}){this._collectionPrefix=t;const{client:s,pgp:n}=(0,l.createClient)(e,r);this._client=s,this._pgp=n}handleShutdown(){this._client&&this._client.$pool.end()}_ensureSchemaCollectionExists(e){return(e=e||this._client).none('CREATE TABLE IF NOT EXISTS "_SCHEMA" ( "className" varChar(120), "schema" jsonb, "isMmbsClass" bool, PRIMARY KEY ("className") )').catch(e=>{if(e.code!==f&&e.code!==_&&e.code!==m)throw e})}classExists(e){return this._client.one("SELECT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_name = $1)",[e],e=>e.exists)}setClassLevelPermissions(e,t){return this._ensureSchemaCollectionExists().then(()=>{const r=[e,"schema","classLevelPermissions",JSON.stringify(t)];return this._client.none('UPDATE "_SCHEMA" SET $2:name = json_object_set_key($2:name, $3::text, $4::jsonb) WHERE "className"=$1 ',r)})}setIndexesWithSchemaFormat(e,t,r={},s,n){if(n=n||this._client,void 0===t)return Promise.resolve();0===Object.keys(r).length&&(r={_id_:{_id:1}});const o=[],a=[];Object.keys(t).forEach(e=>{const n=t[e];if(r[e]&&"Delete"!==n.__op)throw new u.default.Error(u.default.Error.INVALID_QUERY,`Index ${e} exists, cannot update.`);if(!r[e]&&"Delete"===n.__op)throw new u.default.Error(u.default.Error.INVALID_QUERY,`Index ${e} does not exist, cannot delete.`);"Delete"===n.__op?(o.push(e),delete r[e]):(Object.keys(n).forEach(e=>{if(!s.hasOwnProperty(e))throw new u.default.Error(u.default.Error.INVALID_QUERY,`Field ${e} does not exist, cannot add index.`)}),r[e]=n,a.push({key:n,name:e}))});let i=Promise.resolve();a.length>0&&(i=this.createIndexes(e,a,n));let l=Promise.resolve();return o.length>0&&(l=this.dropIndexes(e,o,n)),n.task(t=>{const s=[e,"schema","indexes",JSON.stringify(r)];return t.batch([l,i,this._ensureSchemaCollectionExists(t),t.none('UPDATE "_SCHEMA" SET $2:name = json_object_set_key($2:name, $3::text, $4::jsonb) WHERE "className"=$1',s)])})}createClass(e,t){return this._client.tx("create-class",r=>{const s=this.createTable(e,t,r),n=r.none('INSERT INTO "_SCHEMA" ("className", "schema", "isMmbsClass") VALUES ($<className>, $<schema>, true)',{className:e,schema:t}),o=this.setIndexesWithSchemaFormat(e,t.indexes,{},t.fields,r);return r.batch([s,n,o])}).then(()=>A(t)).catch(t=>{if(Array.isArray(t.data)&&t.data.length>1&&t.data[0].result.code===y&&(t=t.data[1].result),t.code===_&&t.detail.includes(e))throw new u.default.Error(u.default.Error.DUPLICATE_VALUE,`Class ${e} already exists.`);throw t})}createTable(e,t,r){r=r||this._client,g("createTable",e,t);const s=[],n=[],o=Object.assign({},t.fields);"_User"===e&&(o._email_verify_token_expires_at={type:"Date"},o._email_verify_token={type:"String"},o._account_lockout_expires_at={type:"Date"},o._failed_login_count={type:"Number"},o._perishable_token={type:"String"},o._perishable_token_expires_at={type:"Date"},o._password_changed_at={type:"Date"},o._password_history={type:"Array"});let a=2;const i=[];Object.keys(o).forEach(e=>{const t=o[e];"Relation"!==t.type?(["_rperm","_wperm"].indexOf(e)>=0&&(t.contents={type:"String"}),s.push(e),s.push(v(t)),n.push(`$${a}:name $${a+1}:raw`),"objectId"===e&&n.push(`PRIMARY KEY ($${a}:name)`),a+=2):i.push(e)});const l=`CREATE TABLE IF NOT EXISTS $1:name (${n.join(",")})`,u=[e,...s];return r.task(e=>this._ensureSchemaCollectionExists(e).then(()=>r.none(l,u)).catch(e=>{if(e.code!==f)throw e})).then(()=>r.tx("create-relation-tables",t=>{const r=i.map(r=>t.none('CREATE TABLE IF NOT EXISTS $<joinTable:name> ("relatedId" varChar(120), "owningId" varChar(120), PRIMARY KEY("relatedId", "owningId") )',{joinTable:`_Join:${r}:${e}`}));return t.batch(r)}))}addFieldIfNotExists(e,t,r){return g("addFieldIfNotExists",{className:e,fieldName:t,type:r}),this._client.tx("add-field-if-not-exists",s=>{let n=Promise.resolve();return(n="Relation"!==r.type?s.none("ALTER TABLE $<className:name> ADD COLUMN $<fieldName:name> $<postgresType:raw>",{className:e,fieldName:t,postgresType:v(r)}).catch(s=>{if(s.code===h)return this.createClass(e,{fields:{[t]:r}});if(s.code!==p)throw s}):s.none('CREATE TABLE IF NOT EXISTS $<joinTable:name> ("relatedId" varChar(120), "owningId" varChar(120), PRIMARY KEY("relatedId", "owningId") )',{joinTable:`_Join:${t}:${e}`})).then(()=>s.any('SELECT "schema" FROM "_SCHEMA" WHERE "className" = $<className> and ("schema"::json->\'fields\'->$<fieldName>) is not null',{className:e,fieldName:t})).then(n=>{if(n[0])throw"Attempted to add a field that already exists";{const n=`{fields,${t}}`;return s.none('UPDATE "_SCHEMA" SET "schema"=jsonb_set("schema", $<path>, $<type>)  WHERE "className"=$<className>',{path:n,type:r,className:e})}})})}deleteClass(e){const t=[{query:"DROP TABLE IF EXISTS $1:name",values:[e]},{query:'DELETE FROM "_SCHEMA" WHERE "className" = $1',values:[e]}];return this._client.tx(e=>e.none(this._pgp.helpers.concat(t))).then(()=>0!=e.indexOf("_Join:"))}deleteAllClasses(){const e=(new Date).getTime();return g("deleteAllClasses"),this._client.any('SELECT * FROM "_SCHEMA"').then(e=>{const t=e.reduce((e,t)=>e.concat(j(t.schema)),[]),r=["_SCHEMA","_PushStatus","_JobStatus","_JobSchedule","_Hooks","_GlobalConfig","_Audience",...e.map(e=>e.className),...t];return this._client.tx(e=>e.batch(r.map(t=>e.none("DROP TABLE IF EXISTS $<className:name>",{className:t}))))},e=>{if(e.code!==h)throw e}).then(()=>{g(`deleteAllClasses done in ${(new Date).getTime()-e}`)})}deleteFields(e,t,r){return g("deleteFields",e,r),Promise.resolve().then(()=>{r=r.reduce((e,r)=>{return"Relation"!==t.fields[r].type&&e.push(r),delete t.fields[r],e},[]);const s=[e,...r],n=r.map((e,t)=>`$${t+2}:name`).join(", DROP COLUMN");return this._client.tx(r=>r.batch((r=>{const o=[r.none('UPDATE "_SCHEMA" SET "schema"=$<schema> WHERE "className"=$<className>',{schema:t,className:e})];return s.length>1&&o.push(r.none(`ALTER TABLE $1:name DROP COLUMN ${n}`,s)),o})(r)))})}getAllClasses(){return this._ensureSchemaCollectionExists().then(()=>this._client.map('SELECT * FROM "_SCHEMA"',null,e=>i({className:e.className},e.schema))).then(e=>e.map(A))}getClass(e){return g("getClass",e),this._client.any('SELECT * FROM "_SCHEMA" WHERE "className"=$<className>',{className:e}).then(e=>{if(1===e.length)return e[0].schema;throw void 0}).then(A)}createObject(e,t,r){g("createObject",e,r);let s=[];const o=[];t=N(t);const a={};r=C(r),$(r),Object.keys(r).forEach(i=>{if(null!==r[i]){var l=i.match(/^_auth_data_([a-zA-Z0-9_]+)$/);if(l){var u=l[1];r.authData=r.authData||{},r.authData[u]=r[i],delete r[i],i="authData"}if(s.push(i),!t.fields[i]&&"_User"===e)return"_email_verify_token"!==i&&"_failed_login_count"!==i&&"_perishable_token"!==i&&"_password_history"!==i||o.push(r[i]),"_email_verify_token_expires_at"===i&&(r[i]?o.push(r[i].iso):o.push(null)),void("_account_lockout_expires_at"!==i&&"_perishable_token_expires_at"!==i&&"_password_changed_at"!==i||(r[i]?o.push(r[i].iso):o.push(null)));switch(t.fields[i].type){case"Date":r[i]?o.push(r[i].iso):o.push(null);break;case"Pointer":o.push(r[i].objectId);break;case"Array":["_rperm","_wperm"].indexOf(i)>=0?o.push(r[i]):o.push(JSON.stringify(r[i]));break;case"Object":case"Bytes":case"String":case"Number":case"Boolean":o.push(r[i]);break;case"File":o.push(r[i].name);break;case"Polygon":{const e=n(r[i].coordinates);o.push(e);break}case"GeoPoint":a[i]=r[i],s.pop();break;default:throw`Type ${t.fields[i].type} not supported yet`}}}),s=s.concat(Object.keys(a));const i=o.map((e,r)=>{let n="";const o=s[r];return["_rperm","_wperm"].indexOf(o)>=0?n="::text[]":t.fields[o]&&"Array"===t.fields[o].type&&(n="::jsonb"),`$${r+2+s.length}${n}`}),l=Object.keys(a).map(e=>{const t=a[e];o.push(t.longitude,t.latitude);const r=o.length+s.length;return`POINT($${r}, $${r+1})`}),c=`INSERT INTO $1:name (${s.map((e,t)=>`$${t+2}:name`).join(",")}) VALUES (${i.concat(l).join(",")})`,d=[e,...s,...o];return g(c,d),this._client.none(c,d).then(()=>({ops:[r]})).catch(e=>{if(e.code===_){const t=new u.default.Error(u.default.Error.DUPLICATE_VALUE,"A duplicate value for a field with unique values was provided");if(t.underlyingError=e,e.constraint){const r=e.constraint.match(/unique_([a-zA-Z]+)/);r&&Array.isArray(r)&&(t.userInfo={duplicated_field:r[1]})}throw t}throw e})}deleteObjectsByQuery(e,t,r){g("deleteObjectsByQuery",e,r);const s=[e],n=k({schema:t,index:2,query:r});s.push(...n.values),0===Object.keys(r).length&&(n.pattern="TRUE");const o=`WITH deleted AS (DELETE FROM $1:name WHERE ${n.pattern} RETURNING *) SELECT count(*) FROM deleted`;return g(o,s),this._client.one(o,s,e=>+e.count).then(e=>{if(0===e)throw new u.default.Error(u.default.Error.OBJECT_NOT_FOUND,"Object not found.");return e}).catch(e=>{if(e.code!==h)throw e})}findOneAndUpdate(e,t,r,s){return g("findOneAndUpdate",e,r,s),this.updateObjectsByQuery(e,t,r,s).then(e=>e[0])}updateObjectsByQuery(e,t,r,s){g("updateObjectsByQuery",e,r,s);const o=[],a=[e];let l=2;t=N(t);const c=i({},s);s=C(s);for(const e in s){const t=e.match(/^_auth_data_([a-zA-Z0-9_]+)$/);if(t){var d=t[1];const r=s[e];delete s[e],s.authData=s.authData||{},s.authData[d]=r}}for(const e in s){const r=s[e];if(null===r)o.push(`$${l}:name = NULL`),a.push(e),l+=1;else if("authData"==e){const t=`$${l}:name`,s=l;l+=1,a.push(e);const n=Object.keys(r).reduce((e,t)=>{const s=((e,t,r)=>`json_object_set_key(COALESCE(${e}, '{}'::jsonb), ${t}, ${r})::jsonb`)(e,`$${l}::text`,`$${l+1}::jsonb`);l+=2;let n=r[t];return n&&(n="Delete"===n.__op?null:JSON.stringify(n)),a.push(t,n),s},t);o.push(`$${s}:name = ${n}`)}else if("Increment"===r.__op)o.push(`$${l}:name = COALESCE($${l}:name, 0) + $${l+1}`),a.push(e,r.amount),l+=2;else if("Add"===r.__op)o.push(`$${l}:name = array_add(COALESCE($${l}:name, '[]'::jsonb), $${l+1}::jsonb)`),a.push(e,JSON.stringify(r.objects)),l+=2;else if("Delete"===r.__op)o.push(`$${l}:name = $${l+1}`),a.push(e,null),l+=2;else if("Remove"===r.__op)o.push(`$${l}:name = array_remove(COALESCE($${l}:name, '[]'::jsonb), $${l+1}::jsonb)`),a.push(e,JSON.stringify(r.objects)),l+=2;else if("AddUnique"===r.__op)o.push(`$${l}:name = array_add_unique(COALESCE($${l}:name, '[]'::jsonb), $${l+1}::jsonb)`),a.push(e,JSON.stringify(r.objects)),l+=2;else if("updatedAt"===e)o.push(`$${l}:name = $${l+1}`),a.push(e,r),l+=2;else if("string"==typeof r)o.push(`$${l}:name = $${l+1}`),a.push(e,r),l+=2;else if("boolean"==typeof r)o.push(`$${l}:name = $${l+1}`),a.push(e,r),l+=2;else if("Pointer"===r.__type)o.push(`$${l}:name = $${l+1}`),a.push(e,r.objectId),l+=2;else if("Date"===r.__type)o.push(`$${l}:name = $${l+1}`),a.push(e,S(r)),l+=2;else if(r instanceof Date)o.push(`$${l}:name = $${l+1}`),a.push(e,r),l+=2;else if("File"===r.__type)o.push(`$${l}:name = $${l+1}`),a.push(e,S(r)),l+=2;else if("GeoPoint"===r.__type)o.push(`$${l}:name = POINT($${l+1}, $${l+2})`),a.push(e,r.longitude,r.latitude),l+=3;else if("Polygon"===r.__type){const t=n(r.coordinates);o.push(`$${l}:name = $${l+1}::polygon`),a.push(e,t),l+=2}else if("Relation"===r.__type);else if("number"==typeof r)o.push(`$${l}:name = $${l+1}`),a.push(e,r),l+=2;else if("object"==typeof r&&t.fields[e]&&"Object"===t.fields[e].type){const t=Object.keys(c).filter(t=>"Increment"===c[t].__op&&2===t.split(".").length&&t.split(".")[0]===e).map(e=>e.split(".")[1]);let s="";t.length>0&&(s=" || "+t.map(e=>{const t=r[e].amount;return`CONCAT('{"${e}":', COALESCE($${l}:name->>'${e}','0')::int + ${t}, '}')::jsonb`}).join(" || "),t.forEach(e=>{delete r[e]}));const n=Object.keys(c).filter(t=>"Delete"===c[t].__op&&2===t.split(".").length&&t.split(".")[0]===e).map(e=>e.split(".")[1]),i=n.reduce((e,t,r)=>e+` - '$${l+1+r}:value'`,"");o.push(`$${l}:name = ( COALESCE($${l}:name, '{}'::jsonb) ${i} ${s} || $${l+1+n.length}::jsonb )`),a.push(e,...n,JSON.stringify(r)),l+=2+n.length}else{if(!Array.isArray(r)||!t.fields[e]||"Array"!==t.fields[e].type)return g("Not supported update",e,r),Promise.reject(new u.default.Error(u.default.Error.OPERATION_FORBIDDEN,`Postgres doesn't support update ${JSON.stringify(r)} yet`));if("text[]"===v(t.fields[e]))o.push(`$${l}:name = $${l+1}::text[]`);else{let e="text";for(const t of r)if("object"==typeof t){e="json";break}o.push(`$${l}:name = array_to_json($${l+1}::${e}[])::jsonb`)}a.push(e,r),l+=2}}const h=k({schema:t,index:l,query:r});a.push(...h.values);const f=h.pattern.length>0?`WHERE ${h.pattern}`:"",p=`UPDATE $1:name SET ${o.join(",")} ${f} RETURNING *`;return g("update: ",p,a),this._client.any(p,a)}upsertOneObject(e,t,r,s){g("upsertOneObject",{className:e,query:r,update:s});const n=Object.assign({},r,s);return this.createObject(e,t,n).catch(n=>{if(n.code===u.default.Error.DUPLICATE_VALUE)return this.findOneAndUpdate(e,t,r,s);throw n})}find(e,t,r,{skip:s,limit:n,sort:o,keys:a}){g("find",e,r,{skip:s,limit:n,sort:o,keys:a});const i=void 0!==n,l=void 0!==s;let u=[e];const c=k({schema:t,query:r,index:2});u.push(...c.values);const d=c.pattern.length>0?`WHERE ${c.pattern}`:"",f=i?`LIMIT $${u.length+1}`:"";i&&u.push(n);const p=l?`OFFSET $${u.length+1}`:"";l&&u.push(s);let m="";if(o){const e=Object.keys(o).map(e=>1===o[e]?`"${e}" ASC`:`"${e}" DESC`).join(",");m=void 0!==o&&Object.keys(o).length>0?`ORDER BY ${e}`:""}c.sorts&&Object.keys(c.sorts).length>0&&(m=`ORDER BY ${c.sorts.join(",")}`);let _="*";a&&(_=(a=a.filter(e=>e.length>0)).map((e,t)=>"$score"===e?"ts_rank_cd(to_tsvector($2, $3:name), to_tsquery($4, $5), 32) as score":`$${t+u.length+1}:name`).join(","),u=u.concat(a));const y=`SELECT ${_} FROM $1:name ${d} ${m} ${f} ${p}`;return g(y,u),this._client.any(y,u).catch(e=>e.code===h?[]:Promise.reject(e)).then(r=>r.map(r=>this.postgresObjectToMmbsObject(e,r,t)))}postgresObjectToMmbsObject(e,t,r){Object.keys(r.fields).forEach(e=>{if("Pointer"===r.fields[e].type&&t[e]&&(t[e]={objectId:t[e],__type:"Pointer",className:r.fields[e].targetClass}),"Relation"===r.fields[e].type&&(t[e]={__type:"Relation",className:r.fields[e].targetClass}),t[e]&&"GeoPoint"===r.fields[e].type&&(t[e]={__type:"GeoPoint",latitude:t[e].y,longitude:t[e].x}),t[e]&&"Polygon"===r.fields[e].type){let r=t[e];r=(r=r.substr(2,r.length-4).split("),(")).map(e=>[parseFloat(e.split(",")[1]),parseFloat(e.split(",")[0])]),t[e]={__type:"Polygon",coordinates:r}}t[e]&&"File"===r.fields[e].type&&(t[e]={__type:"File",name:t[e]})}),t.createdAt&&(t.createdAt=t.createdAt.toISOString()),t.updatedAt&&(t.updatedAt=t.updatedAt.toISOString()),t.expiresAt&&(t.expiresAt={__type:"Date",iso:t.expiresAt.toISOString()}),t._email_verify_token_expires_at&&(t._email_verify_token_expires_at={__type:"Date",iso:t._email_verify_token_expires_at.toISOString()}),t._account_lockout_expires_at&&(t._account_lockout_expires_at={__type:"Date",iso:t._account_lockout_expires_at.toISOString()}),t._perishable_token_expires_at&&(t._perishable_token_expires_at={__type:"Date",iso:t._perishable_token_expires_at.toISOString()}),t._password_changed_at&&(t._password_changed_at={__type:"Date",iso:t._password_changed_at.toISOString()});for(const e in t)null===t[e]&&delete t[e],t[e]instanceof Date&&(t[e]={__type:"Date",iso:t[e].toISOString()});return t}ensureUniqueness(e,t,r){const s=`unique_${r.sort().join("_")}`,n=`ALTER TABLE $1:name ADD CONSTRAINT $2:name UNIQUE (${r.map((e,t)=>`$${t+3}:name`).join(",")})`;return this._client.none(n,[e,s,...r]).catch(e=>{if(e.code!==f||!e.message.includes(s))throw e.code===_&&e.message.includes(s)?new u.default.Error(u.default.Error.DUPLICATE_VALUE,"A duplicate value for a field with unique values was provided"):e})}count(e,t,r){g("count",e,r);const s=[e],n=k({schema:t,query:r,index:2});s.push(...n.values);const o=`SELECT count(*) FROM $1:name ${n.pattern.length>0?`WHERE ${n.pattern}`:""}`;return this._client.one(o,s,e=>+e.count).catch(e=>{if(e.code===h)return 0;throw e})}distinct(e,t,r,s){g("distinct",e,r);let n=s,o=s;s.indexOf(".")>=0&&(n=P(s).join("->"),o=s.split(".")[0]);const a=t.fields&&t.fields[s]&&"Array"===t.fields[s].type,i=[n,o,e],l=k({schema:t,query:r,index:4});i.push(...l.values);const u=l.pattern.length>0?`WHERE ${l.pattern}`:"";let c=`SELECT DISTINCT ON ($1:raw) $2:raw FROM $3:name ${u}`;return a&&(c=`SELECT distinct jsonb_array_elements($1:raw) as $2:raw FROM $3:name ${u}`),g(c,i),this._client.any(c,i).catch(()=>[]).then(e=>{if(-1===s.indexOf("."))return e.map(e=>e[n]);const t=s.split(".")[1];return e.map(e=>e[o][t])}).then(r=>r.map(r=>this.postgresObjectToMmbsObject(e,r,t)))}aggregate(e,t,r){g("aggregate",e,r);const s=[e];let n=[],o=null,a="",i="",l="",u="",c="";for(let e=0;e<r.length;e+=1){const t=r[e];if(t.$group){for(const e in t.$group){const r=t.$group[e];null!==r&&void 0!==r&&("_id"!==e?(r.$sum&&("string"==typeof r.$sum?n.push(`SUM(${R(r.$sum)}) AS "${e}"`):(o=e,n.push(`COUNT(*) AS "${e}"`))),r.$max&&n.push(`MAX(${R(r.$max)}) AS "${e}"`),r.$min&&n.push(`MIN(${R(r.$min)}) AS "${e}"`),r.$avg&&n.push(`AVG(${R(r.$avg)}) AS "${e}"`)):(n.push(`${R(r)} AS "objectId"`),c=`GROUP BY ${R(r)}`))}n.join(",")}else n.push("*");if(t.$project){n.includes("*")&&(n=[]);for(const e in t.$project){const r=t.$project[e];1!==r&&!0!==r||n.push(e)}}if(t.$match){const e=[];for(const r in t.$match){const s=t.$match[r];"string"==typeof s?e.push(`${r} = ${s}`):Object.keys(E).forEach(t=>{if(s[t]){const n=E[t];e.push(`${r} ${n} ${s[t]}`)}})}a=e.length>0?`WHERE ${e.join(" ")}`:""}if(t.$limit&&(i=`LIMIT ${t.$limit}`),t.$skip&&(l=`OFFSET ${t.$skip}`),t.$sort){const e=t.$sort,r=Object.keys(e).map(t=>1===e[t]?`"${t}" ASC`:`"${t}" DESC`).join(",");u=void 0!==e&&Object.keys(e).length>0?`ORDER BY ${r}`:""}}const d=`SELECT ${n} FROM $1:name ${a} ${u} ${i} ${l} ${c}`;return g(d,s),this._client.any(d,s).then(r=>r.map(r=>this.postgresObjectToMmbsObject(e,r,t))).then(e=>(o&&(e[0][o]=parseInt(e[0][o],10)),e.forEach(e=>{e.hasOwnProperty("objectId")||(e.objectId=null)}),e))}performInitialization({VolatileClassesSchemas:e}){g("performInitialization");const t=e.map(e=>this.createTable(e.className,e).catch(e=>{if(e.code===f||e.code===u.default.Error.INVALID_CLASS_NAME)return Promise.resolve();throw e}));return Promise.all(t).then(()=>this._client.tx(e=>e.batch([e.none(d.default.misc.jsonObjectSetKeys),e.none(d.default.array.add),e.none(d.default.array.addUnique),e.none(d.default.array.remove),e.none(d.default.array.containsAll),e.none(d.default.array.contains)]))).then(e=>{g(`initializationDone in ${e.duration}`)}).catch(e=>{console.error(e)})}createIndexes(e,t,r){return(r||this._client).tx(r=>r.batch(t.map(t=>r.none("CREATE INDEX $1:name ON $2:name ($3:name)",[t.name,e,t.key]))))}dropIndexes(e,t,r){return(r||this._client).tx(e=>e.batch(t.map(t=>e.none("DROP INDEX $1:name",t))))}getIndexes(e){return this._client.any("SELECT * FROM pg_indexes WHERE tablename = ${className}",{className:e})}updateSchemaWithIndexes(){return Promise.resolve()}}t.PostgresStorageAdapter=M,t.default=M,e.exports=M},function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.createClient=function(e,t){let n={};t=t||{},e&&(n=s.getDatabaseOptionsFromURI(e));for(const e in t)n[e]=t[e];const o=n.initOptions||{},a=r(57)(o),i=a(n);if(n.pgOptions)for(const e in n.pgOptions)a.pg.defaults[e]=n.pgOptions[e];return{client:i,pgp:a}};const s=r(154)},function(e,t,r){"use strict";function s(e){return(e=e||"").split("&").reduce((e,t)=>{const r=t.split("=");return e[decodeURIComponent(r[0])]=r.length>1?decodeURIComponent(r.slice(1).join("=")):"",e},{})}const n=r(15);e.exports={parseQueryParams:s,getDatabaseOptionsFromURI:function(e){const t={},r=n.parse(e),o=s(r.query),a=r.auth?r.auth.split(":"):[];return t.host=r.hostname||"localhost",t.port=r.port?parseInt(r.port):5432,t.database=r.pathname?r.pathname.substr(1):void 0,t.user=a.length>0?a[0]:"",t.password=a.length>1?a[1]:"",t.ssl=!(!o.ssl||"true"!==o.ssl.toLowerCase()),t.binary=!(!o.binary||"true"!==o.binary.toLowerCase()),t.client_encoding=o.client_encoding,t.application_name=o.application_name,t.fallback_application_name=o.fallback_application_name,o.poolSize&&(t.poolSize=parseInt(o.poolSize)||10),t}}},function(e,t,r){"use strict";(function(t){r(57).QueryFile,r(11);e.exports={array:{add:'CREATE OR REPLACE FUNCTION array_add(    "array"   jsonb,    "values"  jsonb  )    RETURNS jsonb    LANGUAGE sql    IMMUTABLE    STRICT  AS $function$    SELECT array_to_json(ARRAY(SELECT unnest(ARRAY(SELECT DISTINCT jsonb_array_elements("array")) ||  ARRAY(SELECT jsonb_array_elements("values")))))::jsonb;  $function$;  ',addUnique:'CREATE OR REPLACE FUNCTION array_add_unique(    "array"   jsonb,    "values"  jsonb  )    RETURNS jsonb    LANGUAGE sql    IMMUTABLE    STRICT  AS $function$    SELECT array_to_json(ARRAY(SELECT DISTINCT unnest(ARRAY(SELECT DISTINCT jsonb_array_elements("array")) ||  ARRAY(SELECT DISTINCT jsonb_array_elements("values")))))::jsonb;  $function$;  ',contains:'CREATE OR REPLACE FUNCTION array_contains(   "array"   jsonb,   "values"  jsonb )   RETURNS boolean   LANGUAGE sql   IMMUTABLE   STRICT AS $function$   SELECT RES.CNT >= 1 FROM (SELECT COUNT(*) as CNT FROM jsonb_array_elements("array") as elt WHERE elt IN (SELECT jsonb_array_elements("values"))) as RES; $function$; ',containsAll:'CREATE OR REPLACE FUNCTION array_contains_all(   "array"   jsonb,   "values"  jsonb )   RETURNS     LANGUAGE sql   IMMUTABLE   STRICT AS $function$   SELECT RES.CNT = jsonb_array_length("values") FROM (SELECT COUNT(*) as CNT FROM jsonb_array_elements("array") as elt WHERE elt IN (SELECT jsonb_array_elements("values"))) as RES; $function$; ',remove:'CREATE OR REPLACE FUNCTION array_remove(   "array"   jsonb,   "values"  jsonb )   RETURNS jsonb   LANGUAGE sql   IMMUTABLE   STRICT AS $function$   SELECT array_to_json(ARRAY(SELECT * FROM jsonb_array_elements("array") as elt WHERE elt NOT IN (SELECT * FROM (SELECT jsonb_array_elements("values")) AS sub)))::jsonb; $function$; '},misc:{jsonObjectSetKeys:'CREATE OR REPLACE FUNCTION json_object_set_key(   "json"        jsonb,   key_to_set    TEXT,   value_to_set  anyelement )   RETURNS jsonb   LANGUAGE sql   IMMUTABLE   STRICT AS $function$ SELECT concat("{", string_agg(to_json("key") || ":"|| "value", ","), "}")::jsonb   FROM (SELECT *     FROM jsonb_each("json")     WHERE key <> key_to_set     UNION ALL     SELECT key_to_set, to_json("value_to_set")::jsonb) AS fields $function$; '}}}).call(t,"/")},function(e,t,r){"use strict";function s(e){return e&&e.__esModule?e:{default:e}}Object.defineProperty(t,"__esModule",{value:!0});var n=Object.assign||function(e){for(var t=1;t<arguments.length;t++){var r=arguments[t];for(var s in r)Object.prototype.hasOwnProperty.call(r,s)&&(e[s]=r[s])}return e},o=s(r(0)),a=s(r(157)),i=r(158);(process.env.VERBOSE||process.env.VERBOSE_MMBS_SERVER_MYSQL_ADAPTER)&&(a.default.level="verbose");const l=r(159),u=r(160),c="ER_NO_SUCH_TABLE",d="ER_DUP_FIELDNAME",h="ER_DUP_ENTRY",f="WARN_DATA_TRUNCATED",p="ER_TRUNCATED_WRONG_VALUE",m="ER_DUP_KEYNAME",_="ER_BLOB_KEY_WITHOUT_LENGTH",y="varchar(120)",b="mmbs-server-mysql-adapter",g="ER_BAD_FIELD_ERROR";let v=!1;const E=(e,t)=>{v||(a.default.verbose(b,e),t&&a.default.verbose(b,t))};class S{constructor({uri:e,collectionPrefix:t="",databaseOptions:r={}}){this._uri=e,this._collectionPrefix=t;let s={};const n=r||{};e&&(s=l.getDatabaseOptionsFromURI(e)),Object.keys(n).forEach(e=>{s[e]=n[e]}),s.multipleStatements=!0,s.queryFormat=((e,t)=>{if(!t)return e;const r=/\^|~|#|:raw|:alias|:name|:json|:csv|:value/,s=e.replace(/\$([1-9][0-9]{0,16}(?![0-9])(\^|~|#|:raw|:alias|:name|:json|:csv|:value)?)/g,e=>{const s=e.substring(1).match(r);let n=1e5;if((n=s?e.substring(1).substring(0,s.index)-1:e.substring(1)-1)>=1e5)throw new o.default.Error(`Variable $${e.substring(1)} exceeds supported maximum of $100000`);if(n<t.length){var a=t[n];if("string"==typeof a){return a.replace(/'/g,"''")}return a}throw new o.default.Error(`Index $${n} exceeds values length: $${t.length}`)});return E(s),s}),this._databaseOptions=s}connect(){return this.connectionPromise?this.connectionPromise:(this.connectionPromise=u.createConnection(this._databaseOptions).then(e=>{e?(e.on("error",()=>{delete this.connectionPromise}),e.on("close",()=>{delete this.connectionPromise}),this.database=e):delete this.connectionPromise}).catch(e=>(delete this.connectionPromise,Promise.reject(e))),this.connectionPromise)}handleShutdown(){this.database&&this.database.end()}_ensureSchemaCollectionExists(){return E("_ensureSchemaCollectionExists"),this.connect().then(()=>this.database.query("CREATE TABLE IF NOT EXISTS `_SCHEMA` (`className` VARCHAR(120), `schema` JSON, `isMmbsClass` BOOL, PRIMARY KEY (`className`));"))}_arr_unique(e){console.log(e);let t=[];for(let r of e)if(void 0!==r){let e=r;for(let r of e)void 0!==r&&t.push(r)}let r=[];for(let e=0;e<t.length;e++)-1==r.indexOf(t[e])&&r.push(t[e]);return r}classExists(e){return this.connect().then(()=>this.database.query("SELECT 'exists' from (SELECT 1 FROM `$1:name` LIMIT 1) as classExist",[e])).then(([e])=>e[0].exists).catch(()=>Promise.resolve(!1))}setClassLevelPermissions(e,t){const r=[e,"schema","classLevelPermissions",JSON.stringify(t)];return this.connect().then(()=>this._ensureSchemaCollectionExists()).then(()=>this.database.query("UPDATE `_SCHEMA` SET `$2:name` = JSON_SET(COALESCE(`$2:name`, '{}'), '$.$3:name', CAST('$4:name' AS JSON)) WHERE `className` = '$1:name'",r))}setIndexesWithSchemaFormat(e,t,r={},s,n){if(n=n||this._client,void 0===t)return Promise.resolve();0===Object.keys(r).length&&(r={_id_:{_id:1}});const a=[],i=[];Object.keys(t).forEach(e=>{const n=t[e];if(r[e]&&"Delete"!==n.__op)throw new o.default.Error(o.default.Error.INVALID_QUERY,`Index ${e} exists, cannot update.`);if(!r[e]&&"Delete"===n.__op)throw new o.default.Error(o.default.Error.INVALID_QUERY,`Index ${e} does not exist, cannot delete.`);"Delete"===n.__op?(a.push(e),delete r[e]):(Object.keys(n).forEach(e=>{if(!s.hasOwnProperty(e))throw new o.default.Error(o.default.Error.INVALID_QUERY,`Field ${e} does not exist, cannot add index.`)}),r[e]=n,i.push({key:n,name:e}))});let l=Promise.resolve();i.length>0&&(l=this.createIndexes(e,i,n));let u=Promise.resolve();return a.length>0&&(u=this.dropIndexes(e,a,n)),u.then(()=>l).then(()=>this._ensureSchemaCollectionExists()).then(()=>{const t=[e,"schema","indexes",JSON.stringify(r)];return n.none('UPDATE "_SCHEMA" SET $2:name = json_object_set_key($2:name, $3::text, $4::jsonb) WHERE "className"=$1 ',t)})}createClass(e,t){E("createClass",e,t);return this.connect().then(()=>this.createTable(e,t)).then(()=>this.database.query("INSERT INTO `_SCHEMA` (`className`, `schema`, `isMmbsClass`) VALUES ('$1:name', '$2:name', true)",[e,JSON.stringify(t)])).then(()=>(0,i.toMmbsSchema)(t)).catch(t=>{throw t.code===h&&t.message.includes("PRIMARY")?new o.default.Error(o.default.Error.DUPLICATE_VALUE,`Class ${e} already exists.`):t})}createTable(e,t){E("createTable",e,t);const r=[],s=[],n=Object.assign({},t.fields);"_User"===e&&(n._email_verify_token_expires_at={type:"Date"},n._email_verify_token={type:"String"},n._account_lockout_expires_at={type:"Date"},n._failed_login_count={type:"Number"},n._perishable_token={type:"String"},n._perishable_token_expires_at={type:"Date"},n._password_changed_at={type:"Date"},n._password_history={type:"Array"});let o=2;const a=[];Object.keys(n).forEach(e=>{const t=n[e];if("Relation"!==t.type){if(["_rperm","_wperm"].indexOf(e)>=0&&(t.contents={type:"String"}),r.push(e),"Date"===t.type)return r.push((0,i.parseTypeToMySQLType)(t)),"createdAt"===e?s.push(`\`$${o}:name\` $${o+1}:raw DEFAULT CURRENT_TIMESTAMP(6)`):"updatedAt"===e?s.push(`\`$${o}:name\` $${o+1}:raw DEFAULT CURRENT_TIMESTAMP(6) ON UPDATE CURRENT_TIMESTAMP(6)`):s.push(`\`$${o}:name\` $${o+1}:raw NULL`),void(o+=2);s.push(`\`$${o}:name\` $${o+1}:raw`),"objectId"===e?(r.push(y),s.push(`PRIMARY KEY (\`$${o}:name\`)`)):"email"===e||"username"===e||"name"===e?r.push(y):r.push((0,i.parseTypeToMySQLType)(t)),o+=2}else a.push(e)});const l=`CREATE TABLE IF NOT EXISTS \`$1:name\` (${s.join(",")})`,u=[e,...r];return E(l,u),this.connect().then(()=>this._ensureSchemaCollectionExists()).then(()=>this.database.query(l,u)).then(()=>Promise.all(a.map(t=>this.database.query("CREATE TABLE IF NOT EXISTS `$1:name` (`relatedId` varChar(120), `owningId` varChar(120), PRIMARY KEY(`relatedId`, `owningId`))",[`_Join:${t}:${e}`])))).catch(e=>{console.log("error here"),console.log(e)})}addFieldIfNotExists(e,t,r){return E("addFieldIfNotExists",{className:e,fieldName:t,type:r}),this.connect().then(()=>{let s=Promise.resolve();if("Relation"!==r.type){let n=(0,i.parseTypeToMySQLType)(r);"Date"===r.type&&(n="timestamp(6) null default null"),s=this.database.query("ALTER TABLE `$1:name` ADD COLUMN `$2:name` $3:name",[e,t,n]).catch(e=>{if(e.code!==d)throw e})}else s=this.database.query("CREATE TABLE IF NOT EXISTS `$1:name` (`relatedId` varChar(120), `owningId` varChar(120), PRIMARY KEY(`relatedId`, `owningId`))",[`_Join:${t}:${e}`]);return s}).then(()=>this.database.query("SELECT `schema` FROM `_SCHEMA` WHERE `className` = '$1:name' and (`schema`->>'$.fields.$2:name') is not null",[e,t])).then(([s])=>{if(s[0])throw"Attempted to add a field that already exists";{const s=`"$.fields.${t}"`;return this.database.query("UPDATE `_SCHEMA` SET `schema`=JSON_SET(`schema`, $1:name, CAST('$2:name' AS JSON)) WHERE `className`='$3:name'",[s,JSON.stringify(r),e])}})}deleteClass(e){return this.connect().then(()=>this.database.query("DROP TABLE IF EXISTS `$1:name`; DELETE FROM `_SCHEMA` WHERE `className`= '$1:name';",[e])).then(()=>0!==e.indexOf("_Join:"))}deleteAllClasses(){const e=(new Date).getTime();return E("deleteAllClasses"),this.connect().then(()=>this.database.query("SELECT * FROM `_SCHEMA`")).then(([e])=>{const t=e.reduce((e,t)=>e.concat((0,i.joinTablesForSchema)(t.schema)),[]),r=["_SCHEMA","_PushStatus","_JobStatus","_JobSchedule","_Hooks","_GlobalConfig","_Audience",...e.map(e=>e.className),...t];let s="";for(let e=1;e<=r.length;e+=1)s+=`DROP TABLE IF EXISTS \`$${e}:name\`;`;return E(s,r),this.database.query(s,r)}).then(()=>{E(`deleteAllClasses done in ${(new Date).getTime()-e}`)}).catch(e=>{if(e.code!==c)throw e})}deleteFields(e,t,r){E("deleteFields",e,t,r),r=r.reduce((e,r)=>{return"Relation"!==t.fields[r].type&&e.push(r),delete t.fields[r],e},[]);const s=[e,...r],n=r.map((e,t)=>`\`$${t+2}:name\``).join(", DROP COLUMN");return this.connect().then(()=>this.database.query("UPDATE `_SCHEMA` SET `schema` = JSON_SET(COALESCE(`schema`, '{}'), '$.fields', CAST('$1:name' AS JSON)) WHERE `className`='$2:name'",[JSON.stringify(t.fields),e])).then(()=>{if(s.length>1)return this.database.query(`ALTER TABLE \`$1:name\` DROP COLUMN ${n}`,[...s])})}getAllClasses(){return this._ensureSchemaCollectionExists().then(()=>this.database.query("SELECT * FROM `_SCHEMA`")).then(([e])=>e.map(e=>(0,i.toMmbsSchema)(n({className:e.className},e.schema))))}getClass(e){return E("getClass",e),this.connect().then(()=>this.database.query("SELECT * FROM `_SCHEMA` WHERE `className` COLLATE utf8_general_ci ='$1:name'",[e])).then(([e])=>{if(1===e.length)return e[0].schema;throw void 0}).then(i.toMmbsSchema)}createObject(e,t,r){E("createObject",e,r);let s=[];const n=[];t=(0,i.toMySQLSchema)(t);const a={};r=(0,i.handleDotFields)(r),(0,i.validateKeys)(r),Object.keys(r).forEach(o=>{if(null===r[o])return;const l=o.match(/^_auth_data_([a-zA-Z0-9_]+)$/);if(l){const e=l[1];r.authData=r.authData||{},r.authData[e]=r[o],delete r[o],o="authData"}if(s.push(o),!t.fields[o]&&"_User"===e)return"_email_verify_token"!==o&&"_failed_login_count"!==o&&"_perishable_token"!==o&&"_password_history"!==o||n.push(r[o]),void("_account_lockout_expires_at"!==o&&"_perishable_token_expires_at"!==o&&"_password_changed_at"!==o&&"_email_verify_token_expires_at"!==o||(r[o]?n.push((0,i.toMySQLValue)(r[o])):n.push(null)));switch(t.fields[o].type){case"Date":r[o]?("updatedAt"!==o||r[o].iso||(r[o].iso=new Date),n.push((0,i.toMySQLValue)(r[o]))):n.push(null);break;case"Pointer":n.push(r[o].objectId);break;case"Array":case"Object":case"Bytes":n.push(JSON.stringify(r[o]));break;case"String":case"Number":if(!r[o]){n.push(0);break}n.push(r[o]);break;case"Boolean":n.push(r[o]);break;case"File":n.push(r[o].name);break;case"GeoPoint":a[o]=r[o],s.pop();break;default:throw`Type ${t.fields[o].type} not supported yet`}}),s=s.concat(Object.keys(a));const l=n.map((e,r)=>{const n=s[r];return t.fields[n]&&"Boolean"===t.fields[n].type||null===e?`$${r+2+s.length}:name`:`'$${r+2+s.length}:name'`}),u=Object.keys(a).map(e=>{const t=a[e];n.push(t.longitude,t.latitude);const r=n.length+s.length;return`POINT($${r}, $${r+1})`}),c=`INSERT INTO \`$1:name\` (${s.map((e,t)=>`\`$${t+2}:name\``).join(",")}) VALUES (${l.concat(u).join(",")})`,d=[e,...s,...n];return E(c,d),this.connect().then(()=>this.database.query(c,d)).catch(t=>{if(t.code===h&&"_Role"===e||t.code===h&&t.message.includes("unique_")||t.code===h&&t.message.includes("PRIMARY"))throw new o.default.Error(o.default.Error.DUPLICATE_VALUE,"A duplicate value for a field with unique values was provided");if(t.code!==h&&t.code!==f)throw t}).then(()=>({ops:[r]})).catch(e=>{throw e.code===p?new o.default.Error(o.default.Error.INTERNAL_SERVER_ERROR,e):e})}deleteObjectsByQuery(e,t,r){E("deleteObjectsByQuery",e,r);const s=[e],n=(0,i.buildWhereClause)({schema:t,index:2,query:r});s.push(...n.values),0===Object.keys(r).length&&(n.pattern="TRUE");const a=`DELETE FROM \`$1:name\` WHERE ${n.pattern}`;return E(a,s),this.connect().then(()=>this.database.query(a,s)).then(([e])=>{if(0===e.affectedRows)throw new o.default.Error(o.default.Error.OBJECT_NOT_FOUND,"Object not found.");return e.affectedRows})}findOneAndUpdate(e,t,r,s){return E("findOneAndUpdate",e,r,s),this.updateObjectsByQuery(e,t,r,s).then(e=>e)}updateObjectsByQuery(e,t,r,s){E("updateObjectsByQuery",e,r,s);const a=[],l=[e];let u=2;t=(0,i.toMySQLSchema)(t);const c=n({},s);s=(0,i.handleDotFields)(s),Object.keys(s).forEach(e=>{const t=e.match(/^_auth_data_([a-zA-Z0-9_]+)$/);if(t){const r=t[1],n=s[e];delete s[e],s.authData=s.authData||{},s.authData[r]=n}}),Object.keys(s).forEach(e=>{const r=s[e];if(null===r)a.push(`$${u}:name = NULL`),l.push(e),u+=1;else if("authData"===e){const t=`$${u}:name`,s=u;u+=1,l.push(`\`${e}\``);const n=Object.keys(r).reduce((t,s)=>{const n=((t,r,s)=>`JSON_SET(COALESCE(\`${e}\`, '{}'), '$.${r}', CAST('${s}' AS JSON))`)(0,`$${u}:name`,`$${u+1}:name`);u+=2;let o=r[s];return o&&(o="Delete"===o.__op?null:JSON.stringify(o)),l.push(s,o),n},t);a.push(`$${s}:name = ${n}`)}else if("Increment"===r.__op)a.push(`\`$${u}:name\` = COALESCE(\`$${u}:name\`, 0) + $${u+1}:name`),l.push(e,r.amount),u+=2;else if("Add"===r.__op)a.push(`\`$${u}:name\`= JSON_ARRAY_INSERT(COALESCE(\`$${u}:name\`, '[]'), CONCAT('$[',JSON_LENGTH(\`$${u}:name\`),']'), '$${u+1}:name')`),l.push(e,JSON.stringify(r.objects)),u+=2;else if("Delete"===r.__op)a.push(`\`$${u}:name\` = $${u+1}`),l.push(e,null),u+=2;else if("Remove"===r.__op)r.objects.forEach(t=>{a.push(`\`$${u}:name\` = JSON_REMOVE(\`$${u}:name\`, REPLACE(JSON_SEARCH(COALESCE(\`$${u}:name\`,'[]'), 'one', '$${u+1}:name'),'"',''))`),"object"==typeof t?l.push(e,JSON.stringify(t)):l.push(e,t),u+=2});else if("AddUnique"===r.__op)r.objects.forEach(t=>{if("object"==typeof t)for(let r of t)a.push(`\`$${u}:name\` = if (JSON_CONTAINS(\`$${u}:name\`, '$${u+1}:name') = 0, JSON_MERGE(\`$${u}:name\`,'$${u+1}:name'),\`$${u}:name\`)`),"number"==typeof r?l.push(e,r):"string"==typeof r&&l.push(e,'"'+r+'"'),u+=2;else a.push(`\`$${u}:name\` = if (JSON_CONTAINS(\`$${u}:name\`, '$${u+1}:name') = 0, JSON_MERGE(\`$${u}:name\`,'$${u+1}:name'),\`$${u}:name\`)`),"number"==typeof t?l.push(e,t):l.push(e,'"'+t+'"'),u+=2});else if("updatedAt"===e||"finishedAt"===e)a.push(`\`$${u}:name\` = '$${u+1}:name'`),l.push(e,(0,i.formatDateToMySQL)(r)),u+=2;else if("string"==typeof r)a.push(`\`$${u}:name\` = '$${u+1}:name'`),l.push(e,r),u+=2;else if("boolean"==typeof r)a.push(`\`$${u}:name\` = $${u+1}:name`),l.push(e,r),u+=2;else if("Pointer"===r.__type)a.push(`\`$${u}:name\` = '$${u+1}:name'`),l.push(e,r.objectId),u+=2;else if("Date"===r.__type)a.push(`\`$${u}:name\` = '$${u+1}:name'`),l.push(e,(0,i.toMySQLValue)(r)),u+=2;else if(r instanceof Date)a.push(`\`$${u}:name\` = '$${u+1}:name'`),l.push(e,r),u+=2;else if("File"===r.__type)a.push(`\`$${u}:name\` = '$${u+1}:name'`),l.push(e,(0,i.toMySQLValue)(r)),u+=2;else if("GeoPoint"===r.__type)a.push(`\`$${u}:name\` = POINT($${u+1}, $${u+2})`),l.push(e,r.longitude,r.latitude),u+=3;else if("Relation"===r.__type);else if("number"==typeof r)a.push(`\`$${u}:name\` = $${u+1}`),l.push(e,r),u+=2;else if("object"==typeof r&&t.fields[e]&&"Object"===t.fields[e].type){const t=Object.keys(c).filter(e=>!c[e].__op&&-1===e.indexOf(".")&&"updatedAt"!==e);let s="";t.length>0&&(s=t.map(()=>`CAST('${JSON.stringify(r)}' AS JSON)`));const n=Object.keys(c).filter(t=>!c[t].__op&&2===t.split(".").length&&t.split(".")[0]===e).map(e=>e.split(".")[1]);let o="";n.length>0&&(o=n.map(e=>"object"==typeof r[e]?`'$.${e}', CAST('${JSON.stringify(r[e])}' AS JSON)`:`'$.${e}', '${r[e]}'`).join(" || "),n.forEach(e=>{delete r[e]}));const i=Object.keys(c).filter(t=>"Increment"===c[t].__op&&2===t.split(".").length&&t.split(".")[0]===e).map(e=>e.split(".")[1]);let d="";i.length>0&&(d=i.map(e=>{const t=r[e].amount;return`'$.${e}', COALESCE(\`$${u}:name\`->>'$.${e}','0') + ${t}`}).join(" || "),i.forEach(e=>{delete r[e]}));const h=Object.keys(c).filter(t=>"Delete"===c[t].__op&&2===t.split(".").length&&t.split(".")[0]===e).map(e=>e.split(".")[1]),f=h.reduce((e,t,r)=>`'$.$${u+1+r}:name'`,", ");h.length>0&&a.push(`\`$${u}:name\` = JSON_REMOVE(\`$${u}:name\`, ${f})`),i.length>0&&a.push(`\`$${u}:name\` = JSON_SET(COALESCE(\`$${u}:name\`, '{}'), ${d})`),n.length>0&&a.push(`\`$${u}:name\` = JSON_SET(COALESCE(\`$${u}:name\`, '{}'), ${o})`),t.length>0&&a.push(`\`$${u}:name\` = ${s}`),l.push(e,...h,JSON.stringify(r)),u+=2+h.length}else{if(!Array.isArray(r)||!t.fields[e]||"Array"!==t.fields[e].type)return E("Not supported update",e,r),Promise.reject(new o.default.Error(o.default.Error.OPERATION_FORBIDDEN,`MySQL doesn't support update ${JSON.stringify(r)} yet`));a.push(`$${u}:name = '$${u+1}:name'`),l.push(e,JSON.stringify(r)),u+=2}});const d=(0,i.buildWhereClause)({schema:t,index:u,query:r});l.push(...d.values);const h=`UPDATE \`$1:name\` SET ${a.join(",")} WHERE ${d.pattern}`;return E("update: ",h,l),this.connect().then(()=>this.database.query(h,l)).then(([s])=>s.affectedRows>0?this.find(e,t,r,{undefined:void 0,limit:s.affectedRows}).then(e=>1===e.length?e[0]:e):null)}upsertOneObject(e,t,r,s){E("upsertOneObject",{className:e,query:r,update:s});const n=Object.assign({},r,s);return this.createObject(e,t,n).catch(n=>{if(n.code===o.default.Error.DUPLICATE_VALUE)return this.findOneAndUpdate(e,t,r,s);throw n})}updateSchemaWithIndexes(){return Promise.resolve()}find(e,t,r,{skip:s,limit:n,sort:o,keys:a}){E("find",e,r,{skip:s,limit:n,sort:o,keys:a});const l=void 0!==n,u=void 0!==s;let d=[e];const h=(0,i.buildWhereClause)({schema:t,query:r,index:2});d.push(...h.values);const f=h.pattern.length>0?`WHERE ${h.pattern}`:"",p=l?`LIMIT $${d.length+1}:name`:"";l&&d.push(n);const m=u?`OFFSET $${d.length+1}:name`:"";u&&d.push(s);let _="";if(o){const e=Object.keys(o).map(e=>1===o[e]?`\`${e}\` ASC`:`\`${e}\` DESC`).join(",");_=void 0!==o&&Object.keys(o).length>0?`ORDER BY ${e}`:""}h.sorts&&Object.keys(h.sorts).length>0&&(_=`ORDER BY ${h.sorts.join(",")}`);let y="*";a&&(y=(a=a.filter(e=>e.length>0)).map((e,t)=>"$score"===e?"*, MATCH (`$2:name`) AGAINST ('$3:name') as score":`\`$${t+d.length+1}:name\``).join(","),d=d.concat(a));const b=`SELECT ${y} FROM \`$1:name\` ${f} ${_} ${p} ${m}`;return E(b,d),this.connect().then(()=>this.database.query(b,d)).catch(e=>e.code===c?[[]]:e.code===g?[[]]:Promise.reject(e)).then(([e])=>e.map(e=>{const r=e;return Object.keys(t.fields).forEach(e=>{"Pointer"===t.fields[e].type&&r[e]&&(r[e]={objectId:r[e],__type:"Pointer",className:t.fields[e].targetClass}),"Relation"===t.fields[e].type&&(r[e]={__type:"Relation",className:t.fields[e].targetClass}),r[e]&&"GeoPoint"===t.fields[e].type&&(r[e]={__type:"GeoPoint",latitude:r[e].y,longitude:r[e].x}),r[e]&&"File"===t.fields[e].type&&(r[e]={__type:"File",name:r[e]}),void 0!==r[e]&&"Boolean"===t.fields[e].type&&(r[e]=1===r[e])}),r.createdAt&&(r.createdAt=r.createdAt.toISOString()),r.updatedAt&&(r.updatedAt=r.updatedAt.toISOString()),Object.keys(r).forEach(e=>{null===r[e]&&delete r[e],r[e]instanceof Date&&(r[e]={__type:"Date",iso:r[e].toISOString()})}),r}))}mysqlObjectToMmbsObject(e,t,r){const s=t;return Object.keys(r.fields).forEach(e=>{"Pointer"===r.fields[e].type&&s[e]&&(s[e]={objectId:s[e],__type:"Pointer",className:r.fields[e].targetClass}),"Relation"===r.fields[e].type&&(s[e]={__type:"Relation",className:r.fields[e].targetClass}),s[e]&&"GeoPoint"===r.fields[e].type&&(s[e]={__type:"GeoPoint",latitude:s[e].y,longitude:s[e].x}),s[e]&&"File"===r.fields[e].type&&(s[e]={__type:"File",name:s[e]}),void 0!==s[e]&&"Boolean"===r.fields[e].type&&(s[e]=1===s[e])}),s.createdAt&&(s.createdAt=s.createdAt.toISOString()),s.updatedAt&&(s.updatedAt=s.updatedAt.toISOString()),Object.keys(s).forEach(e=>{null===s[e]&&delete s[e],s[e]instanceof Date&&(s[e]={__type:"Date",iso:s[e].toISOString()})}),s}ensureUniqueness(e,t,r){const s=`unique_${r.sort().join("_")}`,n=`ALTER TABLE \`$1:name\` ADD CONSTRAINT \`$2:name\` UNIQUE (${r.map((e,t)=>`\`$${t+3}:name\``).join(",")})`;return E("ensureUniqueness",n,[e,s,...r]),this.connect().then(()=>this.database.query(n,[e,s,...r])).then(([e])=>e).catch(e=>{if(e.code===d||e.code===h||e.code===_)throw new o.default.Error(o.default.Error.DUPLICATE_VALUE,"A duplicate value for a field with unique values was provided");if(e.code!==m)throw e})}count(e,t,r){E("count",e,r);const s=[e],n=(0,i.buildWhereClause)({schema:t,query:r,index:2});s.push(...n.values);const o=`SELECT count(*) FROM \`$1:name\` ${n.pattern.length>0?`WHERE ${n.pattern}`:""}`;return this.connect().then(()=>this.database.query(o,s)).then(([e])=>e[0]["count(*)"]).catch(e=>{if(e.code===c)return 0;throw e})}distinct(e,t,r,s){E("distinct",e,r);let n=s,o=s;s.indexOf(".")>=0&&(n=(0,i.transformDotFieldToComponents)(s).join("->"),o=s.split(".")[0]);const a=t.fields&&t.fields[s]&&"Array"===t.fields[s].type,l=[n,o,e],u=(0,i.buildWhereClause)({schema:t,query:r,index:4});l.push(...u.values);const c=u.pattern.length>0?`WHERE ${u.pattern}`:"";let d=`SELECT DISTINCT($1:raw) FROM $3:name ${c}`;return a&&(d=`SELECT DISTINCT($1:raw) FROM $3:name ${c}`),E(d,l),this.database.query(d,l).catch(()=>[]).then(([r])=>r.map(r=>this.mysqlObjectToMmbsObject(e,r,t))).then(e=>{if(-1===s.indexOf("."))return a?this._arr_unique(e.map(e=>e[n])):e.map(e=>e[n]);const t=s.split(".")[1];return e.map(e=>e[o][t])})}aggregate(e,t,r){E("aggregate",e,r);const s=[e];let n=[],o=null,a="",l="",u="",c="",d="";for(let e=0;e<r.length;e+=1){const t=r[e];if(t.$group){for(const e in t.$group){const r=t.$group[e];null!==r&&void 0!==r&&("_id"!==e?(r.$sum&&("string"==typeof r.$sum?n.push(`SUM(${(0,i.transformAggregateField)(r.$sum)}) AS "${e}"`):(o=e,n.push(`COUNT(*) AS "${e}"`))),r.$max&&n.push(`MAX(${(0,i.transformAggregateField)(r.$max)}) AS "${e}"`),r.$min&&n.push(`MIN(${(0,i.transformAggregateField)(r.$min)}) AS "${e}"`),r.$avg&&n.push(`AVG(${(0,i.transformAggregateField)(r.$avg)}) AS "${e}"`)):(n.push(`${(0,i.transformAggregateField)(r)} AS "objectId"`),d=`GROUP BY ${(0,i.transformAggregateField)(r)}`))}n.join(",")}else n.push("*");if(t.$project){n.includes("*")&&(n=[]);for(const e in t.$project){const r=t.$project[e];1!==r&&!0!==r||n.push(e)}}if(t.$match){const e=[];for(const r in t.$match){const s=t.$match[r];"string"==typeof s?e.push(`${r} = ${s}`):Object.keys(i.MmbsToMySQLComparator).forEach(t=>{if(s[t]){const n=i.MmbsToMySQLComparator[t];e.push(`${r} ${n} ${s[t]}`)}})}a=e.length>0?`WHERE ${e.join(" ")}`:""}if(t.$limit&&(l=`LIMIT ${t.$limit}`),t.$skip&&(u=`OFFSET ${t.$skip}`),t.$sort){const e=t.$sort,r=Object.keys(e).map(t=>1===e[t]?`"${t}" ASC`:`"${t}" DESC`).join(",");c=void 0!==e&&Object.keys(e).length>0?`ORDER BY ${r}`:""}}const h=`SELECT ${n} FROM $1:name ${a} ${c} ${l} ${u} ${d}`;return E(h,s),this.database.query(h,s).then(([r])=>r.map(r=>this.mysqlObjectToMmbsObject(e,r,t))).then(e=>(o&&(e[0][o]=parseInt(e[0][o],10)),e.forEach(e=>{e.hasOwnProperty("objectId")||(e.objectId=null)}),e))}performInitialization({VolatileClassesSchemas:e}){E("performInitialization"),v=!0;const t=e.map(e=>this.connect().then(()=>this.createTable(e.className,e)).catch(e=>{if(e.code===o.default.Error.INVALID_CLASS_NAME)return Promise.resolve();throw e}));return Promise.all(t).then(()=>{v=!1,E("initializationDone")}).catch(e=>{console.error(e)})}createFullTextIndex(e,t){return this.connect().then(()=>this.database.query(`ALTER TABLE \`${e}\` ADD FULLTEXT (${t})`))}}t.default=S,e.exports=S},function(e,t){e.exports=__webpack_require__(38)},function(e,t,r){"use strict";function s(e){return e&&e.__esModule?e:{default:e}}function n(e){return e.split("").map(e=>null!==e.match(/[0-9a-zA-Z]/)?e:"'"===e?"''":`\\${e}`).join("")}function o(e){const t=e.match(/\\Q((?!\\E).*)\\E$/);if(t&&t.length>1&&t.index>-1){const r=e.substr(0,t.index),s=t[1];return o(r)+n(s)}const r=e.match(/\\Q((?!\\E).*)$/);if(r&&r.length>1&&r.index>-1){const t=e.substr(0,r.index),s=r[1];return o(t)+n(s)}return e.replace(/([^\\])(\\E)/,"$1").replace(/([^\\])(\\Q)/,"$1").replace(/^\\E/,"").replace(/^\\Q/,"").replace(/([^'])'/,"$1''").replace(/^'([^'])/,"''$1").replace("\\w","[0-9a-zA-Z]")}var a=Object.assign||function(e){for(var t=1;t<arguments.length;t++){var r=arguments[t];for(var s in r)Object.prototype.hasOwnProperty.call(r,s)&&(e[s]=r[s])}return e},i=s(r(0)),l=s(r(7));const u={$gt:">",$lt:"<",$gte:">=",$lte:"<=",$ne:"!="},c=Object.freeze({find:{},get:{},create:{},update:{},delete:{},addField:{}}),d=Object.freeze({find:{"*":!0},get:{"*":!0},create:{"*":!0},update:{"*":!0},delete:{"*":!0},addField:{"*":!0}}),h=e=>{const t=i.default._encode(new Date(e));return t.iso=t.iso.replace("T"," ").replace("Z",""),e.iso?t:t.iso},f=e=>{if("object"==typeof e){if("Date"===e.__type)return e.iso?h(e.iso):null;if("File"===e.__type)return e.name}return e},p=e=>"object"==typeof e&&"Pointer"===e.__type?e.objectId:e,m=e=>e?(e.fields=e.fields||{},e.fields._wperm={type:"Array",contents:{type:"String"}},e.fields._rperm={type:"Array",contents:{type:"String"}},"_User"===e.className&&(e.fields._hashed_password={type:"String"},e.fields._password_history={type:"Array"}),e):e,_=e=>{"object"==typeof e&&null!==e&&Object.keys(e).forEach(t=>{if("object"==typeof e[t]&&_(e[t]),t.includes("$")||t.includes("."))throw new i.default.Error(i.default.Error.INVALID_NESTED_KEY,"Nested keys should not contain the '$' or '.' characters")})},y=({schema:e,query:t,index:r})=>{const s=[];let n=[];const a=[];return e=m(e),void 0!=t&&Object.keys(t).forEach(c=>{const d=e.fields&&e.fields[c]&&"Array"===e.fields[c].type,h=s.length,p=t[c];if(!e.fields[c]&&p&&!1===p.$exists)return;if(c.indexOf(".")>=0){let e;c.split(".").forEach((t,r)=>{0===r?e=`\`${t}\`->>`:e+=1===r?`'$.${t}`:`.${t}`}),e+="'",null===p?s.push(`\`${e}\` IS NULL`):s.push(`${e} = '${p}'`)}else{if(null===p)return s.push(`\`$${r}:name\` IS NULL`),n.push(c),void(r+=1);if("string"==typeof p&&"Array"===e.fields[c].type)s.push(`JSON_CONTAINS(\`$${r}:name\`, '"$${r+1}:name"')`),n.push(c,p),r+=2;else if("string"==typeof p)s.push(`\`$${r}:name\` = '$${r+1}:name'`),n.push(c,p),r+=2;else if("boolean"==typeof p)s.push(`\`$${r}:name\` = $${r+1}:name`),n.push(c,p),r+=2;else if("number"==typeof p&&"Array"===e.fields[c].type)s.push(`JSON_CONTAINS(\`$${r}:name\`, '$${r+1}:name')`),n.push(c,p),r+=2;else if("number"==typeof p)s.push(`\`$${r}:name\` = $${r+1}:name`),n.push(c,p),r+=2;else if("$or"===c||"$and"===c){const t=[],o=[];p.forEach(s=>{const n=y({schema:e,query:s,index:r});n.pattern.length>0&&(t.push(n.pattern),o.push(...n.values),r+=n.values.length)});const a="$or"===c?" OR ":" AND ";s.push(`(${t.join(a)})`),n.push(...o)}}if(void 0!==p.$ne){if(d)p.$ne=JSON.stringify([p.$ne]),s.push(`JSON_CONTAINS(\`$${r}:name\`, '$${r+1}:name') != 1`);else{if(null===p.$ne)return s.push(`\`$${r}:name\` IS NOT NULL`),n.push(c),void(r+=1);s.push(`(\`$${r}:name\` <> '$${r+1}:name' OR \`$${r}:name\` IS NULL)`)}n.push(c,p.$ne),r+=2}p.$eq&&(s.push(`\`$${r}:name\` = '$${r+1}:name'`),n.push(c,p.$eq),r+=2);const m=Array.isArray(p.$in)||Array.isArray(p.$nin);if(Array.isArray(p.$in)&&d&&e.fields[c].contents&&"String"===e.fields[c].contents.type){const e=[];let t=!1;n.push(c),p.$in.forEach((s,o)=>{null===s?t=!0:(n.push(s),e.push(`JSON_CONTAINS(\`$${r}:name\`, JSON_ARRAY('$${r+1+o-(t?1:0)}:name')) = 1`))});const o=e.join(" OR ");t?s.push(`(\`$${r}:name\` IS NULL OR ${o})`):s.push(`\`$${r}:name\` && ${o}`),r=r+1+e.length}else if(m){const e=(e,t)=>{if(e.length>0){const o=t?" NOT ":"";if(d){const o=t?" != ":" = ",a=[];n.push(c),e.forEach((e,t)=>{n.push(JSON.stringify(e)),a.push(`JSON_CONTAINS(\`$${r}:name\`, '$${r+1+t}:name') ${o} 1`)}),s.push(`${a.join(" || ")}`),r=r+1+a.length}else{const t=[];n.push(c),e.forEach((e,s)=>{n.push(e),t.push(`'$${r+1+s}:name'`)}),s.push(`\`$${r}:name\` ${o} IN (${t.join(",")})`),r=r+1+t.length}}else t||(n.push(c),s.push(`\`$${r}:name\` IS NULL`),r+=1)};p.$in&&e(l.default.flatMap(p.$in,e=>e),!1),p.$nin&&e(l.default.flatMap(p.$nin,e=>e),!0)}if(Array.isArray(p.$all)&&d&&(s.push(`JSON_CONTAINS(\`$${r}:name\`, '$${r+1}:name') = 1`),n.push(c,JSON.stringify(p.$all)),r+=2),void 0!==p.$exists&&(p.$exists?s.push(`$${r}:name IS NOT NULL`):s.push(`\`$${r}:name\` IS NULL`),n.push(c),r+=1),p.$text){const e=p.$text.$search;if("object"!=typeof e)throw new i.default.Error(i.default.Error.INVALID_JSON,"bad $text: $search, should be object");if(!e.$term||"string"!=typeof e.$term)throw new i.default.Error(i.default.Error.INVALID_JSON,"bad $text: $term, should be string");if(e.$language&&"string"!=typeof e.$language)throw new i.default.Error(i.default.Error.INVALID_JSON,"bad $text: $language, should be string");if(e.$caseSensitive&&"boolean"!=typeof e.$caseSensitive)throw new i.default.Error(i.default.Error.INVALID_JSON,"bad $text: $caseSensitive, should be boolean");if(e.$caseSensitive)throw new i.default.Error(i.default.Error.INVALID_JSON,"bad $text: $caseSensitive not supported, please use $regex or create a separate lower case column.");if(e.$diacriticSensitive&&"boolean"!=typeof e.$diacriticSensitive)throw new i.default.Error(i.default.Error.INVALID_JSON,"bad $text: $diacriticSensitive, should be boolean");if(!1===e.$diacriticSensitive)throw new i.default.Error(i.default.Error.INVALID_JSON,"bad $text: $diacriticSensitive - false not supported, install MySQL Unaccent Extension");s.push(`MATCH (\`$${r}:name\`) AGAINST ('$${r+1}:name')`),n.push(c,e.$term),r+=2}if(p.$nearSphere){const e=p.$nearSphere;if(a.push(`ST_Distance_Sphere(\`$${r}:name\`, ST_GeomFromText('POINT($${r+1}:name $${r+2}:name)')) ASC`),p.$maxDistance){const t=6371*p.$maxDistance*1e3;s.push(`ST_Distance_Sphere(\`$${r}:name\`, ST_GeomFromText('POINT($${r+1}:name $${r+2}:name)')) <= $${r+3}:name`),n.push(c,e.longitude,e.latitude,t),r+=4}else s.push(`ST_Distance_Sphere(\`$${r}:name\`, ST_GeomFromText('POINT($${r+1}:name $${r+2}:name)'))`),n.push(c,e.longitude,e.latitude),r+=3}if(p.$within&&p.$within.$box){const e=p.$within.$box,t=e[0].longitude,o=e[0].latitude,a=e[1].longitude,i=e[1].latitude;s.push(`MBRCovers(ST_GeomFromText('Polygon($${r}:name)'), \`$${r+1}:name\`)`),n.push(`(${t} ${o}, ${t} ${i}, ${i} ${a}, ${a} ${o}, ${t} ${o})`,c),r+=2}if(p.$geoWithin&&p.$geoWithin.$polygon){const e=p.$geoWithin.$polygon;if(!(e instanceof Array))throw new i.default.Error(i.default.Error.INVALID_JSON,"bad $geoWithin value; $polygon should contain at least 3 GeoPoints");if(e.length<3)throw new i.default.Error(i.default.Error.INVALID_JSON,"bad $geoWithin value; $polygon should contain at least 3 GeoPoints");e[0].latitude===e[e.length-1].latitude&&e[0].longitude===e[e.length-1].longitude||e.push(e[0]);const t=e.map(e=>{if("object"!=typeof e||"GeoPoint"!==e.__type)throw new i.default.Error(i.default.Error.INVALID_JSON,"bad $geoWithin value");return i.default.GeoPoint._validate(e.latitude,e.longitude),`${e.longitude} ${e.latitude}`}).join(", ");s.push(`MBRCovers(ST_GeomFromText('Polygon($${r}:name)'), \`$${r+1}:name\`)`),n.push(`(${t})`,c),r+=2}if(p.$regex){let e=p.$regex;const t=p.$options;t&&t.indexOf("x")>=0&&(e=function(e){return e.endsWith("\n")||(e+="\n"),e.replace(/([^\\])#.*\n/gim,"$1").replace(/^#.*\n/gim,"").replace(/([^\\])\s+/gim,"$1").replace(/^\s+/,"").trim()}(e)),e=function(e){return e&&e.startsWith("^")?`^${o(e.slice(1))}`:e&&e.endsWith("$")?`${o(e.slice(0,e.length-1))}$`:o(e)}(e),s.push(`\`$${r}:name\` REGEXP '$${r+1}:name'`),n.push(c,e),r+=2}if("Pointer"===p.__type&&(d?(s.push(`JSON_CONTAINS(\`$${r}:name\`, '$${r+1}:name') = 1`),n.push(c,JSON.stringify([p])),r+=2):(s.push(`$${r}:name = '$${r+1}:name'`),n.push(c,p.objectId),r+=2)),"Date"===p.__type&&(s.push(`\`$${r}:name\` = '$${r+1}:name'`),n.push(c,f(p)),r+=2),"GeoPoint"===p.__type&&(s.push(`\`$${r}:name\` = ST_GeomFromText('POINT($${r+1}:name $${r+2}:name)')`),n.push(c,p.longitude,p.latitude),r+=3),Object.keys(u).forEach(e=>{if(p[e]){const t=u[e];s.push(`\`$${r}:name\` ${t} '$${r+1}:name'`),n.push(c,f(p[e])),r+=2}}),h===s.length)throw new i.default.Error(i.default.Error.OPERATION_FORBIDDEN,`MySQL does not support this query type yet ${p}`)}),n=n.map(p),{pattern:s.join(" AND "),values:n,sorts:a}};e.exports={toMmbsSchema:e=>{"_User"===e.className&&delete e.fields._hashed_password,e.fields&&(delete e.fields._wperm,delete e.fields._rperm);let t=d;return e.classLevelPermissions&&(t=a({},c,e.classLevelPermissions)),{className:e.className,fields:e.fields,classLevelPermissions:t}},toMySQLSchema:m,parseTypeToMySQLType:e=>{switch(e.type){case"String":return"text";case"Date":return"timestamp(6)";case"Object":return"json";case"File":return"text";case"Boolean":return"boolean";case"Pointer":return"char(10)";case"Number":return"double precision";case"GeoPoint":return"point";case"Bytes":case"Array":return"json";default:throw`no type for ${JSON.stringify(e)} yet`}},joinTablesForSchema:e=>{const t=[];return e&&Object.keys(e.fields).forEach(r=>{"Relation"===e.fields[r].type&&t.push(`_Join:${r}:${e.className}`)}),t},handleDotFields:e=>(Object.keys(e).forEach(t=>{if(t.indexOf(".")>-1){const r=t.split("."),s=r.shift();e[s]=e[s]||{};let n,o=e[s],a=e[t];for(a&&"Delete"===a.__op&&(a=void 0);n=r.shift();)o[n]=o[n]||{},0===r.length&&(o[n]=a),o=o[n];delete e[t]}}),e),validateKeys:_,toMySQLValue:f,buildWhereClause:y,formatDateToMySQL:h,transformAggregateField:e=>e.substr(1),transformDotFieldToComponents:e=>e.split(".").map((e,t)=>0===t?`"${e}"`:`'${e}'`),MmbsToMySQLComparator:u}},function(e,t,r){"use strict";function s(e){return(e=e||"").split("&").reduce((e,t)=>{const r=t.split("=");return e[decodeURIComponent(r[0])]=r.length>1?decodeURIComponent(r.slice(1).join("=")):"",e},{})}const n=r(15);e.exports={parseQueryParams:s,getDatabaseOptionsFromURI:function(e){const t={},r=n.parse(e),o=s(r.query),a=r.auth?r.auth.split(":"):[];return t.host=r.hostname||"localhost",t.port=r.port?parseInt(r.port,10):5432,t.database=r.pathname?r.pathname.substr(1):void 0,t.user=a.length>0?a[0]:"",t.password=a.length>1?a[1]:"",t.ssl=o.ssl&&"true"===o.ssl.toLowerCase(),t.binary=o.binary&&"true"===o.binary.toLowerCase(),t.client_encoding=o.client_encoding,t.application_name=o.application_name,t.fallback_application_name=o.fallback_application_name,o.poolSize&&(t.poolSize=parseInt(o.poolSize,10)||10),t}}},function(e,t){e.exports=__webpack_require__(39)},function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0});class s{send(e,t,r){}getValidPushTypes(){return[]}}t.PPushAdapter=s,t.default=s},function(e,t,r){"use strict";function s(e){if("string"==typeof e)return a.parse(e)}function n(e,t,r){t=t?s(t):void 0,r=r?s(r):void 0;const n=e.length-l.length;let a=e.slice(0,n);const u=function(e){if(e.slice(0,a.length)!=a)throw new o.Error(o.Error.INVALID_JSON,"cannot route batch path "+e);return i.posix.join("/",e.slice(a.length))};if(t&&r&&t.path!=r.path){const e=t.path,s=r.path;return a=e,function(t){const r=i.posix.join("/",e,"/",t.slice(s.length));return u(r)}}return u}const o=r(0).Mmbs,a=r(15),i=r(11),l="/batch";e.exports={mountOnto:function(e){e.route("POST",l,t=>(function(e,t){if(!Array.isArray(t.body.requests))throw new o.Error(o.Error.INVALID_JSON,"requests must be an array");if(!t.originalUrl.endsWith(l))throw"internal routing problem - expected url to end with batch";const r=n(t.originalUrl,t.config.serverURL,t.config.publicServerURL),s=t.body.requests.map(s=>{const n=r(s.path),o={body:s.body,config:t.config,auth:t.auth,info:t.info};return e.tryRouteRequest(s.method,n,o).then(e=>({success:e.response}),e=>({error:{code:e.code,error:e.message}}))});return Promise.all(s).then(e=>({response:e}))})(e,t))},makeBatchRoutingPathFunction:n}},function(e,t){e.exports=__webpack_require__(40)},function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0});class s{constructor(){}get(){return new Promise(e=>e(null))}put(){return Promise.resolve()}del(){return Promise.resolve()}clear(){return Promise.resolve()}}t.NullCacheAdapter=s,t.default=s},function(e,t,r){"use strict";function s(e){return e&&e.__esModule?e:{default:e}}function n(){a.default.debug.apply(a.default,["RedisCacheAdapter",...arguments])}Object.defineProperty(t,"__esModule",{value:!0}),t.RedisCacheAdapter=void 0;var o=s(r(44)),a=s(r(1));const i=3e4;class l{constructor(e,t=i){this.client=o.default.createClient(e),this.p=Promise.resolve(),this.ttl=t}get(e){return n("get",e),this.p=this.p.then(()=>new Promise(t=>{this.client.get(e,function(r,s){if(n("-> get",e,s),!s)return t(null);t(JSON.parse(s))})})),this.p}put(e,t,r=this.ttl){return t=JSON.stringify(t),n("put",e,t,r),0===r?this.p:((r<0||isNaN(r))&&(r=i),this.p=this.p.then(()=>new Promise(s=>{r===1/0?this.client.set(e,t,function(){s()}):this.client.psetex(e,r,t,function(){s()})})),this.p)}del(e){return n("del",e),this.p=this.p.then(()=>new Promise(t=>{this.client.del(e,function(){t()})})),this.p}clear(){return n("clear"),this.p=this.p.then(()=>new Promise(e=>{this.client.flushdb(function(){e()})})),this.p}}t.RedisCacheAdapter=l,t.default=l},function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.destroyAllDataPermanently=function(){if(!process.env.TESTING)throw"Only supported in test environment";return Promise.all(Object.keys(s.default.cache).map(e=>{const t=s.default.get(e);return t.databaseController?t.databaseController.deleteEverything():Promise.resolve()}))};var s=function(e){return e&&e.__esModule?e:{default:e}}(r(20))},function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.useExternal=function(e,t){return function(){throw`${e} is not provided by mmbs-server anymore; please install ${t}`}}}])})},function(e,t){e.exports=require("xmlhttprequest")},function(e,t){e.exports=require("https")},function(e,t){e.exports=require("lodash")},function(e,t){e.exports=require("path")},function(e,t){e.exports=require("url")},function(e,t){e.exports=require("querystring")},function(e,t){e.exports=require("request")},function(e,t){e.exports=require("deepcopy")},function(e,t){e.exports=require("express")},function(e,t){e.exports=require("mongodb")},function(e,t){e.exports=require("fs")},function(e,t){e.exports=require("crypto")},function(e,t){e.exports=require("body-parser")},function(e,t){e.exports=require("mime")},function(e,t){e.exports=require("redis")},function(e,t){e.exports=require("lru-cache")},function(e,t){e.exports=require("pg-promise")},function(e,t){e.exports=require("winston")},function(e,t){e.exports=require("winston-daily-rotate-file")},function(e,t){e.exports=require("intersect")},function(e,t){e.exports=require("net")},function(e,t){e.exports=require("bcryptjs")},function(e,t){e.exports=require("bcrypt")},function(e,t){e.exports=require("semver")},function(e,t){e.exports=require("cron")},function(e,t){e.exports=require("mockjs")},function(e,t){e.exports=require("csvtojson")},function(e,t){e.exports=require("util")},function(e,t){e.exports=require("express/lib/router/layer")},function(e,t){e.exports=require("tv4")},function(e,t){e.exports=require("uws")},function(e,t){e.exports=require("uuid")},function(e,t){e.exports=require("punycode")},function(e,t){e.exports=require("npmlog")},function(e,t){e.exports=require("mysql2/promise")},function(e,t){e.exports=require("http")}])});